(function(Ge,Ve){typeof exports=="object"&&typeof module<"u"?Ve(exports):typeof define=="function"&&define.amd?define(["exports"],Ve):(Ge=typeof globalThis<"u"?globalThis:Ge||self,Ve(Ge.MoodlePaellaPlayer={}))})(this,function(Ge){"use strict";var Ve=n=>{throw TypeError(n)},ln=(n,t,e)=>t.has(n)||Ve("Cannot "+e),O=(n,t,e)=>(ln(n,t,"read from private field"),e?e.call(n):t.get(n)),at=(n,t,e)=>t.has(n)?Ve("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),ht=(n,t,e,i)=>(ln(n,t,"write to private field"),t.set(n,e),e),pa=(n,t,e)=>(ln(n,t,"access private method"),e);const V=Object.freeze({PLAY:"paella:play",PAUSE:"paella:pause",STOP:"paella:stop",ENDED:"paella:ended",SEEK:"paella:seek",FULLSCREEN_CHANGED:"paella:fullscreenchanged",ENTER_FULLSCREEN:"paella:enterfullscreen",EXIT_FULLSCREEN:"paella:exitfullscreen",VOLUME_CHANGED:"paella:volumeChanged",TIMEUPDATE:"paella:timeupdate",TRIMMING_CHANGED:"paella:trimmingChanged",CAPTIONS_CHANGED:"paella:captionsChanged",CAPTIONS_ENABLED:"paella:captionsEnabled",CAPTIONS_DISABLED:"paella:captionsDisabled",BUTTON_PRESS:"paella:buttonPress",SHOW_POPUP:"paella:showPopUp",HIDE_POPUP:"paella:hidePopUp",MANIFEST_LOADED:"paella:manifestLoaded",STREAM_LOADED:"paella:streamLoaded",PLAYER_LOADED:"paella:playerLoaded",PLAYER_UNLOADED:"paella:playerUnloaded",RESIZE:"paella:resize",RESIZE_END:"paella:resizeEnd",LAYOUT_CHANGED:"paella:layoutChanged",PLAYBACK_RATE_CHANGED:"paella:playbackRateChanged",VIDEO_QUALITY_CHANGED:"paella:videoQualityChanged",HIDE_UI:"paella:hideUI",SHOW_UI:"paella:showUI",COOKIE_CONSENT_CHANGED:"paella:cookieConsentChanged",LOG:"paella:log"});function bt(n,t,e,i=!0){return n.__eventListeners__=n.__eventListeners__||{},Array.isArray(t)||(t=[t]),t.forEach(s=>{n.__eventListeners__[s]=n.__eventListeners__[s]||[],n.__eventListeners__[s].push({callback:e,unregisterOnUnload:i})}),e}function et(n,t,e={}){n.__eventListeners__&&n.__eventListeners__[t]&&n.__eventListeners__[t].forEach(i=>i.callback(e))}function He(n,t,e={}){n.ready&&et(n,t,e)}function eu(n){if(n.__eventListeners__)for(const t in n.__eventListeners__)n.__eventListeners__[t]=n.__eventListeners__[t].filter(e=>e.unregisterOnUnload==!1),n.log.debug("Unregister event: "+n.__eventListeners__[t])}function iu(n){return new Promise((t,e)=>{fetch(n).then(i=>i.text()).then(i=>{t(i)}).catch(i=>e(i))})}function su(n){const t=new URLSearchParams(window.location.search);return t.has(n)?t.get(n):null}function nu(n){const t=window.location.hash.replace("#","?"),e=new URLSearchParams(t);return e.has(n)?e.get(n):null}function ce(n,t){const e=t||"/";return n=n.map((i,s)=>(s&&(i=i.replace(new RegExp("^"+e),"")),s!==n.length-1&&(i=i.replace(new RegExp(e+"$"),"")),i)),n.join(e)}function ru(n){return new RegExp("^([a-z]+://|//)","i").test(n)||/^\//.test(n)}function hn(n){try{return new URL(n).pathname.split("/").pop()}catch{return n.split("/").pop()}}function au(n){return n.split(".").reduce((t,e,i,s)=>i<s.length-1?t!==""?`${t}.${e}`:e:t,"")}function ma(n){const t=e=>{const i=e.split("/").reduce((s,r,a,o)=>a<o.length-1?s!==""?`${s}/${r}`:r:s,"");return(e[0]==="/"?`/${i}`:i)+"/"};try{const e=new URL(n);return e.origin+t(e.pathname)}catch{return t(n)}}function ya(n){return hn(n).split(".").pop()}function ye(n,t){return ru(t)?t:ce([n.manifestUrl,t])}function ou(n){n.__hideTimerPaused__=!0}function va(n){n.__hideTimerPaused__=!1}function lu(n,t="hideUiTime"){var e;n.__hideTimer__=null;const i=async()=>n.__hideTimerPaused__?(n.log.debug("UI not hidden because the auto hide timer is paused"),!1):s()?(n.log.debug("UI not hidden because there is a focused element"),!1):(await n.hideUserInterface(),!0);(e=n.config.ui)!=null&&e.hideOnMouseLeave&&n.containerElement.addEventListener("mouseleave",()=>{i()});const s=()=>{const a=document.activeElement,o=document.querySelector(":focus-visible");return(n.playbackBar.element.contains(a)||n.videoContainer.element.contains(a))&&["input","textarea","button"].find(l=>a.tagName.toLowerCase(l))!==-1&&o},r=async()=>{n.__hideTimer__&&clearTimeout(n.__hideTimer__),await n.showUserInterface(),n.__hideTimer__=setTimeout(async()=>{n.__hideTimer__=null,i()||r()},n[t])};n.containerElement.addEventListener("mousemove",async a=>{r()}),bt(n,V.PLAY,async()=>{r()}),bt(n,V.PAUSE,async()=>{await n.showUserInterface()}),bt(n,V.ENDED,async()=>{await n.showUserInterface()}),document.addEventListener("keydown",async()=>{r()})}function hu(n){n.__hideTimer__&&(clearTimeout(n.__hideTimer__),delete n.__hideTimer__)}function Ke(n){const t=Math.floor(n/60/60),e=Math.floor(n/60)-t*60,i=Math.floor(n%60);return(t>0?t.toString().padStart(2,"0")+":":"")+e.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")}function cn(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)(\.\d+)?$/.exec(n);if(t){const e=t[1]!==void 0?Number(t[1]):0,i=Number(t[2]),s=Number(t[3]);return e*3600+i*60+s}return null}function Ea(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)\.(\d+)?$/.exec(n);if(t){const e=t[1]!==void 0?Number(t[1]):0,i=Number(t[2]),s=Number(t[3]),r=t[4]&&Number(t[4])||0;return e*36e5+i*6e4+s*1e3+r}return null}function We(n,t,e=365){let i=new Date;i.setTime(i.getTime()+e*24*60*60*1e3);let s=`expires=${i.toUTCString()}`;document.cookie=`${n}=${t};${s};path=/;SameSite=None;`+(/Apple/.test(navigator.vendor)?"":"Secure;")}function cu(n,t,e,i,s=365){n.cookieConsent.getConsentForType(t)&&We(e,i,s)}function ui(n){let t=n+"=",e=decodeURIComponent(document.cookie).split(";");for(let i=0;i<e.length;++i){let s=e[i];for(;s.charAt(0)==" ";)s=s.substring(1);if(s.indexOf(t)==0)return s.substring(t.length,s.length)}return""}function Ta(n,t=!0){return new Promise(e=>{const i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",n),i.onload=()=>e(i);const s=document.getElementsByTagName("head")[0];t&&s.appendChild(i),e()})}function uu(n){document.getElementsByTagName("head")[0].removeChild(n)}function Fi(n,t,e=!0){for(const i in t){const s=n[i];let r=t[i];e&&Array.isArray(s)&&Array.isArray(r)?(s.forEach(a=>{r=r.filter(o=>typeof a=="object"&&typeof o=="object"&&a.id===o.id?(Fi(a,o,e),!1):!0)}),r.forEach(a=>{s.push(a)})):typeof s=="object"&&r?Fi(s,r,e):n[i]=t[i]}}function _a(n,{excludedTags:t=null}={}){const e=document.createElement("div");e.innerHTML=n;const i=["script"];return t&&i.push(...t),i.flatMap(s=>Array.from(e.getElementsByTagName(s))).forEach(s=>{s.parentElement.removeChild(s)}),e.innerHTML}let Ui=null;function La(n){if(!n)return!1;Ui||(Ui=document.createElement("video"));let t=Ui.canPlayType(n);if(t==="maybe"||t==="probably")return!0;if(/video\/mp4/i.test(n))return t=Ui.canPlayType("video/mp4"),t==="maybe"||t==="probably"}async function du(n,t){return t.log.debug("Using default configuration loading function."),(await fetch(n)).json()}async function fu(n,t){return t.log.debug("Using default getVideoId function"),nu("id")||su("id")||n.fallbackId}async function gu(n,t,e,i){return i.log.debug("Using default getManifestUrl function"),ce([n,t])}async function pu(n,t,e,i){return i.log.debug("Using default getManifestFileUrl function"),ce([n,t])}async function mu(n,t,e){e.log.debug("Using default loadVideoManifest function");const i=await fetch(n);if(i.ok)try{return await i.json()}catch{throw new Error(e.translate("Error parsing video manifest. Unexpected file format."))}else throw new Error(e.translate("Error loading video manifest: $1 $2",[i.status,i.statusText]))}var Bi;let ze=class{constructor(t){at(this,Bi,null),ht(this,Bi,t)}get player(){return O(this,Bi)}};Bi=new WeakMap;function Ca({tag:n="div",attributes:t={},children:e="",innerText:i="",parent:s=null}){const r=document.createElement(n);r.innerText=i;for(let a in t)r.setAttribute(a,t[a]);return r.innerHTML=e,s&&s.appendChild(r),r}function Z(n,t=null){const e=document.createElement("div");e.innerHTML=n;const i=e.children[0];return t&&t.appendChild(i),i}var Vt;let se=class extends ze{constructor(t,{tag:e="div",attributes:i=[],children:s="",parent:r=null}){super(t),at(this,Vt,null),ht(this,Vt,Ca({tag:e,attributes:i,children:s,parent:r})),Object.defineProperty(this,e,{get:()=>O(this,Vt)})}get element(){return O(this,Vt)}get parent(){return O(this,Vt).parentElement}hide(){this.element.style.display="none"}show(t="block"){this.element.style.display=null}get isVisible(){const t=window.getComputedStyle(this.element);return t.display!=="none"&&t.display!==""}setAttribute(t,e){O(this,Vt).setAttribute(t,e)}removeFromParent(){var t;(t=O(this,Vt).parentElement)==null||t.removeChild(O(this,Vt))}setParent(t){this.removeFromParent(),t.appendChild(O(this,Vt))}};Vt=new WeakMap;const yu=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 256 256" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(1,0,0,1,3,-3.88857)">
        <path d="M128,35.819C65.633,35.819 14.999,86.453 14.999,148.82C14.999,163.127 17.663,176.817 22.549,189.403L22.475,189.447C11.612,170.791 5.889,149.588 5.889,128C5.889,60.56 60.56,5.889 128,5.889L128,35.819Z" style="fill:url(#_Linear1);"/>
    </g>
    <g transform="matrix(-1,1.22465e-16,-1.22465e-16,-1,258,251.914)">
        <path d="M128,35.819C65.633,35.819 14.999,86.453 14.999,148.82C14.999,163.127 17.663,176.817 22.549,189.403L22.475,189.447C11.612,170.791 5.889,149.588 5.889,128C5.889,60.56 60.56,5.889 128,5.889L128,35.819Z" style="fill:url(#_Linear2);"/>
    </g>
    <defs>
        <linearGradient id="_Linear1" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(-89.3028,140.734,-140.734,-89.3028,144.417,48.7125)"><stop offset="0" style="stop-color:rgb(13,13,13);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(175,175,175);stop-opacity:0.5"/></linearGradient>
        <linearGradient id="_Linear2" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(-89.3028,140.734,-140.734,-89.3028,144.417,48.7125)"><stop offset="0" style="stop-color:rgb(13,13,13);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(175,175,175);stop-opacity:0.5"/></linearGradient>
    </defs>
</svg>
`;let vu=class extends se{constructor(t){super(t,{parent:t.containerElement}),this.element.className="loader-container"}async create(){Z(`<i>${yu}</i>`,this.element)}get debug(){return!1}};const Eu=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 256 256" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g id="Cancel" transform="matrix(5.54545,6.8353e-32,6.8353e-32,5.54545,-2567.37,-10735.5)">
        <path d="M486.05,1937C498.192,1937 508.05,1946.86 508.05,1959C508.05,1971.14 498.192,1981 486.05,1981C473.908,1981 464.05,1971.14 464.05,1959C464.05,1946.86 473.908,1937 486.05,1937ZM478.979,1950.52L477.565,1951.93L484.636,1959L477.565,1966.07L478.979,1967.49L486.05,1960.41L493.121,1967.49L494.535,1966.07L487.464,1959L494.535,1951.93L493.121,1950.52L486.05,1957.59L478.979,1950.52Z" style="fill:rgb(210,0,0);"/>
    </g>
</svg>
`;let un=class extends se{constructor(t,e=""){super(t,{parent:t.containerElement}),this.element.className="error-container",Z(`
            <div>
                <i>${Eu}</i>
                <p>${e}</p>
            </div>`,this.element)}},di=class extends ze{constructor(t,e){super(t),this._name=e}getPluginModuleInstance(){return null}get config(){return this._config}get type(){return"none"}get order(){var t;return((t=this._config)==null?void 0:t.order)||0}get description(){var t;return((t=this._config)==null?void 0:t.description)||""}get name(){return this._name}async isEnabled(){var t;return(t=this.config)==null?void 0:t.enabled}async load(){}async unload(){}},Gi=class extends di{get type(){return"video"}get streamType(){return"mp4"}async isCompatible(){return!1}async getVideoInstance(){return null}getCompatibleFileExtensions(){return[]}getManifestData(t){}};const Vi=[];async function Tu(n){await Kt(n,"video",t=>{Vi.push(t)})}async function _u(n){Vi.slice(0)}function ba(n){if(Vi.length===0)throw Error("No video plugins loaded. Note that `loadVideoPlugins()` must to be called before using `getVideoPlugins()`.");return Vi}function Lu(n,t){const e=ya(t);return ba().find(i=>i.getCompatibleFileExtensions().indexOf(e)!==-1)}async function Cu(n,t){const e=ba();let i=null;for(const s of e)if(await s.isCompatible(t)){i=s;break}return i}async function bu(){return await new Promise(n=>{const t=document.createElement("audio"),e=setTimeout(()=>n(!1),100);t.addEventListener("volumechange",i=>{clearTimeout(e),n(!0)}),t.volume=.5})}let dn=class extends se{constructor(t,e,i){const s={class:"video-player"};super(e,{tag:t,attributes:s,parent:i}),this._streamProvider=null,this._streamData=null,this._ready=!1}async isVolumeApiAvailable(){return await bu()}get streamData(){return this._streamData}get ready(){return this._ready}async load(t,e){return this._streamProvider=e,this._streamData=t,await this.loadStreamData(t)}get isMainAudioPlayer(){return this._streamProvider.mainAudioPlayer===this}onVideoEnded(t){this._videoEndedCallback=t}async play(){return!1}async pause(){return!1}async duration(){return-1}get currentTimeSync(){return-1}async currentTime(){return-1}async setCurrentTime(){return!1}async volume(){return-1}async setVolume(){return!1}initVolume(t){this._initialVolume=t}async paused(){return!0}async playbackRate(){return-1}async setPlaybackRate(){return!1}async getQualities(){return null}async setQuality(){return!1}get currentQuality(){return null}async getDimensions(){return null}async supportsMultiaudio(){return!1}async getAudioTracks(){return null}async setCurrentAudioTrack(){}get currentAudioTrack(){return null}async loadStreamData(t){return!1}get isEnabled(){return this._enabled}async enable(){this._enabled=!0}async disable(){this._enabled=!1}},Hi=class extends ze{get moduleName(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleName'`),"-"}get moduleVersion(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleVersion'`),"0.0.0"}async getDictionaries(){return null}};const Su="@asicupv/paella-core",wu={".":"./dist/paella-core.js","./src/":"./src/","./paella-core.css":"./dist/paella-core.css"},Iu="2.2.4",Au="Multi stream HTML video player",Ru="./dist/paella-core.js",ku=["dist/paella-core.css","dist/paella-core.js","dist/paella-core.umd.cjs","dist/paella-core.js.map","dist/paella-core.umd.cjs.map","dist/paella-core.d.ts"],Du="./dist/paella-core.js",Pu="module",xu={dev:"vite build --watch",build:"vite build --emptyOutDir"},Mu={type:"git",url:"git+https://github.com/polimediaupv/paella-player.git"},Ou=["html","player","video","hls"],$u="Fernando Serrano Carpena <ferserc1@gmail.com>",Nu="ECL-2.0",Fu={url:"https://github.com/polimediaupv/paella-player/issues"},Uu="https://github.com/polimediaupv/paella-player#readme",Bu={typescript:"^5.8.3",vite:"^6.0.11"},Gu={"@ferserc1/input-style-unifier":"^0.0.2","vite-plugin-static-copy":"^3.0.0"},fi={name:Su,exports:wu,version:Iu,description:Au,main:Ru,files:ku,module:Du,type:Pu,scripts:xu,repository:Mu,keywords:Ou,author:$u,license:Nu,bugs:Fu,homepage:Uu,devDependencies:Bu,dependencies:Gu};let fn=null,Ki=class jc extends Hi{static Get(){return fn||(fn=new jc),fn}get moduleName(){return"paella-core default video formats"}get moduleVersion(){return fi.version}};function Vu(n){return new Promise((t,e)=>{const i=new Image;i.addEventListener("load",s=>{t(i)}),i.addEventListener("error",s=>{e(new Error("Could not load preview image. The preview image is required in audio only streams"))}),i.src=n})}function Hu(n,t,e){return new Promise((i,s)=>{t.oncanplay=()=>i(),t.onerror=()=>s(new Error(n.translate("Error loading audio: $1",[e]))),t.src=ye(n,e),i()})}let Ku=class extends dn{constructor(t,e,i){super("audio",t,e),this.isMainAudio=i,this._ready=!1}get streamType(){return"audio"}waitForLoaded(){return new Promise(t=>{const e=()=>{this._ready?t():setTimeout(e,100)};e()})}async play(){await this.waitForLoaded(),this.audio.play()}async pause(){await this.waitForLoaded(),this.audio.pause()}async duration(){return await this.waitForLoaded(),this.audio.duration}get currentTimeSync(){var t;return((t=this.audio)==null?void 0:t.currentTime)||0}async currentTime(){return await this.waitForLoaded(),this.audio.currentTime}async setCurrentTime(t){await this.waitForLoaded(),this.audio.currentTime=t}async volume(){return await this.waitForLoaded(),this.audio.volume}async setVolume(t){await this.waitForLoaded(),this.audio.volume=t}async paused(){return await this.waitForLoaded(),this.audio.paused}async playbackRate(){return await this.waitForLoaded(),this.audio.playbackRate}async setPlaybackRate(t){await this.waitForLoaded(),this.audio.playbackRate=t}async getDimensions(){return{w:this._previewImage.width,h:this._previewImage.height}}async loadStreamData(t=null){this._streamData=this._streamData||t,this.player.log.debug("es.upv.paella.audioVideoFormat: loadStreamData");const e=this.player.videoManifest.metadata.preview;if(!e||e==null)throw new Error("Invalid video manifest data: preview image is required");if(this._previewImage=await Vu(e),this._imageContainer=document.createElement("div"),this._imageContainer.className="image-container",this.parent.appendChild(this._imageContainer),this._imageContainer.appendChild(this._previewImage),this._source=t.sources.audio&&t.sources.audio[0],!this._source)throw new Error("Invalid source in audio only video stream");if(!this.isMainAudioPlayer)throw new Error("Audio only video stream must be main audio player. Check the role property at video manifest");await Hu(this.player,this.audio,this._source.src);const i=()=>{const s=this.player.videoContainer.baseVideoRect.offsetWidth/this.player.videoContainer.baseVideoRect.offsetHeight,r=this._previewImage.width/this._previewImage.height;s>r?(this._previewImage.classList.add("landscape"),this._previewImage.classList.remove("portrait")):(this._previewImage.classList.add("portrait"),this._previewImage.classList.remove("landscape"))};this.player.frameList.frames.length>0&&this.audio.addEventListener("timeupdate",s=>{const r=this.player.frameList.getImage(s.target.currentTime,!0);this._previewImage.src!=r.url&&(this._previewImage.src=r.url,this._previewImage.onload=()=>i())}),window.addEventListener("resize",s=>i()),i(),this._ready=!0}},Wu=class extends Gi{getPluginModuleInstance(){return Ki.Get()}get name(){return super.name||"es.upv.paella.audioVideoFormat"}get streamType(){return"audio"}async isCompatible(t){return t.sources.audio!=null}async getVideoInstance(t,e){return new Ku(this.player,t,e)}getCompatibleFileExtensions(){return["m4a","mp3"]}getManifestData(t){return{audio:t.map(e=>({src:e}))}}},Sa=class extends dn{constructor(t,e,i,s){super("video",t,e),this._config=s||{};const r=this._config.crossOrigin??"";this.element.setAttribute("playsinline",""),r!==!1&&this.element.setAttribute("crossorigin",r),this.isMainAudio=i,this.element.setAttribute("autoplay",""),this.element.autoplay=!0,i||(this.element.muted=!0),this._videoEnabled=!0}async play(){if(this._videoEnabled)try{return await this.waitForLoaded(),this.video.play()}catch{}else this._disabledProperties.paused=!1}async pause(){if(this._videoEnabled)return await this.waitForLoaded(),this.video.pause();this._disabledProperties.paused=!0}async duration(){return this._videoEnabled?(await this.waitForLoaded(),this.video.duration):this._disabledProperties.duration}get currentTimeSync(){return this._videoEnabled?this.ready?this.video.currentTime:-1:this._disabledProperties.currentTime}async currentTime(){return this._videoEnabled?(await this.waitForLoaded(),this.currentTimeSync):this._disabledProperties.currentTime}async setCurrentTime(t){return this._videoEnabled?(await this.waitForLoaded(),this.video.currentTime=t):(this._disabledProperties.currentTime=t,t)}async volume(){return this._videoEnabled?(await this.waitForLoaded(),this.video.volume):this._disabledProperties.volume}async setVolume(t){return this._videoEnabled?(await this.waitForLoaded(),t===0?this.video.setAttribute("muted",""):this.video.removeAttribute("muted"),this.video.volume=t):(this._disabledProperties.volume=t,t)}async paused(){return this._videoEnabled?(await this.waitForLoaded(),this.video.paused):this._disabledProperties.paused}async playbackRate(){return this._videoEnabled?(await this.waitForLoaded(),await this.video.playbackRate):this._disabledProperties.playbackRate}async setPlaybackRate(t){return this._videoEnabled?(await this.waitForLoaded(),this.video.playbackRate=t):(this._disabledProperties.playbackRate=t,t)}async getQualities(){}async setQuality(){}get currentQuality(){return 0}async getDimensions(){return this._videoEnabled?(await this.waitForLoaded(),{w:this.video.videoWidth,h:this.video.videoHeight}):{w:this._disabledProperties.videoWidth,h:this._disabledProperties.videoHeight}}saveDisabledProperties(t){this._disabledProperties={duration:t.duration,volume:t.volume,videoWidth:t.videoWidth,videoHeight:t.videoHeight,playbackRate:t.playbackRate,paused:t.paused,currentTime:t.currentTime}}async loadStreamData(t=null){this._streamData=this._streamData||t,this.player.log.debug("es.upv.paella.htmlVideoFormat: loadStreamData"),this._sources=t.sources.html,this._currentQuality=0,this.isMainAudioPlayer||(this.video.muted=!0),this._sources.forEach(({src:e,mimetype:i})=>{e=ye(this.player,e);const s=document.createElement("source");s.src=e,s.type=i,this.video.appendChild(s)}),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback);try{await this.video.play()}catch{}await this.waitForLoaded(),this.player.log.debug(`es.upv.paella.htmlVideoFormat (${this.streamData.content}): video loaded and ready.`),this.saveDisabledProperties(this.video)}async clearStreamData(){this.video.src="",this.video.removeEventListener("ended",this._endedCallback),this.video.removeEventListener("loadeddata",this._handleLoadedCallback),this._ready=!1}get isEnabled(){return this._videoEnabled}async enable(){this._videoEnabled=!0}async disable(){return this.isMainAudio?this.player.log.debug("video.disable() - the video is not disabled because it is the main audio source."):this._videoEnabled=!1,this._videoEnabled}waitForLoaded(){return new Promise((t,e)=>{this.video.readyState>=2&&(this._ready=!0),this.ready?t():(this._handleLoadedCallback=i=>{this.video.readyState>=2&&(this.video.pause(),this._ready=!0,t())},this.video.addEventListener("loadeddata",this._handleLoadedCallback))})}},zu=class extends Gi{getPluginModuleInstance(){return Ki.Get()}get name(){return super.name||"es.upv.paella.htmlVideoFormat"}get streamType(){return"html"}async isCompatible(t){const{html:e}=t.sources;return e&&e.some(i=>La(i.mimetype))}async getVideoInstance(t,e){return new Sa(this.player,t,e,this.config)}getCompatibleFileExtensions(){return["m4v","mp4","ogg","webm","ogv"]}getManifestData(t){const e=i=>{switch(ya(i)){case"mp4":case"m4v":return"video/mp4";case"webm":return"video/webm";case"ogg":case"ogv":return"video/ogg";default:return null}};return{html:t.map(i=>({src:i,mimetype:e(i)}))}}},Yu=class{constructor({label:t,shortLabel:e,isAuto:i=!1,index:s=0,src:r="",width:a=-1,height:o=-1,bitrate:l=-1}){this._label=t,this._shortLabel=e,this._index=s,this._src=r,this._res={w:a,h:o},this._bitrate=l,this._isAuto=i}get label(){return this._label}get shortLabel(){return this._shortLabel}get index(){return this._index}get src(){return this._src}get res(){return this._res}get bitrate(){return this._bitrate}get isAuto(){return this._isAuto}get quality(){return this._res.w!==-1&&this._res.h!==-1?this._res.w*this._res.h:this._bitrate}compare(t){return t.quality-this.quality}};function wa(n){let t=this._currentSource.frames[0];this._currentSource.frames.some(e=>{if(e.time<=this._currentTime)t=e;else return!0}),this.img.src=t.src}function ju(){this._startTimestamp=Date.now();const n=()=>{this._timer=setTimeout(n,250);const t=Date.now(),e=t-this._startTimestamp;this._currentTime+=e/1e3,this._startTimestamp=t,wa.apply(this,[this._currentTime])};n()}function qu(){this._timer&&(clearTimeout(this._timer),this._timer=null)}let Zu=class extends dn{constructor(t,e){super("img",t,e),this._currentTime=0,this._startTimesamp=0,this._playbackRate=1,this._timer=null,this.video=this.domElement}async play(){ju.apply(this)}async pause(){qu.apply(this)}async duration(){return this._currentSource.duration}get currentTimeSync(){return this._currentTime}async currentTime(){return this._currentTime}async setCurrentTime(t){this._currentTime=t,wa.apply(this,[t])}async volume(){return 0}async setVolume(t){}async paused(){return this._timer===null}async playbackRate(){return this._playbackRate}async setPlaybackRate(t){this._playbackRate=t}async getQualities(){return this._qualities}async setQuality(){}get currentQuality(){return this._currentQuality}async getDimensions(){return this._currentSource.res}async loadStreamData(t){return this._sources=t.sources.image,this._qualities=this._sources.map(e=>new Yu({src:e.frames[0].src,label:`${e.res.w}x${e.res.h}`,shortLabel:`${e.res.h}p`,width:e.res.w,height:e.res.h})),this._currentQuality=this._qualities.length-1,this._qualities.forEach((e,i)=>{this._qualities[this._currentQuality].compare(e)>0&&(this._currentQuality=i)}),this._currentSource=this._sources[this._currentQuality],this._sources.forEach(e=>{e.frames.sort((i,s)=>i.time-s.time)}),!0}},Qu=class extends Gi{getPluginModuleInstance(){return Ki.Get()}get name(){return super.name||"es.upv.paella.imageVideoFormat"}get streamType(){return"image"}async isCompatible(t){return t.sources.image!=null}async getVideoInstance(t,e){return new Zu(this.player,t,this.config,e)}},Xu=class extends Sa{constructor(t,e,i,s){super(t,e,i,s)}async loadStreamData(t=null){this._streamData=this._streamData||t,this.player.log.debug("es.upv.paella.mp4VideoFormat: loadStreamData"),this._currentSource||(this._sources=null,this._currentQuality=0,this._sources=t.sources.mp4,this._sources.sort((e,i)=>Number(e.res.w)-Number(i.res.w)),this._currentQuality=this._sources.length-1,this._currentSource=this._sources[this._currentQuality]),this.isMainAudioPlayer||(this.video.muted=!0),this._initialVolume&&(this.video.volume=this._initialVolume,this._initialVolume===0&&(this.video.muted=!0)),this.video.src=ye(this.player,this._currentSource.src),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback);try{await this.video.play()}catch{}await this.waitForLoaded(),this.player.log.debug(`es.upv.paella.mp4VideoFormat (${this.streamData.content}): video loaded and ready.`),this.saveDisabledProperties(this.video)}},Ju=class extends Gi{getPluginModuleInstance(){return Ki.Get()}get name(){return super.name||"es.upv.paella.mp4VideoFormat"}get streamType(){return"mp4"}isCompatible(t){var e;const{mp4:i}=t.sources;return i&&La((e=i[0])==null?void 0:e.mimetype)}async getVideoInstance(t,e){return new Xu(this.player,t,e,this.config)}getCompatibleFileExtensions(){return["m4v","mp4"]}getManifestData(t){return{mp4:t.map(e=>({src:e,mimetype:"video/mp4"}))}}};async function td(n){const t=[];await Kt(n,"captions",async e=>{t.push(e)});for(let e in t){const i=await t[e].getCaptions(),s=n.captionsCanvas;i.forEach(r=>s.addCaptions(r))}}let Ia=class extends di{get type(){return"captions"}async load(){this.player.log.debug("load captions plugin")}async getCaptions(){return this.player.log.warn(`CaptionsPlugin ${this.name}: getCaptions() is not implemented.`),[]}},Aa=class{get cues(){return this._cues}get label(){return this._label}get language(){return this._lang}set label(t){this._label=t}set language(t){this._lang=t}constructor(t="",e=""){this._cues=[],this._label=t,this._lang=e}addCue({label:t="",start:e,end:i,captions:s}){const r={label:t};if(typeof s=="string")r.captions=[s];else if(Array.isArray(s))r.captions=s;else throw Error("Invalid cue caption format: must be an array of strings or a string");if(typeof e=="string")r.start=cn(e),r.startString=e;else if(typeof e=="number")r.start=e,r.startString=Ke(e);else throw Error("Invalid cue timestamp format: must be a valid time string or a number of seconds");if(typeof i=="string")r.end=cn(i),r.endString=i;else if(typeof i=="number")r.end=i,r.endString=Ke(i);else throw Error("Invalid cue timestamp format: must be a valid time string or a number of seconds");return this._cues.push(r),r}getCue(t){if(typeof t=="string")t=cn(t);else if(typeof t!="number")throw Error("Invalid time instant format getting cue");let e=null;return this._cues.some(i=>{if(t>=i.start&&t<=i.end)return e=i,!0}),e}};function Ra(n,t){const e={},i=new DOMParser().parseFromString(t,"text/xml");return Array.from(i.getElementsByTagName("div")).forEach(s=>{const r=s.getAttribute("xml:lang")||"unknonw";e[r]=e[r]||new Aa(n.translate(r),r),Array.from(s.getElementsByTagName("p")).forEach(a=>{const o=Ea(a.getAttribute("begin"));e[r].addCue({label:`caption_${a.getAttribute("xml:id")||o}`,start:o/1e3,end:Ea(a.getAttribute("end"))/1e3,captions:a.innerHTML})})}),e}let ed=class{constructor(t,e=""){this.player=t,this._text=e,this._captions=Ra(this.player,e)}get text(){return this._text}set text(t){this._text=t,this._captions=Ra(t)}get captions(){return this._captions}},gn=null,Wi=class qc extends Hi{static Get(){return gn||(gn=new qc),gn}get moduleName(){return"paella-core default plugins"}get moduleVersion(){return fi.version}},id=class extends Ia{getPluginModuleInstance(){return Wi.Get()}get name(){return super.name||"es.upv.paella.dfxpManifestCaptionsPlugin"}async isEnabled(){return await super.isEnabled()&&this.player.videoManifest.captions&&this.player.videoManifest.captions.length>0}async getCaptions(){const t=[],e=[];return this.player.videoManifest.captions.forEach(i=>{e.push(new Promise(async(s,r)=>{if(/dfxp/i.test(i.format)){const a=ye(this.player,i.url),o=await fetch(a);if(o.ok){let l=await o.text();l=l.replace(/[^\x09\x0A\x0D\x20-\xFF\x85\xA0-\uD7FF\uE000-\uFDCF\uFDE0-\uFFFD]/gm,""),l=l.replace(/&\w+;/gmi,""),l=l.replaceAll("<br>","");const h=new ed(this.player,l);Object.entries(h.captions).forEach(([c,u])=>{t.push(u)}),s()}else r()}else r()}))}),await Promise.allSettled(e),t}},ka=class extends di{constructor(t,e,i){super(t,e,i),this.__uiPlugin=!0}async getDictionaries(){return null}},pn="en",Da="";const Ye={};function Pa(n){const t=Ye[pn]||{},e=Ye[Da]||{};return t[n]||e[n]||n}function xa(n){pn=n}function Ma(){return pn}function Oa(n,t){Ye[n]=Ye[n]||{};for(const e in t){const i=t[e];Ye[n][e]=i}}function $a(){return Ye}function Na(n){return n.config.defaultLanguage||navigator.language}let Fa=Pa,Ua=xa,Ba=Ma,Ga=Oa,Va=$a,Ha=Na;function gi(n,t=null){const e=Fa(n);if(Array.isArray(t)){let i=e;return t.forEach((s,r)=>{const a=`$${r+1}`;i=i.replace(a,s)}),i}else return e}function Ka(n){Ua(n)}function sd(){return Ba()}function pi(n,t){Ga(n,t)}function nd(){return Va()}function Wa(n){return Ha(n)}function rd(n){Fa=n}function ad(n){Ua=n}function od(n){Ba=n}function ld(n){Ga=n}function hd(n){Va=n}function cd(n){Ha=n}function ud(n){Da=Wa(n)}async function zi(n,t){var e,i;const s=Z("<li></li>",t);s.plugin=n;const r=gi(n.ariaLabel),a=gi(n.description),o=n.dynamicWidth?"dynamic-width":"fixed-width",l=n.id?`id="${n.id}" `:"",h=n.buttonName?`name="${n.buttonName}" `:"",c=n.tabIndex?` tabindex="${n.tabIndex}" `:"";if(n.interactive){const u=Z(`
			<button type="button" ${l}${h}class="${o}"${c}aria-label="${r}" title="${a}">
			</button>
		`,s);n.className!==""&&u.classList.add(n.className),n._button=u,n._container=s,u._pluginData=n,s._pluginData=n,u.addEventListener("click",y=>{const v=u._pluginData;et(v.player,V.BUTTON_PRESS,{plugin:v}),v.action(y,null),y.stopPropagation(),y.pageX!==0&&y.pageY!==0&&document.activeElement.blur()});let d=null;const g=()=>{d&&(clearTimeout(d),d=null)},f=()=>{g(),d=setTimeout(()=>{n.leftSideContainerPresent&&n.leftSideContainer.classList.add("hidden"),n.rightSideContainerPresent&&n.rightSideContainer.classList.add("hidden"),d=null},300)},p=()=>{g(),n.leftSideContainerPresent&&n.leftSideContainer.classList.remove("hidden"),n.rightSideContainerPresent&&n.rightSideContainer.classList.remove("hidden")};u.addEventListener("focus",p),u.addEventListener("mouseover",p),u.addEventListener("mouseout",f),u.addEventListener("blur",f),((e=n.player.config.accessibility)==null?void 0:e.clickWithSpacebar)===void 0||(i=n.player.config.accessibility)!=null&&i.clickWithSpacebar||(u.addEventListener("keyup",y=>{y.keyCode==32&&y.preventDefault()}),u.addEventListener("keydown",y=>{y.keyCode==32&&y.preventDefault()})),n.className!==""&&u.classList.add(n.className)}else{const u=Z(`
			<div ${l}${h} class="non-interactive ${o}" title="${a}">
			</div>
		`,s);n._button=u,n._container=s,u._pluginData=n,s._pluginData=n,n.className!==""&&u.classList.add(n.className)}}const za=()=>{const n=document.createElement("span");return n.classList.add("side-container"),n.classList.add("hidden"),n};let dd=class{onIconChanged(t,e,i){}onTitleChanged(t,e,i){}onStateChanged(t,e,i,s,r){}};var Yi,mn,ve,Ee,ji;let yn=class extends ka{constructor(){super(...arguments),at(this,Yi),at(this,ve,null),at(this,Ee,null),at(this,ji,[])}get type(){return"button"}get container(){return this._container}get button(){return this._button}get interactive(){return!0}get dynamicWidth(){return!1}getId(){return null}get id(){return this.config.id||this.getId()}getButtonName(){return null}get buttonName(){return this.config.name||this.getButtonName()||this.name}get ariaLabel(){return this.config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return null}getDescription(){return""}get description(){return this.config.description||this.getDescription()}get minContainerSize(){return this.config.minContainerSize||this.getMinContainerSize()}getMinContainerSize(){return 0}setObserver(t){if(t instanceof dd)this._observer=t;else if(typeof t.onIconChanged=="function"||typeof t.onTitleChanged=="function"||typeof t.onStateChanged=="function")this._observer=t;else throw new Error("Invalid observer for ButtonPlugin")}get icon(){return this._icon||(this._icon=""),this._icon}set icon(t){typeof t=="string"&&(t=_a(t)),this._icon=t,pa(this,Yi,mn).call(this)}get haveIcon(){return this.icon!==""}get menuIcon(){return this._menuIcon||(this._menuIcon=""),this._menuIcon}set menuIcon(t){typeof t=="string"&&(t=_a(t)),this._menuIcon=t,pa(this,Yi,mn).call(this)}get haveMenuIcon(){return this.menuIcon!==""}get isMenuButton(){var t,e,i;const s=((t=this.config)==null?void 0:t.parentContainer)==="playbackBar"||!((e=this.config)!=null&&e.parentContainer),r=((i=this.config)==null?void 0:i.parentContainer)==="videoContainer";return!s&&!r}get title(){return this._title||""}set title(t){var e;if(this._title=t,t&&this._button instanceof HTMLElement){const i=this._button.querySelector("span")||Z(`<span class="button-title-${this.titleSize}"></span>`,this._button);i.innerHTML=t}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("span");i&&this._button.removeChild(i)}(e=this._observer)!=null&&e.onTitleChanged&&this._observer.onTitleChanged(this,this._title,t)}get titleSize(){return"medium"}get side(){var t;return((t=this.config)==null?void 0:t.side)||"left"}get closePopUps(){return this.config.closePopUps||this.getClosePopUps()}getClosePopUps(){return!0}get parentContainer(){var t;return((t=this.config)==null?void 0:t.parentContainer)||"playbackBar"}get className(){return""}enable(){this._enabled=!0,this.show()}disable(){this._enabled=!1,this.hide()}hide(){this._button&&(this._button.style.display="none")}show(){if(this._enabled===!1)return;const{width:t}=this.player.playbackBar.containerSize;this._button&&(t>this.minContainerSize||this.parentContainer!=="playbackBar")&&(this._button.style.display=null)}get leftSideContainer(){return O(this,ve)||(ht(this,ve,za()),this.container.appendChild(O(this,ve))),O(this,ve)}get leftSideContainerPresent(){return O(this,ve)!==null}get rightSideContainer(){return O(this,Ee)||(ht(this,Ee,za()),this.container.appendChild(O(this,Ee))),O(this,Ee)}get rightSideContainerPresent(){return O(this,Ee)!==null}get stateText(){return null}get stateIcon(){return null}setState({text:t=null,icon:e=null}={}){var i,s;const r=this._statusText,a=this._statusIcon;this._statusText=t,this._statusIcon=e,O(this,ji).forEach(o=>o(this)),this._statusIcon&&(this.icon=this._statusIcon,this.menuIcon=this._statusIcon),this._statusText&&(this.title=this._statusText),(s=(i=this._observer)==null?void 0:i.onStateChanged)==null||s.call(i,this,r,t,a,e)}onStateChange(t){typeof t=="function"?O(this,ji).push(t):this.player.log.warn("Invalid callback for ButtonPlugin.onStateChange")}async action(t,e=null){}onResize({width:t,height:e}){t<this.minContainerSize?this.hide():this.show()}focus(){var t;(t=this.button)==null||t.focus()}blur(){var t;(t=this.button)==null||t.blur()}isFocus(){return this.button===document.activeElement}};Yi=new WeakSet,mn=function(){var n;const t=this.isMenuButton?this._menuIcon:this._icon,e=this.isMenuButton&&this.haveMenuIcon?this.menuIcon:this.icon;if(e&&this._button instanceof HTMLElement){const i=this._button.querySelector("i")||Z("<i></i>",this._button);i.innerHTML=e}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("i");i&&this._button.removeChild(i)}(n=this._observer)!=null&&n.onIconChanged&&this._observer.onIconChanged(this,t,e)},ve=new WeakMap,Ee=new WeakMap,ji=new WeakMap;const fd=`<svg width="100%"
    height="100%" viewBox="0 0 24 24"
    style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g id="play">
        <path
            d="M19.662,11.155C19.952,11.338 20.128,11.657 20.128,12C20.128,12.343 19.952,12.662 19.662,12.845C16.249,15 7.228,20.698 3.572,23.007C3.257,23.206 2.857,23.218 2.53,23.038C2.203,22.858 2,22.514 2,22.14C2,17.638 2,6.199 2,1.78C2,1.423 2.194,1.094 2.508,0.921C2.821,0.748 3.203,0.76 3.505,0.951C7.117,3.232 16.228,8.986 19.662,11.155Z" />
    </g>
</svg>
`,gd=`<svg width="100%"
    height="100%" viewBox="0 0 26 24"
    style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <path
        d="M10,1.353L10,20.647C10,21.394 9.394,22 8.647,22L1.353,22C0.606,22 0,21.394 0,20.647L0,1.353C0,0.606 0.606,0 1.353,0L8.647,0C9.394,0 10,0.606 10,1.353Z" />
    <path
        d="M24,1.353L24,20.647C24,21.394 23.394,22 22.647,22L15.353,22C14.606,22 14,21.394 14,20.647L14,1.353C14,0.606 14.606,0 15.353,0L22.647,0C23.394,0 24,0.606 24,1.353Z" />
</svg>`,pd=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 42" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(1.94013e-16,0.689169,-0.784942,2.23746e-16,110.436,-203.562)">
        <g id="play">
            <path d="M304.588,115.214C304.588,105.205 313.901,97.079 325.373,97.079C336.844,97.079 346.157,105.205 346.157,115.214C346.157,125.223 336.844,133.349 325.373,133.349L325.373,128.287C333.642,128.287 340.356,122.43 340.356,115.214C340.356,107.999 333.642,102.141 325.373,102.141C317.103,102.141 310.39,107.999 310.39,115.214L304.588,115.214Z"/>
            <g transform="matrix(-2.33361,-6.00363e-16,1.21708e-15,-2.59724,320.246,134.358)">
                <path d="M5.454,3.35L9.398,7.505L1.511,7.505L5.454,3.35Z"/>
            </g>
        </g>
    </g>
</svg>
`;let md=class extends yn{getPluginModuleInstance(){return Wi.Get()}get name(){return super.name||"es.upv.paella.playPauseButton"}async load(){const t=this.player.getCustomPluginIcon(this.name,"play")||fd,e=this.player.getCustomPluginIcon(this.name,"pause")||gd,i=this.player.getCustomPluginIcon(this.name,"replay")||pd;this.icon=t,this.player.translate(this.config.ariaLabelPause||"pause");const s=this.player.translate(this.config.ariaLabelPlay||"play");bt(this.player,V.PLAY,()=>{this.icon=e,this.button.ariaLabel=s,this.button.title=this.config.ariaLabelPause||s}),bt(this.player,V.PAUSE,()=>{this.icon=t,this.button.ariaLabel=s,this.button.title=this.config.ariaLabelPause||s}),bt(this.player,V.ENDED,()=>{this.icon=i,this.button.ariaLabel=s,this.button.title=this.config.ariaLabelPause||s}),bt(this.player,V.STOP,()=>{this.icon=t,this.button.ariaLabel=s,this.button.title=this.config.ariaLabelPause||s})}async action(){await this.player.paused()?await this.player.videoContainer.play():await this.player.videoContainer.pause()}};const Ya="(?:\\d*:){1,2}\\d*(?:\\.\\d+)?",yd=`(${Ya})\\s*\\-\\->\\s*(${Ya})`,vd={cueTiming:new RegExp(yd)},Ed=(n,t,e,i)=>{const s=vd.cueTiming.exec(t);if(s){const r=i[e-1],a=[];for(let o=1;e+o<i.length&&i[e+o]!=="";++o)a.push(i[e+o]);n.addCue({label:r,start:s[1],end:s[2],captions:a})}};function ja(n){const t=new Aa;return n!==""&&(n=n.replace(/\r\n/gm,`
`),n=n.replace(/\r/gm,`
`),n.split(/\n/).forEach((e,i,s)=>{Ed(t,e,i,s)})),t}let Td=class{constructor(t=""){this._text=t,this._captions=ja(t)}get text(){return this._text}set text(t){this._text=t,this._captions=ja(t)}get captions(){return this._captions}},_d=class extends Ia{getPluginModuleInstance(){return Wi.Get()}get name(){return super.name||"es.upv.paella.vttManifestCaptionsPlugin"}async isEnabled(){return await super.isEnabled()&&this.player.videoManifest.captions&&this.player.videoManifest.captions.length>0}async getCaptions(){const t=[],e=[];return this.player.videoManifest.captions.forEach(i=>{e.push(new Promise(async(s,r)=>{if(/vtt/i.test(i.format)){const a=ye(this.player,i.url),o=await fetch(a);if(o.ok){const l=await o.text(),h=new Td(l);h.captions.label=i.text,h.captions.language=i.lang,t.push(h.captions),s()}else r()}else r()}))}),await Promise.allSettled(e),t}},Ld=class extends yn{getPluginModuleInstance(){return Wi.Get()}get name(){return"es.upv.paella.currentTimeLabel"}async load(){this.title=Ke(0);const t=async()=>{const e=await this.player.videoContainer.currentTime();let i=Ke(e);if(this.config.showTotalTime){const s=await this.player.videoContainer.duration();i+=` / ${Ke(s)}`}this.title=i};this.player.bindEvent(V.TIMEUPDATE,()=>t()),this.player.bindEvent(V.TRIMMING_CHANGED,()=>t()),this.player.bindEvent(V.SEEK,()=>t())}get interactive(){return!1}get dynamicWidth(){return!0}};function qi(n,t){return oo(n,"layout").filter(e=>e.config&&e.config.enabled&&e.canApply(t))}function qa(n,t){const e=qi(n,t),i=[];return e.forEach(s=>{i.push(...s.getValidContentIds(t))}),i}function Cd(n,t){const e=[];return oo(n,"layout").filter(i=>{var s,r;if((s=i.config)!=null&&s.enabled&&(r=i.config)!=null&&r.validContent)return i.config.validContent.every(a=>a.content.length===t)}).forEach(i=>i.config.validContent.forEach(s=>e.push(s.content))),e}function Za(n,t,e){const i=qi(n,t);let s=null;return i.some(r=>{if(r.getValidContentIds(t).indexOf(e)!==-1)return s=r,!0}),s}function bd(n,t){const e=qi(n,t),i=qa(n,t);let s=[];return e.forEach(r=>{s=[...s,...r.config.validContent]}),s.filter(r=>i.indexOf(r.id)!==-1)}function Qa(n,t,e,i=null){const s=Za(n,t,e);if(s){const r=s.getLayoutStructure(t,e,i);return r.plugin=s,r}return null}let je=class extends ka{get type(){return"layout"}get layoutType(){return"static"}getTabIndexStart(){return 10}get tabIndexStart(){var t;return((t=this.config)==null?void 0:t.tabIndexStart)||this.getTabIndexStart()}get identifier(){return"default"}get icon(){return"icon.png"}get validContent(){var t;return((t=this.config)==null?void 0:t.validContent)||[]}get validContentIds(){const t=[];return this.validContent.forEach(e=>t.push(e.id)),t}getValidContentIds(t){const e=[];return this.validContent.forEach(i=>{i.content.every(s=>t.some(r=>s===r.content))&&e.push(i.id)}),e}getValidStreams(t){const e=[];return this.validContent.forEach(i=>{let s=[];i.content.every(r=>t.some(a=>{if(r===a.content)return s.push(a),!0}))&&e.push(s)}),e}canApply(t){return this.getValidStreams(t).length>0}getLayoutStructure(){return{}}getVideoCanvasButtons(t,e,i){return[]}};function Sd(n){return{icon:n.icon,position:n.position,title:n.description,ariaLabel:n.ariaLabel,name:n.buttonName,click:async t=>{const e=n.player.videoContainer.streamProvider.streams[t];await n.action(t,e==null?void 0:e.player,e==null?void 0:e.canvas,e==null?void 0:e.canvasPlugin)}}}async function wd(n,t){const e=[];return await Kt(n,"canvasButton",async i=>{n.log.debug(` Canvas button plugin: ${i.name}`),e.push(i)}),e.filter(i=>i.content.indexOf(t.content)!==-1).map(i=>Sd(i))}const vn=[];async function Id(n){await Kt(n,"canvas",t=>{vn.push(t)})}async function Ad(n){}function Rd(n,t){if(vn.length===0)throw Error("No canvas plugins loaded. Note that `loadCanvasPlugins()` must to be called before use `getCanvasPlugins()`");let e=null;return vn.some(i=>{if(i.isCompatible(t))return e=i,!0}),e}const rt=Object.freeze({LEFT:"left",CENTER:"center",RIGHT:"right"}),kd=function({icon:n,tabIndex:t,ariaLabel:e,title:i,className:s,position:r=rt.CENTER,click:a,content:o,name:l}){if(!n)throw new Error("Error in video layout definition. getVideoCanvasButtons(): missing 'icon' attribute.");if(!a)throw new Error("Error in video layout definition. getVideoCanvasButtons(): missing 'click' function.");let h=`class="align-${r}${s?" "+s:""}"`;e&&(h+=` aria-label="${e}"`),i&&(h+=` title="${i}"`),t!==void 0&&(h+=` tabindex="${t}"`),l!==void 0&&(h+=` name="${l}"`);const c=Z(`
        <button ${h}><i class="button-icon" style="pointer-events: none">${n}</i></button>
    `);return this.buttonsArea.appendChild(c),c.addEventListener("click",async u=>(u.stopPropagation(),await a(o),!1)),c},En=async(n,t,e,i,s)=>{const r=t.plugin;let a=r.tabIndexStart;const o=await wd(n,i),l=[];return[...o,...r.getVideoCanvasButtons(t,i.content,i,e)].forEach(h=>{h.tabIndex=a++,h.content=s;const c=kd.apply(e,[h]);l.push(c)}),l},Tn=(n,t,e)=>{let{tabIndexStart:i}=t.plugin;e.sort((s,r)=>{const a=s.getBoundingClientRect().left,o=r.getBoundingClientRect().left;return a-o}).forEach(s=>{s.setAttribute("tabindex",i++)})};let Xa=class extends se{constructor(t,e,i){super(e,{tag:t,parent:i}),this.element.className="video-canvas",this._userArea=null,this._buttonsArea=Z(`
        <div class="button-area">
        </div>
        `,this.element)}async loadCanvas(t){throw Error(`${this.name}: loadCanvas() not implemented`)}get userArea(){return this._userArea||(this._userArea=document.createElement("div"),this._userArea.className="user-area",this.element.appendChild(this._userArea)),this._userArea}get buttonsArea(){return this._buttonsArea}showButtons(){this.buttonsArea.style.display=null}hideButtons(){this.buttonsArea.style.display="none"}},Ja=class extends di{get type(){return"canvas"}get canvasType(){return""}isCompatible(t){return Array.isArray(t==null?void 0:t.canvas)?t.canvas.indexOf(this.canvasType)!==-1:t.canvas===this.canvasType}getCanvasInstance(t){throw Error(`${this.name} canvas plugin: getCanvasInstance() not implemented`)}},_n=null,qe=class Zc extends Hi{static Get(){return _n||(_n=new Zc),_n}get moduleName(){return"paella-core default video layouts"}get moduleVersion(){return fi.version}};const Ln=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(0.920758,0,0,0.920758,2.50561,1.21236)">
        <path d="M11.937,17.699L11.937,21.044C11.937,21.656 11.573,22.209 11.012,22.451C10.45,22.693 9.798,22.578 9.354,22.158L1.874,15.1C1.568,14.811 1.394,14.408 1.394,13.986C1.394,13.564 1.568,13.161 1.874,12.872L9.354,5.814C9.798,5.394 10.45,5.279 11.012,5.521C11.573,5.763 11.937,6.316 11.937,6.928L11.937,10.272L22.937,10.272C23.783,10.272 24.469,10.958 24.469,11.804L24.469,16.168C24.469,17.014 23.783,17.699 22.937,17.699L11.937,17.699ZM26.063,23.11L26.063,19.765C26.063,19.153 26.427,18.6 26.988,18.358C27.55,18.116 28.201,18.231 28.646,18.651L36.126,25.709C36.432,25.999 36.606,26.402 36.606,26.823C36.606,27.245 36.432,27.648 36.126,27.937L28.646,34.996C28.201,35.415 27.55,35.53 26.988,35.288C26.427,35.046 26.063,34.493 26.063,33.882L26.063,30.537L15.063,30.537C14.217,30.537 13.531,29.851 13.531,29.005L13.531,24.641C13.531,23.795 14.217,23.11 15.063,23.11L26.063,23.11Z"/>
    </g>
</svg>
`,Zi=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <path d="M-20.625,8.591C-20.625,6.174 -17.975,4.215 -14.704,4.215L31.492,4.215C34.763,4.215 37.413,6.174 37.413,8.591L37.413,35.582C37.413,37.998 34.763,39.957 31.492,39.957L-14.704,39.957C-17.975,39.957 -20.625,37.998 -20.625,35.582L-20.625,8.591ZM1.285,12.825L8.1,7.789L-15.786,7.789L-15.786,25.442L-8.972,20.406L6.737,32.016L16.994,24.435L1.285,12.825Z" />
    </g>
</svg>
`,mi=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(0.707107,0.707107,-0.707107,0.707107,20,-8.28427)">
        <path d="M23,17L23,4.998C23,4.203 22.684,3.44 22.122,2.878C21.56,2.316 20.797,2 20.002,2C20.001,2 19.999,2 19.998,2C19.203,2 18.44,2.316 17.878,2.878C17.316,3.44 17,4.203 17,4.998C17,9.375 17,17 17,17L4.998,17C4.203,17 3.44,17.316 2.878,17.878C2.316,18.44 2,19.203 2,19.998C2,19.999 2,20.001 2,20.002C2,20.797 2.316,21.56 2.878,22.122C3.44,22.684 4.203,23 4.998,23C9.375,23 17,23 17,23L17,35.002C17,35.797 17.316,36.56 17.878,37.122C18.44,37.684 19.203,38 19.998,38C19.999,38 20.001,38 20.002,38C20.797,38 21.56,37.684 22.122,37.122C22.684,36.56 23,35.797 23,35.002C23,30.625 23,23 23,23L35.002,23C35.797,23 36.56,22.684 37.122,22.122C37.684,21.56 38,20.797 38,20.002C38,20.001 38,19.999 38,19.998C38,19.203 37.684,18.44 37.122,17.878C36.56,17.316 35.797,17 35.002,17C30.625,17 23,17 23,17Z"/>
    </g>
</svg>`,yi=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g>
        <path d="M18,13.029L18,26.971C18,27.509 17.786,28.025 17.406,28.406C17.025,28.786 16.509,29 15.971,29L3.029,29C2.491,29 1.975,28.786 1.594,28.406C1.214,28.025 1,27.509 1,26.971L1,13.029C1,12.491 1.214,11.975 1.594,11.594C1.975,11.214 2.491,11 3.029,11L15.971,11C16.509,11 17.025,11.214 17.406,11.594C17.786,11.975 18,12.491 18,13.029ZM39,13.029L39,26.971C39,27.509 38.786,28.025 38.406,28.406C38.025,28.786 37.509,29 36.971,29L24.029,29C23.491,29 22.975,28.786 22.594,28.406C22.214,28.025 22,27.509 22,26.971L22,13.029C22,12.491 22.214,11.975 22.594,11.594C22.975,11.214 23.491,11 24.029,11L36.971,11C37.509,11 38.025,11.214 38.406,11.594C38.786,11.975 39,12.491 39,13.029ZM21,7L21,33L19,33L19,7L21,7Z"/>
    </g>
</svg>
`,Dd=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.61211,0,0,1.19142,40.6376,-0.550686)">
            <path d="M38.001,14.89L16.256,14.89C15.767,14.89 15.297,15.084 14.951,15.43C14.605,15.776 14.41,16.246 14.41,16.735C14.41,21.528 14.41,33.999 14.41,33.999L5.673,33.999C3.644,33.999 2,32.355 2,30.327L2,7.673C2,5.644 3.644,4 5.673,4L34.329,4C36.358,4 38.001,5.644 38.001,7.673L38.001,14.89Z"/>
        </g>
        <g transform="matrix(-1.62701,0,0,1.19712,41.1319,-0.602464)">
            <path d="M39.174,17.858C39.174,17.501 39.032,17.158 38.781,16.906C38.529,16.653 38.188,16.511 37.833,16.511C33.587,16.511 20.516,16.511 17.043,16.511C16.816,16.511 16.598,16.602 16.438,16.763C16.278,16.924 16.188,17.142 16.188,17.37C16.188,20.366 16.188,30.369 16.188,34.019C16.188,34.376 16.329,34.719 16.581,34.971C16.832,35.224 17.173,35.366 17.529,35.366C21.597,35.366 33.765,35.366 37.833,35.366C38.188,35.366 38.529,35.224 38.781,34.971C39.032,34.719 39.174,34.376 39.174,34.019C39.174,30.548 39.174,21.329 39.174,17.858Z"/>
        </g>
    </g>
</svg>
`;let to=class extends je{getPluginModuleInstance(){return qe.Get()}get name(){return super.name||"es.upv.paella.dualVideoDynamic"}get layoutType(){return"dynamic"}async load(){this.pipContentIds=this.config.pipContentIds||[],this.allowSwitchSide=this.config.allowSwitchSide!==void 0?this.config.allowSwitchSide:!0}getVideoCanvasButtons(t,e,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconMaximize")||Zi,a=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||yi,o=this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||Ln,l=this.player.getCustomPluginIcon(this.name,"iconClose")||mi,h=this.player.getCustomPluginIcon(this.name,"iconPiP")||Dd,c=()=>this._currentContent.find(f=>f.id===e),u=()=>c().size===25,d=()=>c().size>50,g=[];return u()||d()?g.push({icon:a,position:rt.LEFT,title:this.player.translate("Dual stream 50%"),ariaLabel:this.player.translate("Dual stream 50%"),name:this.name+":iconSideBySide",click:async()=>{this._currentContent.forEach(f=>{f.size=50}),await this.player.videoContainer.updateLayout()}}):g.push({icon:r,position:rt.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{this._currentContent.forEach(f=>{f.size=f.id===e?75:25}),await this.player.videoContainer.updateLayout()}}),this.allowSwitchSide&&g.push({icon:o,position:rt.LEFT,title:this.player.translate("Switch side"),ariaLabel:this.player.translate("Switch side"),name:this.name+":iconSwitchSide",click:async()=>{const f=this._currentContent[0].id,p=this._currentContent[1].id,y=this._currentContent[0].size,v=this._currentContent[1].size;this._currentContent[0].id=p,this._currentContent[0].size=v,this._currentContent[1].id=f,this._currentContent[1].size=y,await this.player.videoContainer.updateLayout()}}),g.push({icon:l,position:rt.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{const f=this.player.videoContainer.validContentIds.filter(p=>p.indexOf("-")===-1).find(p=>p!=e);await this.player.videoContainer.setLayout(f)}}),this.pipContentIds.length>0&&g.push({icon:h,position:rt.LEFT,title:this.player.translate("Picture-in-picture"),ariaLabel:this.player.translate("Picture-in-picture"),name:this.name+":iconPiP",click:async()=>{const f=this.player.videoContainer.validContentIds.find(p=>this.pipContentIds.indexOf(p)!==-1);await this.player.videoContainer.setLayout(f,e)}}),g}getLayoutStructure(t,e,i){if(!this._currentContent){const{content:s}=this.validContent.find(r=>r.id===e);this._currentContent=s.map(r=>({id:r,size:50}))}return{id:"dual-dynamic",videos:[{content:this._currentContent[0].id,visible:!0,size:this._currentContent[0].size},{content:this._currentContent[1].id,visible:!0,size:this._currentContent[1].size}]}}};const eo=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.50139,0,0,1.10483,39.8625,1.72153)">
            <path d="M22.034,28.802C22.58,28.752 23.089,28.64 23.626,28.496C28.793,27.112 31.864,21.792 30.48,16.625C30.189,15.54 29.715,14.525 29.088,13.619L31.915,8.722C33.663,10.535 34.942,12.776 35.606,15.251C37.748,23.248 32.996,31.48 24.999,33.622C24.011,33.887 23.04,34.063 22.034,34.123L22.034,40.015L13,31.5L22.034,23.015L22.034,28.802Z" />
        </g>
        <g transform="matrix(1.50139,1.35303e-16,1.83867e-16,-1.10483,-24.8768,44.5033)">
            <path d="M22.161,28.786C22.706,28.736 23.089,28.64 23.626,28.496C28.793,27.112 31.864,21.792 30.48,16.625C30.189,15.54 29.715,14.525 29.088,13.619L31.915,8.722C33.663,10.535 34.942,12.776 35.606,15.251C37.748,23.248 32.996,31.48 24.999,33.622C24.011,33.887 23.167,34.048 22.161,34.107L22.161,40L13,31.5L22.161,23L22.161,28.786Z" />
        </g>
    </g>
</svg>
`,Pd=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-0.620305,0,0,0.839332,25.2077,0.462208)">
        <g transform="matrix(-1.61211,0,0,1.25099,40.6376,0.938594)">
            <path d="M26,18.498C26,16.566 24.356,15 22.327,15C17.811,15 10.189,15 5.673,15C3.644,15 2,16.566 2,18.498C2,22.151 2,27.849 2,31.502C2,33.434 3.644,35 5.673,35C10.189,35 17.811,35 22.327,35C24.356,35 26,33.434 26,31.502C26,27.849 26,22.151 26,18.498Z" />
        </g>
        <path d="M-2.889,42.341L-16.002,42.341C-17.664,42.341 -19.01,41.345 -19.01,40.117L-19.01,11.346L-15.787,13.728L-15.787,36.879C-15.787,37.695 -15.348,38.478 -14.567,39.056C-13.785,39.633 -12.726,39.958 -11.621,39.958L-2.889,39.958L-2.889,42.341ZM30.962,18.512L30.962,8.485C30.962,7.669 30.523,6.886 29.741,6.308C28.96,5.731 27.9,5.406 26.795,5.406L-4.721,5.406L-7.945,3.024L31.181,3.024C32.842,3.024 34.189,4.019 34.189,5.247L34.189,18.512L30.962,18.512Z" />
        <g transform="matrix(-0.595969,-0.440448,-1.13993,0.842464,17.4661,11.4472)">
            <path d="M18.389,14.006L18.389,18L5,11L18.389,4L18.389,7.994L36,7.994L36,14.006L18.389,14.006Z" />
        </g>
    </g>
</svg>
`;let Ht=0;const Cn=[{id:"side-by-side",videos:[{content:null,rect:[{aspectRatio:"16/9",width:560,height:315,top:218,left:712},{aspectRatio:"16/10",width:560,height:350,top:206,left:712},{aspectRatio:"4/3",width:560,height:420,top:173,left:712},{aspectRatio:"5/3",width:560,height:336,top:206,left:712},{aspectRatio:"5/4",width:560,height:448,top:160,left:712}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",width:688,height:387,top:166,left:10},{aspectRatio:"16/10",width:688,height:430,top:148,left:10},{aspectRatio:"4/3",width:688,height:516,top:111,left:10},{aspectRatio:"5/3",width:690,height:414,top:154,left:10},{aspectRatio:"5/4",width:690,height:552,top:96,left:10}],visible:!0,layer:"1"}],buttons:[]},{id:"pip-left",videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:50,top:470,width:350,height:197},{aspectRatio:"16/10",left:50,top:448,width:350,height:219},{aspectRatio:"5/3",left:50,top:457,width:350,height:210},{aspectRatio:"5/4",left:50,top:387,width:350,height:280},{aspectRatio:"4/3",left:50,top:404,width:350,height:262}],visible:!0,layer:2}],buttons:[]},{id:"pip-right",videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:880,top:470,width:350,height:197},{aspectRatio:"16/10",left:880,top:448,width:350,height:219},{aspectRatio:"5/3",left:880,top:457,width:350,height:210},{aspectRatio:"5/4",left:880,top:387,width:350,height:280},{aspectRatio:"4/3",left:880,top:404,width:350,height:262}],visible:!0,layer:2}],buttons:[]}];function xd(n){return Ht=(Ht+1)%Cn.length,bn(n)}function vi(n,t){return Ht=t<Cn.length?t:Ht,bn(n)}function bn(n){let t=JSON.parse(JSON.stringify(Cn[Ht]));return t.videos[0].content=n[0],t.videos[1].content=n[1],t}let Md=class extends je{getPluginModuleInstance(){return qe.Get()}get name(){return super.name||"es.upv.paella.dualVideo"}get identifier(){return"dual-video"}async load(){let t=ui("dualVideoLayoutIndex");t!==""&&(Ht=Number(t)),this.player.log.debug("Dual video layout loaded")}getValidStreams(t){return super.getValidStreams(t).filter(e=>e.length===2)}switchContent(){const t=this._currentContent[0],e=this._currentContent[1];this._currentContent[0]=e,this._currentContent[1]=t,this.player.videoContainer.updateLayout()}async switchMinimized(){xd(this._currentContent),await this.player.videoContainer.updateLayout()}async minimizeVideo(t){let e=!0;if(t===this._currentContent[0]){const i=this._currentContent[0],s=this._currentContent[1];this._currentContent[0]=s,this._currentContent[1]=i,e=!1}Ht===1&&e?vi(this._currentContent,2):vi(this._currentContent,1),await this.player.videoContainer.updateLayout()}async maximizeVideo(t){let e=!0;if(t===this._currentContent[1]){const i=this._currentContent[0],s=this._currentContent[1];this._currentContent[0]=s,this._currentContent[1]=i,e=!1}Ht===1&&e?vi(this._currentContent,2):vi(this._currentContent,1),await this.player.videoContainer.updateLayout()}async setSideBySide(){vi(this._currentContent,0),await this.player.videoContainer.updateLayout()}get minimizedContent(){return Ht===0?"":this._currentContent[1]}async closeVideo(t){const e=this.player.videoContainer.validContentIds.filter(i=>i.indexOf("-")===-1).find(i=>i!=t);await this.player.videoContainer.setLayout(e)}getVideoCanvasButtons(t,e,i,s){if(t.id==="side-by-side")return[{icon:this.player.getCustomPluginIcon(this.name,"iconRotate")||eo,position:rt.LEFT,title:this.player.translate("Swap position of the videos"),ariaLabel:this.player.translate("Swap position of the videos"),name:this.name+":iconRotate",click:async()=>{await this.switchContent()}},{icon:this.player.getCustomPluginIcon(this.name,"iconMaximize")||Zi,position:rt.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{await this.maximizeVideo(e)}},{icon:this.player.getCustomPluginIcon(this.name,"iconClose")||mi,position:rt.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(e)}}];{const r=[];return e===this.minimizedContent?(r.push({icon:this.player.getCustomPluginIcon(this.name,"iconMaximize")||Zi,position:rt.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{await this.switchContent()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||Ln,position:rt.LEFT,title:this.player.translate("Place the video on the other side of the screen"),ariaLabel:this.player.translate("Place the video on the other side of the screen"),name:this.name+":iconSwitchSide",click:async()=>{await this.minimizeVideo(e)}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconClose")||mi,position:rt.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(e)}})):(r.push({icon:this.player.getCustomPluginIcon(this.name,"iconMinimize")||Pd,position:rt.LEFT,title:this.player.translate("Minimize video"),ariaLabel:this.player.translate("Minimize video"),name:this.name+":iconMinimize",click:async()=>{await this.switchContent()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconSideBySide")||yi,position:rt.LEFT,title:this.player.translate("Put the videos side by side"),ariaLabel:this.player.translate("Put the videos side by side"),name:this.name+":iconSideBySide",click:async()=>{await this.setSideBySide()}}),r.push({icon:this.player.getCustomPluginIcon(this.name,"iconClose")||mi,position:rt.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{await this.closeVideo(e)}})),r}}getLayoutStructure(t,e){if(!this._currentContent||this._currentContentId!==e){const{content:r}=this.validContent.find(l=>l.id===e);this._currentContent=r,this._currentContentId=e;const a=ui("dualVideoLayoutContent0"),o=ui("dualVideoLayoutContent1");a!==""&&o!==""&&this._currentContent.indexOf(a)!==-1&&this._currentContent.indexOf(o)!==-1&&(this._currentContent[0]=a,this._currentContent[1]=o)}const i=bn(this._currentContent),s={id:i.id,player:this.player,name:{es:"Dos streams con posición dinámica"},hidden:!1,videos:i.videos,buttons:[]};return We("dualVideoLayoutIndex",Ht),We("dualVideoLayoutContent0",this._currentContent[0]),We("dualVideoLayoutContent1",this._currentContent[1]),s}};const io={id:"pip-left",name:{es:"Dos streams imagen dentro de imagen"},hidden:!1,videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"9/16",left:617,top:17,width:386,height:687}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:50,top:470,width:350,height:197},{aspectRatio:"16/10",left:50,top:448,width:350,height:219},{aspectRatio:"5/3",left:50,top:457,width:350,height:210},{aspectRatio:"5/4",left:50,top:387,width:350,height:280},{aspectRatio:"4/3",left:50,top:404,width:350,height:262},{aspectRatio:"9/16",left:224,top:301,width:224,height:400}],visible:!0,layer:2}],buttons:[]},Od={id:"pip-right",name:{es:"Dos streams imagen dentro de imagen a la derecha"},hidden:!1,videos:[{content:null,rect:[{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"9/16",left:242,top:17,width:386,height:687}],visible:!0,layer:1},{content:null,rect:[{aspectRatio:"16/9",left:880,top:470,width:350,height:197},{aspectRatio:"16/10",left:880,top:448,width:350,height:219},{aspectRatio:"5/3",left:880,top:457,width:350,height:210},{aspectRatio:"5/4",left:880,top:387,width:350,height:280},{aspectRatio:"4/3",left:880,top:404,width:350,height:262},{aspectRatio:"9/16",left:887,top:304,width:224,height:400}],visible:!0,layer:2}],buttons:[]};let $d=class extends je{getPluginModuleInstance(){return qe.Get()}get name(){return super.name||"es.upv.paella.dualVideoPiP"}get identifier(){return"dual-video-pip"}async load(){this._currentLayout=io,this.dualVideoContentIds=this.config.dualVideoContentIds||[]}getValidStreams(t){return super.getValidStreams(t).filter(e=>e.length===2)}getVideoCanvasButtons(t,e,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconClose")||mi,a=this.player.getCustomPluginIcon(this.name,"iconSwitchSide")||Ln,o=this.player.getCustomPluginIcon(this.name,"iconMaximize")||Zi,l=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||yi,h=[{icon:r,position:rt.RIGHT,title:this.player.translate("Close video"),ariaLabel:this.player.translate("Close video"),name:this.name+":iconClose",click:async()=>{const c=this.player.videoContainer.validContentIds.filter(u=>u.indexOf("-")===-1).find(u=>u!==e);await this.player.videoContainer.setLayout(c)}}];return e===this._pipVideo?(h.push({icon:a,position:rt.LEFT,title:this.player.translate("Switch side"),ariaLabel:this.player.translate("Switch side"),name:this.name+":iconSwitchSide",click:async()=>{this.switchSide(),await this.player.videoContainer.updateLayout(this._fullVideo)}}),h.push({icon:o,position:rt.LEFT,title:this.player.translate("Maximize video"),ariaLabel:this.player.translate("Maximize video"),name:this.name+":iconMaximize",click:async()=>{this.switchSources(),await this.player.videoContainer.updateLayout(this._fullVideo)}})):this.dualVideoContentIds.length>0&&h.push({icon:l,position:rt.LEFT,title:this.player.translate("Set side by side"),ariaLabel:this.player.translate("Set side by side"),name:this.name+":iconSideBySide",click:async()=>{const c=this.player.videoContainer.validContentIds,u=this.dualVideoContentIds.find(d=>c.indexOf(d)!==-1);u&&this.player.videoContainer.setLayout(u)}}),h}switchSide(){this._currentLayout.id==="pip-left"?this._currentLayout=Od:this._currentLayout=io}switchSources(){const t=this._pipVideo;this._pipVideo=this._fullVideo,this._fullVideo=t}getLayoutStructure(t,e,i){const{content:s}=this.validContent.find(a=>a.id===e);i&&s.find(a=>a===i)?(this._fullVideo=i,this._pipVideo=s.find(a=>a!==i)):(!this._pipVideo||!this._fullVideo)&&(this._pipVideo=s[0],this._fullVideo=s[1]);const r=JSON.parse(JSON.stringify(this._currentLayout));return r.player=this.player,r.videos[0].content=this._fullVideo,r.videos[1].content=this._pipVideo,r}},Nd=class extends je{getPluginModuleInstance(){return qe.Get()}get name(){return super.name||"es.upv.paella.singleVideo"}get identifier(){return"single-video"}async load(){this.player.log.debug("Single video layout loaded"),this.dualVideoContentIds=this.config.dualVideoContentIds||["presenter-presentation-dynamic","presenter-2-presentation-dynamic","presenter-presenter-2-dynamic","presenter-presentation","presenter-2-presentation","presenter-presenter-2"]}getValidStreams(t){return super.getValidStreams(t).filter(e=>e.length===1)}getVideoCanvasButtons(t,e,i,s){return this._multiStream?[{icon:this.player.getCustomPluginIcon(this.name,"iconSideBySide")||yi,position:rt.LEFT,title:this.player.translate("Two videos 50%"),ariaLabel:this.player.translate("Two videos 50%"),name:this.name+":iconSideBySide",click:()=>{const r=this.player.videoContainer.validContentIds,a=this.dualVideoContentIds.find(o=>r.indexOf(o)!==-1);a&&this.player.videoContainer.setLayout(a)}}]:[]}getLayoutStructure(t,e){const i=this.validContent.find(r=>r.id===e),s={player:this.player,name:{es:"One stream"},hidden:!1,videos:[{content:i.content[0],rect:[{aspectRatio:"1/1",left:280,top:0,width:720,height:720},{aspectRatio:"6/5",left:208,top:0,width:864,height:720},{aspectRatio:"5/4",left:190,top:0,width:900,height:720},{aspectRatio:"4/3",left:160,top:0,width:960,height:720},{aspectRatio:"11/8",left:145,top:0,width:990,height:720},{aspectRatio:"1.41/1",left:132,top:0,width:1015,height:720},{aspectRatio:"1.43/1",left:125,top:0,width:1029,height:720},{aspectRatio:"3/2",left:100,top:0,width:1080,height:720},{aspectRatio:"16/10",left:64,top:0,width:1152,height:720},{aspectRatio:"5/3",left:40,top:0,width:1200,height:720},{aspectRatio:"16/9",left:0,top:0,width:1280,height:720},{aspectRatio:"1.85/1",left:0,top:14,width:1280,height:692},{aspectRatio:"2.35/1",left:0,top:87,width:1280,height:544},{aspectRatio:"2.41/1",left:0,top:94,width:1280,height:531},{aspectRatio:"2.76/1",left:0,top:128,width:1280,height:463}],visible:!0,layer:1}],background:{content:"slide_professor_paella.jpg",zIndex:5,rect:{left:0,top:0,width:1280,height:720},visible:!0,layer:0},logos:[{content:"paella_logo.png",zIndex:5,rect:{top:10,left:10,width:49,height:42}}],buttons:[],onApply:function(){}};return t.length>1&&(this._multiStream=!0),s}},Fd=class extends je{getPluginModuleInstance(){return qe.Get()}get name(){return super.name||"es.upv.paella.singleVideoDynamic"}get layoutType(){return"dynamic"}async load(){this.player.log.debug("Single video dynamic layout loaded"),this.dualVideoContentIds=this.config.dualVideoContentIds||["presenter-presentation-dynamic","presenter-2-presentation-dynamic","presenter-presenter-2-dynamic","presenter-presentation","presenter-2-presentation","presenter-presenter-2"]}getVideoCanvasButtons(t,e,i,s){const r=this.player.getCustomPluginIcon(this.name,"iconSideBySide")||yi,a=[];return this._multiStream&&a.push({icon:r,position:rt.LEFT,title:this.player.translate("Dual stream 50%"),ariaLabel:this.player.translate("Dual stream 50%"),name:this.name+":iconSideBySide",click:async()=>{const o=this.player.videoContainer.validContentIds,l=this.dualVideoContentIds.find(h=>o.indexOf(h)!==-1);l&&this.player.videoContainer.setLayout(l)}}),a}getLayoutStructure(t,e,i){t.length>1&&(this._multiStream=!0);const{content:s}=this.validContent.find(r=>r.id===e);return this._currentContent=s.map(r=>({id:r,size:50})),{id:"single-dynamic",videos:[{content:this._currentContent[0].id,visible:!0,size:this._currentContent[0].size}]}}};const Ud={videos:[{content:{},rect:[{aspectRatio:"16/9",left:239,top:17,width:803,height:451}],visible:!0,layer:1},{content:{},rect:[{aspectRatio:"16/9",left:44,top:482,width:389,height:218}],visible:!0,layer:1},{content:{},rect:[{aspectRatio:"16/9",left:847,top:482,width:389,height:218}],visible:!0,layer:1}],buttons:[{rect:{left:618,top:495,width:45,height:45},onClick:function(n){this.rotate()},label:"Rotate",icon:"icon_rotate.svg",layer:2}]};function Bd(n){let t=JSON.parse(JSON.stringify(Ud));return t.videos[0].content=n[0],t.videos[1].content=n[1],t.videos[2].content=n[2],t}let Gd=class extends je{getPluginModuleInstance(){return qe.Get()}get name(){return super.name||"es.upv.paella.tripleVideo"}get identifier(){return"triple-video"}async load(){this.player.log.debug("Triple video layout loaded")}getValidStreams(t){return super.getValidStreams(t).filter(e=>e.length===3)}switchContent(){const t=this._currentContent[0],e=this._currentContent[1],i=this._currentContent[2];this._currentContent[0]=i,this._currentContent[1]=t,this._currentContent[2]=e,this.player.videoContainer.updateLayout()}getLayoutStructure(t,e){if(!this._currentContent||this._currentContentId!==e){this._currentContentId=e;const{content:s}=this.validContent.find(r=>r.id===e);this._currentContent=s}const i=Bd(this._currentContent);return{player:this.player,name:{es:"Three streams with dynamic position"},hidden:!1,videos:i.videos,buttons:[{rect:i.buttons[0].rect,onClick:()=>{this.switchContent()},label:"Switch",icon:eo,layer:2,ariaLabel:"Swap the position of the videos",title:"Swap the position of the videos"}]}}},Vd=class extends Xa{constructor(t,e){super("div",t,e),this.element.classList.add("image-canvas")}async loadCanvas(t){t.element.style.width="100%",t.element.style.height="100%"}},Hd=class extends Ja{get name(){return super.name||"es.upv.paella.audioCanvas"}get canvasType(){return"audio"}getCanvasInstance(t){return new Vd(this.player,t)}},Kd=class extends Xa{constructor(t,e){super("div",t,e)}async loadCanvas(t){t.element.style.width="100%",t.element.style.height="100%",t.element.style.position="absolute",t.element.style.top="0",t.element.style.left="0"}},Wd=class extends Ja{get name(){return super.name||"es.upv.paella.videoCanvas"}get canvasType(){return"video"}async isCompatible(t){return!Array.isArray(t.canvas)||t.canvas.length===0?!0:await super.isCompatible(t)}getCanvasInstance(t){return new Kd(this.player,t)}},so=class extends di{get type(){return"data"}get context(){return this.config.context||[]}async read(){throw Error(`DataPlugin.read() not implemented in data plugin '${this.name}'`)}async write(){throw Error(`DataPlugin.write() not implemented in data plugin '${this.name}'`)}async remove(){throw Error(`DataPlugin.remove() not implemented in data plugin '${this.name}'`)}},zd=class extends ze{constructor(t){super(t),this._dataPlugins={},Kt(this.player,"data",async e=>{var i;(i=e.context)==null||i.forEach(s=>{this._dataPlugins[s]=this._dataPlugins[s]||[],this._dataPlugins[s].push(e)})})}getDataPlugin(t){let e=this._dataPlugins[t]&&this._dataPlugins[t].length>0&&this._dataPlugins[t][0];if(e||(e=this._dataPlugins.default&&this._dataPlugins.default.length>0&&this._dataPlugins.default[0]),!e)throw Error(`No data plugin found for context '${t}'`);return e}getDataPlugins(t){let e=this._dataPlugins[t]&&this._dataPlugins[t].length>0&&this._dataPlugins[t];if(e||(e=this._dataPlugins.default&&this._dataPlugins.default.length>0&&this._dataPlugins.default),!e)throw Error(`No data plugin found for context '${t}'`);return e}async read(t,e){return await this.getDataPlugin(t).read(t,e)}async write(t,e,i){const s=this.getDataPlugins(t);if(Array.isArray(s)){let r=null;for(let a=0;a<s.length;++a)r=await s[a].write(t,e,i);return r}else{if(s)return await s.write(t,e,i);this.player.log.warn(`No such data plugin found for context '${t}'`)}}async remove(t,e){const i=this.getDataPlugins(t);if(i.length>1){let s=null;for(let r=0;r<i.length;++r)s=await i[r].remove(t,e);return s}else return await i.remove(t,e)}},Sn=null,no=class Qc extends Hi{static Get(){return Sn||(Sn=new Qc),Sn}get moduleName(){return"paella-core default data plugins"}get moduleVersion(){return fi.version}};const Yd=[{plugin:Wu,config:{enabled:!1}},{plugin:zu,config:{enabled:!1}},{plugin:Qu,config:{enabled:!1}},{plugin:Ju,config:{enabled:!1}},{plugin:id,config:{enabled:!1}},{plugin:md,config:{enabled:!1}},{plugin:_d,config:{enabled:!1}},{plugin:Ld,config:{enabled:!1}},{plugin:to,config:{enabled:!1}},{plugin:Md,config:{enabled:!1}},{plugin:$d,config:{enabled:!1}},{plugin:Nd,config:{enabled:!1}},{plugin:Fd,config:{enabled:!1}},{plugin:to,config:{enabled:!1}},{plugin:Gd,config:{enabled:!1}},{plugin:Hd,config:{enabled:!1}},{plugin:Wd,config:{enabled:!1}},{plugin:class extends so{getPluginModuleInstance(){return no.Get()}get name(){return super.name||"es.upv.paella.cookieDataPlugin"}serializeKey(t,e){return typeof e=="object"&&(e=JSON.stringify(e)),`${t}|${e}`}async read(t,e){const i=this.serializeKey(t,e);let s=ui(i);try{s=JSON.parse(s)}catch{}return this.player.log.debug(`CookieDataPlugin.read: ${i}`),s}async write(t,e,i){const s=this.serializeKey(t,e);if(i&&typeof i=="object")try{i=JSON.stringify(i)}catch{this.player.log.warn(`CookieDataPlugin.write: ${s}: invalid data object.`),i=""}We(s,i),this.player.log.debug(`CookieDataPlugin.write: ${s}`)}async remove(t,e){const i=this.serializeKey(t,e);We(i,""),this.player.log.debug(`CookieDataPlugin.remove: ${i}`)}},config:{enabled:!1,context:["default"]}},{plugin:class extends so{getPluginModuleInstance(){return no.Get()}get name(){return super.name||"es.upv.paella.localStorageDataPlugin"}serializeKey(t,e){return typeof e=="object"&&(e=JSON.stringify(e)),`${t}|${e}`}async read(t,e){const i=this.serializeKey(t,e);let s=localStorage.getItem(i);try{s=JSON.parse(s)}catch{}return this.player.log.debug(`LocalStorageDataPlugin.read: ${i}`),s}async write(t,e,i){const s=this.serializeKey(t,e);if(i&&typeof i=="object")try{i=JSON.stringify(i)}catch{this.player.log.warn(`LocalStorageDataPlugin.write: ${s}: invalid data object.`),i=""}localStorage.setItem(s,i),this.player.log.debug(`LocalStorageDataPlugin.write: ${s}`)}async remove(t,e){const i=this.serializeKey(t,e);localStorage.setItem(i,""),this.player.log.debug(`LocalStorageDataPlugin.remove: ${i}`)}},config:{enable:!0,context:["default"]}}];let jd=class extends yn{constructor(){super(...arguments),this._refreshContent=!0}set refreshContent(t){this._refreshContent=t}get refreshContent(){return this._refreshContent}get closeParentPopUp(){return this.config.closeParentPopUp||this.getCloseParentPopUp()}getCloseParentPopUp(){return!1}async action(t,e){super.action(t,e),this.parentPopUp=e,await this.showPopUp()}get parentPopUp(){return this._parentPopUp}set parentPopUp(t){this._parentPopUp=t}get popUp(){return this._popUp}get menuTitle(){return this.config.menuTitle||null}get moveable(){return this.config.moveable??!1}get resizeable(){return this.config.resizeable??!1}get customPopUpClass(){return this.config.customPopUpClass??""}get closeActions(){var t,e;const i=((t=this.config.closeActions)==null?void 0:t.clickOutside)??!0,s=((e=this.config.closeActions)==null?void 0:e.closeButton)??!1;return{clickOutside:i,closeButton:s}}get currentContent(){return this._currentContent}async getContent(){return Z("<p>Pop Up Button Plugin Content</p>")}async checkRefreshContent(){if(this.refreshContent){const t=await this.getContent();this._currentContent.innerHTML="",Array.from(t.children).forEach(e=>this._currentContent.appendChild(e))}}get popUpType(){return this.config.popUpType||"modal"}hidePopUp(){this.player.playbackBar.popUp.isHidden||this.player.playbackBar.popUp.hide()}async showPopUp(){this._keyEventHandler||(this._keyEventHandler=e=>{e.key==="Escape"&&this.hidePopUp()},this.button.addEventListener("keydown",this._keyEventHandler));const t=this.player.playbackBar.popUp;if(t.isHidden||this._contentId!==t.currentContentId){const e=await this.getContent();this._currentContent=e,this._contentId=t.show({title:this.menuTitle||this.description,content:e,attachRight:this.popUpType==="timeline"||this.side==="right",attachLeft:this.popUpType==="timeline"||this.side==="left",parent:this.parentPopUp})}else t.hide()}};const qd=n=>n?`<span class="menu-title">${n}</span>`:"",Zd=n=>n?`<i class="menu-icon">${n}</i>`:"",Qd=n=>n?`aria-label="${n}"`:"",Xd=n=>n?`<span class="state-text">${n}</span>`:"",Jd=n=>n?`<i class="state-icon">${n}</i>`:"",tf=(n,t)=>n||t?`<span class="button-state">${Xd(n)}${Jd(t)}</span>`:"";function ef({itemData:n,buttonType:t,container:e,allItems:i,menuName:s,selectedItems:r,itemPlugin:a}){const{id:o=0,title:l=null,icon:h=null,iconText:c=null,showTitle:u=!0,stateText:d=null,stateIcon:g=null}=n,f=this,p=document.createElement("li"),y=r[o]??!1,v=Z(`
		<button class="menu-button-item${y?" selected":""}" ${Qd(l)} data-id="${o}"" id="${f.name}_menuItem_${o}">
			${Zd(h)}
			${u?qd(l):""}
			${d||g?tf(d,g):""}
		</button>
	`);return a&&(a._button=v),v.addEventListener("keydown",E=>{var _;const T=()=>{E.stopPropagation(),E.preventDefault()};if(E.key==="ArrowUp"){const L=v.dataPrev;L==null||L.focus(),T()}else if(E.key==="ArrowDown"){const L=v.dataNext;L==null||L.focus(),T()}else if(E.key==="Tab"){const L=E.shiftKey?E.target.dataPrev:E.target.dataNext;L==null||L.focus(),T()}else E.key==="Escape"&&(this.player.playbackBar.popUp.pop()?(_=f.button)==null||_.focus():this.focus(),T())}),v.addEventListener("click",async E=>{if(t==="check"){const _=i.find(T=>T.id===o);r[o]=!r[o],f.itemSelected(_,i)}else if(t==="radio"){r[o]=!0;let _=null;i.forEach(T=>{T.id===o?_=T:r[T.id]=!1}),f.itemSelected(_,i)}else{const _=i.find(T=>T.id===o);f.itemSelected(_,i)}await f.checkRefreshContent(),E.stopPropagation(),f.closeOnSelect&&(f.closeMenu(),va(f.player))}),p.appendChild(v),e.appendChild(p),p}let sf=class extends jd{get closeOnSelect(){return this.config.closeOnSelect===void 0&&(this.buttonType!=="check"?this.config.closeOnSelect=!0:this.config.closeOnSelect=!1),this.config.closeOnSelect}setSelected(t,e){this._selectedItems&&(this._selectedItems[t]=e)}async getContent(){var t,e;const i=(t=document.activeElement)==null?void 0:t.id,s=Z("<menu></menu>");this._content=s;const r=await this.getMenu();this._menuItems=r,this._selectedItems||(this._selectedItems={},this._menuItems.forEach(l=>{l.selected!==void 0&&l.selected!==null&&(this._selectedItems[l.id]=l.selected)}));const a=self.crypto.randomUUID(),o=r.map(l=>ef.apply(this,[{itemData:l,buttonType:typeof this.buttonType=="function"?this.buttonType():this.buttonType,container:s,allItems:r,menuName:a,selectedItems:this._selectedItems,itemPlugin:l.plugin}]));return o.forEach((l,h,c)=>{const u=l.querySelector("button");let d=c[h+1],g=c[h-1];h===c.length-1&&(d=c[0]),h===0&&(g=c[c.length-1]),u.dataNext=d==null?void 0:d.querySelector("button"),u.dataPrev=g==null?void 0:g.querySelector("button")}),this._firstItem=(e=o[0])==null?void 0:e.querySelector("button"),i&&setTimeout(()=>{var l;(l=document.getElementById(i))==null||l.focus()},10),s}get menuTitle(){return this.config.menuTitle||null}async getMenu(){return[{id:0,title:"Option 1"},{id:1,title:"Option 2"},{id:2,title:"Option 3"},{id:3,title:"Option 4"},{id:4,title:"Option 5"}]}get menuItems(){return this._menuItems}get showTitles(){return!0}get buttonType(){return"radio"}itemSelected(t,e){this.player.log.warn(`MenuButtonPlugin (${this.name}): itemSelected() function not implemented.`)}closeMenu(){this.player.playbackBar.popUp.hide()}async showPopUp(){this.refreshContent=!0,await super.showPopUp(),this.player.containsFocus&&this._firstItem&&this._firstItem.focus()}},nf=class extends sf{get closeOnSelect(){return this.config.closeOnSelect??!1}async load(){this._iconPath&&(this.icon=await iu(this._iconPath))}async getContent(){return this._buttonPlugins||(this._buttonPlugins=[],await Kt(this.player,"button",async t=>{this.player.log.debug(`Load button plugins into "${this.groupName}" container`),this._buttonPlugins.push(t),t.setObserver(this)},async t=>t.parentContainer===this.groupName?await t.isEnabled():!1)),await super.getContent()}onIconChanged(t,e,i){}onTitleChanged(t,e,i){}onStateChanged(t,e,i,s,r){}get groupName(){var t;return((t=this.config)==null?void 0:t.groupName)||"buttonGroup"}get popUpType(){return"no-modal"}getClosePopUps(){return!1}buttonType(){return"button"}async getMenu(){return this._buttonPlugins.map(t=>({id:t.name,title:t.title||t.description,icon:t.menuIcon!==""?t.menuIcon:t.icon,stateText:t.stateText,stateIcon:t.stateIcon,plugin:t,iconText:t.title}))}itemSelected(t,e){const i=this._buttonPlugins.find(s=>s.name===t.id);if(i){const s=new Event("menuitemselected");i.action(s,this.currentContent)}}async showPopUp(){var t;await super.showPopUp(),setTimeout(()=>{this._firstItem&&this._firstItem.focus()},50),(t=this.buttons)==null||t.forEach(e=>{e.style.display==="none"?this.hideButtonContainer(e):this.showButtonContainer(e)})}get buttons(){return this._content&&Array.from(this._content.getElementsByClassName("button-plugin"))}hideButtonContainer(t){var e;const i=(e=t.parentNode)==null?void 0:e.parentNode;i&&(i.style.display="none")}showButtonContainer(t){var e;const i=(e=t.parentNode)==null?void 0:e.parentNode;i&&(i.style.display=null)}};const ro=(n,t,e,i={})=>{const s=new n(t,e);return e=s.name||e,e?(t.config.plugins&&t.config.plugins[e]&&Fi(i,t.config.plugins[e],!1),s._config=i,s):(t.log.warn(`The instance of the ${n.name} plugin cannot be created because it is being loaded explicitly and does not have the name property implemented.`),null)};function ao(n,t,e,i,s=!1){const r=e.type;let a=-1;if(n.__pluginData__.pluginInstances[r]&&n.__pluginData__.pluginInstances[r].find((l,h)=>{if(l.name===e.name)return a=h,!0})&&!s){n.log.info(`Plugin ${e.name} of type ${r} already registered.`);return}n.__pluginData__.pluginClasses[t]=i,n.__pluginData__.pluginInstances[r]=n.__pluginData__.pluginInstances[r]||[],a!==-1&&n.__pluginData__.pluginInstances[r].splice(a,1),n.__pluginData__.pluginInstances[r].push(e),n.__pluginModules=n.__pluginModules||[];const o=e.getPluginModuleInstance();if(o&&(o._player=o._player||n,!n.__pluginModules.find(l=>l.constructor.name===o.constructor.name))){const l=o.moduleName,h=o.moduleVersion;n.log.debug(`Plugin module imported: ${l}: v${h}`),n.__pluginModules.push(o)}}function rf(n,t){let e=null,i={enabled:!0};if(typeof t=="function"?e=t:typeof t=="object"&&typeof t.plugin=="function"&&(e=t.plugin,i=t.config),!e)n.log.warn("Error importing plugin with explicit import API. Check the 'plugins' array at init params");else{const s=ro(e,n,null,i);if(!s)n.log.warn(`Unable to create an instance of the plugin ${e.name}`);else{const r=s.constructor.name;ao(n,r,s,e,!0)}}}function af(n){const t=n.config;if(n.__pluginData__=n.__pluginData__||{pluginClasses:[],pluginInstances:{}},n.__pluginData__.pluginClasses.length!==0)return;[...Yd,...n.initParams.plugins].forEach(i=>{rf(n,i)});const{buttonGroups:e}=t;e&&e.forEach((i,s)=>{const r=`button_group_${s}`,a=ro(nf,n,r,i);a._iconPath=ce([n.configResourcesUrl,i.icon]),ao(n,a.type,a,`ButtonGroupPlugin${s}`,!1)}),n.log.debug("Plugins have been registered:")}function of(n){delete n.__pluginData__}function oo(n,t){var e;return((e=n.__pluginData__)==null?void 0:e.pluginInstances[t])||[]}async function Kt(n,t,e=null,i=null){if(!n.__pluginData__.pluginInstances[t]){n.log.info(`There are no defined plugins of type '${t}'`);return}n.__pluginData__.pluginInstances[t].sort((s,r)=>s.order-r.order),n.__pluginData__.pluginInstances[t].forEach(s=>n.log.debug(`type: ${t}, name: ${s.name}`)),typeof i!="function"&&(i=async function(s){return await s.isEnabled()});for(const s in n.__pluginData__.pluginInstances[t]){const r=n.__pluginData__.pluginInstances[t][s];if(await i(r)){if(r.__uiPlugin){const a=await r.getDictionaries();if(typeof a=="object")for(const o in a){const l=a[o];n.addDictionary(o,l)}}typeof e=="function"&&await e(r),await r.load()}}}async function lo(n,t){var e;(e=n.__pluginData__.pluginInstances[t])==null||e.forEach(async i=>{await i.unload()})}function lf(n){var t;const e=(i,s)=>{if(!i)throw new Error(`Invalid video manifest: ${s}`)};e(n.streams,"missing 'streams' object."),e(n.streams.length>0,"the 'streams' array is empty."),e((t=n.metadata)==null?void 0:t.preview,"the 'metadata.preview' field is required.")}let hf=class extends ze{constructor(t,e){super(t,e),this._videoContainer=e,this._streamData=null,this._streams=null,this._players=[],this._mainAudioPlayer=null,this._streamSyncTimer=null,this._trimming={enabled:!1,start:100,end:200}}async load(t){this._streamData=t,this._streams={};let e=this.player.config.defaultAudioStream||"presenter";this._streamData.length===1&&(e=this._streamData[0].content),t.some(i=>{if(i.role==="mainAudio")return e=i.content,!0}),this.player.log.debug("Finding compatible video plugins"),await Id(this.player);for(const i of this._streamData){const s=Rd(this.player,i);if(!s)throw Error(`Canvas plugin not found: ${i.canvas}`);const r=i.content===e,a=await Cu(this.player,i);if(!a)throw Error(`Incompatible stream type: ${i.content}`);this._streams[i.content]={stream:i,isMainAudio:r,videoPlugin:a,canvasPlugin:s}}for(const i in this._streams){const s=this._streams[i];s.canvas=await s.canvasPlugin.getCanvasInstance(this._videoContainer),s.player=await s.videoPlugin.getVideoInstance(s.canvas.element,s.isMainAudio),e===i?(this._mainAudioPlayer=s.player,s.player.initVolume(1)):s.player.initVolume(0),await s.player.load(s.stream,this),await s.canvas.loadCanvas(s.player),s.player.onVideoEnded(()=>{this.executeAction("pause"),this.executeAction("setCurrentTime",0),He(this.player,V.ENDED)}),this._players.push(s.player)}if(this.mainAudioPlayer===null)throw this.player.log.error("The video stream containing the audio track could not be identified. The `role` attribute must be specified in the main video stream, or the `defaultAudioStream` attribute must be set correctly in the player configuration."),new Error("The video stream containing the audio track could not be identified.")}async unload(){this.stopStreamSync(),await Ad(this.player)}get players(){return this._players}get streamData(){return this._streamData}get streams(){return this._streams}get mainAudioPlayer(){return this._mainAudioPlayer}get isTrimEnabled(){var t,e,i;return((t=this._trimming)==null?void 0:t.enabled)&&((e=this._trimming)==null?void 0:e.end)>((i=this._trimming)==null?void 0:i.start)}get trimStart(){var t;return(t=this._trimming)==null?void 0:t.start}get trimEnd(){var t;return(t=this._trimming)==null?void 0:t.end}async setTrimming({enabled:t,start:e,end:i}){if(e>=i)throw Error(`Error setting trimming: start time (${e}) must be lower than end time ${i}`);this._trimming={enabled:t,start:e,end:i};const s=await this.currentTime();He(this.player,V.TIMEUPDATE,{currentTime:t?e+s:s})}startStreamSync(){this._timeSync=!0;const t=async()=>{if(!this._players.length){this.player.log.warn("Player not yet loaded. Waiting for video sync.");return}let e=this.mainAudioPlayer.currentTimeSync;const i=.2;if(this.players.length>1)for(let s=0;s<this.players.length;++s){const r=this.players[s];if(r!==this.mainAudioPlayer){const a=r.currentTimeSync;Math.abs(e-a)>i&&(this.player.log.debug("Video synchronization triggered"),r.setCurrentTime(e))}}if(this.isTrimEnabled){let s=e-this.trimStart;if(this.trimEnd<=e){await this.executeAction("pause"),await this.setCurrentTime(0),this.stopStreamSync(),e=0,He(this.player,V.ENDED,{});return}else e<this.trimStart&&(await this.setCurrentTime(0),e=this.trimStart,s=0);He(this.player,V.TIMEUPDATE,{currentTime:s}),this._timeupdateTimer=setTimeout(()=>{this._timeSync&&t()},250)}else this._timeSync&&(He(this.player,V.TIMEUPDATE,{currentTime:e}),this._timeupdateTimer=setTimeout(()=>{t()},250))};t()}stopStreamSync(){this._timeSync=!1,this._timeupdateTimer&&clearTimeout(this._timeupdateTimer)}executeAction(t,e=[]){return Array.isArray(e)||(e=[e]),new Promise(i=>{let s=[],r=[];this.players.forEach(a=>{r.push(new Promise(o=>{a[t](...e).then(l=>{s.push(l),o()})}))}),Promise.allSettled(r).then(()=>i(s))})}get isLiveStream(){return this._streamData.some(t=>Array.from(Object.keys(t.sources)).indexOf("hlsLive")!==-1)}async play(){return this.startStreamSync(),await this.executeAction("play")}async pause(){return this.stopStreamSync(),await this.executeAction("pause")}async stop(){this.stopStreamSync(),await this.executeAction("pause"),await this.executeAction("setCurrentTime",0)}async paused(){return(await this.executeAction("paused"))[0]}async setCurrentTime(t){const e=await this.duration();t<0?t=0:t>e&&(t=e);const i=(await this.executeAction("currentTime"))[0];let s=null;if(this.isTrimEnabled){t=t+this.trimStart,t=t>=this.trimEnd?this.trimEnd:t;const a=(await this.executeAction("setCurrentTime",[t]))[0],o=(await this.executeAction("currentTime"))[0];s={result:a,prevTime:i-this.trimStart,newTime:o-this.trimStart}}else{const a=(await this.executeAction("setCurrentTime",[t]))[0],o=(await this.executeAction("currentTime"))[0];s={result:a,prevTime:i,newTime:o}}const r=await this.currentTime();return He(this.player,V.TIMEUPDATE,{currentTime:r}),s}async currentTime(){const t=await this.mainAudioPlayer.currentTime();return this.isTrimEnabled?t-this.trimStart:t}async currentTimeIgnoringTrimming(){return await this.mainAudioPlayer.currentTime()}async volume(){return this.mainAudioPlayer?await this.mainAudioPlayer.volume():(await this.executeAction("volume"))[0]}async setVolume(t){return this.mainAudioPlayer?await this.mainAudioPlayer.setVolume(t):(await this.executeAction("setVolume",[t]))[0]}async duration(){return this.isTrimEnabled?this.trimEnd-this.trimStart:await this.durationIgnoringTrimming()}async durationIgnoringTrimming(){return(await this.executeAction("duration")).reduce((t,e)=>Math.min(t,e),Number.MAX_VALUE)}async playbackRate(){return(await this.executeAction("playbackRate"))[0]}async setPlaybackRate(t){return(await this.executeAction("setPlaybackRate",[t]))[0]}async getQualityReferencePlayer(){let t=null,e=[];if(Object.keys(this.streams).length>0)for(const i in this.streams){const s=this.streams[i],r=await s.player.getQualities()||[];!t&&r.length>e.length&&(e=r,t=s.player)}return t||this.mainAudioPlayer}async getCurrentQuality(){return(await this.getQualityReferencePlayer()).currentQuality}async getQualities(){return await(await this.getQualityReferencePlayer()).getQualities()}async setQuality(t){const e=await(await this.getQualityReferencePlayer()).getQualities(),i=e.length;let s=-1;if(e.some((r,a)=>(t.index===r.index&&(s=a),s!==-1)),s>=0){const r=s/i;for(const a in this.streams){const o=this.streams[a],l=await o.player.getQualities()||[];if(this.player.log.debug(l),l.length>1){const h=Math.round(l.length*r),c=l[h];await o.player.setQuality(c)}}}}async supportsMultiaudio(){return this.mainAudioPlayer.supportsMultiaudio()}async getAudioTracks(){return this.mainAudioPlayer.getAudioTracks()}async setCurrentAudioTrack(t){return this.mainAudioPlayer.setCurrentAudioTrack(t)}get currentAudioTrack(){return this.mainAudioPlayer.currentAudioTrack}};const Wt=Object.freeze({TOP_LEFT:"topLeft",TOP_MIDDLE:"topMiddle",TOP_RIGHT:"topRight",CENTER_LEFT:"centerLeft",CENTER_MIDDLE:"centerMiddle",CENTER_RIGHT:"centerRight",BOTTOM_LEFT:"bottomLeft",BOTTOM_MIDDLE:"bottomMiddle",BOTTOM_RIGHT:"bottomRight"}),ne=(n,t,e,i,s)=>{i=i||"",e=e||1e3;const r=Z(`
        <div class="message-content ${i}">
            ${n?`<i class="icon">${n}</i>`:""}
            ${t?`<p class="text">${t}</p>`:""}
        </div>
    `);return s.innerHTML="",s.appendChild(r),s.timer&&(clearTimeout(s.timer),s.timer=null),s.timer=setTimeout(()=>{s.removeChild(r)},e),r};let cf=class extends se{constructor(t,e){const i={class:"video-container-message"};super(t,{attributes:i,parent:e}),this._topLeftContainer=Z('<div class="container top-left"></div>',this.element),this._topMiddleContainer=Z('<div class="container top-middle"></div>',this.element),this._topRightContainer=Z('<div class="container top-right"></div>',this.element),this._centerLeftContainer=Z('<div class="container center-left"></div>',this.element),this._centerMiddleContainer=Z('<div class="container center-middle"></div>',this.element),this._centerRightContainer=Z('<div class="container center-right"></div>',this.element),this._bottomLeftContainer=Z('<div class="container bottom-left"></div>',this.element),this._bottomMiddleContainer=Z('<div class="container bottom-middle"></div>',this.element),this._bottomRightContainer=Z('<div class="container bottom-right"></div>',this.element)}show({icon:t=null,text:e="",timeout:i=1e3,position:s=Wt.CENTER_MIDDLE,cssClass:r=""}){switch(s){case Wt.TOP_LEFT:ne.apply(this,[t,e,i,r,this._topLeftContainer]);break;case Wt.TOP_MIDDLE:ne.apply(this,[t,e,i,r,this._topMiddleContainer]);break;case Wt.TOP_RIGHT:ne.apply(this,[t,e,i,r,this._topRightContainer]);break;case Wt.CENTER_LEFT:ne.apply(this,[t,e,i,r,this._centerLeftContainer]);break;case Wt.CENTER_MIDDLE:ne.apply(this,[t,e,i,r,this._centerMiddleContainer]);break;case Wt.CENTER_RIGHT:ne.apply(this,[t,e,i,r,this._centerRightContainer]);break;case Wt.BOTTOM_LEFT:ne.apply(this,[t,e,i,r,this._bottomLeftContainer]);break;case Wt.BOTTOM_MIDDLE:ne.apply(this,[t,e,i,r,this._bottomMiddleContainer]);break;case Wt.BOTTOM_RIGHT:ne.apply(this,[t,e,i,r,this._bottomRightContainer]);break}}};const z=Object.freeze({UNLOADED:0,LOADING_MANIFEST:1,MANIFEST:2,LOADING_PLAYER:3,LOADED:4,UNLOADING_MANIFEST:5,UNLOADING_PLAYER:6,ERROR:7});function uf(n,t){return Array.isArray[t]||(t=[t]),Lu(n,t).getManifestData(t)}async function df(n){return{w:1280,h:720}}async function ho(n){var t;for(const e in this.streamProvider.streams){const i=((t=n==null?void 0:n.videos)==null?void 0:t.find(r=>r.content===e))!=null,s=this.streamProvider.streams[e];i&&!s.player.isEnabled?await s.player.enable():!i&&s.player.isEnabled&&await s.player.disable()}}function co(){for(const n in this.streamProvider.streams){const t=this.streamProvider.streams[n];t.canvas.element.style.display="none",this._hiddenVideos.appendChild(t.canvas.element)}}async function ff(){var n,t;const e=Qa(this.player,this.streamProvider.streamData,this._layoutId,this._mainLayoutContent);await ho.apply(this,[e]),co.apply(this);const i=await df(this.player),s=100/i.w,r=100/i.h;if(this.baseVideoRect.classList.remove("dynamic"),this.baseVideoRect.classList.add("static"),(n=e==null?void 0:e.videos)!=null&&n.length){const o=[];for(const l of e.videos){const h=this.streamProvider.streams[l.content],{stream:c,player:u,canvas:d}=h,g=await u.getDimensions(),f=g.w/g.h;let p=Number.MAX_VALUE,y=null;d.buttonsArea.innerHTML="",o.push(await En(this.player,e,d,l,l.content)),l.rect.forEach(v=>{const E=/^(\d+.?\d*)\/(\d+.?\d*)$/.exec(v.aspectRatio),_=E?Number(E[1])/Number(E[2]):1,T=Math.abs(f-_);T<p&&(y=v,p=T)}),d.element.style.display="block",d.element.style.position="absolute",d.element.style.left=`${(y==null?void 0:y.left)*s}%`,d.element.style.top=`${(y==null?void 0:y.top)*r}%`,d.element.style.width=`${(y==null?void 0:y.width)*s}%`,d.element.style.height=`${(y==null?void 0:y.height)*r}%`,d.element.style.zIndex=l.layer,this.baseVideoRect.appendChild(d.element)}setTimeout(()=>{Tn(this.player,e,o.flat())},100)}const a=this.baseVideoRect.getElementsByClassName("video-layout-button");return Array.from(a).forEach(o=>this.baseVideoRect.removeChild(o)),(t=e==null?void 0:e.buttons)==null||t.forEach(o=>{const l=Ca({tag:"button",attributes:{class:"video-layout-button","aria-label":gi(o.ariaLabel),title:gi(o.title),style:`
                    left: ${o.rect.left*s}%;
                    top: ${o.rect.top*r}%;
                    width: ${o.rect.width*s}%;
                    height: ${o.rect.height*r}%;
                    z-index: ${o.layer};
                `},parent:this.baseVideoRect,children:o.icon});l.layout=e,l.buttonAction=o.onClick,l.addEventListener("click",async h=>{et(this.player,V.BUTTON_PRESS,{plugin:e.plugin,layoutStructure:e}),await h.target.buttonAction.apply(h.target.layout),h.stopPropagation()}),this._layoutButtons.push(l)}),!0}async function gf(){var n,t,e,i,s,r;const a=Qa(this.player,this.streamProvider.streamData,this._layoutId,this._mainLayoutContent);await ho.apply(this,[a]),co.apply(this),this.baseVideoRect.classList.add("dynamic"),this.baseVideoRect.classList.remove("static"),this.baseVideoRect.innerHTML="";const o=this.element.clientWidth,l=this.element.clientHeight,h=o>l;if(this.baseVideoRect.classList.remove("align-center"),this.baseVideoRect.classList.remove("align-top"),this.baseVideoRect.classList.remove("align-bottom"),this.baseVideoRect.classList.remove("align-left"),this.baseVideoRect.classList.remove("align-right"),h){const d=((t=(n=this.player.config.videoContainer)==null?void 0:n.dynamicLayout)==null?void 0:t.landscapeVerticalAlignment)||"align-center";this.baseVideoRect.classList.remove("portrait"),this.baseVideoRect.classList.add("landscape"),this.baseVideoRect.classList.add(d)}else{const d=((i=(e=this.player.config.videoContainer)==null?void 0:e.dynamicLayout)==null?void 0:i.portraitHorizontalAlignment)||"align-center";this.baseVideoRect.classList.add("portrait"),this.baseVideoRect.classList.remove("landscape"),this.baseVideoRect.classList.add(d)}const c=this.baseVideoRect.clientWidth,u=this.element.clientHeight;if(((s=a==null?void 0:a.videos)==null?void 0:s.length)===1){const d=[],g=[],f=a.videos[0],p=this.streamProvider.streams[f.content],{player:y,canvas:v}=p;v.buttonsArea.innerHTML="",g.push(await En(this.player,a,v,f,f.content)),v.element.style={},v.element.style.display="block",v.element.style.width="100%",v.element.style.height="100%",v.element.style.overflow="hidden",v.element.style.position="relative",d.push(v.element),v.element.sortIndex=0,d.forEach(E=>this.baseVideoRect.appendChild(E)),setTimeout(()=>{Tn(this.player,a,g.flat())},100)}else if((r=a==null?void 0:a.videos)!=null&&r.length){let d=0;const g=[],f=[];for(const p of a.videos){const y=this.streamProvider.streams[p.content],{player:v,canvas:E}=y,_=await v.getDimensions(),T=_.w/_.h,L=c,w=u,I=(h?L:w)*p.size/100;let D=Math.round(h?I:I*T),P=Math.round(h?I/T:I);D>L&&(D=L,P=Math.round(D/T)),P>w&&(P=w,D=Math.round(P*T)),E.buttonsArea.innerHTML="",f.push(await En(this.player,a,E,p,p.content)),E.element.style={},E.element.style.display="block",E.element.style.width=`${D}px`,E.element.style.height=`${P}px`,E.element.style.overflow="hidden",E.element.style.position="relative",E.element.sortIndex=d++,g.push(E.element)}if(h){const p=Z('<div class="landscape-container"></div>',this.baseVideoRect);g.forEach(y=>p.appendChild(y))}else g.forEach(p=>this.baseVideoRect.appendChild(p));setTimeout(()=>{Tn(this.player,a,f.flat())},100)}return!0}let pf=class extends se{constructor(t,e){var i;const s="base-video-rect",r={class:"video-container"};(i=t.config.videoContainer)!=null&&i.overPlaybackBar&&(r.class+=" over-playback-bar");const a=`
            <div class="${s}"></div>
            <div class="hidden-videos-container" style="display: none"></div>
        `;super(t,{attributes:r,children:a,parent:e}),this._hiddenVideos=this.element.getElementsByClassName("hidden-videos-container")[0],this._baseVideoRect=this.element.getElementsByClassName(s)[0],this.element.addEventListener("click",async()=>{await this.paused()?await this.play():await this.pause()}),this._ready=!1,this._players=[],this._streamProvider=new hf(this.player,this.baseVideoRect)}get layoutId(){return this._layoutId}get mainLayoutContent(){return this._mainLayoutContent}async setLayout(t,e=null){var i,s;if(this.validContentIds.indexOf(t)===-1)return!1;{const r=(s=(i=this.player.config.videoContainer)==null?void 0:i.restoreVideoLayout)==null?void 0:s.global;await this.player.preferences.set("videoLayout",t,{global:r}),await this.player.preferences.set("videoLayoutMainContent",e,{global:r});const a=this._layoutId;this._layoutId=t,this._mainLayoutContent=e,await this.updateLayout(),a!==t&&et(this.player,V.LAYOUT_CHANGED,{prevLayout:a,layoutId:t})}}get validContentIds(){return this._validContentIds}get validContentSettings(){return this._validContentSettings}get validLayouts(){return qi(this.player,this.streamData)}get streamData(){return this._streamData}get baseVideoRect(){return this._baseVideoRect}get streamProvider(){return this._streamProvider}async create(){this._baseVideoRect.style.display="none",await Kt(this.player,"layout"),await Tu(this.player)}async load(t){var e,i,s,r,a,o,l,h,c,u;if(this._streamData=t,(i=(e=this.player.config.videoContainer)==null?void 0:e.restoreVideoLayout)!=null&&i.enabled){const v=(r=(s=this.player.config.videoContainer)==null?void 0:s.restoreVideoLayout)==null?void 0:r.global;this._layoutId=await this.player.preferences.get("videoLayout",{global:v})||this.player.config.defaultLayout,this._mainLayoutContent=await this.player.preferences.get("videoLayoutMainContent",{global:v})||null}else this._layoutId=this.player.config.defaultLayout,this._mainLayoutContent=null;await this.streamProvider.load(t),this._validContentIds=qa(this.player,t),this._validContentSettings=bd(this.player,t),await this.updateLayout(null,!0);const d=Z('<div class="button-plugins left-side"></div>',this.element),g=Z('<div class="button-plugins right-side"></div>',this.element);this._buttonPlugins=[d,g],this.player.log.debug("Loading videoContainer button plugins"),await Kt(this.player,"button",async v=>{this.player.log.debug(` Button plugin: ${v.name}`),v.side==="left"?await zi(v,d):v.side==="right"&&await zi(v,g)},async v=>v.parentContainer==="videoContainer"?await v.isEnabled():!1),this._baseVideoRect.style.display="";const f=await this.player.preferences.get("volume",{global:!0}),p=await this.player.preferences.get("playbackRate",{global:!0}),y=await this.player.preferences.get("lastKnownTime",{global:!1});if((a=this.player.config.videoContainer)!=null&&a.restoreVolume&&f!==null&&f!==void 0&&await this.streamProvider.setVolume(f),(o=this.player.config.videoContainer)!=null&&o.restorePlaybackRate&&p!==null&&p!==void 0&&await this.streamProvider.setPlaybackRate(p),this.player.videoManifest.trimming&&await this.player.videoContainer.setTrimming(this.player.videoManifest.trimming),(h=(l=this.player.config.videoContainer)==null?void 0:l.restoreLastTime)!=null&&h.enabled&&!this.streamProvider.isLiveStream){const v=async()=>{if(!await this.paused()){const E=await this.currentTime();await this.player.preferences.set("lastKnownTime",E,{global:!1})}setTimeout(v,1e3)};if(y){const E=await this.player.preferences.get("lastKnownTime",{global:!1}),_=await this.duration(),T=(u=(c=this.player.config.videoContainer)==null?void 0:c.restoreLastTime)==null?void 0:u.remainingSeconds;_-E>T&&await this.setCurrentTime(E)}v()}this._messageContainer=new cf(this.player,this.element),this._ready=!0}async unload(){this.removeFromParent(),await lo(this.player,"layout"),await _u(this.player),await this.streamProvider.unload()}async updateLayout(t=null){const e=arguments[1];if(t&&(this._mainLayoutContent=t),!e&&this.player.state!==z.LOADED)return;if(this._updateInProgress)return this.player.log.warn("Recursive update layout detected"),!1;this._updateInProgress=!0;let i=!0;this._layoutButtons=[],(!this._layoutId||this._validContentIds.indexOf(this._layoutId)===-1)&&(this._layoutId=this.player.config.defaultLayout,this._mainLayoutContent=null,this._validContentIds.indexOf(this._layoutId)===-1&&(this._layoutId=this._validContentIds[0]),i=!1);const s=Za(this.player,this.streamProvider.streamData,this._layoutId);return s.layoutType==="static"?i=ff.apply(this):s.layoutType==="dynamic"&&(i=gf.apply(this)),this._updateInProgress=!1,i}hideUserInterface(){if(this._layoutButtons&&this._buttonPlugins){this.player.log.debug("Hide video container user interface");const t=e=>{e._prevDisplay=e.style.display,e.style.display="none"};this._layoutButtons.forEach(t),this._buttonPlugins.forEach(t);for(const e in this.streamProvider.streams)this.streamProvider.streams[e].canvas.hideButtons()}}showUserInterface(){if(this._layoutButtons&&this._buttonPlugins){const t=e=>e.style.display=e._prevDisplay||"block";this._layoutButtons.forEach(t),this._buttonPlugins.forEach(t);for(const e in this.streamProvider.streams)this.streamProvider.streams[e].canvas.showButtons()}}get message(){return this._messageContainer}get elementSize(){return{w:this.element.offsetWidth,h:this.element.offsetHeight}}get ready(){return this._ready}get isLiveStream(){return this.streamProvider.isLiveStream}async play(){const t=await this.streamProvider.play();return et(this.player,V.PLAY),t}async pause(){const t=await this.streamProvider.pause();return et(this.player,V.PAUSE),t}async stop(){this.streamProvider.stop(),et(this.player,V.STOP)}async paused(){return this.streamProvider.paused()}async setCurrentTime(t){const e=await this.streamProvider.setCurrentTime(t);return et(this.player,V.SEEK,{prevTime:e.prevTime,newTime:e.newTime}),e.result}async currentTime(){return this.streamProvider.currentTime()}async volume(){return this.streamProvider.volume()}async setVolume(t){const e=await this.streamProvider.setVolume(t);return et(this.player,V.VOLUME_CHANGED,{volume:t}),await this.player.preferences.set("volume",t,{global:!0}),e}async duration(){return await this.streamProvider.duration()}async playbackRate(){return await this.streamProvider.playbackRate()}async setPlaybackRate(t){const e=await this.streamProvider.setPlaybackRate(t);return et(this.player,V.PLAYBACK_RATE_CHANGED,{newPlaybackRate:t}),await this.player.preferences.set("playbackRate",t,{global:!0}),e}get isTrimEnabled(){return this.streamProvider.isTrimEnabled}get trimStart(){return this.streamProvider.trimStart}get trimEnd(){return this.streamProvider.trimEnd}async setTrimming({enabled:t,start:e,end:i}){const s=await this.streamProvider.setTrimming({enabled:t,start:e,end:i});return et(this.player,V.TRIMMING_CHANGED,{enabled:t,start:e,end:i}),s}getVideoRect(t=null){var e,i;let s=this.baseVideoRect;if(typeof t=="string"){if(s=(e=this.streamProvider.streams[t])==null?void 0:e.canvas.element,!s)return this.player.log.warn(`videoContainer.getVideoRect: Invalid target '${t}'. Valid targets are: ${Object.keys(this.streamProvider.streams).join(", ")}`),this.player.log.warn("Please, configure a valid target in the 'targetContent' property of the configuration file, or provide a valid target in the 'frameList.targetContent' property of the video manifest"),null}else t===0&&(s=(i=this.streamProvider.streams[Object.keys(this.streamProvider.streams)[0]])==null?void 0:i.canvas.element);return{x:s==null?void 0:s.offsetLeft,y:s==null?void 0:s.offsetTop,width:s==null?void 0:s.offsetWidth,height:s==null?void 0:s.offsetHeight,element:s}}appendChild(t,e=null,i=1){if(e){const{width:s,height:r}=this.getVideoRect();e.x=e.x*100/s,e.width=e.width*100/s,e.y=e.y*100/r,e.height=e.height*100/r,t.style.position="absolute",t.style.left=`${e.x}%`,t.style.top=`${e.y}%`,t.style.width=`${e.width}%`,t.style.height=`${e.height}%`,i!==null&&(t.style.zIndex=i)}return this.baseVideoRect.appendChild(t),t}removeChild(t){this.baseVideoRect.removeChild(t)}};const mf=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 300 300" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <rect id="Play" x="0" y="0" width="300" height="300" style="fill:none;"/>
    <g id="Play1" serif:id="Play">
        <g transform="matrix(1.21457,0,0,1.21457,-55.8704,-35.2227)">
            <circle cx="169.5" cy="152.5" r="123.5" style="fill:rgb(128,128,128);"/>
            <path d="M169.5,29C237.662,29 293,84.338 293,152.5C293,220.662 237.662,276 169.5,276C101.338,276 46,220.662 46,152.5C46,84.338 101.338,29 169.5,29ZM169.5,37.233C233.117,37.233 284.767,88.883 284.767,152.5C284.767,216.117 233.117,267.767 169.5,267.767C105.883,267.767 54.233,216.117 54.233,152.5C54.233,88.883 105.883,37.233 169.5,37.233Z" style="fill:rgb(235,235,235);"/>
        </g>
        <g transform="matrix(6.12323e-17,1,-1,6.12323e-17,347,-59)">
            <path d="M209,82L317,253L101,253L209,82Z" style="fill:rgb(235,235,235);"/>
        </g>
    </g>
</svg>
`,yf=`
    background-color: #e4e4e4;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: absolute;
    top: 50%;
    transform: translateY(-50%); 
`,wn=`
    width: 100%;
`,vf=`
    position: absolute; 
    top: 0px; 
    left: 0px; 
    right: 0px; 
    bottom: 0px; 
    display: flex;
    align-content: center;
    justify-content: center;
    align-items: center;
`,Ef=`
    pointer-events: none;
    width: 20%;
    max-width: 400px;
    min-width: 100px;
    opacity: 0.6;
`,Tf=`
    display: block;
    width: 20%;
    background: none;
    border: none;
    cursor: pointer;
`;let _f=class extends se{constructor(t,e,i,s){const r={class:"preview-container",style:yf,role:"button","aria-label":"Play video"};super(t,{attributes:r,parent:e}),this._img=Z(`
        <div style="${wn}">
            ${i?`<img style="${wn}" src="${i}" class="preview-image-landscape" alt=""/>`:""}
            ${s?`<img style="${wn}" src="${s}" class="preview-image-portrait" alt=""/>`:""}
            <div style="${vf}">
                <button style="${Tf}" role="button" aria-label="Play video">
                    <i class="preview-play-icon" style="${Ef}">${mf}</i>
                </button>
            </div>
        </div>
        `,this.element),this.element.setAttribute("id","playerContainerClickArea"),this.element.addEventListener("click",l=>{t.play()});const a=i&&s,o=()=>{if(a){const l=this.element.clientWidth/this.element.clientHeight,h=Array.from(this.element.getElementsByClassName("preview-image-landscape")),c=Array.from(this.element.getElementsByClassName("preview-image-portrait"));l>=1?(h.forEach(u=>u.style.display=""),c.forEach(u=>u.style.display="none")):(h.forEach(u=>u.style.display="none"),c.forEach(u=>u.style.display=""))}};window.addEventListener("resize",()=>{o()}),o()}loadBackgroundImage(t){this._img.setAttribute("src",t)}};const Lf=n=>{const t=document.createElement("section");return t.classList.add("pop-up"),t.innerHTML=`
        <header class="pop-up-title">
            <button class="action-back">
                <svg width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M15 6l-6 6l6 6" />
                </svg>
            </button>
            <h2>title</h2>
        </header>
        <div class="pop-up-content">
        </div>
    `,n.appendChild(t),t.setTitle=e=>{t.querySelector("header.pop-up-title h2").textContent=e},t.popButton=()=>t.querySelector("header.pop-up-title button"),t.onPopClicked=e=>{t._clickCallback&&t.popButton().removeEventListener("click",t._clickCallback),t._clickCallback=e,t.popButton().addEventListener("click",e)},t.hidePopButton=()=>t.popButton().style.display="none",t.showPopButton=()=>t.popButton().style.display="",t.setContent=e=>{t.querySelector("div.pop-up-content").innerHTML="",t.querySelector("div.pop-up-content").appendChild(e)},t};let Cf=0;function bf(){return++Cf}var Ze,ct,St,Qi;let Sf=class{constructor(t){at(this,Ze,null),at(this,ct,null),at(this,St,[]),at(this,Qi,""),ht(this,Ze,t),ht(this,ct,document.createElement("div")),O(this,ct).className="pop-up-wrapper",t.element.prepend(O(this,ct)),O(this,ct).classList.add("hidden"),O(this,ct).addEventListener("click",e=>e.stopPropagation()),O(this,Ze).element.addEventListener("click",e=>{e.stopPropagation(),this.hide()})}get title(){return O(this,Qi)}set title(t){ht(this,Qi,t)}get currentContent(){return O(this,St).length&&O(this,St)[O(this,St).length-1]}get currentContentId(){var t;return((t=this.currentContent)==null?void 0:t.dataContentId)??-1}show({content:t,title:e="",parent:i=null,attachLeft:s=!1,attachRight:r=!1}){if(!t)throw new Error("PlaybackBarPopUp.show(): No content provided.");t.setAttribute("data-pop-up-content-id",bf()),t.dataContentId=t.getAttribute("data-pop-up-content-id");const a=O(this,St).length&&O(this,St)[O(this,St).length-1],o=i&&i.getAttribute("data-pop-up-content-id");a&&a.getAttribute("data-pop-up-content-id")!==o?(O(this,ct).innerHTML="",ht(this,St,[])):a&&a.container.classList.add("out"),O(this,St).push(t),O(this,Ze).element.classList.add("pop-up-active"),O(this,ct).classList.remove("hidden");const l=Lf(O(this,ct));return l.setTitle(e),t.container=l,s===!0?O(this,ct).classList.add("left"):O(this,ct).classList.remove("left"),r===!0?O(this,ct).classList.add("right"):O(this,ct).classList.remove("right"),l.setContent(t),O(this,St).length>1?l.onPopClicked(()=>{O(this,St).pop(),O(this,St)[O(this,St).length-1].container.classList.remove("out"),O(this,ct).removeChild(l)}):l.hidePopButton(),this.title=e,t.dataContentId}pop(){if(O(this,ct).querySelectorAll(".pop-up").length===1)return this.hide(),!1;const t=new Event("click");return O(this,ct).querySelector(".pop-up:not(.out) .action-back").dispatchEvent(t),!0}hide(){O(this,Ze).element.classList.remove("pop-up-active"),O(this,ct).classList.add("hidden")}get isHidden(){return O(this,ct).classList.contains("hidden")}};Ze=new WeakMap,ct=new WeakMap,St=new WeakMap,Qi=new WeakMap;var Xi,Ei,Ti,Te,_i,Ji,Li,Mt,Qe,Ci;let wf=class extends se{constructor(t,e){var i;const s=((i=t.config.progressIndicator)==null?void 0:i.inlineMode)??!1;super(t,{attributes:{class:"playback-bar-container"},parent:e}),at(this,Xi,null),at(this,Ei,null),at(this,Ti,null),at(this,Te,null),at(this,_i,null),at(this,Ji,null),at(this,Li,null),at(this,Mt,null),at(this,Qe,!0),at(this,Ci,[]),ht(this,Xi,new Sf(this)),this.element.addEventListener("mouseenter",()=>ou(t)),this.element.addEventListener("mouseleave",()=>va(t)),ht(this,Ei,Z('<section class="playback-bar"></section>',this.element)),ht(this,Ti,Z("<div></div>")),ht(this,Te,Z("<nav></nav>")),ht(this,_i,Z("<ul></ul>",O(this,Te))),ht(this,Ji,Z("<div></div>",O(this,Te))),ht(this,Li,Z("<ul></ul>",O(this,Te)));const r=t._initParams.getProgressIndicator,a=1e3,o=0,l=100;s?ht(this,Mt,r({container:O(this,Ji),player:t,duration:a,currentTime:o,precision:l})):(O(this,Ei).appendChild(O(this,Ti)),ht(this,Mt,r({container:O(this,Ti),player:t,duration:a,currentTime:o,precision:l}))),O(this,Mt).onChange(async h=>{await t.videoContainer.setCurrentTime(h)}),O(this,Ei).appendChild(O(this,Te))}get popUp(){return O(this,Xi)}get enabled(){return O(this,Qe)}set enabled(t){ht(this,Qe,t),O(this,Qe)?this.showUserInterface():this.hide()}async load(){ht(this,Ci,[]),this.player.log.debug("Loading button plugins"),await Kt(this.player,"button",async i=>{this.player.log.debug(` Button plugin: ${i.name}`),O(this,Ci).push(i),i.side==="left"?await zi(i,this.buttonPluginsLeft):i.side==="right"&&await zi(i,this.buttonPluginsRight)},async i=>i.parentContainer==="playbackBar"?await i.isEnabled():!1);const t=await this.player.videoContainer.duration();O(this,Mt).setDuration(t),this.player.frameList.frames.forEach((i,s,r)=>{const a=r[s+1],o=a?a.time-i.time:t-i.time;O(this,Mt).addMarker({time:i.time,duration:t,frameDuration:o,addGap:s<r.length-1})}),this.player.bindEvent([this.player.Events.TIMEUPDATE,this.player.Events.SEEK],i=>{O(this,Mt).setCurrentTime(i.newTime??i.currentTime)}),this.player.bindEvent(this.player.Events.TRIMMING_CHANGED,async i=>{const s=i.end-i.start;O(this,Mt).setDuration(s);const r=await this.player.videoContainer.currentTime();O(this,Mt).setCurrentTime(r)}),this.onResize();const e=this.element.querySelector(".playback-bar").offsetHeight;this.player.containerElement.style.setProperty("--playback-bar-height",`${e}px`)}async unload(){this.removeFromParent(),await lo(this.player,"button"),O(this,_i).innerHTML="",O(this,Li).innerHTML=""}hideUserInterface(){this.player.log.debug("Hide playback bar user interface"),this.hide()}showUserInterface(){var t;if(O(this,Qe)){const e=((t=this.player.config.progressIndicator)==null?void 0:t.inlineMode)??!1?"flex":"block";this.show(e),this.onResize()}}get buttonPluginsRight(){return O(this,Li)}get buttonPluginsLeft(){return O(this,_i)}get progressIndicator(){return O(this,Mt)}get containerSize(){const t=this.element.clientWidth,e=this.element.clientHeight;return{width:t,height:e}}onResize(){const{containerSize:t}=this;O(this,Ci).forEach(e=>e.onResize(t))}};Xi=new WeakMap,Ei=new WeakMap,Ti=new WeakMap,Te=new WeakMap,_i=new WeakMap,Ji=new WeakMap,Li=new WeakMap,Mt=new WeakMap,Qe=new WeakMap,Ci=new WeakMap;const uo=[{maxWidth:400,className:"size-s"},{maxWidth:600,className:"size-m"},{maxWidth:900,className:"size-l"},{maxWidth:1100,className:"size-xl"},{className:"size-xxl"}],If=n=>uo.find(t=>t.maxWidth&&t.maxWidth>=n||t.maxWidth===void 0).className;let Af=class extends se{constructor(t,e){const i={class:"captions-canvas visible-ui"};super(t,{tag:"div",attributes:i,parent:e}),this._captionsContainer=Z(`
            <div class="text-container">
            </div>
        `,this.element),this._captions=[],this.hide(),this._currentCaptions=null;const s=async r=>{const a=(t.videoContainer.isTrimEnabled?t.videoContainer.trimStart:0)+(r.currentTime||r.newTime||0);if(this._currentCaptions){const o=this._currentCaptions.getCue(a);this._captionsContainer.innerHTML="",o&&o.captions.forEach(l=>{this._captionsContainer.innerHTML+=l,this._captionsContainer.innerHTML+="<br/>"}),o?this._captionsContainer.style.display=null:this._captionsContainer.style.display="none",this.resize()}};bt(this.player,V.TIMEUPDATE,s),bt(this.player,V.SEEK,s),bt(this.player,V.RESIZE,()=>this.resize()),bt(this.player,V.SHOW_UI,()=>this.element.classList.add("visible-ui")),bt(this.player,V.HIDE_UI,()=>this.element.classList.remove("visible-ui"))}async load(){await td(this.player)}unload(){}resize(){const t=If(this._captionsContainer.clientWidth);uo.forEach(e=>this.element.classList.remove(e.className)),this.element.classList.add(t)}addCaptions(t){this._captions.push(t),et(this.player,V.CAPTIONS_CHANGED,{captions:this._captions})}get captions(){return this._captions}get currentCaptions(){return this._currentCaptions}getCaptions({label:t,index:e,lang:i}){if(t===void 0&&e===void 0&&i===void 0)throw Error("Could not find captions: you must specify the label, the index or the language");return e!==void 0?this._captions[e]:this._captions.find(s=>{if(t!==void 0)return s.label===t;if(i!==void 0)return s.language===i})}enableCaptions(t){const e=this.getCaptions(t);if(e!==this._currentCaptions&&(this._currentCaptions=e,this.currentCaptions)){const{language:i,label:s}=this.currentCaptions;et(this.player,V.CAPTIONS_ENABLED,{language:i,label:s})}this.show()}disableCaptions(){this.currentCaptions&&et(this.player,V.CAPTIONS_DISABLED),this._currentCaptions=null,this.hide()}};async function Rf(n){await Kt(n,"eventLog",async t=>{t.events.forEach(e=>{bt(n,e,async i=>{await t.onEvent(e,i)})})})}async function kf(n){}const fo=n=>!1,go=n=>n.description;let Df=class{constructor(t,e){this._player=t,this._cookieConsentData=t.config.cookieConsent||[],this._getConsentCallback=e.getConsent||fo,this._getDescriptionCallback=e.getDescription||go,this._cookieConsentData.forEach(i=>{i.description=this._getDescriptionCallback(i)}),this.updateConsentData()}updateConsentData(){this._cookieConsentData.forEach(t=>{t.value=this._getConsentCallback(t.type)||t.required}),et(this._player,V.COOKIE_CONSENT_CHANGED,{cookieConsent:this})}getConsentForType(t){const e=this._cookieConsentData.find(i=>i.type===t);return(e==null?void 0:e.value)||!1}};function Pf({container:n}){n.innerHTML=`
        <div class="timeline-preview hidden">
            <img src="" alt="" />
            <p></p>
        </div>
    `;const t=n.querySelector("img"),e=n.querySelector("p"),i=n.querySelector(".timeline-preview");return{setImage(s,r){s!==t.src&&(t.src=s,t.alt=r)},setText(s){e.innerText=s},setPosition(s){s>.5?(i.style.left="",i.style.right=`${100-s*100}%`):(i.style.right="",i.style.left=`${s*100}%`)},show(){i.classList.remove("hidden")},hide(){i.classList.add("hidden")}}}function xf({container:n,player:t,duration:e=100,currentTime:i=0,precision:s=100}){n.classList.add("progress-indicator"),n.classList.add("custom-progress-indicator"),n.innerHTML=`
        <div class="range-container">
            <div class="timeline-preview-container"></div>
            <div class="tracker">
                <div class="elapsed"></div>
                <div class="remaining"></div>
            </div>
            <input type="range" min="0" max="${e*s}" value="${i*s}" tabindex="0" role="slider" class="slider">
            <ul class="markers-container"></ul>
        </div>
    `;const r=n.querySelector(".elapsed"),a=n.querySelector(".remaining"),o=n.querySelector(".slider"),l=n.querySelector(".timeline-preview-container"),h=Pf({container:l});let c=!1,u=null;const d=[],g=v=>{var E;return(E=d.find(_=>_.time<v&&_.time+_.frameDuration>=v))==null?void 0:E.marker},f={player:t,elapsed:r,remaining:a,range:o,timeLinePreview:h,markersContainer:n.querySelector(".markers-container"),addMarker({time:v,duration:E,frameDuration:_,addGap:T=!0}){const L=Z(`<li>
                <div class="elapsed"></div>
                <div class="remaining"></div>
            </li>`);L.style.left=`${v/E*100}%`,L.style.width=T?`calc(${_/E*100}% - var(--slide-marker-gap))`:`${_/E*100}%`,this.markersContainer.appendChild(L),d.push({marker:L,time:v,frameDuration:_})},updateRemaining(){const v=this.range.value/this.range.max*100;this.elapsed.style.width=`${v}%`,this.remaining.style.width=`${100-v}%`;const E=g(this.range.value/s),_=d.findIndex(T=>T.marker===E);d.forEach((T,L)=>{if(L<_)T.marker.querySelector(".elapsed").style.width="100%",T.marker.querySelector(".remaining").style.width="0%";else if(L===_){const w=(this.range.value/s-T.time)/T.frameDuration*100;T.marker.querySelector(".elapsed").style.width=`${w}%`,T.marker.querySelector(".remaining").style.width=`${100-w}%`}else T.marker.querySelector(".elapsed").style.width="0%",T.marker.querySelector(".remaining").style.width="100%"})},setDuration(v){c||(this.range.max=v*s,this.updateRemaining())},setCurrentTime(v){c||(this.range.value=v*s,this.updateRemaining())},onChange(v){u=v},hideTimeLine(){n.classList.add("hide-timeline")}};o.addEventListener("pointerdown",()=>{c=!0});let p=null;o.addEventListener("mousemove",async v=>{var E;const _=((E=t.frameList)==null?void 0:E.frames)||[];if(_&&_.length){const T=await t.videoContainer.duration(),L=v.target.clientWidth,w=v.layerX/L,I=w*T,D=_.filter(Y=>Y.time<=I).pop(),P=D&&(D.thumb||D.url),R=D&&Ke(T*w),k=g(I);k!==p&&p!==null&&p.classList.remove("active"),k&&k.classList.add("active"),p=k,h.setImage(P,R),h.setText(R),h.setPosition(w),h.show()}}),o.addEventListener("mouseleave",()=>{h.hide(),p&&p.classList.remove("active")}),o.addEventListener("pointerup",()=>{var v;c=!1,(v=document.activeElement)==null||v.blur(),typeof u=="function"&&u(o.value/s)}),o.addEventListener("input",()=>{f.updateRemaining()});const y=async v=>{const E=await t.videoContainer.currentTime();await t.videoContainer.setCurrentTime(E+v)};return o.addEventListener("keydown",v=>{v.key==="ArrowLeft"?(y(-10),v.preventDefault(),v.stopPropagation()):v.key==="ArrowRight"&&(y(10),v.preventDefault(),v.stopPropagation())}),f.updateRemaining(),f}const ut=Object.freeze({DISABLED:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,VERBOSE:5});let po=ut.INFO;const mo=(n,t=null)=>{const e=typeof n=="string"?ut[n.toUpperCase()]:n;if(e<ut.DISABLED||e>ut.VERBOSE)throw Error(`setLogLevel: invalid log level ${e}`);t?(t.__logSettings=t.__logSettings||{},t.__logSettings.logLevel=e):po=e},yo=(n=null)=>n?n.__logSettings.logLevel:po,bi=({msg:n,level:t=ut.INFO,player:e=null,context:i="paella-core"})=>{e&&!e.__logSettings&&mo(e,ut.INFO);const s=yo(e);if(t<ut.DISABLED)throw Error(`printMessage: invalid log level ${t}`);if(e&&et(e,V.LOG,{severity:t,context:i,message:n,currentLogLevel:s}),t<=s)switch(t){case ut.ERROR:console.error(`${i} - Error: ${n}`);break;case ut.WARN:console.warn(`${i} - Warning: ${n}`);break;case ut.INFO:console.info(`${i} - Info: ${n}`);break;case ut.DEBUG:console.debug(`${i} - Debug: ${n}`);break;case ut.VERBOSE:console.log(`${i} - Verbose: ${n}`);break}},_e={setLevel:(n,t=null)=>{mo(n,t)},currentLevel:(n=null)=>yo(n),error:(n,t=null,e="paella-core")=>{bi({msg:n,level:ut.ERROR,player:t,context:e})},warn:(n,t=null,e="paella-core")=>{bi({msg:n,level:ut.WARN,player:t,context:e})},info:(n,t=null,e="paella-core")=>{bi({msg:n,level:ut.INFO,player:t,context:e})},debug:(n,t=null,e="paella-core")=>{bi({msg:n,level:ut.DEBUG,player:t,context:e})},verbose:(n,t=null,e="paella-core")=>{bi({msg:n,level:ut.VERBOSE,player:t,context:e})}};let Mf=class{constructor(t,e="paella-core"){this._player=t,this._context=e}get context(){return this._context}get player(){return this._player}setLevel(t){_e.setLevel(t,this._player)}currentLevel(){return _e.currentLevel(this._player)}error(t,e=null){_e.error(t,this._player,e||this._context)}warn(t,e=null){_e.warn(t,this._player,e||this._context)}info(t,e=null){_e.info(t,this._player,e||this._context)}debug(t,e=null){_e.debug(t,this._player,e||this._context)}verbose(t,e=null){_e.verbose(t,this._player,e||this._context)}};const vo={},In='{ "global": {}, "videos": {} }';async function Eo(){switch(this.source.name){case"cookie":try{return JSON.parse(ui("preferences"))}catch{return JSON.parse(In)}case"dataPlugin":try{return await this.player.data.read(this.source.context,{})||JSON.parse(In)}catch{return JSON.parse(In)}}}async function Of(n){switch(this.source.name){case"cookie":cu(this.player,this.source.consentType,"preferences",JSON.stringify(n));break;case"dataPlugin":await this.player.data.write(this.source.context,{},n);break}}let $f=class extends ze{constructor(t){super(t);const{currentSource:e,sources:i}=t.config.preferences||{currentSource:"cookie",sources:{cookie:{consentType:"necessary"}}};if(this.source=i[e],this.source.name=e,this._loaded=!1,!this.source)throw Error("Invalid configuration in preferences. Check the configuration file.")}async set(t,e,{global:i=!1}={}){const s=await Eo.apply(this);i?s.global[t]=e:(s.videos[this.player.videoId]=s.videos[this.player.videoId]||{},s.videos[this.player.videoId][t]=e),await Of.apply(this,[s])}async get(t,{global:e=!1}={}){const i=await Eo.apply(this);return e?i.global[t]:i.videos[this.player.videoId]&&i.videos[this.player.videoId][t]||void 0}};function Nf(n){var t;(t=this._skinData)!=null&&t.configOverrides&&Fi(n,this._skinData.configOverrides)}async function Ff(){var n;if((n=this._skinData)!=null&&n.styleSheets){const t=[];this._skinData.styleSheets.forEach(e=>{if(!/\{.*/.test(e))if(this._externalResourcesAllowed){const i=ce([this._skinUrl,e]);t.push(new Promise(async s=>{await Ta(i,!1),s()}))}else throw new Error("No external resources allowed loading skin object")}),await Promise.allSettled(t)}}async function Uf(){var n;if(this.player.__skinStyleSheets__=this.player.__skinStyleSheets__||[],(n=this._skinData)!=null&&n.styleSheets){const t=[];this._skinData.styleSheets.forEach(e=>{if(/\{.*/.test(e))t.push(new Promise(i=>{const s=document.createElement("style");s.innerHTML=e,this.player.__skinStyleSheets__.push(s),document.head.appendChild(s),i()}));else{const i=ce([this._skinUrl,e]);t.push(new Promise(async s=>{const r=await Ta(i);this.player.__skinStyleSheets__.push(r),s()}))}}),await Promise.allSettled(t)}}function To(){this.player.__skinStyleSheets__=this.player.__skinStyleSheets__||[],this.player.__skinStyleSheets__.forEach(n=>{uu(n)}),this.player.__skinStyleSheets__=[]}async function Bf(){var n;Array.isArray((n=this._skinData)==null?void 0:n.icons)&&await Promise.all(this._skinData.icons.map(({plugin:t,identifier:e,icon:i})=>new Promise(async(s,r)=>{const a=document.createElement("div");if(a.innerHTML=i,a.children[0]&&a.children[0].tagName==="svg")s();else if(this._externalResourcesAllowed){const o=ce([this._skinUrl,i]);(await fetch(o)).ok?s():r(new Error(`Skin icon not found at URL '${o}'`))}else throw new Error("No external resources allowed loading skin object")})))}async function Gf(){var n;Array.isArray((n=this._skinData)==null?void 0:n.icons)&&await Promise.all(this._skinData.icons.map(({plugin:t,identifier:e,icon:i})=>new Promise(async(s,r)=>{const a=document.createElement("div");if(a.innerHTML=i,a.children[0]&&a.children[0].tagName==="svg")this.player.addCustomPluginIcon(t,e,i),s();else{const o=ce([this._skinUrl,i]),l=await fetch(o);if(l.ok){const h=await l.text();this.player.addCustomPluginIcon(t,e,h),s()}else r(new Error(`Skin icon not found at URL '${o}'`))}})))}let Vf=class{constructor(t){this._player=t}get player(){return this._player}async loadSkin(t){const e=this._player.state===z.LOADED&&!await this._player.paused(),i=this._player.state===z.LOADED?await this._player.currentTime():0;if(typeof t=="string"){this._skinUrl=ma(t),this._externalResourcesAllowed=!0;const s=await fetch(t);if(!s.ok)throw new Error(`Error loading skin from URL ${t}`);this._skinData=await s.json()}else typeof t=="object"&&(this._skinUrl="",this._externalResourcesAllowed=!1,this._skinData=t);try{await Ff.apply(this),await Bf.apply(this),(this._player.state===z.LOADED||this._player.state===z.MANIFEST)&&(await this._player.reload(),await this._player.play(),await this._player.setCurrentTime(i),e||await this._player.pause())}catch(s){throw this._skinUrl="",this._externalResourcesAllowed=!0,this._skinData={},s}}unloadSkin(){var t,e;Array.isArray((t=this._skinData)==null?void 0:t.icons)&&((e=this._skinData)==null||e.icons.forEach(({plugin:i,identifier:s})=>{this.player.removeCustomPluginIcon(i,s)})),this._skinUrl=null,this._skinData={},(this._player.state===z.LOADED||this._player.state===z.MANIFEST)&&this._player.reload()}},Hf=class{constructor(t,e){this._player=e,this._videoManifest=JSON.parse(JSON.stringify(t)),this._metadata=this._videoManifest.metadata||{},this._streams={},this._frameList={},this._trimming=this._videoManifest.trimming,this._captions=this._videoManifest.captions,this._visibleTimeLine=this._videoManifest.visibleTimeLine;function i(){if(this.streams.length!==1)return null;if(this.isAudioOnly)return this.audioOnlySource.src;const s=this.streams[0];if(!(s.sources.mp4||s.sources.hls||s.sources.hlsLive))return null;const r=document.createElement("video");if(s.sources.mp4&&s.sources.mp4.length&&r.canPlayType(s.sources.mp4[0].mimetype||"video/mp4")==="probably")return s.sources.mp4[0].src;const a=s.sources.hls||s.sources.hlsLive;return a&&a.length&&r.canPlayType(a[0].mimetype||"application/vnd.apple.mpegurl")!==""&&/safari/i.test(navigator.userAgent)?a[0].src:null}this._streams={streams:this._videoManifest.streams,get contents(){return this.streams.map(s=>s.content)},getStream(s){return this.streams.find(r=>r.content===s)},getSourceTypes(s){const r=this.getStream(s);return r&&Object.keys(r.sources)||null},getCanvasTypes(s){const r=this.getStream(s);return r?r.canvas||["video"]:null},get isAudioOnly(){const s=this.contents.length===1&&this.contents[0],r=s&&this.getCanvasTypes(s)||[],a=this.getStream(s);return r.length===1&&r[0]==="audio"&&a.sources.audio&&a.sources.audio.length>0},get audioOnlySource(){return this.isAudioOnly?this.getStream(this.contents[0]).sources.audio[0]:null},get isNativelyPlayable(){return i.apply(this)!==null},get nativeSource(){return i.apply(this)},get nativeType(){return this.isNativelyPlayable?this.isAudioOnly?"audio":"video":null},get nativePlayer(){const s=this.nativeType;if(s){const r=document.createElement(s);return r.src=this.nativeSource,r}else return null}},this._videoManifest.frameList&&!Array.isArray(this._videoManifest.frameList)&&typeof this._videoManifest.frameList=="object"&&typeof this._videoManifest.frameList.targetContent=="string"&&Array.isArray(this._videoManifest.frameList.frames)?this._frameList=this._videoManifest.frameList:Array.isArray(this._videoManifest.frameList)?this._frameList={targetContent:null,frames:this._videoManifest.frameList}:this._frameList={targetContent:null,frames:[]},this._frameList.frames.sort((s,r)=>s.time-r.time),this._frameList.getImage=(s,r=!1)=>{var a,o;return(a=this._player)!=null&&a.videoContainer&&this._player._videoContainer.isTrimEnabled&&!r?s+=this._player.videoContainer.trimStart:!((o=this._player)!=null&&o._videoContainer)&&!r&&console.warn("frameList.getImage(): player instance is null. The trimming information will be ignored."),[...this._frameList.frames].sort((l,h)=>h.time-l.time).find(l=>l.time<s)},Object.defineProperty(this._frameList,"isEmpty",{get(){return Array.isArray(t.frameList)&&t.frameList.length===0||!t.frameList}}),Object.freeze(this._metadata),Object.freeze(this._streams),Object.freeze(this._trimming),Object.freeze(this._captions)}get metadata(){return this._metadata}get streams(){return this._streams}get frameList(){return this._frameList}get captions(){return this._captions}get trimming(){return this._trimming}get visibleTimeLine(){return this._visibleTimeLine}};const zt=Object.freeze(["UNLOADED","LOADING_MANIFEST","MANIFEST","LOADING_PLAYER","LOADED","UNLOADING_MANIFEST","UNLOADING_PLAYER","ERROR"]);function _o(){var n,t,e,i,s,r,a,o;const l=((t=(n=this.videoManifest)==null?void 0:n.metadata)==null?void 0:t.preview)&&ye(this,(i=(e=this.videoManifest)==null?void 0:e.metadata)==null?void 0:i.preview)||this.defaultVideoPreview,h=((r=(s=this.videoManifest)==null?void 0:s.metadata)==null?void 0:r.previewPortrait)&&ye(this,(o=(a=this.videoManifest)==null?void 0:a.metadata)==null?void 0:o.previewPortrait)||this.defaultVideoPreviewPortrait;this._previewContainer=new _f(this,this._containerElement,l,h)}async function Lo(){this._playerState=z.LOADING_MANIFEST,this._manifestLoaded=!0,this.log.debug("Loading paella player"),this._config=await this.initParams.loadConfig(this.configUrl,this),Nf.apply(this.skin,[this._config]),ud(this),this._defaultVideoPreview=this._config.defaultVideoPreview||this._initParams.defaultVideoPreview||"",this._defaultVideoPreviewPortrait=this._config.defaultVideoPreviewPortrait||this._initParams.defaultVideoPreviewPortrait||"",this._cookieConsent=new Df(this,{getConsent:this._initParams.getCookieConsentFunction,getDescription:this._initParams.getCookieDescriptionFunction}),this._preferences=new $f(this);const n=new URLSearchParams(window.location.search),t=new URLSearchParams;for(const[s,r]of n)t.append(s.toLowerCase(),r);const e=t.get("loglevel"),i=e&&Array.from(Object.keys(ut)).indexOf(e.toUpperCase())!==-1?e:this._config.logLevel||"INFO";this._log.setLevel(i),await this._initParams.loadDictionaries(this),af(this),await Rf(this),this._videoContainer=new pf(this,this._containerElement),await this.videoContainer.create();for(const s of this.pluginModules){const r=s.getDictionaries&&await s.getDictionaries();if(r)for(const a in r)pi(a,r[a])}}async function Co(){var n,t;this.log.debug("Video manifest loaded:"),this.log.debug(this.videoManifest),this._data=new zd(this);for(const e in vo){const i=vo[e];pi(e,i)}if(this._playerState=z.MANIFEST,et(this,V.MANIFEST_LOADED),(t=(n=this.videoManifest)==null?void 0:n.metadata)!=null&&t.preview)_o.apply(this);else throw new Error("No preview image found in video manifest, and no default preview image defined.");lf(this._videoManifest)}let Kf=class{constructor(t,e={}){this._log=new Mf(this),this._packageData=fi,this._log.setLevel(ut.VERBOSE),window.__paella_instances__=window.__paella_instances__||[],window.__paella_instances__.push(this),this.log.debug("New paella player instance"),typeof t=="string"&&(t=document.getElementById(t)),t.classList.add("player-container"),this.log.debug("Loading skin manager"),this._skin=new Vf(this),this._containerElement=t,this._initParams=e,this._initParams.manifestFileName=this._initParams.manifestFileName||"data.json",this._initParams.loadConfig=this._initParams.loadConfig||du,this._initParams.getVideoId=this._initParams.getVideoId||fu,this._initParams.getManifestUrl=this._initParams.getManifestUrl||gu,this._initParams.getManifestFileUrl=this._initParams.getManifestFileUrl||pu,this._initParams.loadVideoManifest=this._initParams.loadVideoManifest||mu,this._initParams.translateFunction=this._initParams.translateFunction||Pa,this._initParams.getLanguageFunction=this._initParams.getLanguageFunction||Ma,this._initParams.setLanguageFunction=this._initParams.setLanguageFunction||xa,this._initParams.addDictionaryFunction=this._initParams.addDictionaryFunction||Oa,this._initParams.getDictionariesFunction=this._initParams.getDictionariesFunction||$a,this._initParams.getDefaultLanguageFunction=this._initParams.getDefaultLanguageFunction||Na,this._initParams.Loader=this._initParams.customLoader||vu,this._initParams.getCookieConsentFunction=this._initParams.getCookieConsentFunction||fo,this._initParams.getCookieDescriptionFunction=this._initParams.getCookieDescriptionFunction||go,this._initParams.getProgressIndicator=this._initParams.getProgressIndicator||xf,this._initParams.loadDictionaries=this._initParams.loadDictionaries||async function(r){pi("en",{Hello:"Hello",World:"World"}),pi("es",{Hello:"Hola",World:"Mundo"}),Ka(navigator.language.substring(0,2))};const i=this._initParams.plugins||[];this._initParams.plugins=[...i],rd(this._initParams.translateFunction),ad(this._initParams.setLanguageFunction),od(this._initParams.getLanguageFunction),ld(this._initParams.addDictionaryFunction),hd(this._initParams.getDictionariesFunction),cd(this._initParams.getDefaultLanguageFunction),this._config=null,this._defaultVideoPreview="",this._defaultVideoPreviewPortrait="",this._videoId=null,this._manifestUrl=null,this._manifestFileUrl=null,this._manifestData=null,this._videoManifest=null,this._playerLoaded=!1;const s=()=>{this.resize()};window.addEventListener("resize",s),this.containerElement.addEventListener("fullscreenchange",()=>{et(this,V.FULLSCREEN_CHANGED,{status:this.isFullscreen}),this.isFullscreen?et(this,V.ENTER_FULLSCREEN):et(this,V.EXIT_FULLSCREEN)}),this._playerState=z.UNLOADED,this._customPluginIcons={}}get version(){return this._packageData.version}get pluginModules(){return this.__pluginModules||[]}get log(){return this._log}get ready(){return this._playerState===z.LOADED}get state(){return this._playerState}get stateText(){return zt[this.state]}get Events(){return V}get preferences(){return this._preferences}get skin(){return this._skin}get containsFocus(){return this.containerElement.contains(document.activeElement)}get hideUiTime(){return this._hideUiTime}set hideUiTime(t){this._hideUiTime=t}get containerSize(){return{w:this._containerElement.offsetWidth,h:this._containerElement.offsetHeight}}get containerElement(){return this._containerElement}get initParams(){return this._initParams}get cookieConsent(){return this._cookieConsent}get configLoaded(){return this.configUrl!==null}get videoManifestLoaded(){return this.videoManifest!==null}get videoLoaded(){var t;return((t=this.videoContainer)==null?void 0:t.ready)||!1}get playerLoaded(){return this._playerLoaded}get configResourcesUrl(){var t;return((t=this._initParams)==null?void 0:t.configResourcesUrl)||"config/"}get configUrl(){var t;return((t=this._initParams)==null?void 0:t.configUrl)||"config/config.json"}get config(){return this._config}get defaultVideoPreview(){return this._defaultVideoPreview}get defaultVideoPreviewPortrait(){return this._defaultVideoPreviewPortrait}get videoId(){return this._videoId}get repositoryUrl(){var t,e;return((t=this._initParams)==null?void 0:t.repositoryUrl)||((e=this.config)==null?void 0:e.repositoryUrl)||""}get manifestUrl(){return this._manifestUrl}get manifestFileName(){var t,e;return((t=this.config)==null?void 0:t.manifestFileName)||((e=this._initParams)==null?void 0:e.manifestFileName)||""}get manifestFileUrl(){return this._manifestFileUrl}get videoManifest(){return this._videoManifest}get previewContainer(){return this._previewContainer}get videoContainer(){return this._videoContainer}get playbackBar(){return this._playbackBar}get captionsCanvas(){return this._captionsCanvas}get data(){return this._data}get PlayerState(){return z}get PlayerStateNames(){return zt}get metadata(){var t;return((t=this._manifestParser)==null?void 0:t.metadata)||{}}get streams(){var t;return((t=this._manifestParser)==null?void 0:t.streams)||[]}get frameList(){var t;return((t=this._manifestParser)==null?void 0:t.frameList)||{frames:[]}}get captions(){var t;return((t=this._manifestParser)==null?void 0:t.captions)||[]}get trimming(){var t;return((t=this._manifestParser)==null?void 0:t.trimming)||{}}get visibleTimeLine(){var t;return((t=this._manifestParser)==null?void 0:t.visibleTimeLine)||!0}translate(t,e=null){return gi(t,e)}setLanguage(t){Ka(t)}getLanguage(){return sd()}addDictionary(t,e){pi(t,e)}getDictionaries(){return nd()}getDefaultLanguage(){return Wa(this)}bindEvent(t,e,i=!0){bt(this,t,s=>e(s),i)}getPlugin(t,e=null){if(e){const i=this.__pluginData__.pluginInstances[e];if(i)return i.find(s=>{if(s.name===t)return s})}else{const i={};for(const s in this.__pluginData__.pluginInstances){const r=this.__pluginData__.pluginInstances[s].find(a=>{if(a.name===t)return a});r&&(i[s]=r)}return i}}waitState(t){return new Promise((e,i)=>{const s=()=>{this.state===t?e():setTimeout(s,50)};typeof t=="string"&&(t=z[t]),(t<0||t>Object.values(z).length)&&i(Error(`Invalid player state '${t}'`)),s()})}async loadUrl(t,{title:e,duration:i,preview:s,previewPortrait:r}={}){if(this._playerState!==z.UNLOADED)throw new Error(this.translate("loadUrl(): Invalid current player state: $1",[zt[this._playerState]]));if(this._manifestLoaded)throw new Error(this.translate("loadUrl(): Invalid current player state: $1",[zt[this._playerState]]));if(!t)throw new Error(this.translate("loadUrl(): No URL specified."));Array.isArray(t)||(t=[t]),e||(e=hn(t[0]),this.log.warn("Paella.loadUrl(): no title specified. Using URL file name as video name."));try{if(await Lo.apply(this),!s&&(this.defaultVideoPreview!==""||this.defaultVideoPreviewPortrait!==""))s=this.defaultVideoPreview,r=this.defaultVideoPreviewPortrait,this.log.warn("Paella.loadUrl(): no preview image specified. Using default preview image.");else if(!s&&!r)throw new Error("Paella.loadUrl(): no preview image specified and no default preview image configured.");this._videoId=au(hn(t[0])),this._manifestUrl=ma(t[0]),this._manifestFileUrl=t[0],this.log.debug(`Loading video with identifier '${this.videoId}' from URL '${this.manifestFileUrl}'`);const a=Cd(this,t.length)[0];this._videoManifest={metadata:{duration:i,title:e,preview:s,previewPortrait:r},streams:t.map((o,l)=>({sources:uf(this,o),content:a[l],role:l===0?"mainAudio":null}))},await Co.apply(this)}catch(a){throw this._playerState=z.ERROR,this.log.error(a),this._errorContainer=new un(this,this.translate(a.message)),a}}async loadManifest(){if(this._playerState!==z.UNLOADED)throw new Error(this.translate("loadManifest(): Invalid current player state: $1",[zt[this._playerState]]));if(!this._manifestLoaded)try{if(await Lo.apply(this),this._videoId=await this.initParams.getVideoId(this._config,this),this.videoId===null)throw new Error("No video identifier specified");this._manifestUrl=await this.initParams.getManifestUrl(this.repositoryUrl,this.videoId,this._config,this),this._manifestFileUrl=await this.initParams.getManifestFileUrl(this._manifestUrl,this.manifestFileName,this._config,this),this.log.debug(`Loading video with identifier '${this.videoId}' from URL '${this.manifestFileUrl}'`),this._videoManifest=await this.initParams.loadVideoManifest(this.manifestFileUrl,this._config,this),this._videoManifest.metadata=this._videoManifest.metadata||{},!this._videoManifest.metadata.preview&&(this.defaultVideoPreview!==""||this.defaultVideoPreviewPortrait!=="")&&(this._videoManifest.metadata.preview=this.defaultVideoPreview,this._videoManifest.metadata.previewPortrait=this.defaultVideoPreviewPortrait,this.log.warn("Paella.loadUrl(): no preview image specified. Using default preview image.")),this._manifestParser=new Hf(this.videoManifest,this),To.apply(this.skin),await Gf.apply(this.skin),await Uf.apply(this.skin),await Co.apply(this)}catch(t){throw this._playerState=z.ERROR,this.log.error(t),this._errorContainer=new un(this,this.translate(t.message)),t}}async loadPlayer(){var t,e,i;try{if(this._captionsCanvas=new Af(this,this._containerElement),this._playerState!==z.MANIFEST)throw new Error(this.translate("loadPlayer(): Invalid current player state: $1",[zt[this._playerState]]));this._playerState=z.LOADING_PLAYER,(t=this._previewContainer)==null||t.removeFromParent(),this._loader=new this.initParams.Loader(this),await this._loader.create(),await this.videoContainer.load((e=this.videoManifest)==null?void 0:e.streams),et(this,V.STREAM_LOADED),this._playbackBar=new wf(this,this.containerElement),await this._playbackBar.load(),this._hideUiTime=((i=this.config.ui)==null?void 0:i.hideUITimer)??5e3,lu(this),this._captionsCanvas.load(),this._playerState=z.LOADED,await this.videoContainer.updateLayout(),et(this,V.PLAYER_LOADED),!(this.videoManifest.metadata.visibleTimeLine??!0)&&this.playbackBar.progressIndicator.hideTimeLine(),this._loader.debug||(this._loader.removeFromParent(),this._loader=null)}catch(s){throw this._playerState=z.ERROR,this._loader&&(this._loader.removeFromParent(),this._loader=null),this._errorContainer=new un(this,s.message),s}}async load(){switch(this.state){case z.UNLOADED:await this.loadManifest(),await this.loadPlayer();break;case z.MANIFEST:await this.loadPlayer();break;case z.LOADED:break;default:throw new Error(this.translate("Could not load player: state transition in progress: $1",[zt[this.state]]))}}async unload(){switch(this.state){case z.UNLOADED:break;case z.MANIFEST:await this.unloadManifest();break;case z.LOADED:case z.ERROR:await this.unloadPlayer(),await this.unloadManifest();break;default:throw new Error(this.translate("Could not unload player: state transition in progress: $1",[zt[this.state]]))}}async unloadManifest(){var t;if(this._playerState!==z.MANIFEST&&this._playerState!==z.ERROR)throw new Error(this.translate("unloadManifest(): Invalid current player state: $1",[zt[this._playerState]]));this._errorContainer&&(this._errorContainer.removeFromParent(),this._errorContainer=null),this._playerState=z.UNLOADING_MANIFEST,this.log.debug("Unloading paella player"),await kf(),await of(this),this._manifestLoaded=!1,(t=this._previewContainer)==null||t.removeFromParent(),this._preferences=null,this._playerState=z.UNLOADED,To.apply(this.skin)}async unloadPlayer(){var t,e,i,s,r;if(this._playerState!==z.LOADED&&this._playerState!==z.ERROR)throw new Error(this.translate("unloadManifest(): Invalid current player state: $1",[zt[this._playerState]]));this._errorContainer&&(this._errorContainer.removeFromParent(),this._errorContainer=null),this._playerState=z.UNLOADING_PLAYER,await((t=this._videoContainer)==null?void 0:t.unload()),this._videoContainer=null,await((e=this._playbackBar)==null?void 0:e.unload()),this._playbackBar=null,(i=this._captionsCanvas)==null||i.unload(),this._captionsCanvas=null,hu(this),et(this,V.PLAYER_UNLOADED),(r=(s=this.videoManifest)==null?void 0:s.metadata)!=null&&r.preview&&_o.apply(this),eu(this),this._playerState=z.MANIFEST}async reload(t=null){switch(this.state){case z.UNLOADED:break;case z.MANIFEST:await this.unloadManifest();break;case z.LOADED:await this.unload();break}typeof t=="function"&&await t(),await this.load()}async resize(){var t,e;if((t=this.videoContainer)==null||t.updateLayout(),(e=this.playbackBar)==null||e.onResize(),this.videoContainer){const i=()=>({w:this.videoContainer.element.offsetWidth,h:this.videoContainer.element.offsetHeight});et(this,V.RESIZE,{size:i()}),this._resizeEndTimer&&clearTimeout(this._resizeEndTimer),this._resizeEndTimer=setTimeout(()=>{et(this,V.RESIZE_END,{size:i()})},1e3)}}async hideUserInterface(){var t,e,i;await((t=this.videoContainer)==null?void 0:t.paused())||(this._uiHidden=!0,(e=this.videoContainer)==null||e.hideUserInterface(),(i=this.playbackBar)==null||i.hideUserInterface(),et(this,V.HIDE_UI))}async showUserInterface(){var t,e;(t=this.videoContainer)==null||t.showUserInterface(),(e=this.playbackBar)==null||e.showUserInterface(),this._uiHidden&&et(this,V.SHOW_UI),this._uiHidden=!1}async play(){return this.videoContainer.ready||await this.loadPlayer(),await this.videoContainer.play()}async pause(){var t;return await((t=this.videoContainer)==null?void 0:t.pause())}async togglePlay(){return this.videoContainer.ready?await this.paused()?await this.play():await this.pause():await this.play()}async paused(){return this.videoContainer?this.videoContainer.paused():!0}async stop(){var t;return await((t=this.videoContainer)==null?void 0:t.stop())}async setCurrentTime(t){var e;return await((e=this.videoContainer)==null?void 0:e.setCurrentTime(t))}async currentTime(){var t;return(t=this.videoContainer)==null?void 0:t.currentTime()}async volume(){var t;return(t=this.videoContainer)==null?void 0:t.volume()}async setVolume(t){var e;return(e=this.videoContainer)==null?void 0:e.setVolume(t)}async duration(){var t;return(t=this.videoContainer)==null?void 0:t.duration()}async playbackRate(){var t;return(t=this.videoContainer)==null?void 0:t.playbackRate()}async setPlaybackRate(t){var e;return(e=this.videoContainer)==null?void 0:e.setPlaybackRate(t)}async skipSeconds(t){const e=await this.currentTime();return await this.setCurrentTime(e+t)}async rewindSeconds(t){const e=await this.currentTime();return await this.setCurrentTime(e-t)}isFullScreenSupported(){return this.containerElement.requestFullscreen||this.containerElement.webkitRequestFullScreen}async enterFullscreen(){let t=null;return this.containerElement.requestFullscreen?t=this.containerElement.requestFullscreen():this.containerElement.webkitRequestFullScreen&&(this.log.debug("Safari enter fullscreen"),t=this.containerElement.webkitRequestFullScreen()),setTimeout(()=>this.resize(),500),t}async exitFullscreen(){if(document.exitFullscreen&&this.isFullscreen)return document.exitFullscreen();if(document.webkitCancelFullScreen&&this.isFullscreen)return this.log.debug("Safari exit fullscreen"),document.webkitCancelFullScreen()}get isFullscreen(){return document.fullscreenElement===this.containerElement||document.webkitFullscreenElement===this.containerElement}addCustomPluginIcon(t,e,i){this._customPluginIcons[`${t}-${e}`]=i}removeCustomPluginIcon(t,e){this._customPluginIcons[`${t}-${e}`]=null}getCustomPluginIcon(t,e){return this._requestedCustomIcons=this._requestedCustomIcons||[],this._requestedCustomIcons.find(i=>i.pluginName===t&&i.iconName===e)||this._requestedCustomIcons.push({pluginName:t,iconName:e}),this._customPluginIcons[`${t}-${e}`]}get requestedCustomIcons(){return this._requestedCustomIcons||[]}};var bo=n=>{throw TypeError(n)},So=(n,t,e)=>t.has(n)||bo("Cannot "+e),ts=(n,t,e)=>(So(n,t,"read from private field"),e?e.call(n):t.get(n)),Wf=(n,t,e)=>t.has(n)?bo("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),zf=(n,t,e,i)=>(So(n,t,"write to private field"),t.set(n,e),e),wo=n=>{throw TypeError(n)},An=(n,t,e)=>t.has(n)||wo("Cannot "+e),Ot=(n,t,e)=>(An(n,t,"read from private field"),e?e.call(n):t.get(n)),Si=(n,t,e)=>t.has(n)?wo("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),Rn=(n,t,e,i)=>(An(n,t,"write to private field"),t.set(n,e),e),Io=(n,t,e)=>(An(n,t,"access private method"),e);const At=Object.freeze({PLAY:"paella:play",PAUSE:"paella:pause",STOP:"paella:stop",ENDED:"paella:ended",SEEK:"paella:seek",FULLSCREEN_CHANGED:"paella:fullscreenchanged",ENTER_FULLSCREEN:"paella:enterfullscreen",EXIT_FULLSCREEN:"paella:exitfullscreen",VOLUME_CHANGED:"paella:volumeChanged",TIMEUPDATE:"paella:timeupdate",TRIMMING_CHANGED:"paella:trimmingChanged",CAPTIONS_CHANGED:"paella:captionsChanged",CAPTIONS_ENABLED:"paella:captionsEnabled",CAPTIONS_DISABLED:"paella:captionsDisabled",BUTTON_PRESS:"paella:buttonPress",SHOW_POPUP:"paella:showPopUp",HIDE_POPUP:"paella:hidePopUp",MANIFEST_LOADED:"paella:manifestLoaded",STREAM_LOADED:"paella:streamLoaded",PLAYER_LOADED:"paella:playerLoaded",PLAYER_UNLOADED:"paella:playerUnloaded",RESIZE:"paella:resize",RESIZE_END:"paella:resizeEnd",LAYOUT_CHANGED:"paella:layoutChanged",PLAYBACK_RATE_CHANGED:"paella:playbackRateChanged",VIDEO_QUALITY_CHANGED:"paella:videoQualityChanged",HIDE_UI:"paella:hideUI",SHOW_UI:"paella:showUI",COOKIE_CONSENT_CHANGED:"paella:cookieConsentChanged",LOG:"paella:log"});function re(n,t,e,i=!0){return n.__eventListeners__=n.__eventListeners__||{},Array.isArray(t)||(t=[t]),t.forEach(s=>{n.__eventListeners__[s]=n.__eventListeners__[s]||[],n.__eventListeners__[s].push({callback:e,unregisterOnUnload:i})}),e}function Yf(n){return new Promise((t,e)=>{fetch(n).then(i=>i.text()).then(i=>{t(i)}).catch(i=>e(i))})}function jf(n){const t=new URLSearchParams(window.location.search);return t.has(n)?t.get(n):null}function qf(n){const t=window.location.hash.replace("#","?"),e=new URLSearchParams(t);return e.has(n)?e.get(n):null}function Ao(n,t){const e=t||"/";return n=n.map((i,s)=>(s&&(i=i.replace(new RegExp("^"+e),"")),s!==n.length-1&&(i=i.replace(new RegExp(e+"$"),"")),i)),n.join(e)}function Ro(n){return new RegExp("^([a-z]+://|//)","i").test(n)||/^\//.test(n)}function ko(n){try{return new URL(n).pathname.split("/").pop()}catch{return n.split("/").pop()}}function Zf(n){return n.split(".").reduce((t,e,i,s)=>i<s.length-1?t!==""?`${t}.${e}`:e:t,"")}function Qf(n){const t=e=>{const i=e.split("/").reduce((s,r,a,o)=>a<o.length-1?s!==""?`${s}/${r}`:r:s,"");return(e[0]==="/"?`/${i}`:i)+"/"};try{const e=new URL(n);return e.origin+t(e.pathname)}catch{return t(n)}}function Xf(n){return ko(n).split(".").pop()}function Jf(n,t){return Ro(t)?t:Ao([n.manifestUrl,t])}function tg(n){n.__hideTimerPaused__=!0}function Do(n){n.__hideTimerPaused__=!1}function eg(n,t="hideUiTime"){var e;n.__hideTimer__=null;const i=async()=>n.__hideTimerPaused__?(n.log.debug("UI not hidden because the auto hide timer is paused"),!1):s()?(n.log.debug("UI not hidden because there is a focused element"),!1):(await n.hideUserInterface(),!0);(e=n.config.ui)!=null&&e.hideOnMouseLeave&&n.containerElement.addEventListener("mouseleave",()=>{i()});const s=()=>{const a=document.activeElement,o=document.querySelector(":focus-visible");return(n.playbackBar.element.contains(a)||n.videoContainer.element.contains(a))&&["input","textarea","button"].find(l=>a.tagName.toLowerCase(l))!==-1&&o},r=async()=>{n.__hideTimer__&&clearTimeout(n.__hideTimer__),await n.showUserInterface(),n.__hideTimer__=setTimeout(async()=>{n.__hideTimer__=null,i()||r()},n[t])};n.containerElement.addEventListener("mousemove",async a=>{r()}),re(n,At.PLAY,async()=>{r()}),re(n,At.PAUSE,async()=>{await n.showUserInterface()}),re(n,At.ENDED,async()=>{await n.showUserInterface()}),document.addEventListener("keydown",async()=>{r()})}function ig(n){n.__hideTimer__&&(clearTimeout(n.__hideTimer__),delete n.__hideTimer__)}function sg(n){const t=Math.floor(n/60/60),e=Math.floor(n/60)-t*60,i=Math.floor(n%60);return(t>0?t.toString().padStart(2,"0")+":":"")+e.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")}function ng(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)(\.\d+)?$/.exec(n);if(t){const e=t[1]!==void 0?Number(t[1]):0,i=Number(t[2]),s=Number(t[3]);return e*3600+i*60+s}return null}function rg(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)\.(\d+)?$/.exec(n);if(t){const e=t[1]!==void 0?Number(t[1]):0,i=Number(t[2]),s=Number(t[3]),r=t[4]&&Number(t[4])||0;return e*36e5+i*6e4+s*1e3+r}return null}function Po(n,t,e=365){let i=new Date;i.setTime(i.getTime()+e*24*60*60*1e3);let s=`expires=${i.toUTCString()}`;document.cookie=`${n}=${t};${s};path=/;SameSite=None;`+(/Apple/.test(navigator.vendor)?"":"Secure;")}function ag(n,t,e,i,s=365){n.cookieConsent.getConsentForType(t)&&Po(e,i,s)}function kn(n){let t=n+"=",e=decodeURIComponent(document.cookie).split(";");for(let i=0;i<e.length;++i){let s=e[i];for(;s.charAt(0)==" ";)s=s.substring(1);if(s.indexOf(t)==0)return s.substring(t.length,s.length)}return""}function og(n){const t=kn(n),e=Number(t);return t!==""&&!isNaN(e)?e:null}function lg(n){try{return JSON.parse(kn(n))}catch{return null}}function hg(n,t=!0){return new Promise(e=>{const i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",n),i.onload=()=>e(i);const s=document.getElementsByTagName("head")[0];t&&s.appendChild(i),e()})}function cg(n){document.getElementsByTagName("head")[0].removeChild(n)}function Dn(n,t,e=!0){for(const i in t){const s=n[i];let r=t[i];e&&Array.isArray(s)&&Array.isArray(r)?(s.forEach(a=>{r=r.filter(o=>typeof a=="object"&&typeof o=="object"&&a.id===o.id?(Dn(a,o,e),!1):!0)}),r.forEach(a=>{s.push(a)})):typeof s=="object"&&r?Dn(s,r,e):n[i]=t[i]}}function Pn(n,{excludedTags:t=null}={}){const e=document.createElement("div");e.innerHTML=n;const i=["script"];return t&&i.push(...t),i.flatMap(s=>Array.from(e.getElementsByTagName(s))).forEach(s=>{s.parentElement.removeChild(s)}),e.innerHTML}let es=null;function ug(n){if(!n)return!1;es||(es=document.createElement("video"));let t=es.canPlayType(n);if(t==="maybe"||t==="probably")return!0;if(/video\/mp4/i.test(n))return t=es.canPlayType("video/mp4"),t==="maybe"||t==="probably"}const xo=Object.freeze(Object.defineProperty({__proto__:null,clearAutoHideTimer:ig,getCookie:kn,getFileExtension:Xf,getHashParameter:qf,getJSONCookie:lg,getNumericCookie:og,getUrlFileName:ko,getUrlParameter:jf,isAbsoluteUrl:Ro,joinPath:Ao,loadStyle:hg,loadSvgIcon:Yf,mergeObjects:Dn,pauseAutoHideUiTimer:tg,removeExtension:Zf,removeFileName:Qf,resolveResourcePath:Jf,resumeAutoHideUiTimer:Do,sanitizeHTML:Pn,secondsToTime:sg,setCookie:Po,setCookieIfAllowed:ag,setupAutoHideUiTimer:eg,supportsVideoType:ug,timeToMilliseconds:rg,timeToSeconds:ng,unloadStyle:cg},Symbol.toStringTag,{value:"Module"}));var is;let Mo=class{constructor(t){Si(this,is,null),Rn(this,is,t)}get player(){return Ot(this,is)}};is=new WeakMap;function $t(n,t=null){const e=document.createElement("div");e.innerHTML=n;const i=e.children[0];return t&&t.appendChild(i),i}let dg=class extends Mo{constructor(t,e){super(t),this._name=e}getPluginModuleInstance(){return null}get config(){return this._config}get type(){return"none"}get order(){var t;return((t=this._config)==null?void 0:t.order)||0}get description(){var t;return((t=this._config)==null?void 0:t.description)||""}get name(){return this._name}async isEnabled(){var t;return(t=this.config)==null?void 0:t.enabled}async load(){}async unload(){}};async function fg(){return await new Promise(n=>{const t=document.createElement("audio"),e=setTimeout(()=>n(!1),100);t.addEventListener("volumechange",i=>{clearTimeout(e),n(!0)}),t.volume=.5})}let gg=class extends Mo{get moduleName(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleName'`),"-"}get moduleVersion(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleVersion'`),"0.0.0"}async getDictionaries(){return null}},pg=class extends dg{constructor(t,e,i){super(t,e,i),this.__uiPlugin=!0}async getDictionaries(){return null}},mg="en",yg="";const Oo={};function vg(n){const t=Oo[mg]||{},e=Oo[yg]||{};return t[n]||e[n]||n}let Eg=vg;function Tg(n,t=null){const e=Eg(n);if(Array.isArray(t)){let i=e;return t.forEach((s,r)=>{const a=`$${r+1}`;i=i.replace(a,s)}),i}else return e}const $o=()=>{const n=document.createElement("span");return n.classList.add("side-container"),n.classList.add("hidden"),n};let _g=class{onIconChanged(t,e,i){}onTitleChanged(t,e,i){}onStateChanged(t,e,i,s,r){}};var ss,xn,Le,Ce,ns;let wi=class extends pg{constructor(){super(...arguments),Si(this,ss),Si(this,Le,null),Si(this,Ce,null),Si(this,ns,[])}get type(){return"button"}get container(){return this._container}get button(){return this._button}get interactive(){return!0}get dynamicWidth(){return!1}getId(){return null}get id(){return this.config.id||this.getId()}getButtonName(){return null}get buttonName(){return this.config.name||this.getButtonName()||this.name}get ariaLabel(){return this.config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return null}getDescription(){return""}get description(){return this.config.description||this.getDescription()}get minContainerSize(){return this.config.minContainerSize||this.getMinContainerSize()}getMinContainerSize(){return 0}setObserver(t){if(t instanceof _g)this._observer=t;else if(typeof t.onIconChanged=="function"||typeof t.onTitleChanged=="function"||typeof t.onStateChanged=="function")this._observer=t;else throw new Error("Invalid observer for ButtonPlugin")}get icon(){return this._icon||(this._icon=""),this._icon}set icon(t){typeof t=="string"&&(t=Pn(t)),this._icon=t,Io(this,ss,xn).call(this)}get haveIcon(){return this.icon!==""}get menuIcon(){return this._menuIcon||(this._menuIcon=""),this._menuIcon}set menuIcon(t){typeof t=="string"&&(t=Pn(t)),this._menuIcon=t,Io(this,ss,xn).call(this)}get haveMenuIcon(){return this.menuIcon!==""}get isMenuButton(){var t,e,i;const s=((t=this.config)==null?void 0:t.parentContainer)==="playbackBar"||!((e=this.config)!=null&&e.parentContainer),r=((i=this.config)==null?void 0:i.parentContainer)==="videoContainer";return!s&&!r}get title(){return this._title||""}set title(t){var e;if(this._title=t,t&&this._button instanceof HTMLElement){const i=this._button.querySelector("span")||$t(`<span class="button-title-${this.titleSize}"></span>`,this._button);i.innerHTML=t}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("span");i&&this._button.removeChild(i)}(e=this._observer)!=null&&e.onTitleChanged&&this._observer.onTitleChanged(this,this._title,t)}get titleSize(){return"medium"}get side(){var t;return((t=this.config)==null?void 0:t.side)||"left"}get closePopUps(){return this.config.closePopUps||this.getClosePopUps()}getClosePopUps(){return!0}get parentContainer(){var t;return((t=this.config)==null?void 0:t.parentContainer)||"playbackBar"}get className(){return""}enable(){this._enabled=!0,this.show()}disable(){this._enabled=!1,this.hide()}hide(){this._button&&(this._button.style.display="none")}show(){if(this._enabled===!1)return;const{width:t}=this.player.playbackBar.containerSize;this._button&&(t>this.minContainerSize||this.parentContainer!=="playbackBar")&&(this._button.style.display=null)}get leftSideContainer(){return Ot(this,Le)||(Rn(this,Le,$o()),this.container.appendChild(Ot(this,Le))),Ot(this,Le)}get leftSideContainerPresent(){return Ot(this,Le)!==null}get rightSideContainer(){return Ot(this,Ce)||(Rn(this,Ce,$o()),this.container.appendChild(Ot(this,Ce))),Ot(this,Ce)}get rightSideContainerPresent(){return Ot(this,Ce)!==null}get stateText(){return null}get stateIcon(){return null}setState({text:t=null,icon:e=null}={}){var i,s;const r=this._statusText,a=this._statusIcon;this._statusText=t,this._statusIcon=e,Ot(this,ns).forEach(o=>o(this)),this._statusIcon&&(this.icon=this._statusIcon,this.menuIcon=this._statusIcon),this._statusText&&(this.title=this._statusText),(s=(i=this._observer)==null?void 0:i.onStateChanged)==null||s.call(i,this,r,t,a,e)}onStateChange(t){typeof t=="function"?Ot(this,ns).push(t):this.player.log.warn("Invalid callback for ButtonPlugin.onStateChange")}async action(t,e=null){}onResize({width:t,height:e}){t<this.minContainerSize?this.hide():this.show()}focus(){var t;(t=this.button)==null||t.focus()}blur(){var t;(t=this.button)==null||t.blur()}isFocus(){return this.button===document.activeElement}};ss=new WeakSet,xn=function(){var n;const t=this.isMenuButton?this._menuIcon:this._icon,e=this.isMenuButton&&this.haveMenuIcon?this.menuIcon:this.icon;if(e&&this._button instanceof HTMLElement){const i=this._button.querySelector("i")||$t("<i></i>",this._button);i.innerHTML=e}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("i");i&&this._button.removeChild(i)}(n=this._observer)!=null&&n.onIconChanged&&this._observer.onIconChanged(this,t,e)},Le=new WeakMap,Ce=new WeakMap,ns=new WeakMap;let No=class extends wi{constructor(){super(...arguments),this._refreshContent=!0}set refreshContent(t){this._refreshContent=t}get refreshContent(){return this._refreshContent}get closeParentPopUp(){return this.config.closeParentPopUp||this.getCloseParentPopUp()}getCloseParentPopUp(){return!1}async action(t,e){super.action(t,e),this.parentPopUp=e,await this.showPopUp()}get parentPopUp(){return this._parentPopUp}set parentPopUp(t){this._parentPopUp=t}get popUp(){return this._popUp}get menuTitle(){return this.config.menuTitle||null}get moveable(){return this.config.moveable??!1}get resizeable(){return this.config.resizeable??!1}get customPopUpClass(){return this.config.customPopUpClass??""}get closeActions(){var t,e;const i=((t=this.config.closeActions)==null?void 0:t.clickOutside)??!0,s=((e=this.config.closeActions)==null?void 0:e.closeButton)??!1;return{clickOutside:i,closeButton:s}}get currentContent(){return this._currentContent}async getContent(){return $t("<p>Pop Up Button Plugin Content</p>")}async checkRefreshContent(){if(this.refreshContent){const t=await this.getContent();this._currentContent.innerHTML="",Array.from(t.children).forEach(e=>this._currentContent.appendChild(e))}}get popUpType(){return this.config.popUpType||"modal"}hidePopUp(){this.player.playbackBar.popUp.isHidden||this.player.playbackBar.popUp.hide()}async showPopUp(){this._keyEventHandler||(this._keyEventHandler=e=>{e.key==="Escape"&&this.hidePopUp()},this.button.addEventListener("keydown",this._keyEventHandler));const t=this.player.playbackBar.popUp;if(t.isHidden||this._contentId!==t.currentContentId){const e=await this.getContent();this._currentContent=e,this._contentId=t.show({title:this.menuTitle||this.description,content:e,attachRight:this.popUpType==="timeline"||this.side==="right",attachLeft:this.popUpType==="timeline"||this.side==="left",parent:this.parentPopUp})}else t.hide()}};const Lg=n=>n?`<span class="menu-title">${n}</span>`:"",Cg=n=>n?`<i class="menu-icon">${n}</i>`:"",bg=n=>n?`aria-label="${n}"`:"",Sg=n=>n?`<span class="state-text">${n}</span>`:"",wg=n=>n?`<i class="state-icon">${n}</i>`:"",Ig=(n,t)=>n||t?`<span class="button-state">${Sg(n)}${wg(t)}</span>`:"";function Ag({itemData:n,buttonType:t,container:e,allItems:i,menuName:s,selectedItems:r,itemPlugin:a}){const{id:o=0,title:l=null,icon:h=null,iconText:c=null,showTitle:u=!0,stateText:d=null,stateIcon:g=null}=n,f=this,p=document.createElement("li"),y=r[o]??!1,v=$t(`
		<button class="menu-button-item${y?" selected":""}" ${bg(l)} data-id="${o}"" id="${f.name}_menuItem_${o}">
			${Cg(h)}
			${u?Lg(l):""}
			${d||g?Ig(d,g):""}
		</button>
	`);return a&&(a._button=v),v.addEventListener("keydown",E=>{var _;const T=()=>{E.stopPropagation(),E.preventDefault()};if(E.key==="ArrowUp"){const L=v.dataPrev;L==null||L.focus(),T()}else if(E.key==="ArrowDown"){const L=v.dataNext;L==null||L.focus(),T()}else if(E.key==="Tab"){const L=E.shiftKey?E.target.dataPrev:E.target.dataNext;L==null||L.focus(),T()}else E.key==="Escape"&&(this.player.playbackBar.popUp.pop()?(_=f.button)==null||_.focus():this.focus(),T())}),v.addEventListener("click",async E=>{if(t==="check"){const _=i.find(T=>T.id===o);r[o]=!r[o],f.itemSelected(_,i)}else if(t==="radio"){r[o]=!0;let _=null;i.forEach(T=>{T.id===o?_=T:r[T.id]=!1}),f.itemSelected(_,i)}else{const _=i.find(T=>T.id===o);f.itemSelected(_,i)}await f.checkRefreshContent(),E.stopPropagation(),f.closeOnSelect&&(f.closeMenu(),Do(f.player))}),p.appendChild(v),e.appendChild(p),p}let Xe=class extends No{get closeOnSelect(){return this.config.closeOnSelect===void 0&&(this.buttonType!=="check"?this.config.closeOnSelect=!0:this.config.closeOnSelect=!1),this.config.closeOnSelect}setSelected(t,e){this._selectedItems&&(this._selectedItems[t]=e)}async getContent(){var t,e;const i=(t=document.activeElement)==null?void 0:t.id,s=$t("<menu></menu>");this._content=s;const r=await this.getMenu();this._menuItems=r,this._selectedItems||(this._selectedItems={},this._menuItems.forEach(l=>{l.selected!==void 0&&l.selected!==null&&(this._selectedItems[l.id]=l.selected)}));const a=self.crypto.randomUUID(),o=r.map(l=>Ag.apply(this,[{itemData:l,buttonType:typeof this.buttonType=="function"?this.buttonType():this.buttonType,container:s,allItems:r,menuName:a,selectedItems:this._selectedItems,itemPlugin:l.plugin}]));return o.forEach((l,h,c)=>{const u=l.querySelector("button");let d=c[h+1],g=c[h-1];h===c.length-1&&(d=c[0]),h===0&&(g=c[c.length-1]),u.dataNext=d==null?void 0:d.querySelector("button"),u.dataPrev=g==null?void 0:g.querySelector("button")}),this._firstItem=(e=o[0])==null?void 0:e.querySelector("button"),i&&setTimeout(()=>{var l;(l=document.getElementById(i))==null||l.focus()},10),s}get menuTitle(){return this.config.menuTitle||null}async getMenu(){return[{id:0,title:"Option 1"},{id:1,title:"Option 2"},{id:2,title:"Option 3"},{id:3,title:"Option 4"},{id:4,title:"Option 5"}]}get menuItems(){return this._menuItems}get showTitles(){return!0}get buttonType(){return"radio"}itemSelected(t,e){this.player.log.warn(`MenuButtonPlugin (${this.name}): itemSelected() function not implemented.`)}closeMenu(){this.player.playbackBar.popUp.hide()}async showPopUp(){this.refreshContent=!0,await super.showPopUp(),this.player.containsFocus&&this._firstItem&&this._firstItem.focus()}};Object.freeze({DISABLED:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,VERBOSE:5}).INFO;const Rg="2.2.1",kg={version:Rg};let Mn=null,Nt=class Xc extends gg{static Get(){return Mn||(Mn=new Xc),Mn}get moduleName(){return"paella-basic-plugins"}get moduleVersion(){return kg.version}async getDictionaries(){return{}}};const On=`
<svg width="100%" height="100%" viewBox="0 0 39 32" version="1.1" style="fill:none;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <path style="stroke-width: 1.5pt" d="M38.499,6.519C38.499,3.471 36.028,1 32.981,1C32.981,1 23.993,0.001 19.499,0.001C15.005,0.001 6.017,1 6.017,1C2.97,1 0.499,3.471 0.499,6.519C0.499,6.519 -0.001,12.899 -0.001,15.751C-0.001,18.91 0.499,25.482 0.499,25.482C0.499,28.529 2.97,31 6.017,31C6.017,31 15.506,32 20,32C24.337,32 32.981,31 32.981,31C36.028,31 38.499,28.529 38.499,25.482C38.499,25.482 39,19.161 39,16C39,12.839 38.499,6.519 38.499,6.519Z"/>
</svg>
`;let Dg=class extends Xe{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.audioSelector"}getAriaLabel(){return"Select the active audio track"}getDescription(){return this.getAriaLabel()}get dynamicWidth(){return this.config.showIcon===!1}get titleSize(){return this.config.showIcon===!1?"large":"small"}async isEnabled(){if(!await super.isEnabled())return!1;const t=await this.player.videoContainer.streamProvider.getAudioTracks();return(t==null?void 0:t.length)>1}async load(){this.config.showIcon===!1||(this.icon=this.player.getCustomPluginIcon(this.name,"screenIcon")||On),this._audioTracks=await this.player.videoContainer.streamProvider.getAudioTracks(),await this.updateAudioLabel()}async getMenu(){const t=this.player.videoContainer.streamProvider.currentAudioTrack;return this._audioTracks.map(e=>({id:e.id,title:this.player.translate(e.name)||this.player.translate(e.language),data:e,selected:e===t}))}async updateAudioLabel(){const t=this.player.videoContainer.streamProvider.currentAudioTrack;this.title=t.language}async itemSelected(t){await this.player.videoContainer.streamProvider.setCurrentAudioTrack(t.data),this.updateAudioLabel()}};const Pg=`<svg width="100%" height="100%" viewBox="0 0 27 31" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="repeat" transform="matrix(1,0,0,1,-132.5,-2)">
        <g transform="matrix(1,0,0,1,132.5,2)">
            <path d="M7.364,6.48C9.179,5.515 11.255,4.967 13.461,4.967C20.569,4.967 26.331,10.651 26.331,17.664C26.331,24.676 20.569,30.36 13.461,30.36C8.436,30.36 4.083,27.518 1.964,23.375L1.973,23.34L3.716,22.554C5.531,26.101 9.257,28.534 13.56,28.534C19.645,28.534 24.579,23.667 24.579,17.664C24.579,11.66 19.645,6.793 13.56,6.793C11.624,6.793 9.804,7.286 8.223,8.151L12.5,12L0,12L6.5,0L7.364,6.48Z" style="stroke:none;stroke-width:0.07px;"/>
        </g>
        <g transform="matrix(1.10748,0,0,1.05518,-14.2059,-1.08359)">
            <g>
                <path d="M132.929,20.884L133.826,20.764C133.929,21.273 134.104,21.639 134.352,21.864C134.6,22.088 134.901,22.2 135.257,22.2C135.679,22.2 136.035,22.054 136.326,21.762C136.617,21.469 136.762,21.107 136.762,20.675C136.762,20.263 136.628,19.923 136.359,19.655C136.089,19.388 135.747,19.254 135.332,19.254C135.162,19.254 134.951,19.287 134.699,19.354L134.798,18.566C134.858,18.573 134.906,18.576 134.943,18.576C135.325,18.576 135.669,18.476 135.975,18.277C136.281,18.077 136.433,17.77 136.433,17.355C136.433,17.025 136.322,16.753 136.099,16.537C135.877,16.321 135.589,16.213 135.237,16.213C134.888,16.213 134.597,16.323 134.364,16.542C134.132,16.761 133.982,17.09 133.916,17.529L133.018,17.369C133.128,16.768 133.377,16.302 133.766,15.971C134.155,15.64 134.639,15.475 135.217,15.475C135.616,15.475 135.983,15.561 136.319,15.732C136.654,15.903 136.911,16.136 137.089,16.432C137.267,16.728 137.356,17.042 137.356,17.374C137.356,17.69 137.271,17.978 137.101,18.237C136.932,18.496 136.681,18.702 136.349,18.855C136.781,18.955 137.116,19.162 137.356,19.476C137.595,19.79 137.715,20.183 137.715,20.655C137.715,21.293 137.482,21.834 137.017,22.277C136.551,22.721 135.963,22.943 135.252,22.943C134.61,22.943 134.078,22.752 133.654,22.37C133.23,21.988 132.989,21.492 132.929,20.884Z" style="fill-rule:nonzero;stroke:none;"/>
                <path d="M138.602,19.209C138.602,18.345 138.691,17.649 138.869,17.123C139.047,16.596 139.311,16.19 139.661,15.904C140.012,15.618 140.453,15.475 140.985,15.475C141.377,15.475 141.721,15.554 142.017,15.712C142.313,15.87 142.557,16.097 142.75,16.395C142.943,16.692 143.094,17.055 143.203,17.482C143.313,17.909 143.368,18.485 143.368,19.209C143.368,20.067 143.28,20.759 143.104,21.285C142.928,21.812 142.664,22.219 142.314,22.507C141.963,22.794 141.52,22.938 140.985,22.938C140.28,22.938 139.727,22.685 139.325,22.18C138.843,21.572 138.602,20.582 138.602,19.209ZM139.524,19.209C139.524,20.409 139.665,21.207 139.946,21.604C140.226,22.002 140.573,22.2 140.985,22.2C141.397,22.2 141.744,22.001 142.024,21.602C142.305,21.203 142.446,20.406 142.446,19.209C142.446,18.006 142.305,17.207 142.024,16.811C141.744,16.416 141.394,16.218 140.975,16.218C140.563,16.218 140.234,16.392 139.988,16.741C139.679,17.187 139.524,18.009 139.524,19.209Z" style="fill-rule:nonzero;stroke:none"/>
                <path d="M144.171,21.233L145.058,21.093C145.108,21.449 145.247,21.722 145.474,21.911C145.702,22.101 146.02,22.195 146.429,22.195C146.841,22.195 147.147,22.111 147.346,21.943C147.546,21.776 147.645,21.579 147.645,21.353C147.645,21.15 147.557,20.99 147.381,20.874C147.258,20.794 146.952,20.693 146.464,20.57C145.806,20.404 145.35,20.26 145.095,20.139C144.841,20.017 144.648,19.85 144.517,19.635C144.386,19.421 144.32,19.184 144.32,18.925C144.32,18.689 144.374,18.47 144.482,18.269C144.59,18.068 144.737,17.901 144.923,17.768C145.063,17.665 145.253,17.578 145.494,17.507C145.735,17.435 145.993,17.399 146.269,17.399C146.685,17.399 147.05,17.459 147.364,17.579C147.678,17.699 147.91,17.861 148.059,18.065C148.209,18.269 148.312,18.543 148.368,18.885L147.491,19.005C147.451,18.732 147.335,18.519 147.144,18.367C146.953,18.214 146.683,18.137 146.334,18.137C145.922,18.137 145.628,18.205 145.452,18.342C145.276,18.478 145.188,18.637 145.188,18.82C145.188,18.937 145.224,19.041 145.297,19.134C145.37,19.231 145.485,19.31 145.641,19.374C145.731,19.407 145.995,19.483 146.434,19.603C147.069,19.772 147.512,19.911 147.762,20.019C148.013,20.127 148.21,20.284 148.353,20.49C148.496,20.696 148.568,20.952 148.568,21.258C148.568,21.557 148.48,21.839 148.306,22.103C148.131,22.367 147.88,22.572 147.551,22.716C147.222,22.861 146.849,22.933 146.434,22.933C145.746,22.933 145.222,22.79 144.861,22.504C144.5,22.218 144.27,21.795 144.171,21.233Z" style="fill-rule:nonzero;stroke:none;"/>
            </g>
        </g>
    </g>
</svg>`;let xg=class extends wi{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.backwardButtonPlugin"}getAriaLabel(){return this.player.translate("Backward $1 seconds",[this.time])}getDescription(){return this.getAriaLabel()}async isEnabled(){const t=await super.isEnabled();return this.time=this.config.time||30,t}async load(){const t=this.config.suffix!==void 0?this.config.suffix:!0;this.suffix=t?"s":"",this.icon=this.player.getCustomPluginIcon(this.name,"backwardIcon")||Pg,setTimeout(()=>{var e;Array.from(((e=this.iconElement)==null?void 0:e.getElementsByClassName("time-text"))||[]).forEach(i=>{i.innerHTML=this.time+this.suffix})},100)}async action(){const t=await this.player.videoContainer.currentTime();this.player.videoContainer.setCurrentTime(t-this.time)}};const Mg=`<svg width="100%" height="100%" viewBox="0 0 39 32" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <path d="M37,9.5C37,5.913 34.087,3 30.5,3L8.5,3C4.913,3 2,5.913 2,9.5L2,22.5C2,26.087 4.913,29 8.5,29L30.5,29C34.087,29 37,26.087 37,22.5L37,9.5ZM18.97,21.884C18.97,21.983 18.891,22.125 18.733,22.308C17.111,24.188 15.102,25.128 12.706,25.128C10.21,25.128 8.214,24.217 6.716,22.395C5.319,20.698 4.62,18.577 4.62,16.031C4.62,13.486 5.331,11.356 6.754,9.642C8.268,7.795 10.269,6.872 12.756,6.872C15.277,6.872 17.227,7.725 18.608,9.43C18.741,9.605 18.808,9.75 18.808,9.867C18.808,10.008 18.587,10.426 18.147,11.121C17.706,11.816 17.439,12.163 17.348,12.163C17.24,12.163 16.986,11.959 16.587,11.551C16.096,11.052 15.634,10.678 15.202,10.428C14.486,10.021 13.696,9.817 12.831,9.817C11.184,9.817 9.902,10.445 8.987,11.701C8.172,12.824 7.765,14.238 7.765,15.944C7.765,17.649 8.168,19.076 8.975,20.224C9.89,21.513 11.167,22.158 12.806,22.158C13.621,22.158 14.407,21.954 15.164,21.547C15.663,21.28 16.171,20.902 16.687,20.411C17.119,20.003 17.356,19.8 17.398,19.8C17.448,19.8 17.722,20.13 18.221,20.792C18.721,21.453 18.97,21.817 18.97,21.884ZM34.38,21.884C34.38,21.983 34.301,22.125 34.143,22.308C32.521,24.188 30.512,25.128 28.116,25.128C25.62,25.128 23.624,24.217 22.126,22.395C20.729,20.698 20.03,18.577 20.03,16.031C20.03,13.486 20.741,11.356 22.164,9.642C23.678,7.795 25.678,6.872 28.166,6.872C30.686,6.872 32.637,7.725 34.018,9.43C34.151,9.605 34.218,9.75 34.218,9.867C34.218,10.008 33.997,10.426 33.556,11.121C33.116,11.816 32.849,12.163 32.758,12.163C32.65,12.163 32.396,11.959 31.997,11.551C31.506,11.052 31.044,10.678 30.612,10.428C29.896,10.021 29.106,9.817 28.241,9.817C26.594,9.817 25.312,10.445 24.397,11.701C23.582,12.824 23.174,14.238 23.174,15.944C23.174,17.649 23.578,19.076 24.385,20.224C25.3,21.513 26.577,22.158 28.216,22.158C29.031,22.158 29.817,21.954 30.574,21.547C31.073,21.28 31.581,20.902 32.096,20.411C32.529,20.003 32.766,19.8 32.808,19.8C32.858,19.8 33.132,20.13 33.631,20.792C34.13,21.453 34.38,21.817 34.38,21.884Z" />
</svg>`;let Og=class extends Xe{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.captionsSelectorPlugin"}getAriaLabel(){return"Select captions"}getDescription(){return this.getAriaLabel()}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"captionsIcon")||Mg,this._captionsCanvas=this.player.captionsCanvas,this._selected=null,this._captionsCanvas.captions.length==0&&this.disable(),re(this.player,At.CAPTIONS_CHANGED,()=>{this._captionsCanvas.captions.length>0&&this.enable()}),re(this.player,At.CAPTIONS_ENABLED,t=>{this._selected=t.language}),re(this.player,At.CAPTIONS_DISABLED,()=>{this._selected=null})}async getMenu(){const t=[{id:-1,title:"Disabled",index:-1,selected:this._selected===null}];return this._captionsCanvas.captions.forEach((e,i)=>{t.push({id:e.language,title:e.label,index:i,selected:e.language===this._selected})}),t}get buttonType(){return"radio"}itemSelected(t){t.index===-1?this._captionsCanvas.disableCaptions():this._captionsCanvas.enableCaptions({index:t.index})}};const $g=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
  <path d="M19 18a3.5 3.5 0 0 0 0 -7h-1a5 4.5 0 0 0 -11 -2a4.6 4.4 0 0 0 -2.1 8.4"></path>
  <path d="M12 13l0 9"></path>
  <path d="M9 19l3 3l3 -3"></path>
</svg>`;let Ng=class extends Xe{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.downloadsPlugin"}getAriaLabel(){return Tg("Available downloads")}getDescription(){return this.getAriaLabel()}async isEnabled(){if(!await super.isEnabled())return!1;this._downloads={};const{streams:t}=this.player.videoManifest;return t.forEach(e=>{let i=[];const{mp4:s}=e.sources;s&&s.forEach(r=>{var a,o;i.push({id:`${e.content}_${((a=r.res)==null?void 0:a.w)||0}_${((o=r.res)==null?void 0:o.h)||0}`,src:r.src,res:r.res||{w:0,h:0},mimetype:r.mimetype})}),i.length>0&&(this._downloads[e.content]=i)}),this._downloads=Object.entries(this._downloads).flatMap(([e,i])=>i.map(s=>({content:e,id:s.id,src:s.src,res:s.res,mimetype:s.mimetype}))),this._downloads.length>0}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"downloadIcon")||$g}async getMenu(){return this._downloads.map(t=>({id:t.id,title:`${t.content} - ${t.res.w}x${t.res.h}`,icon:null,selected:!1}))}itemSelected(t){const e=this._downloads.find(i=>i.id===t.id);e&&window.open(e.src,"_blank")}};const Fg=`<svg width="100%" height="100%" viewBox="0 0 256 256" version="1.1" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(1,0,0,1.12928,7.34742,-36.0026)">
        <path d="M64.881,65.571L65.653,58.011C65.716,51.424 73.835,46.089 83.826,46.089C93.857,46.089 102,51.466 102,58.089L101.5,68.542C96.288,64.856 88.807,62.544 80.5,62.544C74.735,62.544 69.368,63.658 64.881,65.571Z"/>
    </g>
    <g transform="matrix(-1,0,0,1.12928,248.653,-36.0026)">
        <path d="M64.881,65.571L65.653,58.011C65.716,51.424 73.835,46.089 83.826,46.089C93.857,46.089 102,51.466 102,58.089L101.5,68.542C96.288,64.856 88.807,62.544 80.5,62.544C74.735,62.544 69.368,63.658 64.881,65.571Z"/>
    </g>
    <g transform="matrix(1,0,0,1.12928,7.34742,-36.0026)">
        <path d="M129.562,96.719L129.624,95.089C129.624,81.291 143.962,70.089 161.624,70.089C179.216,70.089 193.512,81.204 193.623,94.927L193.624,95.089L196.729,121.276C206.965,127.091 212.239,133.908 214.675,146.41C217.073,158.713 223.305,189.137 223.305,192C223.305,209.661 202.813,224 178.805,224C154.797,224 136.305,209.661 134.305,192C133.646,186.176 133.051,180.984 132.515,176.358C129.05,177.4 124.991,178 120.653,178C116.315,178 112.255,177.4 108.79,176.358C108.255,180.984 107.66,186.176 107,192C105,209.661 86.508,224 62.5,224C38.492,224 18,209.661 18,192C18,189.137 24.233,158.713 26.63,146.41C29.066,133.908 34.34,127.091 44.576,121.276L47.682,95.089L47.682,94.927C47.794,81.204 62.089,70.089 79.682,70.089C97.343,70.089 111.682,81.291 111.682,95.089L111.787,97.893C114.663,96.444 118.24,95.585 122.114,95.585C124.782,95.585 127.309,95.992 129.562,96.719ZM63.5,164C82.541,164 98,175.202 98,189C98,202.798 82.541,214 63.5,214C44.459,214 29,202.798 29,189C29,175.202 44.459,164 63.5,164ZM177.805,164C158.764,164 143.305,175.202 143.305,189C143.305,202.798 158.764,214 177.805,214C196.846,214 212.305,202.798 212.305,189C212.305,175.202 196.846,164 177.805,164ZM121,158C127.623,158 133,160.689 133,164C133,167.311 127.623,170 121,170C114.377,170 109,167.311 109,164C109,160.689 114.377,158 121,158Z"/>
    </g>
</svg>`;let Ug=class extends No{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.findCaptionsPlugin"}async getContent(){const t=this.player.translate("Search"),e=$t('<div class="captions-search-container"></div>');this._resultsContainer=$t('<div class="search-results"></div>',e);const i=$t(`<div class="search-input-container">
                <input type="search" placeholder="${t}"/>
            </div>`,e).querySelector("input");i.addEventListener("click",l=>{l.stopPropagation()});const s=navigator.language.substring(0,2),r=l=>this.player.captionsCanvas.currentCaptions?l===this.player.captionsCanvas.currentCaptions.language:l===s,a=()=>{let l=null;this.captions.some(h=>{r(h.language)&&(l=h)}),l||(l=this.captions[0]),this._cueElements=[],l&&l.cues.forEach(h=>{const c=$t(`<p class="result-item">${h.startString}: ${h.captions[0]}</p>`,this._resultsContainer);c._cue=h,c.addEventListener("click",async u=>{const d=u.target._cue.start;await this.player.videoContainer.setCurrentTime(d),u.stopPropagation()}),this._cueElements.push(c)})};a();let o=null;return i.addEventListener("keyup",l=>{o&&clearTimeout(o),this._resultsContainer.innerHTML="";const h=this.player.getLanguage();o=setTimeout(()=>{const c={};this.captions.forEach(u=>{u.cues.forEach(d=>{d.captions.find(g=>new RegExp(i.value,"i").test(g))&&(c[d.startString]=c[d.startString]||{cue:d,text:{}},c[d.startString].text[u.language]=d.captions)})}),this._cueElements=[];for(const u in c){const d=c[u],g=d.text[h]||d.text[Object.keys(d.text)[0]],f=$t(`<p class="result-item">${d.cue.startString}: ${g[0]}</p>`,this._resultsContainer);f._cue=d.cue,f.addEventListener("click",async p=>{const y=p.target._cue.start;await this.player.videoContainer.setCurrentTime(y),p.stopPropagation()}),this._cueElements.push(f)}Object.keys(c).length===0&&i.value!==""?$t(`<p>${this.player.translate("No results found")}</p>`,this._resultsContainer):i.value===""&&a(),o=null},1e3),l.stopPropagation()}),this._timeupdateEvent||(this._timeupdateEvent=async l=>{var h;i.value===""&&(h=this._cueElements)!=null&&h.length&&this._cueElements.forEach(c=>{if(c._cue.start<=l.currentTime&&c._cue.end>=l.currentTime){c.classList.add("current");const u=c.offsetTop-this._resultsContainer.scrollTop;(u<0||u>this._resultsContainer.clientHeight)&&this._resultsContainer.scrollTo({top:c.offsetTop-20})}else c.classList.remove("current")})},this.player.bindEvent(At.TIMEUPDATE,this._timeupdateEvent,!0)),setTimeout(()=>this.refreshContent=!0,10),e}get popUpType(){return"no-modal"}get captions(){return this.player.captionsCanvas.captions}get customPopUpClass(){return"find-captions"}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"findCaptionsIcon")||Fg,this._captionsCanvas=this.player.captionsCanvas,this.captions.length===0&&this.disable(),re(this.player,At.CAPTIONS_CHANGED,()=>{this.captions.length>0&&this.enable()})}};const Bg=`<svg width="100%" height="100%" viewBox="0 0 27 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="repeat" transform="matrix(1,0,0,1,-132.5,-2)">
        <g transform="matrix(-1,0,-0,1,158.831,2)">
            <path d="M7.364,6.48C9.179,5.515 11.255,4.967 13.461,4.967C20.569,4.967 26.331,10.651 26.331,17.664C26.331,24.676 20.569,30.36 13.461,30.36C8.436,30.36 4.083,27.518 1.964,23.375L1.973,23.34L3.716,22.554C5.531,26.101 9.257,28.534 13.56,28.534C19.645,28.534 24.579,23.667 24.579,17.664C24.579,11.66 19.645,6.793 13.56,6.793C11.624,6.793 9.804,7.286 8.223,8.151L12.5,12L0,12L6.5,0L7.364,6.48Z" style="stroke:none;stroke-width:0.07px;"/>
        </g>
        <g transform="matrix(1.10748,0,0,1.05518,-5.70486,-1.08359)">
            <g>
                <path d="M132.929,20.884L133.826,20.764C133.929,21.273 134.104,21.639 134.352,21.864C134.6,22.088 134.901,22.2 135.257,22.2C135.679,22.2 136.035,22.054 136.326,21.762C136.617,21.469 136.762,21.107 136.762,20.675C136.762,20.263 136.628,19.923 136.359,19.655C136.089,19.388 135.747,19.254 135.332,19.254C135.162,19.254 134.951,19.287 134.699,19.354L134.798,18.566C134.858,18.573 134.906,18.576 134.943,18.576C135.325,18.576 135.669,18.476 135.975,18.277C136.281,18.077 136.433,17.77 136.433,17.355C136.433,17.025 136.322,16.753 136.099,16.537C135.877,16.321 135.589,16.213 135.237,16.213C134.888,16.213 134.597,16.323 134.364,16.542C134.132,16.761 133.982,17.09 133.916,17.529L133.018,17.369C133.128,16.768 133.377,16.302 133.766,15.971C134.155,15.64 134.639,15.475 135.217,15.475C135.616,15.475 135.983,15.561 136.319,15.732C136.654,15.903 136.911,16.136 137.089,16.432C137.267,16.728 137.356,17.042 137.356,17.374C137.356,17.69 137.271,17.978 137.101,18.237C136.932,18.496 136.681,18.702 136.349,18.855C136.781,18.955 137.116,19.162 137.356,19.476C137.595,19.79 137.715,20.183 137.715,20.655C137.715,21.293 137.482,21.834 137.017,22.277C136.551,22.721 135.963,22.943 135.252,22.943C134.61,22.943 134.078,22.752 133.654,22.37C133.23,21.988 132.989,21.492 132.929,20.884Z" style="fill-rule:nonzero;stroke:none;"/>
                <path d="M138.602,19.209C138.602,18.345 138.691,17.649 138.869,17.123C139.047,16.596 139.311,16.19 139.661,15.904C140.012,15.618 140.453,15.475 140.985,15.475C141.377,15.475 141.721,15.554 142.017,15.712C142.313,15.87 142.557,16.097 142.75,16.395C142.943,16.692 143.094,17.055 143.203,17.482C143.313,17.909 143.368,18.485 143.368,19.209C143.368,20.067 143.28,20.759 143.104,21.285C142.928,21.812 142.664,22.219 142.314,22.507C141.963,22.794 141.52,22.938 140.985,22.938C140.28,22.938 139.727,22.685 139.325,22.18C138.843,21.572 138.602,20.582 138.602,19.209ZM139.524,19.209C139.524,20.409 139.665,21.207 139.946,21.604C140.226,22.002 140.573,22.2 140.985,22.2C141.397,22.2 141.744,22.001 142.024,21.602C142.305,21.203 142.446,20.406 142.446,19.209C142.446,18.006 142.305,17.207 142.024,16.811C141.744,16.416 141.394,16.218 140.975,16.218C140.563,16.218 140.234,16.392 139.988,16.741C139.679,17.187 139.524,18.009 139.524,19.209Z" style="fill-rule:nonzero;stroke:none;"/>
                <path d="M144.171,21.233L145.058,21.093C145.108,21.449 145.247,21.722 145.474,21.911C145.702,22.101 146.02,22.195 146.429,22.195C146.841,22.195 147.147,22.111 147.346,21.943C147.546,21.776 147.645,21.579 147.645,21.353C147.645,21.15 147.557,20.99 147.381,20.874C147.258,20.794 146.952,20.693 146.464,20.57C145.806,20.404 145.35,20.26 145.095,20.139C144.841,20.017 144.648,19.85 144.517,19.635C144.386,19.421 144.32,19.184 144.32,18.925C144.32,18.689 144.374,18.47 144.482,18.269C144.59,18.068 144.737,17.901 144.923,17.768C145.063,17.665 145.253,17.578 145.494,17.507C145.735,17.435 145.993,17.399 146.269,17.399C146.685,17.399 147.05,17.459 147.364,17.579C147.678,17.699 147.91,17.861 148.059,18.065C148.209,18.269 148.312,18.543 148.368,18.885L147.491,19.005C147.451,18.732 147.335,18.519 147.144,18.367C146.953,18.214 146.683,18.137 146.334,18.137C145.922,18.137 145.628,18.205 145.452,18.342C145.276,18.478 145.188,18.637 145.188,18.82C145.188,18.937 145.224,19.041 145.297,19.134C145.37,19.231 145.485,19.31 145.641,19.374C145.731,19.407 145.995,19.483 146.434,19.603C147.069,19.772 147.512,19.911 147.762,20.019C148.013,20.127 148.21,20.284 148.353,20.49C148.496,20.696 148.568,20.952 148.568,21.258C148.568,21.557 148.48,21.839 148.306,22.103C148.131,22.367 147.88,22.572 147.551,22.716C147.222,22.861 146.849,22.933 146.434,22.933C145.746,22.933 145.222,22.79 144.861,22.504C144.5,22.218 144.27,21.795 144.171,21.233Z" style="fill-rule:nonzero;stroke:none;"/>
            </g>
        </g>
    </g>
</svg>`;let Gg=class extends wi{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.forwardButtonPlugin"}getAriaLabel(){return this.player.translate("Forward $1 seconds",[this.config.time])}getDescription(){return this.getAriaLabel()}async isEnabled(){const t=await super.isEnabled();return this.time=this.config.time||30,t}async load(){const t=this.config.suffix!==void 0?this.config.suffix:!0;this.suffix=t?"s":"",this.icon=this.player.getCustomPluginIcon(this.name,"forwardIcon")||Bg,setTimeout(()=>{var e;Array.from(((e=this.iconElement)==null?void 0:e.getElementsByClassName("time-text"))||[]).forEach(i=>{i.innerHTML=this.time+this.suffix})},100)}async action(){const t=await this.player.videoContainer.currentTime();this.player.videoContainer.setCurrentTime(t+this.time)}};const Vg=`
<svg width="100%" height="100%" viewBox="0 0 34 28" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="FullScreen" transform="matrix(1,0,0,1,-363,-6)">
        <g>
            <g>
                <g transform="matrix(1,0,0,1,-2,2.84217e-14)">
                    <path d="M368.492,8.078L371.207,10.793L369.793,12.207L367.078,9.492L365,11.57L365.014,7.428L365,7.414L365.014,7.4L365.019,6.019L366.4,6.014L366.414,6L366.428,6.014L370.57,6L368.492,8.078Z"/>
                </g>
                <g transform="matrix(1,0,0,-1,-2,40)">
                    <path d="M368.492,8.078L371.207,10.793L369.793,12.207L367.078,9.492L365,11.57L365.014,7.428L365,7.414L365.014,7.4L365.019,6.019L366.4,6.014L366.414,6L366.428,6.014L370.57,6L368.492,8.078Z"/>
                </g>
                <g transform="matrix(-1,0,0,1,762,2.84217e-14)">
                    <path d="M368.492,8.078L371.207,10.793L369.793,12.207L367.078,9.492L365,11.57L365.014,7.428L365,7.414L365.014,7.4L365.019,6.019L366.4,6.014L366.414,6L366.428,6.014L370.57,6L368.492,8.078Z"/>
                </g>
                <g transform="matrix(-1,0,0,-1,762,40)">
                    <path d="M368.492,8.078L371.207,10.793L369.793,12.207L367.078,9.492L365,11.57L365.014,7.428L365,7.414L365.014,7.4L365.019,6.019L366.4,6.014L366.414,6L366.428,6.014L370.57,6L368.492,8.078Z"/>
                </g>
                <g transform="matrix(1,0,0,0.886475,0,2.17871)">
                    <rect x="369" y="12.207" width="22" height="15.793"/>
                </g>
                <g transform="matrix(1,0,0,1,-0.0588586,-0.780796)">
                </g>
            </g>
        </g>
    </g>
</svg>`,Hg=`
<svg width="100%" height="100%" viewBox="0 0 37 29" version="1.1" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="Exit-FullScreen" serif:id="Exit FullScreen" transform="matrix(1,0,0,1,-361.793,-5.79289)">
        <g>
            <g transform="matrix(1,0,0,-1,27,18)">
                <path d="M368.492,8.078L371.207,10.793L369.793,12.207L367.078,9.492L365,11.57L365.014,7.428L365,7.414L365.014,7.4L365.019,6.019L366.4,6.014L366.414,6L366.428,6.014L370.57,6L368.492,8.078Z"/>
            </g>
            <g transform="matrix(-1,0,0,1,733,22)">
                <path d="M368.492,8.078L371.207,10.793L369.793,12.207L367.078,9.492L365,11.57L365.014,7.428L365,7.414L365.014,7.4L365.019,6.019L366.4,6.014L366.414,6L366.428,6.014L370.57,6L368.492,8.078Z"/>
            </g>
            <g transform="matrix(-1,0,0,-1,733,18)">
                <path d="M368.492,8.078L371.207,10.793L369.793,12.207L367.078,9.492L365,11.57L365.014,7.428L365,7.414L365.014,7.4L365.019,6.019L366.4,6.014L366.414,6L366.428,6.014L370.57,6L368.492,8.078Z"/>
            </g>
            <g transform="matrix(1,0,0,1,27,22)">
                <path d="M368.492,8.078L371.207,10.793L369.793,12.207L367.078,9.492L365,11.57L365.014,7.428L365,7.414L365.014,7.4L365.019,6.019L366.4,6.014L366.414,6L366.428,6.014L370.57,6L368.492,8.078Z"/>
            </g>
            <g transform="matrix(1,0,0,0.886475,0,2.17871)">
                <rect x="369" y="12.207" width="22" height="15.793"/>
            </g>
        </g>
    </g>
</svg>`;let Kg=class extends wi{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.fullscreenButton"}getAriaLabel(){return"Toggle fullscreen"}getDescription(){return this.getAriaLabel()}get isFallbackFSAvailable(){const{width:t,height:e}=globalThis.visualViewport,{w:i,h:s}=this.player.containerSize;return t!==i||e!==s}async isEnabled(){return await super.isEnabled()&&this.player.isFullScreenSupported()||this.isFallbackFSAvailable}async load(){const t=this.player.getCustomPluginIcon(this.name,"fullscreenIcon")||Vg,e=this.player.getCustomPluginIcon(this.name,"windowedIcon")||Hg;this.icon=t,re(this.player,At.FULLSCREEN_CHANGED,i=>{i.status?this.icon=e:this.icon=t})}async toggleFS(){this.player.isFullscreen?await this.player.exitFullscreen():await this.player.enterFullscreen()}toggleFallbackFS(){this.player.containerElement.classList.contains("paella-fallback-fullscreen")?this.player.containerElement.classList.remove("paella-fallback-fullscreen"):this.player.containerElement.classList.add("paella-fallback-fullscreen"),setTimeout(()=>{this.player.resize()},100)}async action(){this.player.isFullScreenSupported()?await this.toggleFS():this.toggleFallbackFS()}};const Wg=`
<svg width="100%" height="100%" viewBox="0 0 39 33" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <path d="M38.02,33L20.02,33L20.02,16L38.02,16L38.02,33ZM18.1,31.479L17.261,28.744C17.261,28.744 15.373,29.986 14.365,29.504C13.356,29.022 13.141,28.161 13.141,28.161L15.089,26L10.02,26L10.02,31.317L12.04,29.194C12.04,29.194 12.571,31.145 13.809,31.959C15.732,33.224 18.1,31.479 18.1,31.479ZM35.846,31C35.844,30.985 35.419,26.773 34.821,25.622C34.222,24.47 31.242,24.429 31.242,24.429C31.242,24.429 30.557,27.413 30.373,27.982C30.189,28.55 30.15,28.681 30.15,28.681C30.15,28.681 29.686,25.798 29.604,25.505C29.543,25.285 29.143,25.271 29.058,25.271C28.973,25.271 28.573,25.297 28.512,25.516C28.431,25.809 28.097,28.617 28.097,28.617C28.097,28.617 27.995,28.55 27.811,27.982C27.627,27.413 26.874,24.429 26.874,24.429C26.874,24.429 23.894,24.47 23.295,25.622C22.696,26.775 22.27,31 22.27,31L35.846,31ZM30.15,24.429C30.209,24.682 29.406,25.228 29.406,25.228L28.763,25.212C28.763,25.212 27.907,24.682 27.966,24.429C28.02,24.196 28.753,24.222 29.058,24.219C29.365,24.222 30.096,24.196 30.15,24.429ZM25.02,15L22.02,15L22.02,3L23.02,3L23.02,2L2.02,2L2.02,3L3.02,3L3.02,17L11.79,17L8.396,21.381C8.078,21.995 8.205,22.353 8.367,22.49C8.531,22.629 8.944,22.69 9.341,22.282L12.926,18.594L16.429,22.282C16.589,22.542 16.931,22.561 17.322,22.405C17.601,22.293 17.521,21.746 17.374,21.381L13.875,17L19.02,17L19.02,24L0,24L0,0L25.02,0L25.02,15ZM29.058,17.067C30.719,17.067 32.068,18.527 32.068,20.326C32.068,22.125 30.719,23.586 29.058,23.586C27.397,23.586 26.048,22.125 26.048,20.326C26.048,18.527 27.397,17.067 29.058,17.067ZM21.02,15L21.02,3L4.02,3L4.02,16L19.02,16L19.02,15L21.02,15ZM35.1,14L30.032,14L31.98,11.839C31.98,11.839 31.765,10.978 30.756,10.496C29.747,10.014 27.86,11.256 27.86,11.256L27.02,8.521C27.02,8.521 29.389,6.776 31.312,8.041C32.55,8.855 33.081,10.806 33.081,10.806L35.1,8.683L35.1,14ZM10.744,7.462L6.356,13.008L5.922,12.61L10.727,6.537L13.847,9.959L18.147,5.333L18.55,5.767L13.846,10.826L10.744,7.462Z"/>
</svg>`;let zg=class extends Xe{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.layoutSelector"}getAriaLabel(){return"Video layout"}getDescription(){return this.getAriaLabel()}async isEnabled(){return await super.isEnabled()?this.player.videoContainer.validContentSettings.length>1:!1}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"layoutIcon")||Wg,this._showIcons=this.config.showIcons??!0}async getMenu(){const t=this.player.videoContainer.validContentSettings;return Promise.all(await t.map(async e=>{const i=xo.joinPath([this.player.configResourcesUrl,e.icon]),s=this._showIcons&&await xo.loadSvgIcon(i)||null;return{id:e.id,title:e.title,icon:s,selected:this.player.videoContainer.layoutId===e.id}}))}get showTitles(){return!1}get buttonType(){return"radio"}itemSelected(t){this.player.videoContainer.setLayout(t.id)}};const Yg=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
  <path d="M5.636 19.364a9 9 0 1 1 12.728 0"></path>
  <path d="M16 9l-4 4"></path>
</svg>`;let jg=class extends Xe{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.playbackRateButton"}getAriaLabel(){return"Playback rate"}getDescription(){return this.getAriaLabel()}get dynamicWidth(){return this.config.showIcon===!1}async load(){this.config.showIcon===!1||(this.icon=this.player.getCustomPluginIcon(this.name,"screenIcon")||On,this.menuIcon=this.player.getCustomPluginIcon(this.name,"playbackRateIcon")||Yg);const t=await this.player.videoContainer.playbackRate();this.isMenuButton?(this.title=this.description,this._stateText=`${t}x`):this.title=`${t}x`,this._rates=this.config.rates||[.5,.75,1,1.25,1.5,2],this.player.bindEvent(At.PLAYBACK_RATE_CHANGED,e=>{this.title=e.newPlaybackRate+"x"})}async getMenu(){const t=await this.player.videoContainer.playbackRate(),e=i=>({id:i,title:`${i}x`,selected:i==t});return this._rates.map(i=>e(i))}get titleSize(){return this.config.showIcon===!1?"large":"small"}async itemSelected(t){await this.player.videoContainer.setPlaybackRate(t.id),this.isMenuButton?(this.title=this.description,this._stateText=t.title):this.title=t.title}get buttonType(){return"radio"}get stateText(){return this._stateText}};const qg=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
    <path d="M14 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
    <path d="M4 6l8 0"></path>
    <path d="M16 6l4 0"></path>
    <path d="M8 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
    <path d="M4 12l2 0"></path>
    <path d="M10 12l10 0"></path>
    <path d="M17 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
    <path d="M4 18l11 0"></path>
    <path d="M19 18l1 0"></path>
</svg> `;let Zg=class extends Xe{getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.qualitySelector"}getAriaLabel(){return"Video quality"}getDescription(){return this.getAriaLabel()}get dynamicWidth(){return this.config.showIcon===!1}get titleSize(){return this.config.showIcon===!1?"large":"small"}async isEnabled(){return await super.isEnabled()?(this._qualities=await this.player.videoContainer.streamProvider.getQualities(),this._qualities&&this._qualities.length>1):!1}async load(){this.config.showIcon===!1||(this.icon=this.player.getCustomPluginIcon("es.upv.paella.qualitySelector","screenIcon")||On,this.menuIcon=this.player.getCustomPluginIcon("es.upv.paella.qualitySelector","settingsIcon")||qg),await this.updateQualityLabel()}async getMenu(){await this.updateQualityLabel();const t=await this.player.videoContainer.streamProvider.getCurrentQuality();return this._qualities.map(e=>{const i=e.index===t.index;return{id:e.index,title:e.label,width:e.res.w,height:e.res.h,data:e,selected:i}})}async updateQualityLabel(){const t=async()=>{const e=await this.player.videoContainer.streamProvider.getCurrentQuality();e?this.isMenuButton?(this.title=this.description,this._stateText=e.shortLabel):this.title=e.shortLabel:setTimeout(()=>t(),500)};t()}async itemSelected(t){await this.player.videoContainer.streamProvider.setQuality(t.data),this.updateQualityLabel()}get buttonType(){return"radio"}get stateText(){return this._stateText}};const Qg=`
    <svg width="100%" height="100%" viewBox="0 0 34 30" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
        <g transform="matrix(1,0,0,1,-164.25,-6)">
            <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
        </g>
        <g transform="matrix(1.79727,0,0,1.79727,-310.137,-22.5434)">
            <path d="M184.236,14.634C184.819,14.72 184.834,14.837 185.078,14.956C188.213,16.489 189.629,20.834 187.848,23.947C187.088,25.275 185.842,26.312 184.395,26.83C184.395,26.83 184.071,26.925 183.815,26.778C183.217,26.436 183.496,25.849 184.723,25.159C187.985,23.325 187.943,17.417 183.927,15.98C183.927,15.98 182.939,14.544 184.236,14.634Z" style="fill-rule:nonzero;"/>
        </g>
        <g transform="matrix(2.44245,0,0,2.44245,-427.303,-35.9308)">
            <path d="M184.199,14.815C184.625,14.866 186.828,16.03 187.775,17.801C189.443,20.92 187.935,25.329 184.388,26.637C184.388,26.637 183.459,26.646 183.677,26.009C183.808,25.624 184.344,25.578 184.77,25.344C187.184,24.016 188.202,20.604 186.8,18.153C186.181,17.07 185.166,16.228 183.988,15.807C183.988,15.807 183.242,14.787 184.199,14.815Z" style="fill-rule:nonzero;"/>
        </g>
        <g transform="matrix(1,0,0,1,-125,-5)">
            <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
        </g>
    </svg>`,Xg=`
    <svg width="100%" height="100%" viewBox="0 0 29 29" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-mid" serif:id="volume mid" transform="matrix(1,0,0,1,-165,-5)">
        <g>
            <g transform="matrix(1,0,0,1,0.75,-1)">
                <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1.79727,0,0,1.79727,-145.137,-17.5434)">
                <path d="M184.236,14.634C184.819,14.72 184.834,14.837 185.078,14.956C188.213,16.489 189.629,20.834 187.848,23.947C187.088,25.275 185.842,26.312 184.395,26.83C184.395,26.83 184.071,26.925 183.815,26.778C183.217,26.436 183.496,25.849 184.723,25.159C187.985,23.325 187.943,17.417 183.927,15.98C183.927,15.98 182.939,14.544 184.236,14.634Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1,0,0,1,40,0)">
                <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
            </g>
        </g>
    </g>
    </svg>`,Jg=`<svg width="100%" height="100%" viewBox="0 0 25 29" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-low" serif:id="volume low" transform="matrix(1,0,0,1,-165,-5)">
        <g>
            <g transform="matrix(1,0,0,1,0.75,-1)">
                <path d="M184.233,14.077C188.981,14.489 191.571,24.435 184.954,27.208C183.497,27.819 181.723,25.826 183.988,24.902C187.22,23.511 187.697,17.939 183.734,16.5C183.734,16.5 181.944,14.012 184.233,14.077Z" style="fill-rule:nonzero;"/>
            </g>
            <g transform="matrix(1,0,0,1,40,0)">
                <path d="M131.499,14L139.68,5C140.961,5 142,6.039 142,7.32L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L131.499,14Z"/>
            </g>
        </g>
    </g>
    </svg>`,tp=`<svg width="100%" height="100%" viewBox="0 0 31 31" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <g id="volume-mute" serif:id="volume mute" transform="matrix(1,0,0,1,-123,-4.71142)">
        <path d="M142,28.522L142,31.68C142,32.961 140.961,34 139.68,34L131.499,25L127.375,25C126.063,25 125,23.937 125,22.625L125,16.375C125,15.063 126.063,14 127.375,14L127.478,14L142,28.522ZM151.228,34.983L123,6.756L125.044,4.711L132.848,12.516L139.68,5C140.961,5 142,6.039 142,7.32L142,21.667L153.272,32.939L151.228,34.983Z"/>
    </g>
    </svg>`;var be;let ep=class extends wi{constructor(){super(...arguments),Wf(this,be,null)}getPluginModuleInstance(){return Nt.Get()}get name(){return super.name||"es.upv.paella.volumeButtonPlugin"}async isEnabled(){return await super.isEnabled()&&await fg()}getAriaLabel(){return"Volume"}getDescription(){return this.getAriaLabel()}get className(){return"volume-button"}async updateIcon(t){const e=this.player.getCustomPluginIcon(this.name,"volumeHighIcon")||Qg,i=this.player.getCustomPluginIcon(this.name,"volumeMidIcon")||Xg,s=this.player.getCustomPluginIcon(this.name,"volumeLowIcon")||Jg,r=this.player.getCustomPluginIcon(this.name,"volumeMuteIcon")||tp;switch(!0){case t===0:this.icon=r;break;case(t>0&&t<=.3):this.icon=s;break;case(t>.3&&t<=.6):this.icon=i;break;case t>.6:this.icon=e;break;default:this.icon=e}}get sliderContainer(){return this.config.side==="left"?this.rightArea:this.leftArea}async load(){this.showContainerOnFocus=this.config.showVolumeOnFocus??!0,this.volumeAlwaysVisible=this.config.volumeAlwaysVisible??!1,this._prevVolume=await this.player.videoContainer.volume(),re(this.player,At.VOLUME_CHANGED,({volume:i})=>{this.updateIcon(i)}),this.updateIcon(this._prevVolume);const t=await this.player.videoContainer.volume(),e=this.rightSideContainer;e.innerHTML=`
            <input type="range" class="isu" min="0" max="100" value="${t*100}" class="slider" />
        `,zf(this,be,e.getElementsByTagName("input")[0]),this.player.bindEvent(At.VOLUME_CHANGED,i=>{ts(this,be).value=i.volume*100}),ts(this,be).addEventListener("change",async i=>{this.player.videoContainer.setVolume(i.target.value/100)}),ts(this,be).addEventListener("pointerup",async i=>{var s;(s=document.activeElement)==null||s.blur()}),ts(this,be).addEventListener("keydown",async i=>{if(i.key==="ArrowLeft"||i.key==="ArrowDown"){const s=await this.player.videoContainer.volume();this.player.videoContainer.setVolume(Math.max(0,s-.1)),i.preventDefault(),i.stopPropagation()}else if(i.key==="ArrowRight"||i.key==="ArrowUp"){const s=await this.player.videoContainer.volume();this.player.videoContainer.setVolume(Math.min(s+.1,1)),i.preventDefault(),i.stopPropagation()}})}showSideContainer(){this.volumeAlwaysVisible}hideSideContainer(){this.volumeAlwaysVisible}async mouseOver(t){t===this.container&&this.showSideContainer()}async mouseOut(t){t===this.container&&this.hideSideContainer()}async focusIn(){this.showContainerOnFocus}async focusOut(){this.showContainerOnFocus}async action(){const t=await this.player.videoContainer.volume();console.log("VolumePlugin.action(): ",t);let e=0;t===0&&this._prevVolume===0?e=1:t===0&&this._prevVolume>0?e=this._prevVolume:e=0,await this.player.videoContainer.setVolume(e),this._prevVolume=t}};be=new WeakMap;const ip=[{plugin:Dg,config:{enabled:!1}},{plugin:xg,config:{enabled:!1}},{plugin:Og,config:{enabled:!1}},{plugin:Ng,config:{enabled:!1}},{plugin:Ug,config:{enabled:!1}},{plugin:Gg,config:{enabled:!1}},{plugin:Kg,config:{enabled:!1}},{plugin:zg,config:{enabled:!1}},{plugin:jg,config:{enabled:!1}},{plugin:Zg,config:{enabled:!1}},{plugin:ep,config:{enabled:!1}}];var Fo=n=>{throw TypeError(n)},$n=(n,t,e)=>t.has(n)||Fo("Cannot "+e),pt=(n,t,e)=>($n(n,t,"read from private field"),e?e.call(n):t.get(n)),Je=(n,t,e)=>t.has(n)?Fo("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),rs=(n,t,e,i)=>($n(n,t,"write to private field"),t.set(n,e),e),Uo=(n,t,e)=>($n(n,t,"access private method"),e);const Ii=Object.freeze({PLAY:"paella:play",PAUSE:"paella:pause",STOP:"paella:stop",ENDED:"paella:ended",SEEK:"paella:seek",FULLSCREEN_CHANGED:"paella:fullscreenchanged",ENTER_FULLSCREEN:"paella:enterfullscreen",EXIT_FULLSCREEN:"paella:exitfullscreen",VOLUME_CHANGED:"paella:volumeChanged",TIMEUPDATE:"paella:timeupdate",TRIMMING_CHANGED:"paella:trimmingChanged",CAPTIONS_CHANGED:"paella:captionsChanged",CAPTIONS_ENABLED:"paella:captionsEnabled",CAPTIONS_DISABLED:"paella:captionsDisabled",BUTTON_PRESS:"paella:buttonPress",SHOW_POPUP:"paella:showPopUp",HIDE_POPUP:"paella:hidePopUp",MANIFEST_LOADED:"paella:manifestLoaded",STREAM_LOADED:"paella:streamLoaded",PLAYER_LOADED:"paella:playerLoaded",PLAYER_UNLOADED:"paella:playerUnloaded",RESIZE:"paella:resize",RESIZE_END:"paella:resizeEnd",LAYOUT_CHANGED:"paella:layoutChanged",PLAYBACK_RATE_CHANGED:"paella:playbackRateChanged",VIDEO_QUALITY_CHANGED:"paella:videoQualityChanged",HIDE_UI:"paella:hideUI",SHOW_UI:"paella:showUI",COOKIE_CONSENT_CHANGED:"paella:cookieConsentChanged",LOG:"paella:log"});function Nn(n,t,e,i=!0){return n.__eventListeners__=n.__eventListeners__||{},Array.isArray(t)||(t=[t]),t.forEach(s=>{n.__eventListeners__[s]=n.__eventListeners__[s]||[],n.__eventListeners__[s].push({callback:e,unregisterOnUnload:i})}),e}function Bo(n,t,e={}){n.__eventListeners__&&n.__eventListeners__[t]&&n.__eventListeners__[t].forEach(i=>i.callback(e))}function sp(n){return new Promise((t,e)=>{fetch(n).then(i=>i.text()).then(i=>{t(i)}).catch(i=>e(i))})}function np(n){const t=new URLSearchParams(window.location.search);return t.has(n)?t.get(n):null}function rp(n){const t=window.location.hash.replace("#","?"),e=new URLSearchParams(t);return e.has(n)?e.get(n):null}function Go(n,t){const e=t||"/";return n=n.map((i,s)=>(s&&(i=i.replace(new RegExp("^"+e),"")),s!==n.length-1&&(i=i.replace(new RegExp(e+"$"),"")),i)),n.join(e)}function Vo(n){return new RegExp("^([a-z]+://|//)","i").test(n)||/^\//.test(n)}function Ho(n){try{return new URL(n).pathname.split("/").pop()}catch{return n.split("/").pop()}}function ap(n){return n.split(".").reduce((t,e,i,s)=>i<s.length-1?t!==""?`${t}.${e}`:e:t,"")}function op(n){const t=e=>{const i=e.split("/").reduce((s,r,a,o)=>a<o.length-1?s!==""?`${s}/${r}`:r:s,"");return(e[0]==="/"?`/${i}`:i)+"/"};try{const e=new URL(n);return e.origin+t(e.pathname)}catch{return t(n)}}function lp(n){return Ho(n).split(".").pop()}function Fn(n,t){return Vo(t)?t:Go([n.manifestUrl,t])}function hp(n){n.__hideTimerPaused__=!0}function Ko(n){n.__hideTimerPaused__=!1}function cp(n,t="hideUiTime"){var e;n.__hideTimer__=null;const i=async()=>n.__hideTimerPaused__?(n.log.debug("UI not hidden because the auto hide timer is paused"),!1):s()?(n.log.debug("UI not hidden because there is a focused element"),!1):(await n.hideUserInterface(),!0);(e=n.config.ui)!=null&&e.hideOnMouseLeave&&n.containerElement.addEventListener("mouseleave",()=>{i()});const s=()=>{const a=document.activeElement,o=document.querySelector(":focus-visible");return(n.playbackBar.element.contains(a)||n.videoContainer.element.contains(a))&&["input","textarea","button"].find(l=>a.tagName.toLowerCase(l))!==-1&&o},r=async()=>{n.__hideTimer__&&clearTimeout(n.__hideTimer__),await n.showUserInterface(),n.__hideTimer__=setTimeout(async()=>{n.__hideTimer__=null,i()||r()},n[t])};n.containerElement.addEventListener("mousemove",async a=>{r()}),Nn(n,Ii.PLAY,async()=>{r()}),Nn(n,Ii.PAUSE,async()=>{await n.showUserInterface()}),Nn(n,Ii.ENDED,async()=>{await n.showUserInterface()}),document.addEventListener("keydown",async()=>{r()})}function up(n){n.__hideTimer__&&(clearTimeout(n.__hideTimer__),delete n.__hideTimer__)}function dp(n){const t=Math.floor(n/60/60),e=Math.floor(n/60)-t*60,i=Math.floor(n%60);return(t>0?t.toString().padStart(2,"0")+":":"")+e.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")}function fp(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)(\.\d+)?$/.exec(n);if(t){const e=t[1]!==void 0?Number(t[1]):0,i=Number(t[2]),s=Number(t[3]);return e*3600+i*60+s}return null}function gp(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)\.(\d+)?$/.exec(n);if(t){const e=t[1]!==void 0?Number(t[1]):0,i=Number(t[2]),s=Number(t[3]),r=t[4]&&Number(t[4])||0;return e*36e5+i*6e4+s*1e3+r}return null}function Wo(n,t,e=365){let i=new Date;i.setTime(i.getTime()+e*24*60*60*1e3);let s=`expires=${i.toUTCString()}`;document.cookie=`${n}=${t};${s};path=/;SameSite=None;`+(/Apple/.test(navigator.vendor)?"":"Secure;")}function pp(n,t,e,i,s=365){n.cookieConsent.getConsentForType(t)&&Wo(e,i,s)}function Un(n){let t=n+"=",e=decodeURIComponent(document.cookie).split(";");for(let i=0;i<e.length;++i){let s=e[i];for(;s.charAt(0)==" ";)s=s.substring(1);if(s.indexOf(t)==0)return s.substring(t.length,s.length)}return""}function mp(n){const t=Un(n),e=Number(t);return t!==""&&!isNaN(e)?e:null}function yp(n){try{return JSON.parse(Un(n))}catch{return null}}function vp(n,t=!0){return new Promise(e=>{const i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",n),i.onload=()=>e(i);const s=document.getElementsByTagName("head")[0];t&&s.appendChild(i),e()})}function Ep(n){document.getElementsByTagName("head")[0].removeChild(n)}function Bn(n,t,e=!0){for(const i in t){const s=n[i];let r=t[i];e&&Array.isArray(s)&&Array.isArray(r)?(s.forEach(a=>{r=r.filter(o=>typeof a=="object"&&typeof o=="object"&&a.id===o.id?(Bn(a,o,e),!1):!0)}),r.forEach(a=>{s.push(a)})):typeof s=="object"&&r?Bn(s,r,e):n[i]=t[i]}}function Gn(n,{excludedTags:t=null}={}){const e=document.createElement("div");e.innerHTML=n;const i=["script"];return t&&i.push(...t),i.flatMap(s=>Array.from(e.getElementsByTagName(s))).forEach(s=>{s.parentElement.removeChild(s)}),e.innerHTML}let as=null;function Tp(n){if(!n)return!1;as||(as=document.createElement("video"));let t=as.canPlayType(n);if(t==="maybe"||t==="probably")return!0;if(/video\/mp4/i.test(n))return t=as.canPlayType("video/mp4"),t==="maybe"||t==="probably"}const _p=Object.freeze(Object.defineProperty({__proto__:null,clearAutoHideTimer:up,getCookie:Un,getFileExtension:lp,getHashParameter:rp,getJSONCookie:yp,getNumericCookie:mp,getUrlFileName:Ho,getUrlParameter:np,isAbsoluteUrl:Vo,joinPath:Go,loadStyle:vp,loadSvgIcon:sp,mergeObjects:Bn,pauseAutoHideUiTimer:hp,removeExtension:ap,removeFileName:op,resolveResourcePath:Fn,resumeAutoHideUiTimer:Ko,sanitizeHTML:Gn,secondsToTime:dp,setCookie:Wo,setCookieIfAllowed:pp,setupAutoHideUiTimer:cp,supportsVideoType:Tp,timeToMilliseconds:gp,timeToSeconds:fp,unloadStyle:Ep},Symbol.toStringTag,{value:"Module"}));var os;let Vn=class{constructor(t){Je(this,os,null),rs(this,os,t)}get player(){return pt(this,os)}};os=new WeakMap;function Lp({tag:n="div",attributes:t={},children:e="",innerText:i="",parent:s=null}){const r=document.createElement(n);r.innerText=i;for(let a in t)r.setAttribute(a,t[a]);return r.innerHTML=e,s&&s.appendChild(r),r}function Ai(n,t=null){const e=document.createElement("div");e.innerHTML=n;const i=e.children[0];return t&&t.appendChild(i),i}var Yt;let Cp=class extends Vn{constructor(t,{tag:e="div",attributes:i=[],children:s="",parent:r=null}){super(t),Je(this,Yt,null),rs(this,Yt,Lp({tag:e,attributes:i,children:s,parent:r})),Object.defineProperty(this,e,{get:()=>pt(this,Yt)})}get element(){return pt(this,Yt)}get parent(){return pt(this,Yt).parentElement}hide(){this.element.style.display="none"}show(t="block"){this.element.style.display=null}get isVisible(){const t=window.getComputedStyle(this.element);return t.display!=="none"&&t.display!==""}setAttribute(t,e){pt(this,Yt).setAttribute(t,e)}removeFromParent(){var t;(t=pt(this,Yt).parentElement)==null||t.removeChild(pt(this,Yt))}setParent(t){this.removeFromParent(),t.appendChild(pt(this,Yt))}};Yt=new WeakMap;let zo=class extends Vn{constructor(t,e){super(t),this._name=e}getPluginModuleInstance(){return null}get config(){return this._config}get type(){return"none"}get order(){var t;return((t=this._config)==null?void 0:t.order)||0}get description(){var t;return((t=this._config)==null?void 0:t.description)||""}get name(){return this._name}async isEnabled(){var t;return(t=this.config)==null?void 0:t.enabled}async load(){}async unload(){}},Hn=class extends zo{get type(){return"video"}get streamType(){return"mp4"}async isCompatible(){return!1}async getVideoInstance(){return null}getCompatibleFileExtensions(){return[]}getManifestData(t){}};async function bp(){return await new Promise(n=>{const t=document.createElement("audio"),e=setTimeout(()=>n(!1),100);t.addEventListener("volumechange",i=>{clearTimeout(e),n(!0)}),t.volume=.5})}let Sp=class extends Cp{constructor(t,e,i){const s={class:"video-player"};super(e,{tag:t,attributes:s,parent:i}),this._streamProvider=null,this._streamData=null,this._ready=!1}async isVolumeApiAvailable(){return await bp()}get streamData(){return this._streamData}get ready(){return this._ready}async load(t,e){return this._streamProvider=e,this._streamData=t,await this.loadStreamData(t)}get isMainAudioPlayer(){return this._streamProvider.mainAudioPlayer===this}onVideoEnded(t){this._videoEndedCallback=t}async play(){return!1}async pause(){return!1}async duration(){return-1}get currentTimeSync(){return-1}async currentTime(){return-1}async setCurrentTime(){return!1}async volume(){return-1}async setVolume(){return!1}initVolume(t){this._initialVolume=t}async paused(){return!0}async playbackRate(){return-1}async setPlaybackRate(){return!1}async getQualities(){return null}async setQuality(){return!1}get currentQuality(){return null}async getDimensions(){return null}async supportsMultiaudio(){return!1}async getAudioTracks(){return null}async setCurrentAudioTrack(){}get currentAudioTrack(){return null}async loadStreamData(t){return!1}get isEnabled(){return this._enabled}async enable(){this._enabled=!0}async disable(){this._enabled=!1}},wp=class extends Vn{get moduleName(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleName'`),"-"}get moduleVersion(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleVersion'`),"0.0.0"}async getDictionaries(){return null}},Yo=class extends Sp{constructor(t,e,i,s){super("video",t,e),this._config=s||{};const r=this._config.crossOrigin??"";this.element.setAttribute("playsinline",""),r!==!1&&this.element.setAttribute("crossorigin",r),this.isMainAudio=i,this.element.setAttribute("autoplay",""),this.element.autoplay=!0,i||(this.element.muted=!0),this._videoEnabled=!0}async play(){if(this._videoEnabled)try{return await this.waitForLoaded(),this.video.play()}catch{}else this._disabledProperties.paused=!1}async pause(){if(this._videoEnabled)return await this.waitForLoaded(),this.video.pause();this._disabledProperties.paused=!0}async duration(){return this._videoEnabled?(await this.waitForLoaded(),this.video.duration):this._disabledProperties.duration}get currentTimeSync(){return this._videoEnabled?this.ready?this.video.currentTime:-1:this._disabledProperties.currentTime}async currentTime(){return this._videoEnabled?(await this.waitForLoaded(),this.currentTimeSync):this._disabledProperties.currentTime}async setCurrentTime(t){return this._videoEnabled?(await this.waitForLoaded(),this.video.currentTime=t):(this._disabledProperties.currentTime=t,t)}async volume(){return this._videoEnabled?(await this.waitForLoaded(),this.video.volume):this._disabledProperties.volume}async setVolume(t){return this._videoEnabled?(await this.waitForLoaded(),t===0?this.video.setAttribute("muted",""):this.video.removeAttribute("muted"),this.video.volume=t):(this._disabledProperties.volume=t,t)}async paused(){return this._videoEnabled?(await this.waitForLoaded(),this.video.paused):this._disabledProperties.paused}async playbackRate(){return this._videoEnabled?(await this.waitForLoaded(),await this.video.playbackRate):this._disabledProperties.playbackRate}async setPlaybackRate(t){return this._videoEnabled?(await this.waitForLoaded(),this.video.playbackRate=t):(this._disabledProperties.playbackRate=t,t)}async getQualities(){}async setQuality(){}get currentQuality(){return 0}async getDimensions(){return this._videoEnabled?(await this.waitForLoaded(),{w:this.video.videoWidth,h:this.video.videoHeight}):{w:this._disabledProperties.videoWidth,h:this._disabledProperties.videoHeight}}saveDisabledProperties(t){this._disabledProperties={duration:t.duration,volume:t.volume,videoWidth:t.videoWidth,videoHeight:t.videoHeight,playbackRate:t.playbackRate,paused:t.paused,currentTime:t.currentTime}}async loadStreamData(t=null){this._streamData=this._streamData||t,this.player.log.debug("es.upv.paella.htmlVideoFormat: loadStreamData"),this._sources=t.sources.html,this._currentQuality=0,this.isMainAudioPlayer||(this.video.muted=!0),this._sources.forEach(({src:e,mimetype:i})=>{e=Fn(this.player,e);const s=document.createElement("source");s.src=e,s.type=i,this.video.appendChild(s)}),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback);try{await this.video.play()}catch{}await this.waitForLoaded(),this.player.log.debug(`es.upv.paella.htmlVideoFormat (${this.streamData.content}): video loaded and ready.`),this.saveDisabledProperties(this.video)}async clearStreamData(){this.video.src="",this.video.removeEventListener("ended",this._endedCallback),this.video.removeEventListener("loadeddata",this._handleLoadedCallback),this._ready=!1}get isEnabled(){return this._videoEnabled}async enable(){this._videoEnabled=!0}async disable(){return this.isMainAudio?this.player.log.debug("video.disable() - the video is not disabled because it is the main audio source."):this._videoEnabled=!1,this._videoEnabled}waitForLoaded(){return new Promise((t,e)=>{this.video.readyState>=2&&(this._ready=!0),this.ready?t():(this._handleLoadedCallback=i=>{this.video.readyState>=2&&(this.video.pause(),this._ready=!0,t())},this.video.addEventListener("loadeddata",this._handleLoadedCallback))})}},Se=class{constructor({label:t,shortLabel:e,isAuto:i=!1,index:s=0,src:r="",width:a=-1,height:o=-1,bitrate:l=-1}){this._label=t,this._shortLabel=e,this._index=s,this._src=r,this._res={w:a,h:o},this._bitrate=l,this._isAuto=i}get label(){return this._label}get shortLabel(){return this._shortLabel}get index(){return this._index}get src(){return this._src}get res(){return this._res}get bitrate(){return this._bitrate}get isAuto(){return this._isAuto}get quality(){return this._res.w!==-1&&this._res.h!==-1?this._res.w*this._res.h:this._bitrate}compare(t){return t.quality-this.quality}},Ip=class extends Yo{constructor(t,e,i,s){super(t,e,i,s)}async loadStreamData(t=null){this._streamData=this._streamData||t,this.player.log.debug("es.upv.paella.mp4VideoFormat: loadStreamData"),this._currentSource||(this._sources=null,this._currentQuality=0,this._sources=t.sources.mp4,this._sources.sort((e,i)=>Number(e.res.w)-Number(i.res.w)),this._currentQuality=this._sources.length-1,this._currentSource=this._sources[this._currentQuality]),this.isMainAudioPlayer||(this.video.muted=!0),this._initialVolume&&(this.video.volume=this._initialVolume,this._initialVolume===0&&(this.video.muted=!0)),this.video.src=Fn(this.player,this._currentSource.src),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback);try{await this.video.play()}catch{}await this.waitForLoaded(),this.player.log.debug(`es.upv.paella.mp4VideoFormat (${this.streamData.content}): video loaded and ready.`),this.saveDisabledProperties(this.video)}},Ap=class extends zo{constructor(t,e,i){super(t,e,i),this.__uiPlugin=!0}async getDictionaries(){return null}};const jo=()=>{const n=document.createElement("span");return n.classList.add("side-container"),n.classList.add("hidden"),n};let Rp=class{onIconChanged(t,e,i){}onTitleChanged(t,e,i){}onStateChanged(t,e,i,s,r){}};var ls,Kn,we,Ie,hs;let kp=class extends Ap{constructor(){super(...arguments),Je(this,ls),Je(this,we,null),Je(this,Ie,null),Je(this,hs,[])}get type(){return"button"}get container(){return this._container}get button(){return this._button}get interactive(){return!0}get dynamicWidth(){return!1}getId(){return null}get id(){return this.config.id||this.getId()}getButtonName(){return null}get buttonName(){return this.config.name||this.getButtonName()||this.name}get ariaLabel(){return this.config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return null}getDescription(){return""}get description(){return this.config.description||this.getDescription()}get minContainerSize(){return this.config.minContainerSize||this.getMinContainerSize()}getMinContainerSize(){return 0}setObserver(t){if(t instanceof Rp)this._observer=t;else if(typeof t.onIconChanged=="function"||typeof t.onTitleChanged=="function"||typeof t.onStateChanged=="function")this._observer=t;else throw new Error("Invalid observer for ButtonPlugin")}get icon(){return this._icon||(this._icon=""),this._icon}set icon(t){typeof t=="string"&&(t=Gn(t)),this._icon=t,Uo(this,ls,Kn).call(this)}get haveIcon(){return this.icon!==""}get menuIcon(){return this._menuIcon||(this._menuIcon=""),this._menuIcon}set menuIcon(t){typeof t=="string"&&(t=Gn(t)),this._menuIcon=t,Uo(this,ls,Kn).call(this)}get haveMenuIcon(){return this.menuIcon!==""}get isMenuButton(){var t,e,i;const s=((t=this.config)==null?void 0:t.parentContainer)==="playbackBar"||!((e=this.config)!=null&&e.parentContainer),r=((i=this.config)==null?void 0:i.parentContainer)==="videoContainer";return!s&&!r}get title(){return this._title||""}set title(t){var e;if(this._title=t,t&&this._button instanceof HTMLElement){const i=this._button.querySelector("span")||Ai(`<span class="button-title-${this.titleSize}"></span>`,this._button);i.innerHTML=t}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("span");i&&this._button.removeChild(i)}(e=this._observer)!=null&&e.onTitleChanged&&this._observer.onTitleChanged(this,this._title,t)}get titleSize(){return"medium"}get side(){var t;return((t=this.config)==null?void 0:t.side)||"left"}get closePopUps(){return this.config.closePopUps||this.getClosePopUps()}getClosePopUps(){return!0}get parentContainer(){var t;return((t=this.config)==null?void 0:t.parentContainer)||"playbackBar"}get className(){return""}enable(){this._enabled=!0,this.show()}disable(){this._enabled=!1,this.hide()}hide(){this._button&&(this._button.style.display="none")}show(){if(this._enabled===!1)return;const{width:t}=this.player.playbackBar.containerSize;this._button&&(t>this.minContainerSize||this.parentContainer!=="playbackBar")&&(this._button.style.display=null)}get leftSideContainer(){return pt(this,we)||(rs(this,we,jo()),this.container.appendChild(pt(this,we))),pt(this,we)}get leftSideContainerPresent(){return pt(this,we)!==null}get rightSideContainer(){return pt(this,Ie)||(rs(this,Ie,jo()),this.container.appendChild(pt(this,Ie))),pt(this,Ie)}get rightSideContainerPresent(){return pt(this,Ie)!==null}get stateText(){return null}get stateIcon(){return null}setState({text:t=null,icon:e=null}={}){var i,s;const r=this._statusText,a=this._statusIcon;this._statusText=t,this._statusIcon=e,pt(this,hs).forEach(o=>o(this)),this._statusIcon&&(this.icon=this._statusIcon,this.menuIcon=this._statusIcon),this._statusText&&(this.title=this._statusText),(s=(i=this._observer)==null?void 0:i.onStateChanged)==null||s.call(i,this,r,t,a,e)}onStateChange(t){typeof t=="function"?pt(this,hs).push(t):this.player.log.warn("Invalid callback for ButtonPlugin.onStateChange")}async action(t,e=null){}onResize({width:t,height:e}){t<this.minContainerSize?this.hide():this.show()}focus(){var t;(t=this.button)==null||t.focus()}blur(){var t;(t=this.button)==null||t.blur()}isFocus(){return this.button===document.activeElement}};ls=new WeakSet,Kn=function(){var n;const t=this.isMenuButton?this._menuIcon:this._icon,e=this.isMenuButton&&this.haveMenuIcon?this.menuIcon:this.icon;if(e&&this._button instanceof HTMLElement){const i=this._button.querySelector("i")||Ai("<i></i>",this._button);i.innerHTML=e}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("i");i&&this._button.removeChild(i)}(n=this._observer)!=null&&n.onIconChanged&&this._observer.onIconChanged(this,t,e)},we=new WeakMap,Ie=new WeakMap,hs=new WeakMap;let Dp=class extends kp{constructor(){super(...arguments),this._refreshContent=!0}set refreshContent(t){this._refreshContent=t}get refreshContent(){return this._refreshContent}get closeParentPopUp(){return this.config.closeParentPopUp||this.getCloseParentPopUp()}getCloseParentPopUp(){return!1}async action(t,e){super.action(t,e),this.parentPopUp=e,await this.showPopUp()}get parentPopUp(){return this._parentPopUp}set parentPopUp(t){this._parentPopUp=t}get popUp(){return this._popUp}get menuTitle(){return this.config.menuTitle||null}get moveable(){return this.config.moveable??!1}get resizeable(){return this.config.resizeable??!1}get customPopUpClass(){return this.config.customPopUpClass??""}get closeActions(){var t,e;const i=((t=this.config.closeActions)==null?void 0:t.clickOutside)??!0,s=((e=this.config.closeActions)==null?void 0:e.closeButton)??!1;return{clickOutside:i,closeButton:s}}get currentContent(){return this._currentContent}async getContent(){return Ai("<p>Pop Up Button Plugin Content</p>")}async checkRefreshContent(){if(this.refreshContent){const t=await this.getContent();this._currentContent.innerHTML="",Array.from(t.children).forEach(e=>this._currentContent.appendChild(e))}}get popUpType(){return this.config.popUpType||"modal"}hidePopUp(){this.player.playbackBar.popUp.isHidden||this.player.playbackBar.popUp.hide()}async showPopUp(){this._keyEventHandler||(this._keyEventHandler=e=>{e.key==="Escape"&&this.hidePopUp()},this.button.addEventListener("keydown",this._keyEventHandler));const t=this.player.playbackBar.popUp;if(t.isHidden||this._contentId!==t.currentContentId){const e=await this.getContent();this._currentContent=e,this._contentId=t.show({title:this.menuTitle||this.description,content:e,attachRight:this.popUpType==="timeline"||this.side==="right",attachLeft:this.popUpType==="timeline"||this.side==="left",parent:this.parentPopUp})}else t.hide()}};const Pp=n=>n?`<span class="menu-title">${n}</span>`:"",xp=n=>n?`<i class="menu-icon">${n}</i>`:"",Mp=n=>n?`aria-label="${n}"`:"",Op=n=>n?`<span class="state-text">${n}</span>`:"",$p=n=>n?`<i class="state-icon">${n}</i>`:"",Np=(n,t)=>n||t?`<span class="button-state">${Op(n)}${$p(t)}</span>`:"";function Fp({itemData:n,buttonType:t,container:e,allItems:i,menuName:s,selectedItems:r,itemPlugin:a}){const{id:o=0,title:l=null,icon:h=null,iconText:c=null,showTitle:u=!0,stateText:d=null,stateIcon:g=null}=n,f=this,p=document.createElement("li"),y=r[o]??!1,v=Ai(`
		<button class="menu-button-item${y?" selected":""}" ${Mp(l)} data-id="${o}"" id="${f.name}_menuItem_${o}">
			${xp(h)}
			${u?Pp(l):""}
			${d||g?Np(d,g):""}
		</button>
	`);return a&&(a._button=v),v.addEventListener("keydown",E=>{var _;const T=()=>{E.stopPropagation(),E.preventDefault()};if(E.key==="ArrowUp"){const L=v.dataPrev;L==null||L.focus(),T()}else if(E.key==="ArrowDown"){const L=v.dataNext;L==null||L.focus(),T()}else if(E.key==="Tab"){const L=E.shiftKey?E.target.dataPrev:E.target.dataNext;L==null||L.focus(),T()}else E.key==="Escape"&&(this.player.playbackBar.popUp.pop()?(_=f.button)==null||_.focus():this.focus(),T())}),v.addEventListener("click",async E=>{if(t==="check"){const _=i.find(T=>T.id===o);r[o]=!r[o],f.itemSelected(_,i)}else if(t==="radio"){r[o]=!0;let _=null;i.forEach(T=>{T.id===o?_=T:r[T.id]=!1}),f.itemSelected(_,i)}else{const _=i.find(T=>T.id===o);f.itemSelected(_,i)}await f.checkRefreshContent(),E.stopPropagation(),f.closeOnSelect&&(f.closeMenu(),Ko(f.player))}),p.appendChild(v),e.appendChild(p),p}let Up=class extends Dp{get closeOnSelect(){return this.config.closeOnSelect===void 0&&(this.buttonType!=="check"?this.config.closeOnSelect=!0:this.config.closeOnSelect=!1),this.config.closeOnSelect}setSelected(t,e){this._selectedItems&&(this._selectedItems[t]=e)}async getContent(){var t,e;const i=(t=document.activeElement)==null?void 0:t.id,s=Ai("<menu></menu>");this._content=s;const r=await this.getMenu();this._menuItems=r,this._selectedItems||(this._selectedItems={},this._menuItems.forEach(l=>{l.selected!==void 0&&l.selected!==null&&(this._selectedItems[l.id]=l.selected)}));const a=self.crypto.randomUUID(),o=r.map(l=>Fp.apply(this,[{itemData:l,buttonType:typeof this.buttonType=="function"?this.buttonType():this.buttonType,container:s,allItems:r,menuName:a,selectedItems:this._selectedItems,itemPlugin:l.plugin}]));return o.forEach((l,h,c)=>{const u=l.querySelector("button");let d=c[h+1],g=c[h-1];h===c.length-1&&(d=c[0]),h===0&&(g=c[c.length-1]),u.dataNext=d==null?void 0:d.querySelector("button"),u.dataPrev=g==null?void 0:g.querySelector("button")}),this._firstItem=(e=o[0])==null?void 0:e.querySelector("button"),i&&setTimeout(()=>{var l;(l=document.getElementById(i))==null||l.focus()},10),s}get menuTitle(){return this.config.menuTitle||null}async getMenu(){return[{id:0,title:"Option 1"},{id:1,title:"Option 2"},{id:2,title:"Option 3"},{id:3,title:"Option 4"},{id:4,title:"Option 5"}]}get menuItems(){return this._menuItems}get showTitles(){return!0}get buttonType(){return"radio"}itemSelected(t,e){this.player.log.warn(`MenuButtonPlugin (${this.name}): itemSelected() function not implemented.`)}closeMenu(){this.player.playbackBar.popUp.hide()}async showPopUp(){this.refreshContent=!0,await super.showPopUp(),this.player.containsFocus&&this._firstItem&&this._firstItem.focus()}};Object.freeze({DISABLED:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,VERBOSE:5}).INFO;let qo=class{constructor({id:t,name:e,groupId:i="",language:s="",selected:r=!1}){this._id=t,this._name=e,this._groupId=i,this._lang=s,this._selected=r}get id(){return this._id}get name(){return this._name}get groupId(){return this._groupId}get language(){return this._lang}get selected(){return this._selected}set selected(t){this._selected=t}};const Bp="2.2.0",Gp={version:Bp};let Wn=null,cs=class Jc extends wp{static Get(){return Wn||(Wn=new Jc),Wn}get moduleName(){return"paella-video-plugins"}get moduleVersion(){return Gp.version}};const Zo={autoStartLoad:!0,startPosition:-1,capLevelToPlayerSize:!0,debug:!1,defaultAudioCodec:void 0,initialLiveManifestSize:1,maxBufferLength:6,maxMaxBufferLength:6,maxBufferSize:600*1e3*1e3,maxBufferHole:.5,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:500,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:500,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:500,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,appendErrorMaxRetry:3,enableWebVTT:!0,enableCEA708Captions:!0,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:5,abrEwmaSlowLive:9,abrEwmaFastVoD:4,abrEwmaSlowVoD:15,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,minAutoBitrate:0},Qo={withCredentials:!0,requestHeaders:{"Access-Control-Allow-Headers":"Content-Type, Accept, X-Requested-With","Access-Control-Allow-Origin":"http://localhost:8000","Access-Control-Allow-Credentials":"true"}},Lt={UNSUPPORTED:0,MEDIA_SOURCE_EXTENSIONS:1,NATIVE:2};let zn=null;async function Yn(){return zn||(console.debug("Loading HLS.js"),zn=(await Promise.resolve().then(()=>w2)).default),zn}async function jt(n=!1){const t=await Yn(),e=document.createElement("video");return e.canPlayType("application/vnd.apple.mpegurl")&&n?Lt.NATIVE:t.isSupported()?Lt.MEDIA_SOURCE_EXTENSIONS:e.canPlayType("application/vnd.apple.mpegurl")?Lt.NATIVE:Lt.UNSUPPORTED}const Vp=async(n,t,e,i,s)=>{var r,a;const o=await Yn();s.withCredentials&&(i.xhrSetup=function(c,u){c.withCredentials=s.withCredentials;for(const d in s.requestHeaders){const g=s.requestHeaders[d];c.setRequestHeader(d,g)}}),i.autoStartLoad=!0;const l=new o(i),h=((a=(r=t==null?void 0:t.sources)==null?void 0:r.hls)==null?void 0:a.length)>0&&t.sources.hls[0];return[l,new Promise((c,u)=>{let d=!1;l.on(o.Events.LEVEL_SWITCHED,(y,v)=>{n.log.debug(`HLS: quality level switched to ${v.level}`),d||(l.currentLevel=-1,d=!0),Bo(n,Ii.VIDEO_QUALITY_CHANGED,{})}),l.on(o.Events.ERROR,(y,v)=>{if(v.fatal)switch(v.type){case o.ErrorTypes.NETWORK_ERROR:v.details===o.ErrorDetails.MANIFEST_LOAD_ERROR?u(Error("hlsVideoFormatPlugin: unrecoverable error in HLS player. The video is not available")):(n.log.warn("hlsVideoFormatPlugin: Fatal network error. Try to recover"),l.startLoad());break;case o.ErrorTypes.MEDIA_ERROR:n.log.warn("hlsVideoFormatPlugin: Fatal media error encountered. Try to recover"),l.recoverMediaError();break;default:l.destroy(),u(Error("hlsVideoFormat: Fatal error. Can not recover"))}else n.log.warn("HLS: error"),n.log.warn(v.details)}),l.on(o.Events.LEVEL_SWITCHING,()=>{n.log.debug("HLS media attached")}),l.on(o.Events.MEDIA_ATTACHED,()=>{n.log.debug("HLS media attached")}),l.on(o.Events.MEDIA_DETACHING,()=>{n.log.debug("HLS media detaching")}),l.on(o.Events.MEDIA_DETACHED,()=>{n.log.debug("HLS media detached")}),l.on(o.Events.MANIFEST_PARSED,()=>{n.log.debug("HLS manifest parsed"),l.startLoad(-1)});const g=Math.floor(Math.random()*1e11),f=h.src+(i.enableCache?/\?/.test(h.src)?`&cache=${g}`:`?cache=${g}`:"");l.loadSource(f),l.attachMedia(e);let p=!1;l._videoEventListener=()=>{p=!0,c()},e.addEventListener("canplay",l._videoEventListener),setTimeout(()=>{p||e.play()},1e3)})]};let Xo=class extends Yo{constructor(t,e,i,s){super(t,e,s,i),this._config=this._config||{audioTrackLabel:i.audioTrackLabel||"name",enableCache:i.enableCache||!1};for(const r in Zo)this._config[r]=Zo[r];for(const r in i.hlsConfig)this._config[r]=i.hlsConfig[r];this._cors={};for(const r in Qo)this._cors[r]=Qo[r];for(const r in i.corsConfig)this._cors[r]=i.corsConfig[r];this._ready=!1,this._autoQuality=!0,this._forceNative=i.forceNative||!1}get autoQuality(){return this._autoQuality}get forceNative(){return this._forceNative}async loadStreamData(t){var e,i;if(await jt(this.forceNative)===Lt.NATIVE){t.sources.mp4=t.sources.hls;const s=await super.loadStreamData(t),r=await this.getAudioTracks();return this._currentAudioTrack=r.find(a=>a.selected),this._autoQuality=new Se({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality,this.saveDisabledProperties(this.video),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback),s}else{this.player.log.debug("Loading HLS stream");const s=((i=(e=t==null?void 0:t.sources)==null?void 0:e.hls)==null?void 0:i.length)&&t.sources.hls[0];this._config.audioTrackLabel=(s==null?void 0:s.audioLabel)||this._config.audioTrackLabel;const[r,a]=await Vp(this.player,t,this.video,this._config,this._cors);this._hls=r,await a,this.video.pause(),this._autoQuality=new Se({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality;const o=await this.getAudioTracks();this._currentAudioTrack=o.find(l=>l.selected),this.saveDisabledProperties(this.video),this._endedCallback=this._endedCallback||(()=>{typeof this._videoEndedCallback=="function"&&this._videoEndedCallback()}),this.video.addEventListener("ended",this._endedCallback)}}async duration(){var t;if(this._videoEnabled){await this.waitForLoaded();let e=this.video.duration;return e===1/0&&(e=((t=this._hls)==null?void 0:t.liveSyncPosition)||0),e}else return this._disabledProperties.duration}async waitForLoaded(){if(await jt(this.forceNative)===Lt.NATIVE)return super.waitForLoaded();await new Promise((t,e)=>{const i=()=>{this._ready&&t(),this.video.readyState>=2?(this._ready=!0,t()):setTimeout(()=>i(),200)};i()})}async getQualities(){const t=[];return t.push(this._autoQuality),await jt(this.forceNative)===Lt.MEDIA_SOURCE_EXTENSIONS&&(this._hls.levels.forEach((e,i)=>{t.push(new Se({index:i,label:`${e.width}x${e.height}`,shortLabel:`${e.height}p`,width:e.width,height:e.height}))}),t.sort((e,i)=>e.res.h-i.res.h)),t}async setQuality(t){const e=await jt(this.forceNative);if(this._videoEnabled){if(!(t instanceof Se))throw Error("Invalid parameter setting video quality. VideoQualityItem object expected.");e===Lt.MEDIA_SOURCE_EXTENSIONS?(this._currentQuality=t,this._hls.currentLevel=t.index):this.player.log.warn("Could not set video quality of HLS stream, because the HLS support of this browser is native.")}}get currentQuality(){return this._currentQuality}async supportsMultiaudio(){var t;await this.waitForLoaded();const e=await jt(this.forceNative);return e===Lt.MEDIA_SOURCE_EXTENSIONS?this._hls.audioTracks.length>1:e===Lt.NATIVE?((t=this.video.audioTracks)==null?void 0:t.length)>1:!1}async getAudioTracks(){await this.waitForLoaded();const t=this._config.audioTrackLabel||"name",e=await jt(this.forceNative);return e===Lt.MEDIA_SOURCE_EXTENSIONS?this._hls.audioTracks.map(i=>new qo({id:i.id,name:i[t],language:i.lang,selected:this._hls.audioTrack===i.id})):e===Lt.NATIVE?Array.from(this.video.audioTracks).map(i=>new qo({id:i.id,name:i.label,language:i.language,selected:i.enabled})):null}async setCurrentAudioTrack(t){await this.waitForLoaded();const e=(await this.getAudioTracks()).find(s=>s.id===t.id),i=await jt(this.forceNative);return i===Lt.MEDIA_SOURCE_EXTENSIONS&&e?this._hls.audioTrack=e.id:i===Lt.NATIVE&&e&&Array.from(this.video.audioTracks).forEach(s=>{s.id===e.id?s.enabled=!0:s.enabled=!1}),this._currentAudioTrack=e,e}get currentAudioTrack(){return this._currentAudioTrack}async clearStreamData(){this.video.removeEventListener("canplay",this._hls._videoEventListener),this.video.src="",this._hls.destroy(),this._ready=!1}},Hp=class extends Hn{getPluginModuleInstance(){return cs.Get()}get name(){return super.name||"es.upv.paella.hlsVideoFormat"}get streamType(){return"hls"}async isCompatible(t){const{hls:e}=t.sources;return e&&await jt()}async getVideoInstance(t,e){return new Xo(this.player,t,this.config,e)}getCompatibleFileExtensions(){return["m3u8"]}getManifestData(t){return{hls:t.map(e=>({src:e,mimetype:"video/mp4"}))}}};const Kp=async(n,t,e,i,s)=>{var r,a;const o=await Yn();s.withCredentials&&(i.xhrSetup=function(c,u){c.withCredentials=s.withCredentials;for(const d in s.requestHeaders){const g=s.requestHeaders[d];c.setRequestHeader(d,g)}});const l=new o(i),h=((a=(r=t==null?void 0:t.sources)==null?void 0:r.hlsLive)==null?void 0:a.length)>0&&t.sources.hlsLive[0];return i.initialQualityLevel!==void 0&&i.initialQualityLevel,[l,new Promise((c,u)=>{let d=!1;l.on(o.Events.LEVEL_SWITCHED,(p,y)=>{(void 0).player.log.debug(`HLS: quality level switched to ${y.level}`),d||(l.currentLevel=-1,d=!0),Bo(n,Ii.VIDEO_QUALITY_CHANGED,{})}),l.on(o.Events.ERROR,(p,y)=>{if(y.fatal)switch(y.type){case o.ErrorTypes.NETWORK_ERROR:y.details===o.ErrorDetails.MANIFEST_LOAD_ERROR?u(Error("hlsVideoFormatPlugin: unrecoverable error in HLS player. The video is not available")):(n.log.warn("hlsVideoFormatPlugin: Fatal network error. Try to recover"),l.startLoad());break;case o.ErrorTypes.MEDIA_ERROR:n.log.warn("hlsVideoFormatPlugin: Fatal media error encountered. Try to recover"),l.recoverMediaError();break;default:l.destroy(),u(Error("hlsVideoFormat: Fatal error. Can not recover"))}}),l.on(o.Events.MANIFEST_PARSED,()=>{i.autoStartLoad||l.autoStartLoad()});const g=Math.floor(Math.random()*1e11),f=h.src+(i.enableCache?/\?/.test(h.src)?`&cache=${g}`:`?cache=${g}`:"");l.loadSource(f),l.attachMedia(e),l._videoEventListener=()=>{c()},e.addEventListener("canplay",l._videoEventListener)})]};let Wp=class extends Xo{async loadStreamData(t){if(await jt()===Lt.NATIVE)return t.sources.hls=t.sources.hlsLive,super.loadStreamData(t);{this.player.log.debug("Loading HLS stream");const[e,i]=await Kp(this.player,t,this.video,this._config,this._cors);this._hls=e,await i,this._autoQuality=new Se({label:"auto",shortLabel:"auto",index:-1,width:1,height:1,isAuto:!0}),this._currentQuality=this._autoQuality;const s=await this.getAudioTracks();this._currentAudioTrack=s.find(r=>r.selected),this.saveDisabledProperties(this.video)}}},zp=class extends Hn{getPluginModuleInstance(){return cs.Get()}get name(){return super.name||"es.upv.paella.hlsLiveVideoFormat"}get streamType(){return"hlsLive"}async isCompatible(t){const e=await jt(),{hlsLive:i}=t.sources;return i&&e}async getVideoInstance(t,e){return new Wp(this.player,t,this.config,e)}};const Yp=`<svg width="100%" height="100%" viewBox="0 0 39 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <path d="M37,9.5C37,5.913 34.087,3 30.5,3L8.5,3C4.913,3 2,5.913 2,9.5L2,22.5C2,26.087 4.913,29 8.5,29L30.5,29C34.087,29 37,26.087 37,22.5L37,9.5ZM18.97,21.884C18.97,21.983 18.891,22.125 18.733,22.308C17.111,24.188 15.102,25.128 12.706,25.128C10.21,25.128 8.214,24.217 6.716,22.395C5.319,20.698 4.62,18.577 4.62,16.031C4.62,13.486 5.331,11.356 6.754,9.642C8.268,7.795 10.269,6.872 12.756,6.872C15.277,6.872 17.227,7.725 18.608,9.43C18.741,9.605 18.808,9.75 18.808,9.867C18.808,10.008 18.587,10.426 18.147,11.121C17.706,11.816 17.439,12.163 17.348,12.163C17.24,12.163 16.986,11.959 16.587,11.551C16.096,11.052 15.634,10.678 15.202,10.428C14.486,10.021 13.696,9.817 12.831,9.817C11.184,9.817 9.902,10.445 8.987,11.701C8.172,12.824 7.765,14.238 7.765,15.944C7.765,17.649 8.168,19.076 8.975,20.224C9.89,21.513 11.167,22.158 12.806,22.158C13.621,22.158 14.407,21.954 15.164,21.547C15.663,21.28 16.171,20.902 16.687,20.411C17.119,20.003 17.356,19.8 17.398,19.8C17.448,19.8 17.722,20.13 18.221,20.792C18.721,21.453 18.97,21.817 18.97,21.884ZM34.38,21.884C34.38,21.983 34.301,22.125 34.143,22.308C32.521,24.188 30.512,25.128 28.116,25.128C25.62,25.128 23.624,24.217 22.126,22.395C20.729,20.698 20.03,18.577 20.03,16.031C20.03,13.486 20.741,11.356 22.164,9.642C23.678,7.795 25.678,6.872 28.166,6.872C30.686,6.872 32.637,7.725 34.018,9.43C34.151,9.605 34.218,9.75 34.218,9.867C34.218,10.008 33.997,10.426 33.556,11.121C33.116,11.816 32.849,12.163 32.758,12.163C32.65,12.163 32.396,11.959 31.997,11.551C31.506,11.052 31.044,10.678 30.612,10.428C29.896,10.021 29.106,9.817 28.241,9.817C26.594,9.817 25.312,10.445 24.397,11.701C23.582,12.824 23.174,14.238 23.174,15.944C23.174,17.649 23.578,19.076 24.385,20.224C25.3,21.513 26.577,22.158 28.216,22.158C29.031,22.158 29.817,21.954 30.574,21.547C31.073,21.28 31.581,20.902 32.096,20.411C32.529,20.003 32.766,19.8 32.808,19.8C32.858,19.8 33.132,20.13 33.631,20.792C34.13,21.453 34.38,21.817 34.38,21.884Z" />
</svg>`;let jp=class extends Up{getPluginModuleInstance(){return cs.Get()}get name(){return super.name||"es.upv.paella.hlsCaptionsSelectorPlugin"}getAriaLabel(){return"Select captions"}getDescription(){return this.getAriaLabel()}async isEnabled(){const t=await super.isEnabled();return this._hls=this.player.videoContainer.streamProvider.mainAudioPlayer._hls,this._video=this.player.videoContainer.streamProvider.mainAudioPlayer.video,this._hls&&t}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"captionsIcon")||Yp;const t=this._hls.subtitleTracks||[],e=this._video.textTracks||[];if(t.length>0)this._tracks=t,this._trackType="hls";else{this._videoTracks=e;const i=()=>(console.log("getTextTracks"),Array.from(e).map((s,r)=>({attrs:{LANGUAGE:s.language,NAME:s.label},language:s.language})));this._tracks=i(),this._videoTracks.length>0&&(this._trackType="native",this._tracks=i(),this._tracks.length>0&&this.enable()),e.onaddtrack=()=>{this._trackType="native",this._tracks=i(),this._tracks.length>0&&this.enable()}}this._hls.subtitleTrack,this._disabledTrack={id:-1,title:"Disabled",index:-1,selected:!0},this._selected=null,this._tracks.length==0&&this.disable()}async getMenu(){const t=[{id:-1,title:"Disabled",index:-1,selected:this._selected===null}];return this._tracks.forEach((e,i)=>{t.push({id:e.attrs.LANGUAGE||e.attrs.NAME,title:e.attrs.NAME||e.attrs.LANGUAGE,index:i,selected:e.language===this._selected})}),t}get buttonType(){return"radio"}itemSelected(t){var e;console.log(t),t.index===-1?(this._selected=null,this._trackType==="hls"?this._hls.subtitleTrack=-1:this._trackType==="native"&&Array.from(this._videoTracks).forEach(i=>i.mode="disabled")):(this._trackType==="hls"?this._hls.subtitleTrack=t.index:this._trackType==="native"&&(this._videoTracks[t.index].mode="showing"),this._selected=(e=this._tracks.find(i=>i.index===t.index))==null?void 0:e.language)}},qp=class extends Ip{async getQualities(){return this._qualities||(this._qualities=this._sources.map((t,e)=>new Se({index:e,label:`${t.res.w}x${t.res.h}`,shortLabel:`${t.res.h}p`,width:t.res.w,height:t.res.h,src:t.src}))),this._qualities}async setQuality(t){if(!(t instanceof Se))throw new Error("Invalid parameter setting video quality");this.player.log.debug(`org.opencast.paella.mp4MultiQualityVideoFormat: Change video quality to ${t.shortLabel}`),this._currentQuality=t;const e=this.video.currentTime,i=this.video.playbackRate;this.clearStreamData(),this.video.src=t.src,this.video.currentTime=e,this.video.playbackRate=i,this.video.addEventListener("ended",this._endedCallback),await new Promise(s=>{const r=()=>{this._ready=!0,this.video.pause(),this.video.removeEventListener("canplay",r),s(null)};this.video.addEventListener("canplay",r)})}get currentQuality(){return this._currentQuality}async loadStreamData(t=null){if(this._sources=null,this._sources=t.sources.mp4,this._sources.sort((e,i)=>Number(e.res.w)-Number(i.res.w)),!this._qualities){const e=await this.getQualities(),i=[window.screen.width,window.screen.height].map(o=>o*window.devicePixelRatio);let s=Math.min(i[0],i[1]),r=Math.max(i[0],i[1]);/Mobi/i.test(window.navigator.userAgent)&&(s=Math.max(s,900),r=Math.max(s,1600));let a=0;for(let o=1;o<this._sources.length;o+=1){const l=this._sources[o],h=Math.min(l.res.w,l.res.h),c=Math.max(l.res.w,l.res.h);h<=s&&c<=r&&(a=o)}this._currentQuality=e[a]}this._currentSource=this._sources[this._currentQuality.index],await super.loadStreamData(t)}};const Zp=[{plugin:Hp,config:{enabled:!1}},{plugin:zp,config:{enabled:!1}},{plugin:jp,config:{enabled:!1}},{plugin:class extends Hn{getPluginModuleInstance(){return cs.Get()}get streamType(){return"mp4"}get name(){return"es.upv.paella.mp4MultiQualityVideoFormat"}isCompatible(t){var e;const{mp4:i}=t.sources;return i&&_p.supportsVideoType((e=i[0])==null?void 0:e.mimetype)}async getVideoInstance(t,e){return new qp(this.player,t,e,this.config)}},config:{enabled:!1}}];var Jo=n=>{throw TypeError(n)},jn=(n,t,e)=>t.has(n)||Jo("Cannot "+e),Ft=(n,t,e)=>(jn(n,t,"read from private field"),e?e.call(n):t.get(n)),Ri=(n,t,e)=>t.has(n)?Jo("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),qn=(n,t,e,i)=>(jn(n,t,"write to private field"),t.set(n,e),e),tl=(n,t,e)=>(jn(n,t,"access private method"),e);const ti=Object.freeze({PLAY:"paella:play",PAUSE:"paella:pause",STOP:"paella:stop",ENDED:"paella:ended",SEEK:"paella:seek",FULLSCREEN_CHANGED:"paella:fullscreenchanged",ENTER_FULLSCREEN:"paella:enterfullscreen",EXIT_FULLSCREEN:"paella:exitfullscreen",VOLUME_CHANGED:"paella:volumeChanged",TIMEUPDATE:"paella:timeupdate",TRIMMING_CHANGED:"paella:trimmingChanged",CAPTIONS_CHANGED:"paella:captionsChanged",CAPTIONS_ENABLED:"paella:captionsEnabled",CAPTIONS_DISABLED:"paella:captionsDisabled",BUTTON_PRESS:"paella:buttonPress",SHOW_POPUP:"paella:showPopUp",HIDE_POPUP:"paella:hidePopUp",MANIFEST_LOADED:"paella:manifestLoaded",STREAM_LOADED:"paella:streamLoaded",PLAYER_LOADED:"paella:playerLoaded",PLAYER_UNLOADED:"paella:playerUnloaded",RESIZE:"paella:resize",RESIZE_END:"paella:resizeEnd",LAYOUT_CHANGED:"paella:layoutChanged",PLAYBACK_RATE_CHANGED:"paella:playbackRateChanged",VIDEO_QUALITY_CHANGED:"paella:videoQualityChanged",HIDE_UI:"paella:hideUI",SHOW_UI:"paella:showUI",COOKIE_CONSENT_CHANGED:"paella:cookieConsentChanged",LOG:"paella:log"});function ki(n,t,e,i=!0){return n.__eventListeners__=n.__eventListeners__||{},Array.isArray(t)||(t=[t]),t.forEach(s=>{n.__eventListeners__[s]=n.__eventListeners__[s]||[],n.__eventListeners__[s].push({callback:e,unregisterOnUnload:i})}),e}function Qp(n){return new Promise((t,e)=>{fetch(n).then(i=>i.text()).then(i=>{t(i)}).catch(i=>e(i))})}function Xp(n){const t=new URLSearchParams(window.location.search);return t.has(n)?t.get(n):null}function Jp(n){const t=window.location.hash.replace("#","?"),e=new URLSearchParams(t);return e.has(n)?e.get(n):null}function el(n,t){const e=t||"/";return n=n.map((i,s)=>(s&&(i=i.replace(new RegExp("^"+e),"")),s!==n.length-1&&(i=i.replace(new RegExp(e+"$"),"")),i)),n.join(e)}function il(n){return new RegExp("^([a-z]+://|//)","i").test(n)||/^\//.test(n)}function sl(n){try{return new URL(n).pathname.split("/").pop()}catch{return n.split("/").pop()}}function tm(n){return n.split(".").reduce((t,e,i,s)=>i<s.length-1?t!==""?`${t}.${e}`:e:t,"")}function em(n){const t=e=>{const i=e.split("/").reduce((s,r,a,o)=>a<o.length-1?s!==""?`${s}/${r}`:r:s,"");return(e[0]==="/"?`/${i}`:i)+"/"};try{const e=new URL(n);return e.origin+t(e.pathname)}catch{return t(n)}}function im(n){return sl(n).split(".").pop()}function sm(n,t){return il(t)?t:el([n.manifestUrl,t])}function nm(n){n.__hideTimerPaused__=!0}function rm(n){n.__hideTimerPaused__=!1}function am(n,t="hideUiTime"){var e;n.__hideTimer__=null;const i=async()=>n.__hideTimerPaused__?(n.log.debug("UI not hidden because the auto hide timer is paused"),!1):s()?(n.log.debug("UI not hidden because there is a focused element"),!1):(await n.hideUserInterface(),!0);(e=n.config.ui)!=null&&e.hideOnMouseLeave&&n.containerElement.addEventListener("mouseleave",()=>{i()});const s=()=>{const a=document.activeElement,o=document.querySelector(":focus-visible");return(n.playbackBar.element.contains(a)||n.videoContainer.element.contains(a))&&["input","textarea","button"].find(l=>a.tagName.toLowerCase(l))!==-1&&o},r=async()=>{n.__hideTimer__&&clearTimeout(n.__hideTimer__),await n.showUserInterface(),n.__hideTimer__=setTimeout(async()=>{n.__hideTimer__=null,i()||r()},n[t])};n.containerElement.addEventListener("mousemove",async a=>{r()}),ki(n,ti.PLAY,async()=>{r()}),ki(n,ti.PAUSE,async()=>{await n.showUserInterface()}),ki(n,ti.ENDED,async()=>{await n.showUserInterface()}),document.addEventListener("keydown",async()=>{r()})}function om(n){n.__hideTimer__&&(clearTimeout(n.__hideTimer__),delete n.__hideTimer__)}function lm(n){const t=Math.floor(n/60/60),e=Math.floor(n/60)-t*60,i=Math.floor(n%60);return(t>0?t.toString().padStart(2,"0")+":":"")+e.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")}function hm(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)(\.\d+)?$/.exec(n);if(t){const e=t[1]!==void 0?Number(t[1]):0,i=Number(t[2]),s=Number(t[3]);return e*3600+i*60+s}return null}function cm(n){const t=/^(?:(\d+):){0,1}(\d+):(\d+)\.(\d+)?$/.exec(n);if(t){const e=t[1]!==void 0?Number(t[1]):0,i=Number(t[2]),s=Number(t[3]),r=t[4]&&Number(t[4])||0;return e*36e5+i*6e4+s*1e3+r}return null}function nl(n,t,e=365){let i=new Date;i.setTime(i.getTime()+e*24*60*60*1e3);let s=`expires=${i.toUTCString()}`;document.cookie=`${n}=${t};${s};path=/;SameSite=None;`+(/Apple/.test(navigator.vendor)?"":"Secure;")}function um(n,t,e,i,s=365){n.cookieConsent.getConsentForType(t)&&nl(e,i,s)}function Zn(n){let t=n+"=",e=decodeURIComponent(document.cookie).split(";");for(let i=0;i<e.length;++i){let s=e[i];for(;s.charAt(0)==" ";)s=s.substring(1);if(s.indexOf(t)==0)return s.substring(t.length,s.length)}return""}function dm(n){const t=Zn(n),e=Number(t);return t!==""&&!isNaN(e)?e:null}function fm(n){try{return JSON.parse(Zn(n))}catch{return null}}function gm(n,t=!0){return new Promise(e=>{const i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",n),i.onload=()=>e(i);const s=document.getElementsByTagName("head")[0];t&&s.appendChild(i),e()})}function pm(n){document.getElementsByTagName("head")[0].removeChild(n)}function Qn(n,t,e=!0){for(const i in t){const s=n[i];let r=t[i];e&&Array.isArray(s)&&Array.isArray(r)?(s.forEach(a=>{r=r.filter(o=>typeof a=="object"&&typeof o=="object"&&a.id===o.id?(Qn(a,o,e),!1):!0)}),r.forEach(a=>{s.push(a)})):typeof s=="object"&&r?Qn(s,r,e):n[i]=t[i]}}function Xn(n,{excludedTags:t=null}={}){const e=document.createElement("div");e.innerHTML=n;const i=["script"];return t&&i.push(...t),i.flatMap(s=>Array.from(e.getElementsByTagName(s))).forEach(s=>{s.parentElement.removeChild(s)}),e.innerHTML}let us=null;function mm(n){if(!n)return!1;us||(us=document.createElement("video"));let t=us.canPlayType(n);if(t==="maybe"||t==="probably")return!0;if(/video\/mp4/i.test(n))return t=us.canPlayType("video/mp4"),t==="maybe"||t==="probably"}const ym=Object.freeze(Object.defineProperty({__proto__:null,clearAutoHideTimer:om,getCookie:Zn,getFileExtension:im,getHashParameter:Jp,getJSONCookie:fm,getNumericCookie:dm,getUrlFileName:sl,getUrlParameter:Xp,isAbsoluteUrl:il,joinPath:el,loadStyle:gm,loadSvgIcon:Qp,mergeObjects:Qn,pauseAutoHideUiTimer:nm,removeExtension:tm,removeFileName:em,resolveResourcePath:sm,resumeAutoHideUiTimer:rm,sanitizeHTML:Xn,secondsToTime:lm,setCookie:nl,setCookieIfAllowed:um,setupAutoHideUiTimer:am,supportsVideoType:mm,timeToMilliseconds:cm,timeToSeconds:hm,unloadStyle:pm},Symbol.toStringTag,{value:"Module"}));var ds;let rl=class{constructor(t){Ri(this,ds,null),qn(this,ds,t)}get player(){return Ft(this,ds)}};ds=new WeakMap;function Ut(n,t=null){const e=document.createElement("div");e.innerHTML=n;const i=e.children[0];return t&&t.appendChild(i),i}let al=class extends rl{constructor(t,e){super(t),this._name=e}getPluginModuleInstance(){return null}get config(){return this._config}get type(){return"none"}get order(){var t;return((t=this._config)==null?void 0:t.order)||0}get description(){var t;return((t=this._config)==null?void 0:t.description)||""}get name(){return this._name}async isEnabled(){var t;return(t=this.config)==null?void 0:t.enabled}async load(){}async unload(){}},vm=class extends rl{get moduleName(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleName'`),"-"}get moduleVersion(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleVersion'`),"0.0.0"}async getDictionaries(){return null}};class ol extends al{constructor(t,e,i){super(t,e,i),this.__uiPlugin=!0}async getDictionaries(){return null}}const ll=()=>{const n=document.createElement("span");return n.classList.add("side-container"),n.classList.add("hidden"),n};let Em=class{onIconChanged(t,e,i){}onTitleChanged(t,e,i){}onStateChanged(t,e,i,s,r){}};var fs,Jn,Ae,Re,gs;let Tm=class extends ol{constructor(){super(...arguments),Ri(this,fs),Ri(this,Ae,null),Ri(this,Re,null),Ri(this,gs,[])}get type(){return"button"}get container(){return this._container}get button(){return this._button}get interactive(){return!0}get dynamicWidth(){return!1}getId(){return null}get id(){return this.config.id||this.getId()}getButtonName(){return null}get buttonName(){return this.config.name||this.getButtonName()||this.name}get ariaLabel(){return this.config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return null}getDescription(){return""}get description(){return this.config.description||this.getDescription()}get minContainerSize(){return this.config.minContainerSize||this.getMinContainerSize()}getMinContainerSize(){return 0}setObserver(t){if(t instanceof Em)this._observer=t;else if(typeof t.onIconChanged=="function"||typeof t.onTitleChanged=="function"||typeof t.onStateChanged=="function")this._observer=t;else throw new Error("Invalid observer for ButtonPlugin")}get icon(){return this._icon||(this._icon=""),this._icon}set icon(t){typeof t=="string"&&(t=Xn(t)),this._icon=t,tl(this,fs,Jn).call(this)}get haveIcon(){return this.icon!==""}get menuIcon(){return this._menuIcon||(this._menuIcon=""),this._menuIcon}set menuIcon(t){typeof t=="string"&&(t=Xn(t)),this._menuIcon=t,tl(this,fs,Jn).call(this)}get haveMenuIcon(){return this.menuIcon!==""}get isMenuButton(){var t,e,i;const s=((t=this.config)==null?void 0:t.parentContainer)==="playbackBar"||!((e=this.config)!=null&&e.parentContainer),r=((i=this.config)==null?void 0:i.parentContainer)==="videoContainer";return!s&&!r}get title(){return this._title||""}set title(t){var e;if(this._title=t,t&&this._button instanceof HTMLElement){const i=this._button.querySelector("span")||Ut(`<span class="button-title-${this.titleSize}"></span>`,this._button);i.innerHTML=t}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("span");i&&this._button.removeChild(i)}(e=this._observer)!=null&&e.onTitleChanged&&this._observer.onTitleChanged(this,this._title,t)}get titleSize(){return"medium"}get side(){var t;return((t=this.config)==null?void 0:t.side)||"left"}get closePopUps(){return this.config.closePopUps||this.getClosePopUps()}getClosePopUps(){return!0}get parentContainer(){var t;return((t=this.config)==null?void 0:t.parentContainer)||"playbackBar"}get className(){return""}enable(){this._enabled=!0,this.show()}disable(){this._enabled=!1,this.hide()}hide(){this._button&&(this._button.style.display="none")}show(){if(this._enabled===!1)return;const{width:t}=this.player.playbackBar.containerSize;this._button&&(t>this.minContainerSize||this.parentContainer!=="playbackBar")&&(this._button.style.display=null)}get leftSideContainer(){return Ft(this,Ae)||(qn(this,Ae,ll()),this.container.appendChild(Ft(this,Ae))),Ft(this,Ae)}get leftSideContainerPresent(){return Ft(this,Ae)!==null}get rightSideContainer(){return Ft(this,Re)||(qn(this,Re,ll()),this.container.appendChild(Ft(this,Re))),Ft(this,Re)}get rightSideContainerPresent(){return Ft(this,Re)!==null}get stateText(){return null}get stateIcon(){return null}setState({text:t=null,icon:e=null}={}){var i,s;const r=this._statusText,a=this._statusIcon;this._statusText=t,this._statusIcon=e,Ft(this,gs).forEach(o=>o(this)),this._statusIcon&&(this.icon=this._statusIcon,this.menuIcon=this._statusIcon),this._statusText&&(this.title=this._statusText),(s=(i=this._observer)==null?void 0:i.onStateChanged)==null||s.call(i,this,r,t,a,e)}onStateChange(t){typeof t=="function"?Ft(this,gs).push(t):this.player.log.warn("Invalid callback for ButtonPlugin.onStateChange")}async action(t,e=null){}onResize({width:t,height:e}){t<this.minContainerSize?this.hide():this.show()}focus(){var t;(t=this.button)==null||t.focus()}blur(){var t;(t=this.button)==null||t.blur()}isFocus(){return this.button===document.activeElement}};fs=new WeakSet,Jn=function(){var n;const t=this.isMenuButton?this._menuIcon:this._icon,e=this.isMenuButton&&this.haveMenuIcon?this.menuIcon:this.icon;if(e&&this._button instanceof HTMLElement){const i=this._button.querySelector("i")||Ut("<i></i>",this._button);i.innerHTML=e}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("i");i&&this._button.removeChild(i)}(n=this._observer)!=null&&n.onIconChanged&&this._observer.onIconChanged(this,t,e)},Ae=new WeakMap,Re=new WeakMap,gs=new WeakMap;let hl=class extends ol{get type(){return"canvasButton"}get content(){return this._config.content||["presenter"]}get ariaLabel(){return this._config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex}get description(){return this.config.description||this.getDescription()}getDescription(){return""}get icon(){return this._icon}set icon(t){this._icon=t}get side(){var t;return((t=this.config)==null?void 0:t.side)||"left"}get buttonName(){return this.name}get position(){switch(this.side){case"left":return tr.LEFT;case"center":return tr.CENTER;case"right":return tr.RIGHT;default:throw new Error(`Invalid CanvasButtonPlugin side set: ${this.side}`)}}async action(t){this.player.log.warn(`Action not implemented in canvas button plugin ${this.name}`)}};const tr=Object.freeze({LEFT:"left",CENTER:"center",RIGHT:"right"});let _m=class extends Tm{constructor(){super(...arguments),this._refreshContent=!0}set refreshContent(t){this._refreshContent=t}get refreshContent(){return this._refreshContent}get closeParentPopUp(){return this.config.closeParentPopUp||this.getCloseParentPopUp()}getCloseParentPopUp(){return!1}async action(t,e){super.action(t,e),this.parentPopUp=e,await this.showPopUp()}get parentPopUp(){return this._parentPopUp}set parentPopUp(t){this._parentPopUp=t}get popUp(){return this._popUp}get menuTitle(){return this.config.menuTitle||null}get moveable(){return this.config.moveable??!1}get resizeable(){return this.config.resizeable??!1}get customPopUpClass(){return this.config.customPopUpClass??""}get closeActions(){var t,e;const i=((t=this.config.closeActions)==null?void 0:t.clickOutside)??!0,s=((e=this.config.closeActions)==null?void 0:e.closeButton)??!1;return{clickOutside:i,closeButton:s}}get currentContent(){return this._currentContent}async getContent(){return Ut("<p>Pop Up Button Plugin Content</p>")}async checkRefreshContent(){if(this.refreshContent){const t=await this.getContent();this._currentContent.innerHTML="",Array.from(t.children).forEach(e=>this._currentContent.appendChild(e))}}get popUpType(){return this.config.popUpType||"modal"}hidePopUp(){this.player.playbackBar.popUp.isHidden||this.player.playbackBar.popUp.hide()}async showPopUp(){this._keyEventHandler||(this._keyEventHandler=e=>{e.key==="Escape"&&this.hidePopUp()},this.button.addEventListener("keydown",this._keyEventHandler));const t=this.player.playbackBar.popUp;if(t.isHidden||this._contentId!==t.currentContentId){const e=await this.getContent();this._currentContent=e,this._contentId=t.show({title:this.menuTitle||this.description,content:e,attachRight:this.popUpType==="timeline"||this.side==="right",attachLeft:this.popUpType==="timeline"||this.side==="left",parent:this.parentPopUp})}else t.hide()}},Lm=class extends al{get type(){return"eventLog"}get events(){return[]}async onEvent(t,e){this.player.log.warn(`${this.name}: onEvent() function is not overwritten.`)}};Object.freeze({DISABLED:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,VERBOSE:5}).INFO;function cl(n){return ps(n).length>0}function ps(n){var t;const e=((t=n.frameList)==null?void 0:t.frames)||[];return e.sort((i,s)=>i.time-s.time),e}async function ul(n){const t=ps(n),{videoContainer:e}=n,i=e.isTrimEnabled?e.trimStart:0,s=i+Math.trunc(await e.duration()),r=i+Math.trunc(await e.currentTime());let a=null;t.some(o=>(o.time>r&&o.time<s&&(a=o),a!==null)),a&&await n.videoContainer.setCurrentTime(a.time-i)}async function dl(n){const t=ps(n),{videoContainer:e}=n,i=e.isTrimEnabled?e.trimStart:0,s=Math.trunc(await e.currentTime())+i;let r=null;if(t.some(a=>(a.time<s&&(r=a),a.time>=s)),r){const a=r.time<i?i:r.time;await n.videoContainer.setCurrentTime(a-i)}}const Cm="@asicupv/paella-slide-plugins",bm="2.2.0",fl={name:Cm,version:bm},Sm={"Show slides":"Mostrar diapositivas del vídeo","go to":"ir a","Seek video to the next slide":"Ir a la siguiente diapositiva","Seek video to the previous slide":"Ir a la diapositiva anterior"},wm={"Show slides":"Show slides","go to":"go to","Seek video to the next slide":"Go to the next slide","Seek video to the previous slide":"Go to the previous slide"},Im={"Show slides":"Folien anzeigen","go to":"gehe zu","Seek video to the next slide":"nächste Folie","Seek video to the previous slide":"vorherige Folie"},Am={es:Sm,en:wm,de:Im};let er=null,ms=class tu extends vm{static Get(){return er||(er=new tu),er}get moduleName(){return fl.name}get moduleVersion(){return fl.version}async getDictionaries(){return Am}};const ir=`<svg width="100%" height="100%" viewBox="0 0 512 512" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(4.38063e-16,11.4236,8.46191,-3.24491e-16,68.8773,-7740.5)">
        <g id="arrow-right" serif:id="arrow right">
            <path d="M698.36,2.82C698.726,2.08 699.341,1.636 700,1.636C700.659,1.636 701.274,2.08 701.64,2.82C705.27,10.172 713.981,27.811 717.958,35.864C718.361,36.68 718.398,37.73 718.055,38.595C717.712,39.46 717.045,40 716.318,40L683.682,40C682.955,40 682.288,39.46 681.945,38.595C681.602,37.73 681.639,36.68 682.042,35.864C686.019,27.811 694.73,10.172 698.36,2.82Z"/>
        </g>
    </g>
</svg>`,sr=`<svg width="100%" height="100%" viewBox="0 0 512 512" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(-1.83705e-15,-11.4236,-8.46191,1.36078e-15,452.158,8252.5)">
        <g id="arrow-right" serif:id="arrow right">
            <path d="M698.36,2.82C698.726,2.08 699.341,1.636 700,1.636C700.659,1.636 701.274,2.08 701.64,2.82C705.27,10.172 713.981,27.811 717.958,35.864C718.361,36.68 718.398,37.73 718.055,38.595C717.712,39.46 717.045,40 716.318,40L683.682,40C682.955,40 682.288,39.46 681.945,38.595C681.602,37.73 681.639,36.68 682.042,35.864C686.019,27.811 694.73,10.172 698.36,2.82Z"/>
        </g>
    </g>
</svg>`;let Rm=class extends Lm{getPluginModuleInstance(){return ms.Get()}get name(){return super.name||"es.upv.paella.arrowSlidesNavigator"}get events(){return[ti.PLAYER_LOADED]}async onEvent(t){var e;const i=this.player.getCustomPluginIcon(this.name,"arrowLeftIcon")||ir,s=this.player.getCustomPluginIcon(this.name,"arrowRightIcon")||sr;console.debug("Loading arrow slides navigation plugin");const r=Array.isArray(this.config.target)?this.config.target:[this.config.target],a=this.player.videoContainer.streamProvider.streams,o=r.find(h=>a[h]!==null),l=a[o];if(this.frames=ps(this.player),l&&(e=this.frames)!=null&&e.length){const h=Ut('<div class="arrow-slides-navigator"></div>',l.canvas.userArea);Ut(`
            <button class="button-prev"><i>${i}</i></button>
            `,h).addEventListener("click",async c=>{c.stopPropagation(),await dl(this.player)}),Ut(`
            <button class="button-next"><i>${s}</i></button>
            `,h).addEventListener("click",async c=>{c.stopPropagation(),await ul(this.player)})}else console.warn("No matching stream content or frames found for arrow slides navigator plugin")}};const km=`<svg width="100%" height="100%" viewBox="0 0 33 30" style="stroke:none;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <path d="M23,29.888L0,29.888L0,7.888L23,7.888L23,29.888ZM11,6.888L8.903,6.888L10.5,0L33,5.817L27,27.888L24,27.388L23.994,20.288L27,20.888L30.519,7.199L11.933,2.394L11,6.888ZM21,9.888L1.969,9.888L1.969,23.888L21,23.888L21,9.888ZM7.912,19.349L10.236,15.813L12.561,18.017L15.757,13.49L19,21.888L3.939,21.888L6.169,17.726L7.912,19.349ZM6.473,15.608C5.647,15.608 4.977,14.966 4.977,14.173C4.977,13.381 5.647,12.739 6.473,12.739C7.299,12.739 7.969,13.381 7.969,14.173C7.969,14.966 7.299,15.608 6.473,15.608Z"/>
</svg>`;function gl(n,t){if(t==null||t.forEach(r=>r.classList.remove("selected")),n.classList.add("selected"),this._autoScrollPaused)return;const e=n.parentElement,i=e.getBoundingClientRect(),s=n.getBoundingClientRect();s.left<i.left?e.scrollLeft-=i.left-s.left:s.right>i.right&&(e.scrollLeft+=s.right-i.right)}let Dm=class extends _m{getPluginModuleInstance(){return ms.Get()}get name(){return super.name||"es.upv.paella.frameControlButtonPlugin"}getAriaLabel(){return"Show slides"}getDescription(){return this.getAriaLabel()}get popUpType(){return"timeline"}async isEnabled(){var t,e,i;const s=await super.isEnabled();return this.frames=(t=this.player.frameList)==null?void 0:t.frames,(e=this.frames)==null||e.sort((r,a)=>r.time-a.time),s&&((i=this.frames)==null?void 0:i.length)}async action(){await super.action();const t=await this.player.videoContainer.currentTime();let e=null;this.frameElements.some(i=>(e=i,i.__data.time>t)),e&&e.focus()}async getContent(){const t=this.player.getCustomPluginIcon(this.name,"arrowLeftIcon")||ir,e=this.player.getCustomPluginIcon(this.name,"arrowRightIcon")||sr,i="presentation",s=this.player.frameList.targetContent||this.config.targetContent||i,r=this.config.targetContent||i,a=Ut('<div class="frame-control-plugin-container"></div>'),o=Ut(`<button class="btn-left"><i class="button-icon">${t}</i></button>`,a),l=Ut('<div class="image-list"></div>',a),h=Ut(`<button class="btn-right"><i class="button-icon">${e}</i></button>`,a),{videoContainer:c}=this.player,u=await c.duration();let d=null;l.addEventListener("scroll",async E=>{this._autoScrollPaused=!0,d&&clearTimeout(d),d=setTimeout(()=>{this._autoScrollPaused=!1},2e3)});const g=c.isTrimEnabled?c.trimStart:0,f=c.isTrimEnabled?c.trimEnd:u,p=E=>(E=this.player.videoContainer.isTrimEnabled?E-this.player.videoContainer.trimStart:E,ym.secondsToTime(E<0?0:E)),y=E=>{E.key==="Escape"&&(E.preventDefault(),E.stopPropagation(),this.hidePopUp(),this.button.focus())};this.frameElements=this.frames.filter((E,_)=>{const T=this.frames[_+1];return((T==null?void 0:T.time)>=g||E.time>=g)&&E.time<=f}).map(E=>{const _=`${this.player.translate("go to")} ${p(E.time)}`,T=Ut(`
                <button id="frame_${E.id}" aria-label="${_}" title="${_}"><img src="${E.thumb}" alt="${E.id}"/></button>
                `,l);return T.__data=E,T.addEventListener("click",async L=>{const w=L.currentTarget.__data.time-g;await this.player.videoContainer.setCurrentTime(w>=0?w:0),gl.apply(this,[L.currentTarget,this.frameElements])}),T.addEventListener("keydown",y),T.addEventListener("mouseover",async L=>{this._currentFrame&&this.player.videoContainer.removeChild(this._currentFrame);const w=document.createElement("img");w.className="frame-control-preview",w.src=E.url;const I=this.player.videoContainer.getVideoRect(s)||this.player.videoContainer.getVideoRect(r)||this.player.videoContainer.getVideoRect(i)||this.player.videoContainer.getVideoRect(0);this._currentFrame=this.player.videoContainer.appendChild(w,I)}),T.addEventListener("mouseout",async L=>{this._currentFrame&&(this.player.videoContainer.removeChild(this._currentFrame),this._currentFrame=null)}),T});const v=()=>this.frameElements&&this.frameElements[0]?this.frameElements[0].offsetWidth:0;return o.addEventListener("click",()=>{l.scrollLeft-=v()}),h.addEventListener("click",()=>{l.scrollLeft+=v()}),o.addEventListener("keydown",y),h.addEventListener("keydown",y),setTimeout(()=>this.frameElements[0]&&this.frameElements[0].focus(),50),a}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"photoIcon")||km;const t=3;ki(this.player,ti.TIMEUPDATE,async e=>{var i;const s=this.player.videoContainer.isTrimEnabled?this.player.videoContainer.trimStart:0;let r=this.frameElements&&this.frameElements[0];(i=this.frameElements)==null||i.some(a=>{if(a.__data.time>Math.floor(e.currentTime+s+t))return!0;r=a}),r&&gl.apply(this,[r,this.frameElements])}),ki(this.player,ti.TRIMMING_CHANGED,e=>{this.refreshContent=!0})}};class Pm extends hl{getPluginModuleInstance(){return ms.Get()}get name(){return super.name||"es.upv.paella.nextSlideNavigatorButton"}getAriaLabel(){return this.getDescription()}getDescription(){return this.player.translate("Seek video to the next slide")}async isEnabled(){return await super.isEnabled()&&cl(this.player)}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"arrowRightIcon")||sr}async action(){await ul(this.player)}}const xm=[{plugin:Rm,config:{enabled:!1}},{plugin:Dm,config:{enabled:!1}},{plugin:Pm,config:{enabled:!1}},{plugin:class extends hl{getPluginModuleInstance(){return ms.Get()}get name(){return super.name||"es.upv.paella.prevSlideNavigatorButton"}getAriaLabel(){return this.getDescription()}getDescription(){return this.player.translate("Seek video to the previous slide")}async isEnabled(){return await super.isEnabled()&&cl(this.player)}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"arrowLeftIcon")||ir}async action(){await dl(this.player)}},config:{enabled:!1}}];var pl=n=>{throw TypeError(n)},ml=(n,t,e)=>t.has(n)||pl("Cannot "+e),Mm=(n,t,e)=>(ml(n,t,"read from private field"),e?e.call(n):t.get(n)),Om=(n,t,e)=>t.has(n)?pl("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),$m=(n,t,e,i)=>(ml(n,t,"write to private field"),t.set(n,e),e);const it=Object.freeze({PLAY:"paella:play",PAUSE:"paella:pause",STOP:"paella:stop",ENDED:"paella:ended",SEEK:"paella:seek",FULLSCREEN_CHANGED:"paella:fullscreenchanged",ENTER_FULLSCREEN:"paella:enterfullscreen",EXIT_FULLSCREEN:"paella:exitfullscreen",VOLUME_CHANGED:"paella:volumeChanged",TIMEUPDATE:"paella:timeupdate",TRIMMING_CHANGED:"paella:trimmingChanged",CAPTIONS_CHANGED:"paella:captionsChanged",CAPTIONS_ENABLED:"paella:captionsEnabled",CAPTIONS_DISABLED:"paella:captionsDisabled",BUTTON_PRESS:"paella:buttonPress",SHOW_POPUP:"paella:showPopUp",HIDE_POPUP:"paella:hidePopUp",MANIFEST_LOADED:"paella:manifestLoaded",STREAM_LOADED:"paella:streamLoaded",PLAYER_LOADED:"paella:playerLoaded",PLAYER_UNLOADED:"paella:playerUnloaded",RESIZE:"paella:resize",RESIZE_END:"paella:resizeEnd",LAYOUT_CHANGED:"paella:layoutChanged",PLAYBACK_RATE_CHANGED:"paella:playbackRateChanged",VIDEO_QUALITY_CHANGED:"paella:videoQualityChanged",HIDE_UI:"paella:hideUI",SHOW_UI:"paella:showUI",COOKIE_CONSENT_CHANGED:"paella:cookieConsentChanged",LOG:"paella:log"});function yl(n,t,e,i=!0){return n.__eventListeners__=n.__eventListeners__||{},Array.isArray(t)||(t=[t]),t.forEach(s=>{n.__eventListeners__[s]=n.__eventListeners__[s]||[],n.__eventListeners__[s].push({callback:e,unregisterOnUnload:i})}),e}var ys;let vl=class{constructor(t){Om(this,ys,null),$m(this,ys,t)}get player(){return Mm(this,ys)}};ys=new WeakMap;class El extends vl{constructor(t,e){super(t),this._name=e}getPluginModuleInstance(){return null}get config(){return this._config}get type(){return"none"}get order(){var t;return((t=this._config)==null?void 0:t.order)||0}get description(){var t;return((t=this._config)==null?void 0:t.description)||""}get name(){return this._name}async isEnabled(){var t;return(t=this.config)==null?void 0:t.enabled}async load(){}async unload(){}}let Nm=class extends vl{get moduleName(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleName'`),"-"}get moduleVersion(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleVersion'`),"0.0.0"}async getDictionaries(){return null}},nr=class extends El{get type(){return"data"}get context(){return this.config.context||[]}async read(){throw Error(`DataPlugin.read() not implemented in data plugin '${this.name}'`)}async write(){throw Error(`DataPlugin.write() not implemented in data plugin '${this.name}'`)}async remove(){throw Error(`DataPlugin.remove() not implemented in data plugin '${this.name}'`)}},Fm=class extends El{get type(){return"eventLog"}get events(){return[]}async onEvent(t,e){this.player.log.warn(`${this.name}: onEvent() function is not overwritten.`)}};const Tl=Object.freeze({DISABLED:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,VERBOSE:5});Tl.INFO;const Um="2.2.0",Bm={version:Um};let rr=null;class ei extends Nm{static Get(){return rr||(rr=new ei),rr}get moduleName(){return"paella-user-tracking"}get moduleVersion(){return Bm.version}}let Gm=class extends nr{getPluginModuleInstance(){return ei.Get()}get name(){return super.name||"es.upv.paella.analytics.userTrackingDataPlugin"}async load(){const t=this.config.trackingId,e=this.config.domain||"auto";t?(this.player.log.debug("Google Analytics Enabled"),function(i,s,r,a,o,l,h){i.GoogleAnalyticsObject=o,i[o]=i[o]||function(){(i[o].q=i[o].q||[]).push(arguments)},i[o].l=1*new Date,l=s.createElement(r),h=s.getElementsByTagName(r)[0],l.async=1,l.src=a,h.parentNode.insertBefore(l,h)}(window,document,"script","//www.google-analytics.com/analytics.js","__gaTracker"),__gaTracker("create",t,e),__gaTracker("send","pageview")):this.player.log.debug("No Google Tracking ID found in config file. Disabling Google Analytics")}async write(t,{id:e},i){if(this.config.category===void 0||this.config.category===!0){const s=this.config.category||"PaellaPlayer",r=i.event,a={videoId:e,plugin:i.plugin};try{JSON.stringify(i.params),a.params=i.params}catch{}const o=JSON.stringify(a);__gaTracker(" send","event",s,r,o)}}},Vm=class extends nr{getPluginModuleInstance(){return ei.Get()}get name(){return super.name||"es.upv.paella.matomo.userTrackingDataPlugin"}async isEnabled(){return await super.isEnabled()?(this.matomoGlobalLoaded=this.config.matomoGlobalLoaded??!1,this.server=this.config.server,this.siteId=this.config.siteId,this.events=this.config.events,!this.matomoGlobalLoaded&&!(this.server&&this.siteId)?(this.player.log.warn("Matomo plugin: Plugin is enabled, but is not configured correctly. Please configue `matomoGlobalLoaded`, `server`and `siteId` parameters."),!1):!0):!1}async getCurrentUserId(){return null}async trackCustomDimensions(){const n=await this.getTemplateVars(),t=this.config.customDimensions??{};try{Object.entries(t).forEach(([e,i])=>{const s=this.applyTemplate(i,n);_paq.push(["setCustomDimension",e,s]),this.player.log.debug(`Matomo plugin: setting custom dimension id=${e} to '${s}'`)})}catch{}}async getTemplateVars(n){let t=this.getEventData(n);return{videoId:this.player._videoId,metadata:this.player.videoManifest.metadata,event:(n==null?void 0:n.event)||"",eventData:t}}getEventData(n){switch(n==null?void 0:n.event){case it.SEEK:return Math.round(n.params.newTime);case it.VOLUME_CHANGED:return n.params.volume*100;case it.BUTTON_PRESS:return n.params.plugin.name;case it.SHOW_POPUP:return n.params.plugin.name;case it.HIDE_POPUP:return n.params.plugin.name;case it.RESIZE_END:return`${n.params.size.w}x${n.params.size.h}`;case it.LAYOUT_CHANGED:return n.params.layoutId;case it.PLAYBACK_RATE_CHANGED:return n.params.newPlaybackRate;case it.CAPTIONS_ENABLED:return n.params.language}return""}async load(){const n=this.config.heartBeatTime||15;var t=window._paq=window._paq||[];if(t.push(["requireCookieConsent"]),yl(this.player,it.COOKIE_CONSENT_CHANGED,()=>{this.player.log.debug("Matomo: Cookie consent changed."),this.player.cookieConsent.getConsentForType(this.config.cookieType)?t.push(["rememberCookieConsentGiven"]):t.push(["forgetCookieConsentGiven"])}),this.matomoGlobalLoaded){var t=window._paq=window._paq||[];this.player.log.debug("Assuming Matomo analytics is initialized globaly."),this.config.server&&this.player.log.warn("Matomo plugin: `server` parameter is defined, but never used because Matomo is loaded globaly in the page. Is it an error? Please check it."),this.config.siteId&&this.player.log.warn("Matomo plugin: `siteId` parameter is defined, but never used because Matomo is loaded globaly in the page. Is it an error? Please check it.")}else{const e=this.server,i=this.siteId;this.player.log.debug("Matomo analytics plugin enabled."),this.trackCustomDimensions();const s=await this.getCurrentUserId();s&&t.push(["setUserId",s]),t.push(["trackPageView"]),t.push(["enableLinkTracking"]),function(){var r=e;t.push(["setTrackerUrl",r+"matomo.php"]),t.push(["setSiteId",i]);var a=document,o=a.createElement("script"),l=a.getElementsByTagName("script")[0];o.type="text/javascript",o.async=!0,o.src=r+"matomo.js",l.parentNode.insertBefore(o,l)}()}t.push(["enableHeartBeatTimer",n]),this.trackCustomDimensions(),yl(this.player,it.STREAM_LOADED,()=>{t.push(["MediaAnalytics::scanForMedia"])})}applyTemplate(n,t){return n.replace(/\${[^{]*}/g,e=>e.substring(2,e.length-1).split(".").reduce((i,s)=>i[s],t))}async write(n,{id:t},e){if(this.events){const i=this.events.category||"PaellaPlayer",s=this.events.action||"${event}",r=this.events.name||"${eventData}",a=await this.getTemplateVars(e),o=this.applyTemplate(i,a),l=this.applyTemplate(s,a),h=this.applyTemplate(r,a);_paq.push(["trackEvent",o,l,h]),this.player.log.debug(`Matomo plugin: track event category='${o}', action='${l}', name='${h}'`)}}},Hm=class extends nr{getPluginModuleInstance(){return ei.Get()}get name(){return super.name||"es.upv.paella.debug.userTrackingDataPlugin"}async write(t,{id:e},i){console.log(`id: ${e}`,t,i)}};const Km=n=>n.map(t=>it[t]),Wm=[{plugin:Gm,config:{enabled:!0}},{plugin:Vm,config:{enabled:!0}},{plugin:Hm,config:{enabled:!0}},{plugin:class extends Fm{getPluginModuleInstance(){return ei.Get()}get name(){return super.name||"es.upv.paella.userEventTracker"}get events(){return this.config.events?Km(this.config.events):[it.PLAY,it.PAUSE,it.SEEK,it.STOP,it.ENDED,it.FULLSCREEN_CHANGED,it.VOLUME_CHANGED,it.BUTTON_PRESS,it.RESIZE_END]}async onEvent(t,e){var i;const s=this.config.context||"userTracking",r=this.player.videoId;if(t===it.LOG&&e.severity<=Tl[this.config.logLevel])this.player.data&&await this.player.data.write(s,{id:r},{event:t,params:e});else if(t!==it.LOG&&this.player.data){if(e.plugin){const{name:o,config:l}=e.plugin;e.plugin={name:o,config:l}}const a={event:t,params:e};switch(t){case it.SHOW_POPUP:case it.HIDE_POPUP:case it.BUTTON_PRESS:a.plugin=((i=e.plugin)==null?void 0:i.name)||null}await this.player.data.write(s,{id:r},a)}}},config:{enabled:!0}}];var _l=n=>{throw TypeError(n)},ar=(n,t,e)=>t.has(n)||_l("Cannot "+e),mt=(n,t,e)=>(ar(n,t,"read from private field"),e?e.call(n):t.get(n)),ii=(n,t,e)=>t.has(n)?_l("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),vs=(n,t,e,i)=>(ar(n,t,"write to private field"),t.set(n,e),e),Ll=(n,t,e)=>(ar(n,t,"access private method"),e);function zm(n){n.__hideTimerPaused__=!1}function Cl(n,{excludedTags:t=null}={}){const e=document.createElement("div");e.innerHTML=n;const i=["script"];return t&&i.push(...t),i.flatMap(s=>Array.from(e.getElementsByTagName(s))).forEach(s=>{s.parentElement.removeChild(s)}),e.innerHTML}var Es;let or=class{constructor(n){ii(this,Es,null),vs(this,Es,n)}get player(){return mt(this,Es)}};Es=new WeakMap;function Ym({tag:n="div",attributes:t={},children:e="",innerText:i="",parent:s=null}){const r=document.createElement(n);r.innerText=i;for(let a in t)r.setAttribute(a,t[a]);return r.innerHTML=e,s&&s.appendChild(r),r}function ke(n,t=null){const e=document.createElement("div");e.innerHTML=n;const i=e.children[0];return t&&t.appendChild(i),i}var qt;let jm=class extends or{constructor(t,{tag:e="div",attributes:i=[],children:s="",parent:r=null}){super(t),ii(this,qt,null),vs(this,qt,Ym({tag:e,attributes:i,children:s,parent:r})),Object.defineProperty(this,e,{get:()=>mt(this,qt)})}get element(){return mt(this,qt)}get parent(){return mt(this,qt).parentElement}hide(){this.element.style.display="none"}show(t="block"){this.element.style.display=null}get isVisible(){const t=window.getComputedStyle(this.element);return t.display!=="none"&&t.display!==""}setAttribute(t,e){mt(this,qt).setAttribute(t,e)}removeFromParent(){var t;(t=mt(this,qt).parentElement)==null||t.removeChild(mt(this,qt))}setParent(t){this.removeFromParent(),t.appendChild(mt(this,qt))}};qt=new WeakMap;class bl extends or{constructor(t,e){super(t),this._name=e}getPluginModuleInstance(){return null}get config(){return this._config}get type(){return"none"}get order(){var t;return((t=this._config)==null?void 0:t.order)||0}get description(){var t;return((t=this._config)==null?void 0:t.description)||""}get name(){return this._name}async isEnabled(){var t;return(t=this.config)==null?void 0:t.enabled}async load(){}async unload(){}}let qm=class extends or{get moduleName(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleName'`),"-"}get moduleVersion(){return this.player.log.warn(`Incomplete player module definition: '${__filename}.moduleVersion'`),"0.0.0"}async getDictionaries(){return null}};class Sl extends bl{constructor(t,e,i){super(t,e,i),this.__uiPlugin=!0}async getDictionaries(){return null}}const wl=()=>{const n=document.createElement("span");return n.classList.add("side-container"),n.classList.add("hidden"),n};let Zm=class{onIconChanged(t,e,i){}onTitleChanged(t,e,i){}onStateChanged(t,e,i,s,r){}};var Ts,lr,De,Pe,_s;let hr=class extends Sl{constructor(){super(...arguments),ii(this,Ts),ii(this,De,null),ii(this,Pe,null),ii(this,_s,[])}get type(){return"button"}get container(){return this._container}get button(){return this._button}get interactive(){return!0}get dynamicWidth(){return!1}getId(){return null}get id(){return this.config.id||this.getId()}getButtonName(){return null}get buttonName(){return this.config.name||this.getButtonName()||this.name}get ariaLabel(){return this.config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex||this.getTabIndex()}getTabIndex(){return null}getDescription(){return""}get description(){return this.config.description||this.getDescription()}get minContainerSize(){return this.config.minContainerSize||this.getMinContainerSize()}getMinContainerSize(){return 0}setObserver(t){if(t instanceof Zm)this._observer=t;else if(typeof t.onIconChanged=="function"||typeof t.onTitleChanged=="function"||typeof t.onStateChanged=="function")this._observer=t;else throw new Error("Invalid observer for ButtonPlugin")}get icon(){return this._icon||(this._icon=""),this._icon}set icon(t){typeof t=="string"&&(t=Cl(t)),this._icon=t,Ll(this,Ts,lr).call(this)}get haveIcon(){return this.icon!==""}get menuIcon(){return this._menuIcon||(this._menuIcon=""),this._menuIcon}set menuIcon(t){typeof t=="string"&&(t=Cl(t)),this._menuIcon=t,Ll(this,Ts,lr).call(this)}get haveMenuIcon(){return this.menuIcon!==""}get isMenuButton(){var t,e,i;const s=((t=this.config)==null?void 0:t.parentContainer)==="playbackBar"||!((e=this.config)!=null&&e.parentContainer),r=((i=this.config)==null?void 0:i.parentContainer)==="videoContainer";return!s&&!r}get title(){return this._title||""}set title(t){var e;if(this._title=t,t&&this._button instanceof HTMLElement){const i=this._button.querySelector("span")||ke(`<span class="button-title-${this.titleSize}"></span>`,this._button);i.innerHTML=t}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("span");i&&this._button.removeChild(i)}(e=this._observer)!=null&&e.onTitleChanged&&this._observer.onTitleChanged(this,this._title,t)}get titleSize(){return"medium"}get side(){var t;return((t=this.config)==null?void 0:t.side)||"left"}get closePopUps(){return this.config.closePopUps||this.getClosePopUps()}getClosePopUps(){return!0}get parentContainer(){var t;return((t=this.config)==null?void 0:t.parentContainer)||"playbackBar"}get className(){return""}enable(){this._enabled=!0,this.show()}disable(){this._enabled=!1,this.hide()}hide(){this._button&&(this._button.style.display="none")}show(){if(this._enabled===!1)return;const{width:t}=this.player.playbackBar.containerSize;this._button&&(t>this.minContainerSize||this.parentContainer!=="playbackBar")&&(this._button.style.display=null)}get leftSideContainer(){return mt(this,De)||(vs(this,De,wl()),this.container.appendChild(mt(this,De))),mt(this,De)}get leftSideContainerPresent(){return mt(this,De)!==null}get rightSideContainer(){return mt(this,Pe)||(vs(this,Pe,wl()),this.container.appendChild(mt(this,Pe))),mt(this,Pe)}get rightSideContainerPresent(){return mt(this,Pe)!==null}get stateText(){return null}get stateIcon(){return null}setState({text:t=null,icon:e=null}={}){var i,s;const r=this._statusText,a=this._statusIcon;this._statusText=t,this._statusIcon=e,mt(this,_s).forEach(o=>o(this)),this._statusIcon&&(this.icon=this._statusIcon,this.menuIcon=this._statusIcon),this._statusText&&(this.title=this._statusText),(s=(i=this._observer)==null?void 0:i.onStateChanged)==null||s.call(i,this,r,t,a,e)}onStateChange(t){typeof t=="function"?mt(this,_s).push(t):this.player.log.warn("Invalid callback for ButtonPlugin.onStateChange")}async action(t,e=null){}onResize({width:t,height:e}){t<this.minContainerSize?this.hide():this.show()}focus(){var t;(t=this.button)==null||t.focus()}blur(){var t;(t=this.button)==null||t.blur()}isFocus(){return this.button===document.activeElement}};Ts=new WeakSet,lr=function(){var n;const t=this.isMenuButton?this._menuIcon:this._icon,e=this.isMenuButton&&this.haveMenuIcon?this.menuIcon:this.icon;if(e&&this._button instanceof HTMLElement){const i=this._button.querySelector("i")||ke("<i></i>",this._button);i.innerHTML=e}else if(this._button instanceof HTMLElement){const i=this._button.querySelector("i");i&&this._button.removeChild(i)}(n=this._observer)!=null&&n.onIconChanged&&this._observer.onIconChanged(this,t,e)},De=new WeakMap,Pe=new WeakMap,_s=new WeakMap;class Il extends Sl{get type(){return"canvasButton"}get content(){return this._config.content||["presenter"]}get ariaLabel(){return this._config.ariaLabel||this.getAriaLabel()}getAriaLabel(){return""}get tabIndex(){return this.config.tabIndex}get description(){return this.config.description||this.getDescription()}getDescription(){return""}get icon(){return this._icon}set icon(t){this._icon=t}get side(){var t;return((t=this.config)==null?void 0:t.side)||"left"}get buttonName(){return this.name}get position(){switch(this.side){case"left":return cr.LEFT;case"center":return cr.CENTER;case"right":return cr.RIGHT;default:throw new Error(`Invalid CanvasButtonPlugin side set: ${this.side}`)}}async action(t){this.player.log.warn(`Action not implemented in canvas button plugin ${this.name}`)}}const cr=Object.freeze({LEFT:"left",CENTER:"center",RIGHT:"right"});let Qm=class extends jm{constructor(t,e,i){super(e,{tag:t,parent:i}),this.element.className="video-canvas",this._userArea=null,this._buttonsArea=ke(`
        <div class="button-area">
        </div>
        `,this.element)}async loadCanvas(t){throw Error(`${this.name}: loadCanvas() not implemented`)}get userArea(){return this._userArea||(this._userArea=document.createElement("div"),this._userArea.className="user-area",this.element.appendChild(this._userArea)),this._userArea}get buttonsArea(){return this._buttonsArea}showButtons(){this.buttonsArea.style.display=null}hideButtons(){this.buttonsArea.style.display="none"}},Xm=class extends bl{get type(){return"canvas"}get canvasType(){return""}isCompatible(t){return Array.isArray(t==null?void 0:t.canvas)?t.canvas.indexOf(this.canvasType)!==-1:t.canvas===this.canvasType}getCanvasInstance(t){throw Error(`${this.name} canvas plugin: getCanvasInstance() not implemented`)}},Jm=class extends hr{constructor(){super(...arguments),this._refreshContent=!0}set refreshContent(t){this._refreshContent=t}get refreshContent(){return this._refreshContent}get closeParentPopUp(){return this.config.closeParentPopUp||this.getCloseParentPopUp()}getCloseParentPopUp(){return!1}async action(t,e){super.action(t,e),this.parentPopUp=e,await this.showPopUp()}get parentPopUp(){return this._parentPopUp}set parentPopUp(t){this._parentPopUp=t}get popUp(){return this._popUp}get menuTitle(){return this.config.menuTitle||null}get moveable(){return this.config.moveable??!1}get resizeable(){return this.config.resizeable??!1}get customPopUpClass(){return this.config.customPopUpClass??""}get closeActions(){var t,e;const i=((t=this.config.closeActions)==null?void 0:t.clickOutside)??!0,s=((e=this.config.closeActions)==null?void 0:e.closeButton)??!1;return{clickOutside:i,closeButton:s}}get currentContent(){return this._currentContent}async getContent(){return ke("<p>Pop Up Button Plugin Content</p>")}async checkRefreshContent(){if(this.refreshContent){const t=await this.getContent();this._currentContent.innerHTML="",Array.from(t.children).forEach(e=>this._currentContent.appendChild(e))}}get popUpType(){return this.config.popUpType||"modal"}hidePopUp(){this.player.playbackBar.popUp.isHidden||this.player.playbackBar.popUp.hide()}async showPopUp(){this._keyEventHandler||(this._keyEventHandler=e=>{e.key==="Escape"&&this.hidePopUp()},this.button.addEventListener("keydown",this._keyEventHandler));const t=this.player.playbackBar.popUp;if(t.isHidden||this._contentId!==t.currentContentId){const e=await this.getContent();this._currentContent=e,this._contentId=t.show({title:this.menuTitle||this.description,content:e,attachRight:this.popUpType==="timeline"||this.side==="right",attachLeft:this.popUpType==="timeline"||this.side==="left",parent:this.parentPopUp})}else t.hide()}};const t1=n=>n?`<span class="menu-title">${n}</span>`:"",e1=n=>n?`<i class="menu-icon">${n}</i>`:"",i1=n=>n?`aria-label="${n}"`:"",s1=n=>n?`<span class="state-text">${n}</span>`:"",n1=n=>n?`<i class="state-icon">${n}</i>`:"",r1=(n,t)=>n||t?`<span class="button-state">${s1(n)}${n1(t)}</span>`:"";function a1({itemData:n,buttonType:t,container:e,allItems:i,menuName:s,selectedItems:r,itemPlugin:a}){const{id:o=0,title:l=null,icon:h=null,iconText:c=null,showTitle:u=!0,stateText:d=null,stateIcon:g=null}=n,f=this,p=document.createElement("li"),y=r[o]??!1,v=ke(`
		<button class="menu-button-item${y?" selected":""}" ${i1(l)} data-id="${o}"" id="${f.name}_menuItem_${o}">
			${e1(h)}
			${u?t1(l):""}
			${d||g?r1(d,g):""}
		</button>
	`);return a&&(a._button=v),v.addEventListener("keydown",E=>{var _;const T=()=>{E.stopPropagation(),E.preventDefault()};if(E.key==="ArrowUp"){const L=v.dataPrev;L==null||L.focus(),T()}else if(E.key==="ArrowDown"){const L=v.dataNext;L==null||L.focus(),T()}else if(E.key==="Tab"){const L=E.shiftKey?E.target.dataPrev:E.target.dataNext;L==null||L.focus(),T()}else E.key==="Escape"&&(this.player.playbackBar.popUp.pop()?(_=f.button)==null||_.focus():this.focus(),T())}),v.addEventListener("click",async E=>{if(t==="check"){const _=i.find(T=>T.id===o);r[o]=!r[o],f.itemSelected(_,i)}else if(t==="radio"){r[o]=!0;let _=null;i.forEach(T=>{T.id===o?_=T:r[T.id]=!1}),f.itemSelected(_,i)}else{const _=i.find(T=>T.id===o);f.itemSelected(_,i)}await f.checkRefreshContent(),E.stopPropagation(),f.closeOnSelect&&(f.closeMenu(),zm(f.player))}),p.appendChild(v),e.appendChild(p),p}let o1=class extends Jm{get closeOnSelect(){return this.config.closeOnSelect===void 0&&(this.buttonType!=="check"?this.config.closeOnSelect=!0:this.config.closeOnSelect=!1),this.config.closeOnSelect}setSelected(t,e){this._selectedItems&&(this._selectedItems[t]=e)}async getContent(){var t,e;const i=(t=document.activeElement)==null?void 0:t.id,s=ke("<menu></menu>");this._content=s;const r=await this.getMenu();this._menuItems=r,this._selectedItems||(this._selectedItems={},this._menuItems.forEach(l=>{l.selected!==void 0&&l.selected!==null&&(this._selectedItems[l.id]=l.selected)}));const a=self.crypto.randomUUID(),o=r.map(l=>a1.apply(this,[{itemData:l,buttonType:typeof this.buttonType=="function"?this.buttonType():this.buttonType,container:s,allItems:r,menuName:a,selectedItems:this._selectedItems,itemPlugin:l.plugin}]));return o.forEach((l,h,c)=>{const u=l.querySelector("button");let d=c[h+1],g=c[h-1];h===c.length-1&&(d=c[0]),h===0&&(g=c[c.length-1]),u.dataNext=d==null?void 0:d.querySelector("button"),u.dataPrev=g==null?void 0:g.querySelector("button")}),this._firstItem=(e=o[0])==null?void 0:e.querySelector("button"),i&&setTimeout(()=>{var l;(l=document.getElementById(i))==null||l.focus()},10),s}get menuTitle(){return this.config.menuTitle||null}async getMenu(){return[{id:0,title:"Option 1"},{id:1,title:"Option 2"},{id:2,title:"Option 3"},{id:3,title:"Option 4"},{id:4,title:"Option 5"}]}get menuItems(){return this._menuItems}get showTitles(){return!0}get buttonType(){return"radio"}itemSelected(t,e){this.player.log.warn(`MenuButtonPlugin (${this.name}): itemSelected() function not implemented.`)}closeMenu(){this.player.playbackBar.popUp.hide()}async showPopUp(){this.refreshContent=!0,await super.showPopUp(),this.player.containsFocus&&this._firstItem&&this._firstItem.focus()}};Object.freeze({DISABLED:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,VERBOSE:5}).INFO;const l1="@asicupv/paella-zoom-plugin",h1="2.2.0",Al={name:l1,version:h1},c1={"Zoom in":"Zoom in","Zoom out":"Zoom out","Show video zoom options":"Zoom-Optionen anzeigen","Use Alt+Scroll to zoom":"Zum Zoomen Alt+Rollen drücken"},u1={"Zoom in":"Zoom in","Zoom out":"Zoom out","Show video zoom options":"Show video zoom options","Use Alt+Scroll to zoom":"Use Alt+Scroll to zoom"},d1={"Zoom in":"Ampliar zoom del vídeo","Zoom out":"Reducir zoom de vídeo","Show video zoom options":"Mostrar opciones de zoom de vídeo","Use Alt+Scroll to zoom":"Usar Alt+Desplazamiento para hacer zoom"},f1={de:c1,en:u1,es:d1};let ur=null;class ue extends qm{static Get(){return ur||(ur=new ue),ur}get moduleName(){return Al.name}get moduleVersion(){return Al.version}async getDictionaries(){return f1}}function Ls(n,t,e){const i={w:n.offsetWidth,h:n.offsetHeight},s={left:i.w/2,top:i.h/2};t.style.width=`${e*100}%`,t.style.height=`${e*100}%`;const r={left:t.offsetLeft,top:t.offsetTop,w:t.offsetWidth,h:t.offsetHeight},a={left:r.w/2,top:r.h/2},o={left:a.left-s.left,top:a.top-s.top};return e==1?(t.style.left="0px",t.style.top="0px",o.left=s.left,o.top=s.top):(t.style.left=`-${o.left}px`,t.style.top=`-${o.top}px`),o}function g1(n,t,e){const i={left:t.left+e.left,top:t.top+e.top},s=n.parentElement;return n.style.top=`-${i.top}px`,n.offsetHeight+n.offsetTop-s.offsetHeight<0&&(i.top=t.top),n.style.left=`-${i.left}px`,n.offsetWidth+n.offsetLeft-s.offsetWidth<0&&(i.left=t.left),i}let de=class extends Qm{constructor(t,e,i){super("div",t,e),this.config=i,this._maxZoom=this.config.maxZoom||4,this._showButtons=this.config.showButtons!==void 0?this.config.showButtons:!0}async loadCanvas(t){this.currentZoom=1,this._videoPlayer=t,t.element.style.width="100%",t.element.style.height="100%",t.element.style.position="absolute",t.element.style.top="0",t.element.style.left="0",this.element.style.overflow="hidden",this.element.style.position="relative";const e=c=>{if(c.stopPropagation(),!c.altKey){this.showAltKeyMessage();return}this.hideAltKeyMessage();const u=c.deltaY!==void 0?c.deltaY*.1:c.detail*4,d=this.currentZoom+u*-.01;d>1&&d<=this._maxZoom?(this.currentZoom=d,this._playerCenter=Ls(this.element,this._videoPlayer.element,this.currentZoom)):d<=1&&(this.currentZoom=1,this._playerCenter=Ls(this.element,this._videoPlayer.element,this.currentZoom)),c.preventDefault()};this.element.addEventListener("DOMMouseScroll",e),this.element.addEventListener("mousewheel",e);let i=!1,s=!1,r=null;const a=()=>i=!0,o=()=>i=!1,l=c=>{s&&(c.stopPropagation(),c.preventDefault())};this.element.addEventListener("mousedown",a),this.element.addEventListener("mouseleave",o),this.element.addEventListener("mouseup",o),this.element.addEventListener("click",l),this.element.addEventListener("mouseup",l),this.element.addEventListener("mousemove",c=>{if(i&&this._playerCenter){r===null&&(r={left:c.clientX,top:c.clientY}),s=!0;const u={left:r.left-c.clientX,top:r.top-c.clientY};this.currentZoom==1?this._playerCenter={left:0,top:0}:this._playerCenter=g1(this._videoPlayer.element,this._playerCenter,u),r={left:c.clientX,top:c.clientY}}else s=!1,r=null});const h=this.player.translate("Use Alt+Scroll to zoom");this._zoomMessage=ke(`
            <div class="zoom-message">${h}</div>
        `,this.element),this._zoomMessage.style.display="none"}showAltKeyMessage(){this._hideTimeout&&clearTimeout(this._hideTimeout),this._zoomMessage.style.display="",this._hideTimeout=setTimeout(()=>{this.hideAltKeyMessage()},2e3)}hideAltKeyMessage(){this._zoomMessage.style.display="none",this._hideTimeout=null}zoomIn(){const t=this.currentZoom*1.1;t<this._maxZoom&&(this.currentZoom=t,this._playerCenter=Ls(this.element,this._videoPlayer.element,this.currentZoom))}zoomOut(){const t=this.currentZoom*.9;t>=1&&(this.currentZoom=t,this._playerCenter=Ls(this.element,this._videoPlayer.element,this.currentZoom))}},p1=class extends Xm{getPluginModuleInstance(){return ue.Get()}get name(){return super.name||"es.upv.paella.zoomPlugin"}get canvasType(){return"video"}isCompatible(t){return!Array.isArray(t.canvas)||t.canvas.length===0?!0:super.isCompatible(t)}getCanvasInstance(t){return new de(this.player,t,this.config)}};const Cs=`<svg width="100%" height="100%" viewBox="0 0 32 32" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <path d="M17.094,18.048C15.976,18.956 14.551,19.5 13,19.5C9.413,19.5 6.5,16.587 6.5,13C6.5,9.413 9.413,6.5 13,6.5C16.587,6.5 19.5,9.413 19.5,13C19.5,14.522 18.976,15.923 18.098,17.031L19.553,18.487C20.094,17.958 20.962,17.962 21.498,18.498L25.522,22.522C26.062,23.062 26.062,23.938 25.522,24.478L24.519,25.481C23.98,26.02 23.103,26.02 22.563,25.481L18.539,21.457C18,20.917 18,20.041 18.539,19.501L18.543,19.497L17.094,18.048ZM13,8C15.76,8 18,10.24 18,13C18,15.76 15.76,18 13,18C10.24,18 8,15.76 8,13C8,10.24 10.24,8 13,8ZM13.927,11.886L15.927,11.886L15.927,13.886L13.927,13.886L13.927,15.886L11.927,15.886L11.927,13.886L9.927,13.886L9.927,11.886L11.927,11.886L11.927,9.886L13.927,9.886L13.927,11.886Z"/>
</svg>`;let m1=class extends hr{getPluginModuleInstance(){return ue.Get()}get name(){return super.name||"es.upv.paella.zoomInButtonPlugin"}getAriaLabel(){return"Zoom in"}getDescription(){return this.getAriaLabel()}async isEnabled(){return await super.isEnabled()?(this.target=this.config.target,this._canvas=this.player.videoContainer.streamProvider.streams[this.target].canvas,this._canvas instanceof de):!1}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"zoomInIcon")||Cs}async action(){this._canvas.zoomIn()}};const dr=`<svg width="100%" height="100%" viewBox="0 0 32 32" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <path d="M17.094,18.048C15.976,18.956 14.551,19.5 13,19.5C9.413,19.5 6.5,16.587 6.5,13C6.5,9.413 9.413,6.5 13,6.5C16.587,6.5 19.5,9.413 19.5,13C19.5,14.522 18.976,15.923 18.098,17.031L19.553,18.487C20.094,17.958 20.962,17.962 21.498,18.498L25.522,22.522C26.062,23.062 26.062,23.938 25.522,24.478L24.519,25.481C23.98,26.02 23.103,26.02 22.563,25.481L18.539,21.457C18,20.917 18,20.041 18.539,19.501L18.543,19.497L17.094,18.048ZM13,8C15.76,8 18,10.24 18,13C18,15.76 15.76,18 13,18C10.24,18 8,15.76 8,13C8,10.24 10.24,8 13,8ZM9.927,11.886L15.927,11.886L15.927,13.886L9.927,13.886L9.927,11.886Z"/>
</svg>`,y1=[{plugin:p1,config:{enabled:!1}},{plugin:m1,config:{enabled:!1}},{plugin:class extends hr{getPluginModuleInstance(){return ue.Get()}get name(){return super.name||"es.upv.paella.zoomOutButtonPlugin"}getAriaLabel(){return"Zoom out"}getDescription(){return this.getAriaLabel()}async isEnabled(){return await super.isEnabled()?(this.target=this.config.target,this._canvas=this.player.videoContainer.streamProvider.streams[this.target].canvas,this._canvas instanceof de):!1}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"zoomOutIcon")||dr}async action(){this._canvas.zoomOut()}},config:{enabled:!1}},{plugin:class extends o1{getPluginModuleInstance(){return ue.Get()}get name(){return super.name||"es.upv.paella.zoomMenuButtonPlugin"}getAriaLabel(){return"Show video zoom options"}getDescription(){return this.getAriaLabel()}async isEnabled(){return await super.isEnabled()?(this._target=this.config.target||"presenter",this._canvas=this.player.videoContainer.streamProvider.streams[this._target].canvas,this._canvas instanceof de):!1}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"zoomInIcon")||Cs}async getMenu(){return[{id:"in",title:"Zoom in",icon:this.player.getCustomPluginIcon(this.name,"zoomInIcon")||Cs},{id:"out",title:"Zoom out",icon:this.player.getCustomPluginIcon(this.name,"zoomOutIcon")||dr}]}get buttonType(){return"button"}get showTitles(){return!1}itemSelected(t){switch(t.id){case"in":this._canvas.zoomIn();break;case"out":this._canvas.zoomOut();break}}},config:{enabled:!1}},{plugin:class extends Il{getPluginModuleInstance(){return ue.Get()}get name(){return super.name||"es.upv.paella.canvasZoomInButtonPlugin"}async isEnabled(){if(!await super.isEnabled())return!1;let t=!1;this._streams=this.player.videoContainer.streamProvider.streams;for(const e in this._streams)t||(t=this._streams[e].canvas instanceof de);return t}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"zoomInIcon")||Cs}async action(t,e,i,s){i instanceof de&&i.zoomIn()}},config:{enabled:!1}},{plugin:class extends Il{getPluginModuleInstance(){return ue.Get()}get name(){return super.name||"es.upv.paella.canvasZoomOutButtonPlugin"}async isEnabled(){if(!await super.isEnabled())return!1;let t=!1;this._streams=this.player.videoContainer.streamProvider.streams;for(const e in this._streams)t||(t=this._streams[e].canvas instanceof de);return t}async load(){this.icon=this.player.getCustomPluginIcon(this.name,"zoomOutIcon")||dr}async action(t,e,i,s){i instanceof de&&i.zoomOut()}},config:{enabled:!1}}],v1=(n,t,e)=>{let i=new Kf("playerContainer",{configUrl:n,getVideoId:()=>e.metadata.id,getManifestUrl:()=>"dummy",getManifestFileUrl:()=>"dummy",loadVideoManifest:()=>e,plugins:[...ip,...Zp,...xm,...y1,...Wm]});i.skin.loadSkin(t),i.loadManifest().then(()=>console.log("Initialization done")).catch(s=>console.error(s))};function E1(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Rl={exports:{}};(function(n,t){(function(e){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,h,c){if(c=c||{},l=l.trim(),h=h.trim(),!h){if(!c.alwaysNormalize)return l;var u=o.parseURL(l);if(!u)throw new Error("Error trying to parse base URL.");return u.path=o.normalizePath(u.path),o.buildURLFromParts(u)}var d=o.parseURL(h);if(!d)throw new Error("Error trying to parse relative URL.");if(d.scheme)return c.alwaysNormalize?(d.path=o.normalizePath(d.path),o.buildURLFromParts(d)):h;var g=o.parseURL(l);if(!g)throw new Error("Error trying to parse base URL.");if(!g.netLoc&&g.path&&g.path[0]!=="/"){var f=s.exec(g.path);g.netLoc=f[1],g.path=f[2]}g.netLoc&&!g.path&&(g.path="/");var p={scheme:g.scheme,netLoc:d.netLoc,path:null,params:d.params,query:d.query,fragment:d.fragment};if(!d.netLoc&&(p.netLoc=g.netLoc,d.path[0]!=="/"))if(!d.path)p.path=g.path,d.params||(p.params=g.params,d.query||(p.query=g.query));else{var y=g.path,v=y.substring(0,y.lastIndexOf("/")+1)+d.path;p.path=o.normalizePath(v)}return p.path===null&&(p.path=c.alwaysNormalize?o.normalizePath(d.path):d.path),o.buildURLFromParts(p)},parseURL:function(l){var h=i.exec(l);return h?{scheme:h[1]||"",netLoc:h[2]||"",path:h[3]||"",params:h[4]||"",query:h[5]||"",fragment:h[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(r,"");l.length!==(l=l.replace(a,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};n.exports=o})()})(Rl);var fr=Rl.exports;function kl(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),e.push.apply(e,i)}return e}function yt(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?kl(Object(e),!0).forEach(function(i){L1(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):kl(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function T1(n,t){if(typeof n!="object"||!n)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var i=e.call(n,t);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(n)}function _1(n){var t=T1(n,"string");return typeof t=="symbol"?t:String(t)}function L1(n,t,e){return t=_1(t),t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}function ot(){return ot=Object.assign?Object.assign.bind():function(n){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},ot.apply(this,arguments)}const $=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)},C1=Number.isSafeInteger||function(n){return typeof n=="number"&&Math.abs(n)<=b1},b1=Number.MAX_SAFE_INTEGER||9007199254740991;let m=function(n){return n.MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached",n.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",n}({}),G=function(n){return n.NETWORK_ERROR="networkError",n.MEDIA_ERROR="mediaError",n.KEY_SYSTEM_ERROR="keySystemError",n.MUX_ERROR="muxError",n.OTHER_ERROR="otherError",n}({}),S=function(n){return n.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",n.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",n.KEY_SYSTEM_NO_SESSION="keySystemNoSession",n.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",n.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",n.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",n.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",n.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",n.MANIFEST_LOAD_ERROR="manifestLoadError",n.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",n.MANIFEST_PARSING_ERROR="manifestParsingError",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",n.LEVEL_EMPTY_ERROR="levelEmptyError",n.LEVEL_LOAD_ERROR="levelLoadError",n.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",n.LEVEL_PARSING_ERROR="levelParsingError",n.LEVEL_SWITCH_ERROR="levelSwitchError",n.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",n.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",n.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",n.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",n.FRAG_LOAD_ERROR="fragLoadError",n.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",n.FRAG_DECRYPT_ERROR="fragDecryptError",n.FRAG_PARSING_ERROR="fragParsingError",n.FRAG_GAP="fragGap",n.REMUX_ALLOC_ERROR="remuxAllocError",n.KEY_LOAD_ERROR="keyLoadError",n.KEY_LOAD_TIMEOUT="keyLoadTimeOut",n.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",n.BUFFER_APPEND_ERROR="bufferAppendError",n.BUFFER_APPENDING_ERROR="bufferAppendingError",n.BUFFER_STALLED_ERROR="bufferStalledError",n.BUFFER_FULL_ERROR="bufferFullError",n.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",n.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",n.INTERNAL_EXCEPTION="internalException",n.INTERNAL_ABORTED="aborted",n.UNKNOWN="unknown",n}({});const xe=function(){},gr={trace:xe,debug:xe,log:xe,warn:xe,info:xe,error:xe};let Di=gr;function S1(n){const t=self.console[n];return t?t.bind(self.console,`[${n}] >`):xe}function w1(n,...t){t.forEach(function(e){Di[e]=n[e]?n[e].bind(n):S1(e)})}function I1(n,t){if(typeof console=="object"&&n===!0||typeof n=="object"){w1(n,"debug","log","info","warn","error");try{Di.log(`Debug logs enabled for "${t}" in hls.js version 1.5.20`)}catch{Di=gr}}else Di=gr}const C=Di,A1=/^(\d+)x(\d+)$/,Dl=/(.+?)=(".*?"|.*?)(?:,|$)/g;class nt{constructor(t){typeof t=="string"&&(t=nt.parseAttrList(t)),ot(this,t)}get clientAttrs(){return Object.keys(this).filter(t=>t.substring(0,2)==="X-")}decimalInteger(t){const e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(this[t]){let e=(this[t]||"0x").slice(2);e=(e.length&1?"0":"")+e;const i=new Uint8Array(e.length/2);for(let s=0;s<e.length/2;s++)i[s]=parseInt(e.slice(s*2,s*2+2),16);return i}else return null}hexadecimalIntegerAsNumber(t){const e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}optionalFloat(t,e){const i=this[t];return i?parseFloat(i):e}enumeratedString(t){return this[t]}bool(t){return this[t]==="YES"}decimalResolution(t){const e=A1.exec(this[t]);if(e!==null)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t){let e;const i={},s='"';for(Dl.lastIndex=0;(e=Dl.exec(t))!==null;){let r=e[2];r.indexOf(s)===0&&r.lastIndexOf(s)===r.length-1&&(r=r.slice(1,-1));const a=e[1].trim();i[a]=r}return i}}function R1(n){return n!=="ID"&&n!=="CLASS"&&n!=="START-DATE"&&n!=="DURATION"&&n!=="END-DATE"&&n!=="END-ON-NEXT"}function k1(n){return n==="SCTE35-OUT"||n==="SCTE35-IN"}class pr{constructor(t,e){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,e){const i=e.attr;for(const s in i)if(Object.prototype.hasOwnProperty.call(t,s)&&t[s]!==i[s]){C.warn(`DATERANGE tag attribute: "${s}" does not match for tags with ID: "${t.ID}"`),this._badValueForSameId=s;break}t=ot(new nt({}),i,t)}if(this.attr=t,this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){const i=new Date(this.attr["END-DATE"]);$(i.getTime())&&(this._endDate=i)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const t=this.duration;return t!==null?new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const t=this.attr.decimalFloatingPoint("DURATION");if($(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&$(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class Pi{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var tt={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class mr{constructor(t){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[tt.AUDIO]:null,[tt.VIDEO]:null,[tt.AUDIOVIDEO]:null},this.baseurl=t}setByteRange(t,e){const i=t.split("@",2);let s;i.length===1?s=(e==null?void 0:e.byteRangeEndOffset)||0:s=parseInt(i[1]),this._byteRange=[s,parseInt(i[0])+s]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=fr.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(t){this._url=t}}class bs extends mr{constructor(t,e){super(e),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new Pi,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=t}get decryptdata(){const{levelkeys:t}=this;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null||!$(this.programDateTime))return null;const t=$(this.duration)?this.duration:0;return this.programDateTime+t*1e3}get encrypted(){var t;if((t=this._decryptdata)!=null&&t.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),i=e.length;if(i>1||i===1&&this.levelkeys[e[0]].encrypted)return!0}return!1}setKeyFormat(t){if(this.levelkeys){const e=this.levelkeys[t];e&&!this._decryptdata&&(this._decryptdata=e.getDecryptData(this.sn))}}abortRequests(){var t,e;(t=this.loader)==null||t.abort(),(e=this.keyLoader)==null||e.abort()}setElementaryStreamInfo(t,e,i,s,r,a=!1){const{elementaryStreams:o}=this,l=o[t];if(!l){o[t]={startPTS:e,endPTS:i,startDTS:s,endDTS:r,partial:a};return}l.startPTS=Math.min(l.startPTS,e),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,s),l.endDTS=Math.max(l.endDTS,r)}clearElementaryStreamInfo(){const{elementaryStreams:t}=this;t[tt.AUDIO]=null,t[tt.VIDEO]=null,t[tt.AUDIOVIDEO]=null}}class Pl extends mr{constructor(t,e,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new Pi,this.duration=t.decimalFloatingPoint("DURATION"),this.gap=t.bool("GAP"),this.independent=t.bool("INDEPENDENT"),this.relurl=t.enumeratedString("URI"),this.fragment=e,this.index=s;const a=t.enumeratedString("BYTERANGE");a&&this.setByteRange(a,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:t}=this;return!!(t.audio||t.video||t.audiovideo)}}const D1=10;class xl{constructor(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}reloaded(t){if(!t){this.advanced=!0,this.updated=!0;return}const e=this.lastPartSn-t.lastPartSn,i=this.lastPartIndex-t.lastPartIndex;this.updated=this.endSN!==t.endSN||!!i||!!e||!this.live,this.advanced=this.endSN>t.endSN||e>0||e===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(t.misses*.6):this.misses=t.misses+1,this.availabilityDelay=t.availabilityDelay}get hasProgramDateTime(){return this.fragments.length?$(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||D1}get drift(){const t=this.driftEndTime-this.driftStartTime;return t>0?(this.driftEnd-this.driftStart)*1e3/t:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var t;return(t=this.fragments)!=null&&t.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function yr(n){return Uint8Array.from(atob(n),t=>t.charCodeAt(0))}function P1(n){const t=vr(n).subarray(0,16),e=new Uint8Array(16);return e.set(t,16-t.length),e}function x1(n){const t=function(e,i,s){const r=e[i];e[i]=e[s],e[s]=r};t(n,0,3),t(n,1,2),t(n,4,5),t(n,6,7)}function M1(n){const t=n.split(":");let e=null;if(t[0]==="data"&&t.length===2){const i=t[1].split(";"),s=i[i.length-1].split(",");if(s.length===2){const r=s[0]==="base64",a=s[1];r?(i.splice(-1,1),e=yr(a)):e=P1(a)}}return e}function vr(n){return Uint8Array.from(unescape(encodeURIComponent(n)),t=>t.charCodeAt(0))}const si=typeof self<"u"?self:void 0;var X={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Ct={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Er(n){switch(n){case Ct.FAIRPLAY:return X.FAIRPLAY;case Ct.PLAYREADY:return X.PLAYREADY;case Ct.WIDEVINE:return X.WIDEVINE;case Ct.CLEARKEY:return X.CLEARKEY}}var Ss={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Tr(n){if(n===Ss.WIDEVINE)return X.WIDEVINE;if(n===Ss.PLAYREADY)return X.PLAYREADY;if(n===Ss.CENC||n===Ss.CLEARKEY)return X.CLEARKEY}function _r(n){switch(n){case X.FAIRPLAY:return Ct.FAIRPLAY;case X.PLAYREADY:return Ct.PLAYREADY;case X.WIDEVINE:return Ct.WIDEVINE;case X.CLEARKEY:return Ct.CLEARKEY}}function ws(n){const{drmSystems:t,widevineLicenseUrl:e}=n,i=t?[X.FAIRPLAY,X.WIDEVINE,X.PLAYREADY,X.CLEARKEY].filter(s=>!!t[s]):[];return!i[X.WIDEVINE]&&e&&i.push(X.WIDEVINE),i}const Ml=function(n){return si!=null&&(n=si.navigator)!=null&&n.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function O1(n,t,e,i){let s;switch(n){case X.FAIRPLAY:s=["cenc","sinf"];break;case X.WIDEVINE:case X.PLAYREADY:s=["cenc"];break;case X.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${n}`)}return $1(s,t,e,i)}function $1(n,t,e,i){return[{initDataTypes:n,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:t.map(s=>({contentType:`audio/mp4; codecs="${s}"`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:e.map(s=>({contentType:`video/mp4; codecs="${s}"`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function Ol(n){const t=new Uint16Array(n.buffer,n.byteOffset,n.byteLength/2),e=String.fromCharCode.apply(null,Array.from(t)),i=e.substring(e.indexOf("<"),e.length),s=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(s){const r=s.childNodes[0]?s.childNodes[0].nodeValue:s.getAttribute("VALUE");if(r){const a=yr(r).subarray(0,16);return x1(a),a}}return null}function Me(n,t,e){return Uint8Array.prototype.slice?n.slice(t,e):new Uint8Array(Array.prototype.slice.call(n,t,e))}const Lr=(n,t)=>t+10<=n.length&&n[t]===73&&n[t+1]===68&&n[t+2]===51&&n[t+3]<255&&n[t+4]<255&&n[t+6]<128&&n[t+7]<128&&n[t+8]<128&&n[t+9]<128,$l=(n,t)=>t+10<=n.length&&n[t]===51&&n[t+1]===68&&n[t+2]===73&&n[t+3]<255&&n[t+4]<255&&n[t+6]<128&&n[t+7]<128&&n[t+8]<128&&n[t+9]<128,xi=(n,t)=>{const e=t;let i=0;for(;Lr(n,t);){i+=10;const s=Is(n,t+6);i+=s,$l(n,t+10)&&(i+=10),t+=i}if(i>0)return n.subarray(e,e+i)},Is=(n,t)=>{let e=0;return e=(n[t]&127)<<21,e|=(n[t+1]&127)<<14,e|=(n[t+2]&127)<<7,e|=n[t+3]&127,e},N1=(n,t)=>Lr(n,t)&&Is(n,t+6)+10<=n.length-t,Cr=n=>{const t=Fl(n);for(let e=0;e<t.length;e++){const i=t[e];if(Nl(i))return H1(i)}},Nl=n=>n&&n.key==="PRIV"&&n.info==="com.apple.streaming.transportStreamTimestamp",F1=n=>{const t=String.fromCharCode(n[0],n[1],n[2],n[3]),e=Is(n,4),i=10;return{type:t,size:e,data:n.subarray(i,i+e)}},Fl=n=>{let t=0;const e=[];for(;Lr(n,t);){const i=Is(n,t+6);t+=10;const s=t+i;for(;t+8<s;){const r=F1(n.subarray(t)),a=U1(r);a&&e.push(a),t+=r.size+10}$l(n,t)&&(t+=10)}return e},U1=n=>n.type==="PRIV"?B1(n):n.type[0]==="W"?V1(n):G1(n),B1=n=>{if(n.size<2)return;const t=Zt(n.data,!0),e=new Uint8Array(n.data.subarray(t.length+1));return{key:n.type,info:t,data:e.buffer}},G1=n=>{if(n.size<2)return;if(n.type==="TXXX"){let e=1;const i=Zt(n.data.subarray(e),!0);e+=i.length+1;const s=Zt(n.data.subarray(e));return{key:n.type,info:i,data:s}}const t=Zt(n.data.subarray(1));return{key:n.type,data:t}},V1=n=>{if(n.type==="WXXX"){if(n.size<2)return;let e=1;const i=Zt(n.data.subarray(e),!0);e+=i.length+1;const s=Zt(n.data.subarray(e));return{key:n.type,info:i,data:s}}const t=Zt(n.data);return{key:n.type,data:t}},H1=n=>{if(n.data.byteLength===8){const t=new Uint8Array(n.data),e=t[3]&1;let i=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return i/=45,e&&(i+=4772185884e-2),Math.round(i)}},Zt=(n,t=!1)=>{const e=K1();if(e){const h=e.decode(n);if(t){const c=h.indexOf("\0");return c!==-1?h.substring(0,c):h}return h.replace(/\0/g,"")}const i=n.length;let s,r,a,o="",l=0;for(;l<i;){if(s=n[l++],s===0&&t)return o;if(!(s===0||s===3))switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:r=n[l++],o+=String.fromCharCode((s&31)<<6|r&63);break;case 14:r=n[l++],a=n[l++],o+=String.fromCharCode((s&15)<<12|(r&63)<<6|(a&63)<<0);break}}return o};let br;function K1(){if(!navigator.userAgent.includes("PlayStation 4"))return!br&&typeof self.TextDecoder<"u"&&(br=new self.TextDecoder("utf-8")),br}const Qt={hexDump:function(n){let t="";for(let e=0;e<n.length;e++){let i=n[e].toString(16);i.length<2&&(i="0"+i),t+=i}return t}},As=Math.pow(2,32)-1,W1=[].push,Ul={video:1,audio:2,id3:3,text:4};function dt(n){return String.fromCharCode.apply(null,n)}function Bl(n,t){const e=n[t]<<8|n[t+1];return e<0?65536+e:e}function B(n,t){const e=Vl(n,t);return e<0?4294967296+e:e}function Gl(n,t){let e=B(n,t);return e*=Math.pow(2,32),e+=B(n,t+4),e}function Vl(n,t){return n[t]<<24|n[t+1]<<16|n[t+2]<<8|n[t+3]}function Sr(n,t,e){n[t]=e>>24,n[t+1]=e>>16&255,n[t+2]=e>>8&255,n[t+3]=e&255}function z1(n){const t=n.byteLength;for(let e=0;e<t;){const i=B(n,e);if(i>8&&n[e+4]===109&&n[e+5]===111&&n[e+6]===111&&n[e+7]===102)return!0;e=i>1?e+i:t}return!1}function W(n,t){const e=[];if(!t.length)return e;const i=n.byteLength;for(let s=0;s<i;){const r=B(n,s),a=dt(n.subarray(s+4,s+8)),o=r>1?s+r:i;if(a===t[0])if(t.length===1)e.push(n.subarray(s+8,o));else{const l=W(n.subarray(s+8,o),t.slice(1));l.length&&W1.apply(e,l)}s=o}return e}function Y1(n){const t=[],e=n[0];let i=8;const s=B(n,i);i+=4;let r=0,a=0;e===0?(r=B(n,i),a=B(n,i+4),i+=8):(r=Gl(n,i),a=Gl(n,i+8),i+=16),i+=2;let o=n.length+a;const l=Bl(n,i);i+=2;for(let h=0;h<l;h++){let c=i;const u=B(n,c);c+=4;const d=u&2147483647;if((u&2147483648)>>>31===1)return C.warn("SIDX has hierarchical references (not supported)"),null;const g=B(n,c);c+=4,t.push({referenceSize:d,subsegmentDuration:g,info:{duration:g/s,start:o,end:o+d-1}}),o+=d,c+=4,i=c}return{earliestPresentationTime:r,timescale:s,version:e,referencesCount:l,references:t}}function Hl(n){const t=[],e=W(n,["moov","trak"]);for(let i=0;i<e.length;i++){const s=e[i],r=W(s,["tkhd"])[0];if(r){let a=r[0];const o=B(r,a===0?12:20),l=W(s,["mdia","mdhd"])[0];if(l){a=l[0];const h=B(l,a===0?12:20),c=W(s,["mdia","hdlr"])[0];if(c){const u=dt(c.subarray(8,12)),d={soun:tt.AUDIO,vide:tt.VIDEO}[u];if(d){const g=W(s,["mdia","minf","stbl","stsd"])[0],f=j1(g);t[o]={timescale:h,type:d},t[d]=yt({timescale:h,id:o},f)}}}}}return W(n,["moov","mvex","trex"]).forEach(i=>{const s=B(i,4),r=t[s];r&&(r.default={duration:B(i,12),flags:B(i,20)})}),t}function j1(n){const t=n.subarray(8),e=t.subarray(86),i=dt(t.subarray(4,8));let s=i;const r=i==="enca"||i==="encv";if(r){const a=W(t,[i])[0].subarray(i==="enca"?28:78);W(a,["sinf"]).forEach(o=>{const l=W(o,["schm"])[0];if(l){const h=dt(l.subarray(4,8));if(h==="cbcs"||h==="cenc"){const c=W(o,["frma"])[0];c&&(s=dt(c))}}})}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const a=W(e,["avcC"])[0];s+="."+Rs(a[1])+Rs(a[2])+Rs(a[3]);break}case"mp4a":{const a=W(t,[i])[0],o=W(a.subarray(28),["esds"])[0];if(o&&o.length>12){let l=4;if(o[l++]!==3)break;l=wr(o,l),l+=2;const h=o[l++];if(h&128&&(l+=2),h&64&&(l+=o[l++]),o[l++]!==4)break;l=wr(o,l);const c=o[l++];if(c===64)s+="."+Rs(c);else break;if(l+=12,o[l++]!==5)break;l=wr(o,l);const u=o[l++];let d=(u&248)>>3;d===31&&(d+=1+((u&7)<<3)+((o[l]&224)>>5)),s+="."+d}break}case"hvc1":case"hev1":{const a=W(e,["hvcC"])[0],o=a[1],l=["","A","B","C"][o>>6],h=o&31,c=B(a,2),u=(o&32)>>5?"H":"L",d=a[12],g=a.subarray(6,12);s+="."+l+h,s+="."+c.toString(16).toUpperCase(),s+="."+u+d;let f="";for(let p=g.length;p--;){const y=g[p];(y||f)&&(f="."+y.toString(16).toUpperCase()+f)}s+=f;break}case"dvh1":case"dvhe":{const a=W(e,["dvcC"])[0],o=a[2]>>1&127,l=a[2]<<5&32|a[3]>>3&31;s+="."+Xt(o)+"."+Xt(l);break}case"vp09":{const a=W(e,["vpcC"])[0],o=a[4],l=a[5],h=a[6]>>4&15;s+="."+Xt(o)+"."+Xt(l)+"."+Xt(h);break}case"av01":{const a=W(e,["av1C"])[0],o=a[1]>>>5,l=a[1]&31,h=a[2]>>>7?"H":"M",c=(a[2]&64)>>6,u=(a[2]&32)>>5,d=o===2&&c?u?12:10:c?10:8,g=(a[2]&16)>>4,f=(a[2]&8)>>3,p=(a[2]&4)>>2,y=a[2]&3;s+="."+o+"."+Xt(l)+h+"."+Xt(d)+"."+g+"."+f+p+y+"."+Xt(1)+"."+Xt(1)+"."+Xt(1)+".0";break}}return{codec:s,encrypted:r}}function wr(n,t){const e=t+5;for(;n[t++]&128&&t<e;);return t}function Rs(n){return("0"+n.toString(16).toUpperCase()).slice(-2)}function Xt(n){return(n<10?"0":"")+n}function q1(n,t){if(!n||!t)return n;const e=t.keyId;return e&&t.isCommonEncryption&&W(n,["moov","trak"]).forEach(i=>{const s=W(i,["mdia","minf","stbl","stsd"])[0].subarray(8);let r=W(s,["enca"]);const a=r.length>0;a||(r=W(s,["encv"])),r.forEach(o=>{const l=a?o.subarray(28):o.subarray(78);W(l,["sinf"]).forEach(h=>{const c=Kl(h);if(c){const u=c.subarray(8,24);u.some(d=>d!==0)||(C.log(`[eme] Patching keyId in 'enc${a?"a":"v"}>sinf>>tenc' box: ${Qt.hexDump(u)} -> ${Qt.hexDump(e)}`),c.set(e,8))}})})}),n}function Kl(n){const t=W(n,["schm"])[0];if(t){const e=dt(t.subarray(4,8));if(e==="cbcs"||e==="cenc")return W(n,["schi","tenc"])[0]}return null}function Z1(n,t){return W(t,["moof","traf"]).reduce((e,i)=>{const s=W(i,["tfdt"])[0],r=s[0],a=W(i,["tfhd"]).reduce((o,l)=>{const h=B(l,4),c=n[h];if(c){let u=B(s,4);if(r===1){if(u===As)return C.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),o;u*=As+1,u+=B(s,8)}const d=c.timescale||9e4,g=u/d;if($(g)&&(o===null||g<o))return g}return o},null);return a!==null&&$(a)&&(e===null||a<e)?a:e},null)}function Q1(n,t){let e=0,i=0,s=0;const r=W(n,["moof","traf"]);for(let a=0;a<r.length;a++){const o=r[a],l=W(o,["tfhd"])[0],h=B(l,4),c=t[h];if(!c)continue;const u=c.default,d=B(l,0)|(u==null?void 0:u.flags);let g=u==null?void 0:u.duration;d&8&&(d&2?g=B(l,12):g=B(l,8));const f=c.timescale||9e4,p=W(o,["trun"]);for(let y=0;y<p.length;y++){if(e=X1(p[y]),!e&&g){const v=B(p[y],4);e=g*v}c.type===tt.VIDEO?i+=e/f:c.type===tt.AUDIO&&(s+=e/f)}}if(i===0&&s===0){let a=1/0,o=0,l=0;const h=W(n,["sidx"]);for(let c=0;c<h.length;c++){const u=Y1(h[c]);if(u!=null&&u.references){a=Math.min(a,u.earliestPresentationTime/u.timescale);const d=u.references.reduce((g,f)=>g+f.info.duration||0,0);o=Math.max(o,d+u.earliestPresentationTime/u.timescale),l=o-a}}if(l&&$(l))return l}return i||s}function X1(n){const t=B(n,0);let e=8;t&1&&(e+=4),t&4&&(e+=4);let i=0;const s=B(n,4);for(let r=0;r<s;r++){if(t&256){const a=B(n,e);i+=a,e+=4}t&512&&(e+=4),t&1024&&(e+=4),t&2048&&(e+=4)}return i}function J1(n,t,e){W(t,["moof","traf"]).forEach(i=>{W(i,["tfhd"]).forEach(s=>{const r=B(s,4),a=n[r];if(!a)return;const o=a.timescale||9e4;W(i,["tfdt"]).forEach(l=>{const h=l[0],c=e*o;if(c){let u=B(l,4);if(h===0)u-=c,u=Math.max(u,0),Sr(l,4,u);else{u*=Math.pow(2,32),u+=B(l,8),u-=c,u=Math.max(u,0);const d=Math.floor(u/(As+1)),g=Math.floor(u%(As+1));Sr(l,4,d),Sr(l,8,g)}}})})})}function ty(n){const t={valid:null,remainder:null},e=W(n,["moof"]);if(e.length<2)return t.remainder=n,t;const i=e[e.length-1];return t.valid=Me(n,0,i.byteOffset-8),t.remainder=Me(n,i.byteOffset-8),t}function Rt(n,t){const e=new Uint8Array(n.length+t.length);return e.set(n),e.set(t,n.length),e}function Wl(n,t){const e=[],i=t.samples,s=t.timescale,r=t.id;let a=!1;return W(i,["moof"]).map(o=>{const l=o.byteOffset-8;W(o,["traf"]).map(h=>{const c=W(h,["tfdt"]).map(u=>{const d=u[0];let g=B(u,4);return d===1&&(g*=Math.pow(2,32),g+=B(u,8)),g/s})[0];return c!==void 0&&(n=c),W(h,["tfhd"]).map(u=>{const d=B(u,4),g=B(u,0)&16777215,f=(g&1)!==0,p=(g&2)!==0,y=(g&8)!==0;let v=0;const E=(g&16)!==0;let _=0;const T=(g&32)!==0;let L=8;d===r&&(f&&(L+=8),p&&(L+=4),y&&(v=B(u,L),L+=4),E&&(_=B(u,L),L+=4),T&&(L+=4),t.type==="video"&&(a=ey(t.codec)),W(h,["trun"]).map(w=>{const I=w[0],D=B(w,0)&16777215,P=(D&1)!==0;let R=0;const k=(D&4)!==0,Y=(D&256)!==0;let M=0;const j=(D&512)!==0;let F=0;const H=(D&1024)!==0,x=(D&2048)!==0;let N=0;const J=B(w,4);let K=8;P&&(R=B(w,K),K+=4),k&&(K+=4);let q=R+l;for(let lt=0;lt<J;lt++){if(Y?(M=B(w,K),K+=4):M=v,j?(F=B(w,K),K+=4):F=_,H&&(K+=4),x&&(I===0?N=B(w,K):N=Vl(w,K),K+=4),t.type===tt.VIDEO){let ft=0;for(;ft<F;){const gt=B(i,q);if(q+=4,iy(a,i[q])){const It=i.subarray(q,q+gt);zl(It,a?2:1,n+N/s,e)}q+=gt,ft+=gt+4}}n+=M/s}}))})})}),e}function ey(n){if(!n)return!1;const t=n.indexOf("."),e=t<0?n:n.substring(0,t);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function iy(n,t){if(n){const e=t>>1&63;return e===39||e===40}else return(t&31)===6}function zl(n,t,e,i){const s=Yl(n);let r=0;r+=t;let a=0,o=0,l=0;for(;r<s.length;){a=0;do{if(r>=s.length)break;l=s[r++],a+=l}while(l===255);o=0;do{if(r>=s.length)break;l=s[r++],o+=l}while(l===255);const h=s.length-r;let c=r;if(o<h)r+=o;else if(o>h){C.error(`Malformed SEI payload. ${o} is too small, only ${h} bytes left to parse.`);break}if(a===4){if(s[c++]===181){const u=Bl(s,c);if(c+=2,u===49){const d=B(s,c);if(c+=4,d===1195456820){const g=s[c++];if(g===3){const f=s[c++],p=31&f,y=64&f,v=y?2+p*3:0,E=new Uint8Array(v);if(y){E[0]=f;for(let _=1;_<v;_++)E[_]=s[c++]}i.push({type:g,payloadType:a,pts:e,bytes:E})}}}}}else if(a===5&&o>16){const u=[];for(let f=0;f<16;f++){const p=s[c++].toString(16);u.push(p.length==1?"0"+p:p),(f===3||f===5||f===7||f===9)&&u.push("-")}const d=o-16,g=new Uint8Array(d);for(let f=0;f<d;f++)g[f]=s[c++];i.push({payloadType:a,pts:e,uuid:u.join(""),userData:Zt(g),userDataBytes:g})}}}function Yl(n){const t=n.byteLength,e=[];let i=1;for(;i<t-2;)n[i]===0&&n[i+1]===0&&n[i+2]===3?(e.push(i+2),i+=2):i++;if(e.length===0)return n;const s=t-e.length,r=new Uint8Array(s);let a=0;for(i=0;i<s;a++,i++)a===e[0]&&(a++,e.shift()),r[i]=n[a];return r}function sy(n){const t=n[0];let e="",i="",s=0,r=0,a=0,o=0,l=0,h=0;if(t===0){for(;dt(n.subarray(h,h+1))!=="\0";)e+=dt(n.subarray(h,h+1)),h+=1;for(e+=dt(n.subarray(h,h+1)),h+=1;dt(n.subarray(h,h+1))!=="\0";)i+=dt(n.subarray(h,h+1)),h+=1;i+=dt(n.subarray(h,h+1)),h+=1,s=B(n,12),r=B(n,16),o=B(n,20),l=B(n,24),h=28}else if(t===1){h+=4,s=B(n,h),h+=4;const u=B(n,h);h+=4;const d=B(n,h);for(h+=4,a=2**32*u+d,C1(a)||(a=Number.MAX_SAFE_INTEGER,C.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=B(n,h),h+=4,l=B(n,h),h+=4;dt(n.subarray(h,h+1))!=="\0";)e+=dt(n.subarray(h,h+1)),h+=1;for(e+=dt(n.subarray(h,h+1)),h+=1;dt(n.subarray(h,h+1))!=="\0";)i+=dt(n.subarray(h,h+1)),h+=1;i+=dt(n.subarray(h,h+1)),h+=1}const c=n.subarray(h,n.byteLength);return{schemeIdUri:e,value:i,timeScale:s,presentationTime:a,presentationTimeDelta:r,eventDuration:o,id:l,payload:c}}function ny(n,...t){const e=t.length;let i=8,s=e;for(;s--;)i+=t[s].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(n,4),s=0,i=8;s<e;s++)r.set(t[s],i),i+=t[s].byteLength;return r}function ry(n,t,e){if(n.byteLength!==16)throw new RangeError("Invalid system id");let i,s;i=0,s=new Uint8Array;let r;i>0?(r=new Uint8Array(4),t.length>0&&new DataView(r.buffer).setUint32(0,t.length,!1)):r=new Uint8Array;const a=new Uint8Array(4);return e&&e.byteLength>0&&new DataView(a.buffer).setUint32(0,e.byteLength,!1),ny([112,115,115,104],new Uint8Array([i,0,0,0]),n,r,s,a,e||new Uint8Array)}function ay(n){const t=[];if(n instanceof ArrayBuffer){const e=n.byteLength;let i=0;for(;i+32<e;){const s=new DataView(n,i),r=oy(s);t.push(r),i+=r.size}}return t}function oy(n){const t=n.getUint32(0),e=n.byteOffset,i=n.byteLength;if(i<t)return{offset:e,size:i};if(n.getUint32(4)!==1886614376)return{offset:e,size:t};const s=n.getUint32(8)>>>24;if(s!==0&&s!==1)return{offset:e,size:t};const r=n.buffer,a=Qt.hexDump(new Uint8Array(r,e+12,16)),o=n.getUint32(28);let l=null,h=null;if(s===0){if(t-32<o||o<22)return{offset:e,size:t};h=new Uint8Array(r,e+32,o)}else if(s===1){if(!o||i<e+32+o*16+16)return{offset:e,size:t};l=[];for(let c=0;c<o;c++)l.push(new Uint8Array(r,e+32+c*16,16))}return{version:s,systemId:a,kids:l,data:h,offset:e,size:t}}let ks={};class ni{static clearKeyUriToKeyIdMap(){ks={}}constructor(t,e,i,s=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=e,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=t?t!=="NONE":!1,this.isCommonEncryption=this.encrypted&&t!=="AES-128"}isSupported(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Ct.FAIRPLAY:case Ct.WIDEVINE:case Ct.PLAYREADY:case Ct.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(t){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof t!="number"&&(this.method==="AES-128"&&!this.iv&&C.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),t=0);const i=ly(t);return new ni(this.method,this.uri,"identity",this.keyFormatVersions,i)}const e=M1(this.uri);if(e)switch(this.keyFormat){case Ct.WIDEVINE:this.pssh=e,e.length>=22&&(this.keyId=e.subarray(e.length-22,e.length-6));break;case Ct.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=ry(i,null,e),this.keyId=Ol(e);break}default:{let i=e.subarray(0,16);if(i.length!==16){const s=new Uint8Array(16);s.set(i,16-i.length),i=s}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=ks[this.uri];if(!i){const s=Object.keys(ks).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,s),ks[this.uri]=i}this.keyId=i}return this}}function ly(n){const t=new Uint8Array(16);for(let e=12;e<16;e++)t[e]=n>>8*(15-e)&255;return t}const jl=/\{\$([a-zA-Z0-9-_]+)\}/g;function ql(n){return jl.test(n)}function wt(n,t,e){if(n.variableList!==null||n.hasVariableRefs)for(let i=e.length;i--;){const s=e[i],r=t[s];r&&(t[s]=Ir(n,r))}}function Ir(n,t){if(n.variableList!==null||n.hasVariableRefs){const e=n.variableList;return t.replace(jl,i=>{const s=i.substring(2,i.length-1),r=e==null?void 0:e[s];return r===void 0?(n.playlistParsingError||(n.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),i):r})}return t}function Zl(n,t,e){let i=n.variableList;i||(n.variableList=i={});let s,r;if("QUERYPARAM"in t){s=t.QUERYPARAM;try{const a=new self.URL(e).searchParams;if(a.has(s))r=a.get(s);else throw new Error(`"${s}" does not match any query parameter in URI: "${e}"`)}catch(a){n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${a.message}`))}}else s=t.NAME,r=t.VALUE;s in i?n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):i[s]=r||""}function hy(n,t,e){const i=t.IMPORT;if(e&&i in e){let s=n.variableList;s||(n.variableList=s={}),s[i]=e[i]}else n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}function fe(n=!0){return typeof self>"u"?void 0:(n||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function cy(n){return typeof self<"u"&&n===self.ManagedMediaSource}const Ds={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function uy(n,t){const e=Ds[t];return!!e&&!!e[n.slice(0,4)]}function Ar(n,t,e=!0){return!n.split(",").some(i=>!Ql(i,t,e))}function Ql(n,t,e=!0){var i;const s=fe(e);return(i=s==null?void 0:s.isTypeSupported(Mi(n,t)))!=null?i:!1}function Mi(n,t){return`${t}/mp4;codecs="${n}"`}function Xl(n){if(n){const t=n.substring(0,4);return Ds.video[t]}return 2}function Ps(n){return n.split(",").reduce((t,e)=>{const i=Ds.video[e];return i?(i*2+t)/(t?3:2):(Ds.audio[e]+t)/(t?2:1)},0)}const Rr={};function dy(n,t=!0){if(Rr[n])return Rr[n];const e={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[n];for(let i=0;i<e.length;i++)if(Ql(e[i],"audio",t))return Rr[n]=e[i],e[i];return n}const fy=/flac|opus/i;function xs(n,t=!0){return n.replace(fy,e=>dy(e.toLowerCase(),t))}function Jl(n,t){return n&&n!=="mp4a"?n:t&&t.split(",")[0]}function gy(n){const t=n.split(",");for(let e=0;e<t.length;e++){const i=t[e].split(".");if(i.length>2){let s=i.shift()+".";s+=parseInt(i.shift()).toString(16),s+=("000"+parseInt(i.shift()).toString(16)).slice(-4),t[e]=s}}return t.join(",")}const th=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,eh=/#EXT-X-MEDIA:(.*)/g,py=/^#EXT(?:INF|-X-TARGETDURATION):/m,ih=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),my=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class Jt{static findGroup(t,e){for(let i=0;i<t.length;i++){const s=t[i];if(s.id===e)return s}}static resolve(t,e){return fr.buildAbsoluteURL(e,t,{alwaysNormalize:!0})}static isMediaPlaylist(t){return py.test(t)}static parseMasterPlaylist(t,e){const i=ql(t),s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];th.lastIndex=0;let a;for(;(a=th.exec(t))!=null;)if(a[1]){var o;const h=new nt(a[1]);wt(s,h,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const c=Ir(s,a[2]),u={attrs:h,bitrate:h.decimalInteger("BANDWIDTH")||h.decimalInteger("AVERAGE-BANDWIDTH"),name:h.NAME,url:Jt.resolve(c,e)},d=h.decimalResolution("RESOLUTION");d&&(u.width=d.width,u.height=d.height),yy(h.CODECS,u),(o=u.unknownCodecs)!=null&&o.length||r.push(u),s.levels.push(u)}else if(a[3]){const h=a[3],c=a[4];switch(h){case"SESSION-DATA":{const u=new nt(c);wt(s,u,["DATA-ID","LANGUAGE","VALUE","URI"]);const d=u["DATA-ID"];d&&(s.sessionData===null&&(s.sessionData={}),s.sessionData[d]=u);break}case"SESSION-KEY":{const u=sh(c,e,s);u.encrypted&&u.isSupported()?(s.sessionKeys===null&&(s.sessionKeys=[]),s.sessionKeys.push(u)):C.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${c}"`);break}case"DEFINE":{{const u=new nt(c);wt(s,u,["NAME","VALUE","QUERYPARAM"]),Zl(s,u,e)}break}case"CONTENT-STEERING":{const u=new nt(c);wt(s,u,["SERVER-URI","PATHWAY-ID"]),s.contentSteering={uri:Jt.resolve(u["SERVER-URI"],e),pathwayId:u["PATHWAY-ID"]||"."};break}case"START":{s.startTimeOffset=nh(c);break}}}const l=r.length>0&&r.length<s.levels.length;return s.levels=l?r:s.levels,s.levels.length===0&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(t,e,i){let s;const r={},a=i.levels,o={AUDIO:a.map(h=>({id:h.attrs.AUDIO,audioCodec:h.audioCodec})),SUBTITLES:a.map(h=>({id:h.attrs.SUBTITLES,textCodec:h.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for(eh.lastIndex=0;(s=eh.exec(t))!==null;){const h=new nt(s[1]),c=h.TYPE;if(c){const u=o[c],d=r[c]||[];r[c]=d,wt(i,h,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const g=h.LANGUAGE,f=h["ASSOC-LANGUAGE"],p=h.CHANNELS,y=h.CHARACTERISTICS,v=h["INSTREAM-ID"],E={attrs:h,bitrate:0,id:l++,groupId:h["GROUP-ID"]||"",name:h.NAME||g||"",type:c,default:h.bool("DEFAULT"),autoselect:h.bool("AUTOSELECT"),forced:h.bool("FORCED"),lang:g,url:h.URI?Jt.resolve(h.URI,e):""};if(f&&(E.assocLang=f),p&&(E.channels=p),y&&(E.characteristics=y),v&&(E.instreamId=v),u!=null&&u.length){const _=Jt.findGroup(u,E.groupId)||u[0];rh(E,_,"audioCodec"),rh(E,_,"textCodec")}d.push(E)}}return r}static parseLevelPlaylist(t,e,i,s,r,a){const o=new xl(e),l=o.fragments;let h=null,c=0,u=0,d=0,g=0,f=null,p=new bs(s,e),y,v,E,_=-1,T=!1,L=null;for(ih.lastIndex=0,o.m3u8=t,o.hasVariableRefs=ql(t);(y=ih.exec(t))!==null;){T&&(T=!1,p=new bs(s,e),p.start=d,p.sn=c,p.cc=g,p.level=i,h&&(p.initSegment=h,p.rawProgramDateTime=h.rawProgramDateTime,h.rawProgramDateTime=null,L&&(p.setByteRange(L),L=null)));const P=y[1];if(P){p.duration=parseFloat(P);const R=(" "+y[2]).slice(1);p.title=R||null,p.tagList.push(R?["INF",P,R]:["INF",P])}else if(y[3]){if($(p.duration)){p.start=d,E&&lh(p,E,o),p.sn=c,p.level=i,p.cc=g,l.push(p);const R=(" "+y[3]).slice(1);p.relurl=Ir(o,R),ah(p,f),f=p,d+=p.duration,c++,u=0,T=!0}}else if(y[4]){const R=(" "+y[4]).slice(1);f?p.setByteRange(R,f):p.setByteRange(R)}else if(y[5])p.rawProgramDateTime=(" "+y[5]).slice(1),p.tagList.push(["PROGRAM-DATE-TIME",p.rawProgramDateTime]),_===-1&&(_=l.length);else{if(y=y[0].match(my),!y){C.warn("No matches on slow regex match for level playlist!");continue}for(v=1;v<y.length&&!(typeof y[v]<"u");v++);const R=(" "+y[v]).slice(1),k=(" "+y[v+1]).slice(1),Y=y[v+2]?(" "+y[v+2]).slice(1):"";switch(R){case"PLAYLIST-TYPE":o.type=k.toUpperCase();break;case"MEDIA-SEQUENCE":c=o.startSN=parseInt(k);break;case"SKIP":{const M=new nt(k);wt(o,M,["RECENTLY-REMOVED-DATERANGES"]);const j=M.decimalInteger("SKIPPED-SEGMENTS");if($(j)){o.skippedSegments=j;for(let H=j;H--;)l.unshift(null);c+=j}const F=M.enumeratedString("RECENTLY-REMOVED-DATERANGES");F&&(o.recentlyRemovedDateranges=F.split("	"));break}case"TARGETDURATION":o.targetduration=Math.max(parseInt(k),1);break;case"VERSION":o.version=parseInt(k);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"#":(k||Y)&&p.tagList.push(Y?[k,Y]:[k]);break;case"DISCONTINUITY":g++,p.tagList.push(["DIS"]);break;case"GAP":p.gap=!0,p.tagList.push([R]);break;case"BITRATE":p.tagList.push([R,k]);break;case"DATERANGE":{const M=new nt(k);wt(o,M,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),wt(o,M,M.clientAttrs);const j=new pr(M,o.dateRanges[M.ID]);j.isValid||o.skippedSegments?o.dateRanges[j.id]=j:C.warn(`Ignoring invalid DATERANGE tag: "${k}"`),p.tagList.push(["EXT-X-DATERANGE",k]);break}case"DEFINE":{{const M=new nt(k);wt(o,M,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in M?hy(o,M,a):Zl(o,M,e)}break}case"DISCONTINUITY-SEQUENCE":g=parseInt(k);break;case"KEY":{const M=sh(k,e,o);if(M.isSupported()){if(M.method==="NONE"){E=void 0;break}E||(E={}),E[M.keyFormat]&&(E=ot({},E)),E[M.keyFormat]=M}else C.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${k}"`);break}case"START":o.startTimeOffset=nh(k);break;case"MAP":{const M=new nt(k);if(wt(o,M,["BYTERANGE","URI"]),p.duration){const j=new bs(s,e);oh(j,M,i,E),h=j,p.initSegment=h,h.rawProgramDateTime&&!p.rawProgramDateTime&&(p.rawProgramDateTime=h.rawProgramDateTime)}else{const j=p.byteRangeEndOffset;if(j){const F=p.byteRangeStartOffset;L=`${j-F}@${F}`}else L=null;oh(p,M,i,E),h=p,T=!0}break}case"SERVER-CONTROL":{const M=new nt(k);o.canBlockReload=M.bool("CAN-BLOCK-RELOAD"),o.canSkipUntil=M.optionalFloat("CAN-SKIP-UNTIL",0),o.canSkipDateRanges=o.canSkipUntil>0&&M.bool("CAN-SKIP-DATERANGES"),o.partHoldBack=M.optionalFloat("PART-HOLD-BACK",0),o.holdBack=M.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const M=new nt(k);o.partTarget=M.decimalFloatingPoint("PART-TARGET");break}case"PART":{let M=o.partList;M||(M=o.partList=[]);const j=u>0?M[M.length-1]:void 0,F=u++,H=new nt(k);wt(o,H,["BYTERANGE","URI"]);const x=new Pl(H,p,e,F,j);M.push(x),p.duration+=x.duration;break}case"PRELOAD-HINT":{const M=new nt(k);wt(o,M,["URI"]),o.preloadHint=M;break}case"RENDITION-REPORT":{const M=new nt(k);wt(o,M,["URI"]),o.renditionReports=o.renditionReports||[],o.renditionReports.push(M);break}default:C.warn(`line parsed but not handled: ${y}`);break}}}f&&!f.relurl?(l.pop(),d-=f.duration,o.partList&&(o.fragmentHint=f)):o.partList&&(ah(p,f),p.cc=g,o.fragmentHint=p,E&&lh(p,E,o));const w=l.length,I=l[0],D=l[w-1];if(d+=o.skippedSegments*o.targetduration,d>0&&w&&D){o.averagetargetduration=d/w;const P=D.sn;o.endSN=P!=="initSegment"?P:0,o.live||(D.endList=!0),I&&(o.startCC=I.cc)}else o.endSN=0,o.startCC=0;return o.fragmentHint&&(d+=o.fragmentHint.duration),o.totalduration=d,o.endCC=g,_>0&&vy(l,_),o}}function sh(n,t,e){var i,s;const r=new nt(n);wt(e,r,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=(i=r.METHOD)!=null?i:"",o=r.URI,l=r.hexadecimalInteger("IV"),h=r.KEYFORMATVERSIONS,c=(s=r.KEYFORMAT)!=null?s:"identity";o&&r.IV&&!l&&C.error(`Invalid IV: ${r.IV}`);const u=o?Jt.resolve(o,t):"",d=(h||"1").split("/").map(Number).filter(Number.isFinite);return new ni(a,u,c,d,l)}function nh(n){const t=new nt(n).decimalFloatingPoint("TIME-OFFSET");return $(t)?t:null}function yy(n,t){let e=(n||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const s=e.filter(r=>uy(r,i));s.length&&(t[`${i}Codec`]=s.join(","),e=e.filter(r=>s.indexOf(r)===-1))}),t.unknownCodecs=e}function rh(n,t,e){const i=t[e];i&&(n[e]=i)}function vy(n,t){let e=n[t];for(let i=t;i--;){const s=n[i];if(!s)return;s.programDateTime=e.programDateTime-s.duration*1e3,e=s}}function ah(n,t){n.rawProgramDateTime?n.programDateTime=Date.parse(n.rawProgramDateTime):t!=null&&t.programDateTime&&(n.programDateTime=t.endProgramDateTime),$(n.programDateTime)||(n.programDateTime=null,n.rawProgramDateTime=null)}function oh(n,t,e,i){n.relurl=t.URI,t.BYTERANGE&&n.setByteRange(t.BYTERANGE),n.level=e,n.sn="initSegment",i&&(n.levelkeys=i),n.initSegment=null}function lh(n,t,e){n.levelkeys=t;const{encryptedFragments:i}=e;(!i.length||i[i.length-1].levelkeys!==t)&&Object.keys(t).some(s=>t[s].isCommonEncryption)&&i.push(n)}var Q={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},U={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function hh(n){const{type:t}=n;switch(t){case Q.AUDIO_TRACK:return U.AUDIO;case Q.SUBTITLE_TRACK:return U.SUBTITLE;default:return U.MAIN}}function kr(n,t){let e=n.url;return(e===void 0||e.indexOf("data:")===0)&&(e=t.url),e}class Ey{constructor(t){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=t,this.registerListeners()}startLoad(t){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:t}=this;t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.LEVEL_LOADING,this.onLevelLoading,this),t.on(m.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(m.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:t}=this;t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.LEVEL_LOADING,this.onLevelLoading,this),t.off(m.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(m.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(t){const e=this.hls.config,i=e.pLoader,s=e.loader,r=i||s,a=new r(e);return this.loaders[t.type]=a,a}getInternalLoader(t){return this.loaders[t.type]}resetInternalLoader(t){this.loaders[t]&&delete this.loaders[t]}destroyInternalLoaders(){for(const t in this.loaders){const e=this.loaders[t];e&&e.destroy(),this.resetInternalLoader(t)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(t,e){const{url:i}=e;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Q.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(t,e){const{id:i,level:s,pathwayId:r,url:a,deliveryDirectives:o}=e;this.load({id:i,level:s,pathwayId:r,responseType:"text",type:Q.LEVEL,url:a,deliveryDirectives:o})}onAudioTrackLoading(t,e){const{id:i,groupId:s,url:r,deliveryDirectives:a}=e;this.load({id:i,groupId:s,level:null,responseType:"text",type:Q.AUDIO_TRACK,url:r,deliveryDirectives:a})}onSubtitleTrackLoading(t,e){const{id:i,groupId:s,url:r,deliveryDirectives:a}=e;this.load({id:i,groupId:s,level:null,responseType:"text",type:Q.SUBTITLE_TRACK,url:r,deliveryDirectives:a})}load(t){var e;const i=this.hls.config;let s=this.getInternalLoader(t);if(s){const h=s.context;if(h&&h.url===t.url&&h.level===t.level){C.trace("[playlist-loader]: playlist request ongoing");return}C.log(`[playlist-loader]: aborting previous loader for type: ${t.type}`),s.abort()}let r;if(t.type===Q.MANIFEST?r=i.manifestLoadPolicy.default:r=ot({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(t),$((e=t.deliveryDirectives)==null?void 0:e.part)){let h;if(t.type===Q.LEVEL&&t.level!==null?h=this.hls.levels[t.level].details:t.type===Q.AUDIO_TRACK&&t.id!==null?h=this.hls.audioTracks[t.id].details:t.type===Q.SUBTITLE_TRACK&&t.id!==null&&(h=this.hls.subtitleTracks[t.id].details),h){const c=h.partTarget,u=h.targetduration;if(c&&u){const d=Math.max(c*3,u*.8)*1e3;r=ot({},r,{maxTimeToFirstByteMs:Math.min(d,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(d,r.maxTimeToFirstByteMs)})}}}const a=r.errorRetry||r.timeoutRetry||{},o={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(h,c,u,d)=>{const g=this.getInternalLoader(u);this.resetInternalLoader(u.type);const f=h.data;if(f.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(h,u,new Error("no EXTM3U delimiter"),d||null,c);return}c.parsing.start=performance.now(),Jt.isMediaPlaylist(f)?this.handleTrackOrLevelPlaylist(h,c,u,d||null,g):this.handleMasterPlaylist(h,c,u,d)},onError:(h,c,u,d)=>{this.handleNetworkError(c,u,!1,h,d)},onTimeout:(h,c,u)=>{this.handleNetworkError(c,u,!0,void 0,h)}};s.load(t,o,l)}handleMasterPlaylist(t,e,i,s){const r=this.hls,a=t.data,o=kr(t,i),l=Jt.parseMasterPlaylist(a,o);if(l.playlistParsingError){this.handleManifestParsingError(t,i,l.playlistParsingError,s,e);return}const{contentSteering:h,levels:c,sessionData:u,sessionKeys:d,startTimeOffset:g,variableList:f}=l;this.variableList=f;const{AUDIO:p=[],SUBTITLES:y,"CLOSED-CAPTIONS":v}=Jt.parseMasterPlaylistMedia(a,o,l);p.length&&!p.some(E=>!E.url)&&c[0].audioCodec&&!c[0].attrs.AUDIO&&(C.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),p.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new nt({}),bitrate:0,url:""})),r.trigger(m.MANIFEST_LOADED,{levels:c,audioTracks:p,subtitles:y,captions:v,contentSteering:h,url:o,stats:e,networkDetails:s,sessionData:u,sessionKeys:d,startTimeOffset:g,variableList:f})}handleTrackOrLevelPlaylist(t,e,i,s,r){const a=this.hls,{id:o,level:l,type:h}=i,c=kr(t,i),u=0,d=$(l)?l:$(o)?o:0,g=hh(i),f=Jt.parseLevelPlaylist(t.data,c,d,g,u,this.variableList);if(h===Q.MANIFEST){const p={attrs:new nt({}),bitrate:0,details:f,name:"",url:c};a.trigger(m.MANIFEST_LOADED,{levels:[p],audioTracks:[],url:c,stats:e,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),i.levelDetails=f,this.handlePlaylistLoaded(f,t,e,i,s,r)}handleManifestParsingError(t,e,i,s,r){this.hls.trigger(m.ERROR,{type:G.NETWORK_ERROR,details:S.MANIFEST_PARSING_ERROR,fatal:e.type===Q.MANIFEST,url:t.url,err:i,error:i,reason:i.message,response:t,context:e,networkDetails:s,stats:r})}handleNetworkError(t,e,i=!1,s,r){let a=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${t.type}`;t.type===Q.LEVEL?a+=`: ${t.level} id: ${t.id}`:(t.type===Q.AUDIO_TRACK||t.type===Q.SUBTITLE_TRACK)&&(a+=` id: ${t.id} group-id: "${t.groupId}"`);const o=new Error(a);C.warn(`[playlist-loader]: ${a}`);let l=S.UNKNOWN,h=!1;const c=this.getInternalLoader(t);switch(t.type){case Q.MANIFEST:l=i?S.MANIFEST_LOAD_TIMEOUT:S.MANIFEST_LOAD_ERROR,h=!0;break;case Q.LEVEL:l=i?S.LEVEL_LOAD_TIMEOUT:S.LEVEL_LOAD_ERROR,h=!1;break;case Q.AUDIO_TRACK:l=i?S.AUDIO_TRACK_LOAD_TIMEOUT:S.AUDIO_TRACK_LOAD_ERROR,h=!1;break;case Q.SUBTITLE_TRACK:l=i?S.SUBTITLE_TRACK_LOAD_TIMEOUT:S.SUBTITLE_LOAD_ERROR,h=!1;break}c&&this.resetInternalLoader(t.type);const u={type:G.NETWORK_ERROR,details:l,fatal:h,url:t.url,loader:c,context:t,error:o,networkDetails:e,stats:r};if(s){const d=(e==null?void 0:e.url)||t.url;u.response=yt({url:d,data:void 0},s)}this.hls.trigger(m.ERROR,u)}handlePlaylistLoaded(t,e,i,s,r,a){const o=this.hls,{type:l,level:h,id:c,groupId:u,deliveryDirectives:d}=s,g=kr(e,s),f=hh(s),p=typeof s.level=="number"&&f===U.MAIN?h:void 0;if(!t.fragments.length){const v=new Error("No Segments found in Playlist");o.trigger(m.ERROR,{type:G.NETWORK_ERROR,details:S.LEVEL_EMPTY_ERROR,fatal:!1,url:g,error:v,reason:v.message,response:e,context:s,level:p,parent:f,networkDetails:r,stats:i});return}t.targetduration||(t.playlistParsingError=new Error("Missing Target Duration"));const y=t.playlistParsingError;if(y){o.trigger(m.ERROR,{type:G.NETWORK_ERROR,details:S.LEVEL_PARSING_ERROR,fatal:!1,url:g,error:y,reason:y.message,response:e,context:s,level:p,parent:f,networkDetails:r,stats:i});return}switch(t.live&&a&&(a.getCacheAge&&(t.ageHeader=a.getCacheAge()||0),(!a.getCacheAge||isNaN(t.ageHeader))&&(t.ageHeader=0)),l){case Q.MANIFEST:case Q.LEVEL:o.trigger(m.LEVEL_LOADED,{details:t,level:p||0,id:c||0,stats:i,networkDetails:r,deliveryDirectives:d});break;case Q.AUDIO_TRACK:o.trigger(m.AUDIO_TRACK_LOADED,{details:t,id:c||0,groupId:u||"",stats:i,networkDetails:r,deliveryDirectives:d});break;case Q.SUBTITLE_TRACK:o.trigger(m.SUBTITLE_TRACK_LOADED,{details:t,id:c||0,groupId:u||"",stats:i,networkDetails:r,deliveryDirectives:d});break}}}function ch(n,t){let e;try{e=new Event("addtrack")}catch{e=document.createEvent("Event"),e.initEvent("addtrack",!1,!1)}e.track=n,t.dispatchEvent(e)}function uh(n,t){const e=n.mode;if(e==="disabled"&&(n.mode="hidden"),n.cues&&!n.cues.getCueById(t.id))try{if(n.addCue(t),!n.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(i){C.debug(`[texttrack-utils]: ${i}`);try{const s=new self.TextTrackCue(t.startTime,t.endTime,t.text);s.id=t.id,n.addCue(s)}catch(s){C.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${s}`)}}e==="disabled"&&(n.mode=e)}function ri(n){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues)for(let e=n.cues.length;e--;)n.removeCue(n.cues[e]);t==="disabled"&&(n.mode=t)}function Dr(n,t,e,i){const s=n.mode;if(s==="disabled"&&(n.mode="hidden"),n.cues&&n.cues.length>0){const r=_y(n.cues,t,e);for(let a=0;a<r.length;a++)(!i||i(r[a]))&&n.removeCue(r[a])}s==="disabled"&&(n.mode=s)}function Ty(n,t){if(t<n[0].startTime)return 0;const e=n.length-1;if(t>n[e].endTime)return-1;let i=0,s=e;for(;i<=s;){const r=Math.floor((s+i)/2);if(t<n[r].startTime)s=r-1;else if(t>n[r].startTime&&i<e)i=r+1;else return r}return n[i].startTime-t<t-n[s].startTime?i:s}function _y(n,t,e){const i=[],s=Ty(n,t);if(s>-1)for(let r=s,a=n.length;r<a;r++){const o=n[r];if(o.startTime>=t&&o.endTime<=e)i.push(o);else if(o.startTime>e)return i}return i}function Ms(n){const t=[];for(let e=0;e<n.length;e++){const i=n[e];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&t.push(n[e])}return t}var kt={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};const Ly=.25;function Pr(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function dh(n,t,e,i,s){let r=new n(t,e,"");try{r.value=i,s&&(r.type=s)}catch{r=new n(t,e,JSON.stringify(s?yt({type:s},i):i))}return r}const Os=(()=>{const n=Pr();try{n&&new n(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function xr(n,t){return n.getTime()/1e3-t}function Cy(n){return Uint8Array.from(n.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class by{constructor(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:t}=this;t.on(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(m.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(m.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:t}=this;t.off(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(m.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(m.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(t,e){this.media=e.media}onMediaDetaching(){this.id3Track&&(ri(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(t){const e=this.getID3Track(t.textTracks);return e.mode="hidden",e}getID3Track(t){if(this.media){for(let e=0;e<t.length;e++){const i=t[e];if(i.kind==="metadata"&&i.label==="id3")return ch(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(t,e){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:s}}}=this;if(!i&&!s)return;const{samples:r}=e;this.id3Track||(this.id3Track=this.createTrack(this.media));const a=Pr();if(a)for(let o=0;o<r.length;o++){const l=r[o].type;if(l===kt.emsg&&!i||!s)continue;const h=Fl(r[o].data);if(h){const c=r[o].pts;let u=c+r[o].duration;u>Os&&(u=Os),u-c<=0&&(u=c+Ly);for(let d=0;d<h.length;d++){const g=h[d];if(!Nl(g)){this.updateId3CueEnds(c,l);const f=dh(a,c,u,g,l);f&&this.id3Track.addCue(f)}}}}}updateId3CueEnds(t,e){var i;const s=(i=this.id3Track)==null?void 0:i.cues;if(s)for(let r=s.length;r--;){const a=s[r];a.type===e&&a.startTime<t&&a.endTime===Os&&(a.endTime=t)}}onBufferFlushing(t,{startOffset:e,endOffset:i,type:s}){const{id3Track:r,hls:a}=this;if(!a)return;const{config:{enableEmsgMetadataCues:o,enableID3MetadataCues:l}}=a;if(r&&(o||l)){let h;s==="audio"?h=c=>c.type===kt.audioId3&&l:s==="video"?h=c=>c.type===kt.emsg&&o:h=c=>c.type===kt.audioId3&&l||c.type===kt.emsg&&o,Dr(r,e,i,h)}}onLevelUpdated(t,{details:e}){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:s}=this,{dateRanges:r}=e,a=Object.keys(r);if(s){const c=Object.keys(i).filter(u=>!a.includes(u));for(let u=c.length;u--;){const d=c[u];Object.keys(i[d].cues).forEach(g=>{s.removeCue(i[d].cues[g])}),delete i[d]}}const o=e.fragments[e.fragments.length-1];if(a.length===0||!$(o==null?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const l=o.programDateTime/1e3-o.start,h=Pr();for(let c=0;c<a.length;c++){const u=a[c],d=r[u],g=xr(d.startDate,l),f=i[u],p=(f==null?void 0:f.cues)||{};let y=(f==null?void 0:f.durationKnown)||!1,v=Os;const E=d.endDate;if(E)v=xr(E,l),y=!0;else if(d.endOnNext&&!y){const T=a.reduce((L,w)=>{if(w!==d.id){const I=r[w];if(I.class===d.class&&I.startDate>d.startDate&&(!L||d.startDate<L.startDate))return I}return L},null);T&&(v=xr(T.startDate,l),y=!0)}const _=Object.keys(d.attr);for(let T=0;T<_.length;T++){const L=_[T];if(!R1(L))continue;const w=p[L];if(w)y&&!f.durationKnown&&(w.endTime=v);else if(h){let I=d.attr[L];k1(L)&&(I=Cy(I));const D=dh(h,g,v,{key:L,data:I},kt.dateRange);D&&(D.id=u,this.id3Track.addCue(D),p[L]=D)}}i[u]={cues:p,dateRange:d,durationKnown:y}}}}class Sy{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=t,this.config=t.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:t,levelDetails:e}=this;return t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:e?t.liveMaxLatencyDurationCount*e.targetduration:0}get targetLatency(){const{levelDetails:t}=this;if(t===null)return null;const{holdBack:e,partHoldBack:i,targetduration:s}=t,{liveSyncDuration:r,liveSyncDurationCount:a,lowLatencyMode:o}=this.config,l=this.hls.userConfig;let h=o&&i||e;(l.liveSyncDuration||l.liveSyncDurationCount||h===0)&&(h=r!==void 0?r:a*s);const c=s;return h+Math.min(this.stallCount*1,c)}get liveSyncPosition(){const t=this.estimateLiveEdge(),e=this.targetLatency,i=this.levelDetails;if(t===null||e===null||i===null)return null;const s=i.edge,r=t-e-this.edgeStalled,a=s-i.totalduration,o=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(a,r),o)}get drift(){const{levelDetails:t}=this;return t===null?1:t.drift}get edgeStalled(){const{levelDetails:t}=this;if(t===null)return 0;const e=(this.config.lowLatencyMode&&t.partTarget||t.targetduration)*3;return Math.max(t.age-e,0)}get forwardBufferLength(){const{media:t,levelDetails:e}=this;if(!t||!e)return 0;const i=t.buffered.length;return(i?t.buffered.end(i-1):e.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(m.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(m.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(m.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(m.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(m.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(m.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(m.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(m.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(m.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(m.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(t,{details:e}){this.levelDetails=e,e.advanced&&this.timeupdate(),!e.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(t,e){var i;e.details===S.BUFFER_STALLED_ERROR&&(this.stallCount++,(i=this.levelDetails)!=null&&i.live&&C.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:t,levelDetails:e}=this;if(!t||!e)return;this.currentTime=t.currentTime;const i=this.computeLatency();if(i===null)return;this._latency=i;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:r}=this.config;if(!s||r===1||!e.live)return;const a=this.targetLatency;if(a===null)return;const o=i-a,l=Math.min(this.maxLatency,a+e.targetduration);if(o<l&&o>.05&&this.forwardBufferLength>1){const h=Math.min(2,Math.max(1,r)),c=Math.round(2/(1+Math.exp(-.75*o-this.edgeStalled))*20)/20;t.playbackRate=Math.min(h,Math.max(1,c))}else t.playbackRate!==1&&t.playbackRate!==0&&(t.playbackRate=1)}estimateLiveEdge(){const{levelDetails:t}=this;return t===null?null:t.edge+t.age}computeLatency(){const t=this.estimateLiveEdge();return t===null?null:t-this.currentTime}}const Mr=["NONE","TYPE-0","TYPE-1",null];function wy(n){return Mr.indexOf(n)>-1}const $s=["SDR","PQ","HLG"];function Iy(n){return!!n&&$s.indexOf(n)>-1}var Oi={No:"",Yes:"YES",v2:"v2"};function fh(n){const{canSkipUntil:t,canSkipDateRanges:e,age:i}=n,s=i<t/2;return t&&s?e?Oi.v2:Oi.Yes:Oi.No}class Or{constructor(t,e,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=i}addDirectives(t){const e=new self.URL(t);return this.msn!==void 0&&e.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}}class Oe{constructor(t){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[t.url],this._attrs=[t.attrs],this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.frameRate=t.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=t.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.codecSet=[t.videoCodec,t.audioCodec].filter(e=>!!e).map(e=>e.substring(0,4)).join(","),this.addGroupId("audio",t.attrs.AUDIO),this.addGroupId("text",t.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(t){return gh(this._audioGroups,t)}hasSubtitleGroup(t){return gh(this._subtitleGroups,t)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(t,e){if(e){if(t==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(e)===-1&&i.push(e)}else if(t==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(e)===-1&&i.push(e)}}}get urlId(){return 0}set urlId(t){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var t;return(t=this.audioGroups)==null?void 0:t[0]}get textGroupId(){var t;return(t=this.subtitleGroups)==null?void 0:t[0]}addFallback(){}}function gh(n,t){return!t||!n?!1:n.indexOf(t)!==-1}function $r(n,t){const e=t.startPTS;if($(e)){let i=0,s;t.sn>n.sn?(i=e-n.start,s=n):(i=n.start-e,s=t),s.duration!==i&&(s.duration=i)}else t.sn>n.sn?n.cc===t.cc&&n.minEndPTS?t.start=n.start+(n.minEndPTS-n.start):t.start=n.start+n.duration:t.start=Math.max(n.start-t.duration,0)}function ph(n,t,e,i,s,r){i-e<=0&&(C.warn("Fragment should have a positive duration",t),i=e+t.duration,r=s+t.duration);let a=e,o=i;const l=t.startPTS,h=t.endPTS;if($(l)){const p=Math.abs(l-e);$(t.deltaPTS)?t.deltaPTS=Math.max(p,t.deltaPTS):t.deltaPTS=p,a=Math.max(e,l),e=Math.min(e,l),s=Math.min(s,t.startDTS),o=Math.min(i,h),i=Math.max(i,h),r=Math.max(r,t.endDTS)}const c=e-t.start;t.start!==0&&(t.start=e),t.duration=i-t.start,t.startPTS=e,t.maxStartPTS=a,t.startDTS=s,t.endPTS=i,t.minEndPTS=o,t.endDTS=r;const u=t.sn;if(!n||u<n.startSN||u>n.endSN)return 0;let d;const g=u-n.startSN,f=n.fragments;for(f[g]=t,d=g;d>0;d--)$r(f[d],f[d-1]);for(d=g;d<f.length-1;d++)$r(f[d],f[d+1]);return n.fragmentHint&&$r(f[f.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,c}function Ay(n,t){let e=null;const i=n.fragments;for(let o=i.length-1;o>=0;o--){const l=i[o].initSegment;if(l){e=l;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;let s;Dy(n,t,(o,l,h,c)=>{if(t.skippedSegments&&l.cc!==o.cc){const u=o.cc-l.cc;for(let d=h;d<c.length;d++)c[d].cc+=u}$(o.startPTS)&&$(o.endPTS)&&(l.start=l.startPTS=o.startPTS,l.startDTS=o.startDTS,l.maxStartPTS=o.maxStartPTS,l.endPTS=o.endPTS,l.endDTS=o.endDTS,l.minEndPTS=o.minEndPTS,l.duration=o.endPTS-o.startPTS,l.duration&&(s=l),t.PTSKnown=t.alignedSliding=!0),l.elementaryStreams=o.elementaryStreams,l.loader=o.loader,l.stats=o.stats,o.initSegment&&(l.initSegment=o.initSegment,e=o.initSegment)});const r=t.fragments;if(e&&(t.fragmentHint?r.concat(t.fragmentHint):r).forEach(o=>{var l;o&&(!o.initSegment||o.initSegment.relurl===((l=e)==null?void 0:l.relurl))&&(o.initSegment=e)}),t.skippedSegments){if(t.deltaUpdateFailed=r.some(o=>!o),t.deltaUpdateFailed){C.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let o=t.skippedSegments;o--;)r.shift();t.startSN=r[0].sn}else t.canSkipDateRanges&&(t.dateRanges=Ry(n.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));t.startCC=t.fragments[0].cc,t.endCC=r[r.length-1].cc}ky(n.partList,t.partList,(o,l)=>{l.elementaryStreams=o.elementaryStreams,l.stats=o.stats}),s?ph(t,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):mh(n,t),r.length&&(t.totalduration=t.edge-r[0].start),t.driftStartTime=n.driftStartTime,t.driftStart=n.driftStart;const a=t.advancedDateTime;if(t.advanced&&a){const o=t.edge;t.driftStart||(t.driftStartTime=a,t.driftStart=o),t.driftEndTime=a,t.driftEnd=o}else t.driftEndTime=n.driftEndTime,t.driftEnd=n.driftEnd,t.advancedDateTime=n.advancedDateTime}function Ry(n,t,e){const i=ot({},n);return e&&e.forEach(s=>{delete i[s]}),Object.keys(t).forEach(s=>{const r=new pr(t[s].attr,i[s]);r.isValid?i[s]=r:C.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(t[s].attr)}"`)}),i}function ky(n,t,e){if(n&&t){let i=0;for(let s=0,r=n.length;s<=r;s++){const a=n[s],o=t[s+i];a&&o&&a.index===o.index&&a.fragment.sn===o.fragment.sn?e(a,o):i--}}}function Dy(n,t,e){const i=t.skippedSegments,s=Math.max(n.startSN,t.startSN)-t.startSN,r=(n.fragmentHint?1:0)+(i?t.endSN:Math.min(n.endSN,t.endSN))-t.startSN,a=t.startSN-n.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments;for(let h=s;h<=r;h++){const c=l[a+h];let u=o[h];i&&!u&&h<i&&(u=t.fragments[h]=c),c&&u&&e(c,u,h,o)}}function mh(n,t){const e=t.startSN+t.skippedSegments-n.startSN,i=n.fragments;e<0||e>=i.length||Nr(t,i[e].start)}function Nr(n,t){if(t){const e=n.fragments;for(let i=n.skippedSegments;i<e.length;i++)e[i].start+=t;n.fragmentHint&&(n.fragmentHint.start+=t)}}function Py(n,t=1/0){let e=1e3*n.targetduration;if(n.updated){const i=n.fragments;if(i.length&&e*4>t){const s=i[i.length-1].duration*1e3;s<e&&(e=s)}}else e/=2;return Math.round(e)}function xy(n,t,e){if(!(n!=null&&n.details))return null;const i=n.details;let s=i.fragments[t-i.startSN];return s||(s=i.fragmentHint,s&&s.sn===t)?s:t<i.startSN&&e&&e.sn===t?e:null}function yh(n,t,e){var i;return n!=null&&n.details?vh((i=n.details)==null?void 0:i.partList,t,e):null}function vh(n,t,e){if(n)for(let i=n.length;i--;){const s=n[i];if(s.index===e&&s.fragment.sn===t)return s}return null}function Eh(n){n.forEach((t,e)=>{const{details:i}=t;i!=null&&i.fragments&&i.fragments.forEach(s=>{s.level=e})})}function Ns(n){switch(n.details){case S.FRAG_LOAD_TIMEOUT:case S.KEY_LOAD_TIMEOUT:case S.LEVEL_LOAD_TIMEOUT:case S.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Th(n,t){const e=Ns(t);return n.default[`${e?"timeout":"error"}Retry`]}function Fr(n,t){const e=n.backoff==="linear"?1:Math.pow(2,t);return Math.min(e*n.retryDelayMs,n.maxRetryDelayMs)}function _h(n){return yt(yt({},n),{errorRetry:null,timeoutRetry:null})}function Fs(n,t,e,i){if(!n)return!1;const s=i==null?void 0:i.code,r=t<n.maxNumRetry&&(My(s)||!!e);return n.shouldRetry?n.shouldRetry(n,t,e,i,r):r}function My(n){return n===0&&navigator.onLine===!1||!!n&&(n<400||n>499)}const Lh={search:function(n,t){let e=0,i=n.length-1,s=null,r=null;for(;e<=i;){s=(e+i)/2|0,r=n[s];const a=t(r);if(a>0)e=s+1;else if(a<0)i=s-1;else return r}return null}};function Oy(n,t,e){if(t===null||!Array.isArray(n)||!n.length||!$(t))return null;const i=n[0].programDateTime;if(t<(i||0))return null;const s=n[n.length-1].endProgramDateTime;if(t>=(s||0))return null;e=e||0;for(let r=0;r<n.length;++r){const a=n[r];if(Ny(t,e,a))return a}return null}function Us(n,t,e=0,i=0,s=.005){let r=null;if(n){r=t[n.sn-t[0].sn+1]||null;const o=n.endDTS-e;o>0&&o<15e-7&&(e+=15e-7)}else e===0&&t[0].start===0&&(r=t[0]);if(r&&((!n||n.level===r.level)&&Ur(e,i,r)===0||$y(r,n,Math.min(s,i))))return r;const a=Lh.search(t,Ur.bind(null,e,i));return a&&(a!==n||!r)?a:r}function $y(n,t,e){if(t&&t.start===0&&t.level<n.level&&(t.endPTS||0)>0){const i=t.tagList.reduce((s,r)=>(r[0]==="INF"&&(s+=parseFloat(r[1])),s),e);return n.start<=i}return!1}function Ur(n=0,t=0,e){if(e.start<=n&&e.start+e.duration>n)return 0;const i=Math.min(t,e.duration+(e.deltaPTS?e.deltaPTS:0));return e.start+e.duration-i<=n?1:e.start-i>n&&e.start?-1:0}function Ny(n,t,e){const i=Math.min(t,e.duration+(e.deltaPTS?e.deltaPTS:0))*1e3;return(e.endProgramDateTime||0)-i>n}function Fy(n,t){return Lh.search(n,e=>e.cc<t?1:e.cc>t?-1:0)}var vt={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},Dt={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2};class Ch{constructor(t){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=t,this.log=C.log.bind(C,"[info]:"),this.warn=C.warn.bind(C,"[warning]:"),this.error=C.error.bind(C,"[error]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(m.ERROR,this.onError,this),t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const t=this.hls;t&&(t.off(m.ERROR,this.onError,this),t.off(m.ERROR,this.onErrorOut,this),t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(t){}stopLoad(){this.playlistError=0}getVariantLevelIndex(t){return(t==null?void 0:t.type)===U.MAIN?t.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(t,e){var i,s;if(e.fatal)return;const r=this.hls,a=e.context;switch(e.details){case S.FRAG_LOAD_ERROR:case S.FRAG_LOAD_TIMEOUT:case S.KEY_LOAD_ERROR:case S.KEY_LOAD_TIMEOUT:e.errorAction=this.getFragRetryOrSwitchAction(e);return;case S.FRAG_PARSING_ERROR:if((i=e.frag)!=null&&i.gap){e.errorAction={action:vt.DoNothing,flags:Dt.None};return}case S.FRAG_GAP:case S.FRAG_DECRYPT_ERROR:{e.errorAction=this.getFragRetryOrSwitchAction(e),e.errorAction.action=vt.SendAlternateToPenaltyBox;return}case S.LEVEL_EMPTY_ERROR:case S.LEVEL_PARSING_ERROR:{var o,l;const h=e.parent===U.MAIN?e.level:r.loadLevel;e.details===S.LEVEL_EMPTY_ERROR&&(o=e.context)!=null&&(l=o.levelDetails)!=null&&l.live?e.errorAction=this.getPlaylistRetryOrSwitchAction(e,h):(e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,h))}return;case S.LEVEL_LOAD_ERROR:case S.LEVEL_LOAD_TIMEOUT:typeof(a==null?void 0:a.level)=="number"&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,a.level));return;case S.AUDIO_TRACK_LOAD_ERROR:case S.AUDIO_TRACK_LOAD_TIMEOUT:case S.SUBTITLE_LOAD_ERROR:case S.SUBTITLE_TRACK_LOAD_TIMEOUT:if(a){const h=r.levels[r.loadLevel];if(h&&(a.type===Q.AUDIO_TRACK&&h.hasAudioGroup(a.groupId)||a.type===Q.SUBTITLE_TRACK&&h.hasSubtitleGroup(a.groupId))){e.errorAction=this.getPlaylistRetryOrSwitchAction(e,r.loadLevel),e.errorAction.action=vt.SendAlternateToPenaltyBox,e.errorAction.flags=Dt.MoveAllAlternatesMatchingHost;return}}return;case S.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const h=r.levels[r.loadLevel],c=h==null?void 0:h.attrs["HDCP-LEVEL"];c?e.errorAction={action:vt.SendAlternateToPenaltyBox,flags:Dt.MoveAllAlternatesMatchingHDCP,hdcpLevel:c}:this.keySystemError(e)}return;case S.BUFFER_ADD_CODEC_ERROR:case S.REMUX_ALLOC_ERROR:case S.BUFFER_APPEND_ERROR:e.errorAction=this.getLevelSwitchAction(e,(s=e.level)!=null?s:r.loadLevel);return;case S.INTERNAL_EXCEPTION:case S.BUFFER_APPENDING_ERROR:case S.BUFFER_FULL_ERROR:case S.LEVEL_SWITCH_ERROR:case S.BUFFER_STALLED_ERROR:case S.BUFFER_SEEK_OVER_HOLE:case S.BUFFER_NUDGE_ON_STALL:e.errorAction={action:vt.DoNothing,flags:Dt.None};return}e.type===G.KEY_SYSTEM_ERROR&&this.keySystemError(e)}keySystemError(t){const e=this.getVariantLevelIndex(t.frag);t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e)}getPlaylistRetryOrSwitchAction(t,e){const i=this.hls,s=Th(i.config.playlistLoadPolicy,t),r=this.playlistError++;if(Fs(s,r,Ns(t),t.response))return{action:vt.RetryRequest,flags:Dt.None,retryConfig:s,retryCount:r};const a=this.getLevelSwitchAction(t,e);return s&&(a.retryConfig=s,a.retryCount=r),a}getFragRetryOrSwitchAction(t){const e=this.hls,i=this.getVariantLevelIndex(t.frag),s=e.levels[i],{fragLoadPolicy:r,keyLoadPolicy:a}=e.config,o=Th(t.details.startsWith("key")?a:r,t),l=e.levels.reduce((c,u)=>c+u.fragmentError,0);if(s&&(t.details!==S.FRAG_GAP&&s.fragmentError++,Fs(o,l,Ns(t),t.response)))return{action:vt.RetryRequest,flags:Dt.None,retryConfig:o,retryCount:l};const h=this.getLevelSwitchAction(t,i);return o&&(h.retryConfig=o,h.retryCount=l),h}getLevelSwitchAction(t,e){const i=this.hls;e==null&&(e=i.loadLevel);const s=this.hls.levels[e];if(s){var r,a;const h=t.details;s.loadError++,h===S.BUFFER_APPEND_ERROR&&s.fragmentError++;let c=-1;const{levels:u,loadLevel:d,minAutoLevel:g,maxAutoLevel:f}=i;i.autoLevelEnabled||(i.loadLevel=-1);const p=(r=t.frag)==null?void 0:r.type,y=(p===U.AUDIO&&h===S.FRAG_PARSING_ERROR||t.sourceBufferName==="audio"&&(h===S.BUFFER_ADD_CODEC_ERROR||h===S.BUFFER_APPEND_ERROR))&&u.some(({audioCodec:T})=>s.audioCodec!==T),v=t.sourceBufferName==="video"&&(h===S.BUFFER_ADD_CODEC_ERROR||h===S.BUFFER_APPEND_ERROR)&&u.some(({codecSet:T,audioCodec:L})=>s.codecSet!==T&&s.audioCodec===L),{type:E,groupId:_}=(a=t.context)!=null?a:{};for(let T=u.length;T--;){const L=(T+d)%u.length;if(L!==d&&L>=g&&L<=f&&u[L].loadError===0){var o,l;const w=u[L];if(h===S.FRAG_GAP&&p===U.MAIN&&t.frag){const I=u[L].details;if(I){const D=Us(t.frag,I.fragments,t.frag.start);if(D!=null&&D.gap)continue}}else if(E===Q.AUDIO_TRACK&&w.hasAudioGroup(_)||E===Q.SUBTITLE_TRACK&&w.hasSubtitleGroup(_)||p===U.AUDIO&&(o=s.audioGroups)!=null&&o.some(I=>w.hasAudioGroup(I))||p===U.SUBTITLE&&(l=s.subtitleGroups)!=null&&l.some(I=>w.hasSubtitleGroup(I))||y&&s.audioCodec===w.audioCodec||!y&&s.audioCodec!==w.audioCodec||v&&s.codecSet===w.codecSet)continue;c=L;break}}if(c>-1&&i.loadLevel!==c)return t.levelRetry=!0,this.playlistError=0,{action:vt.SendAlternateToPenaltyBox,flags:Dt.None,nextAutoLevel:c}}return{action:vt.SendAlternateToPenaltyBox,flags:Dt.MoveAllAlternatesMatchingHost}}onErrorOut(t,e){var i;switch((i=e.errorAction)==null?void 0:i.action){case vt.DoNothing:break;case vt.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(e),!e.errorAction.resolved&&e.details!==S.FRAG_GAP?e.fatal=!0:/MediaSource readyState: ended/.test(e.error.message)&&(this.warn(`MediaSource ended after "${e.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(e.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(t){const e=this.hls,i=t.errorAction;if(!i)return;const{flags:s,hdcpLevel:r,nextAutoLevel:a}=i;switch(s){case Dt.None:this.switchLevel(t,a);break;case Dt.MoveAllAlternatesMatchingHDCP:r&&(e.maxHdcpLevel=Mr[Mr.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${e.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(t,a)}switchLevel(t,e){e!==void 0&&t.errorAction&&(this.warn(`switching to level ${e} after ${t.details}`),this.hls.nextAutoLevel=e,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class Bs{constructor(t,e){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=C.log.bind(C,`${e}:`),this.warn=C.warn.bind(C,`${e}:`),this.hls=t}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(t,e,i){const s=e==null?void 0:e.renditionReports;if(s){let r=-1;for(let a=0;a<s.length;a++){const o=s[a];let l;try{l=new self.URL(o.URI,e.url).href}catch(h){C.warn(`Could not construct new URL for Rendition Report: ${h}`),l=o.URI||""}if(l===t){r=a;break}else l===t.substring(0,l.length)&&(r=a)}if(r!==-1){const a=s[r],o=parseInt(a["LAST-MSN"])||(e==null?void 0:e.lastPartSn);let l=parseInt(a["LAST-PART"])||(e==null?void 0:e.lastPartIndex);if(this.hls.config.lowLatencyMode){const c=Math.min(e.age-e.partTarget,e.targetduration);l>=0&&c>e.partTarget&&(l+=1)}const h=i&&fh(i);return new Or(o,l>=0?l:void 0,h)}}}loadPlaylist(t){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)}shouldReloadPlaylist(t){return this.timer===-1&&this.requestScheduled===-1&&this.shouldLoadPlaylist(t)}playlistLoaded(t,e,i){const{details:s,stats:r}=e,a=self.performance.now(),o=r.loading.first?Math.max(0,a-r.loading.first):0;if(s.advancedDateTime=Date.now()-o,s.live||i!=null&&i.live){if(s.reloaded(i),i&&this.log(`live playlist ${t} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),i&&s.fragments.length>0&&Ay(i,s),!this.canLoad||!s.live)return;let l,h,c;if(s.canBlockReload&&s.endSN&&s.advanced){const y=this.hls.config.lowLatencyMode,v=s.lastPartSn,E=s.endSN,_=s.lastPartIndex,T=_!==-1,L=v===E,w=y?0:_;T?(h=L?E+1:v,c=L?w:_+1):h=E+1;const I=s.age,D=I+s.ageHeader;let P=Math.min(D-s.partTarget,s.targetduration*1.5);if(P>0){if(i&&P>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${P} with playlist age: ${s.age}`),P=0;else{const R=Math.floor(P/s.targetduration);if(h+=R,c!==void 0){const k=Math.round(P%s.targetduration/s.partTarget);c+=k}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${I.toFixed(2)}s goal: ${P} skip sn ${R} to part ${c}`)}s.tuneInGoal=P}if(l=this.getDeliveryDirectives(s,e.deliveryDirectives,h,c),y||!L){this.loadPlaylist(l);return}}else(s.canBlockReload||s.canSkipUntil)&&(l=this.getDeliveryDirectives(s,e.deliveryDirectives,h,c));const u=this.hls.mainForwardBufferInfo,d=u?u.end-u.len:0,g=(s.edge-d)*1e3,f=Py(s,g);s.updated&&a>this.requestScheduled+f&&(this.requestScheduled=r.loading.start),h!==void 0&&s.canBlockReload?this.requestScheduled=r.loading.first+f-(s.partTarget*1e3||1e3):this.requestScheduled===-1||this.requestScheduled+f<a?this.requestScheduled=a:this.requestScheduled-a<=0&&(this.requestScheduled+=f);let p=this.requestScheduled-a;p=Math.max(0,p),this.log(`reload live playlist ${t} in ${Math.round(p)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(l),p)}else this.clearTimer()}getDeliveryDirectives(t,e,i,s){let r=fh(t);return e!=null&&e.skip&&t.deltaUpdateFailed&&(i=e.msn,s=e.part,r=Oi.No),new Or(i,s,r)}checkRetry(t){const e=t.details,i=Ns(t),s=t.errorAction,{action:r,retryCount:a=0,retryConfig:o}=s||{},l=!!s&&!!o&&(r===vt.RetryRequest||!s.resolved&&r===vt.SendAlternateToPenaltyBox);if(l){var h;if(this.requestScheduled=-1,a>=o.maxNumRetry)return!1;if(i&&(h=t.context)!=null&&h.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${e}" without delivery-directives`),this.loadPlaylist();else{const c=Fr(o,a);this.timer=self.setTimeout(()=>this.loadPlaylist(),c),this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${e}" in ${c}ms`)}t.levelRetry=!0,s.resolved=!0}return l}}class ai{constructor(t,e=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=i}sample(t,e){const i=Math.pow(this.alpha_,t);this.estimate_=e*(1-i)+i*this.estimate_,this.totalWeight_+=t}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const t=1-Math.pow(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_}}class Uy{constructor(t,e,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new ai(t),this.fast_=new ai(e),this.defaultTTFB_=s,this.ttfb_=new ai(t)}update(t,e){const{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==t&&(this.slow_=new ai(t,i.getEstimate(),i.getTotalWeight())),s.halfLife!==e&&(this.fast_=new ai(e,s.getEstimate(),s.getTotalWeight())),r.halfLife!==t&&(this.ttfb_=new ai(t,r.getEstimate(),r.getTotalWeight()))}sample(t,e){t=Math.max(t,this.minDelayMs_);const i=8*e,s=t/1e3,r=i/s;this.fast_.sample(s,r),this.slow_.sample(s,r)}sampleTTFB(t){const e=t/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(e,2)/2);this.ttfb_.sample(i,Math.max(t,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const bh={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},Sh={};function By(n,t,e,i,s,r){const a=n.audioCodec?n.audioGroups:null,o=r==null?void 0:r.audioCodec,l=r==null?void 0:r.channels,h=l?parseInt(l):o?1/0:2;let c=null;if(a!=null&&a.length)try{a.length===1&&a[0]?c=t.groups[a[0]].channels:c=a.reduce((u,d)=>{if(d){const g=t.groups[d];if(!g)throw new Error(`Audio track group ${d} not found`);Object.keys(g.channels).forEach(f=>{u[f]=(u[f]||0)+g.channels[f]})}return u},{2:0})}catch{return!0}return n.videoCodec!==void 0&&(n.width>1920&&n.height>1088||n.height>1920&&n.width>1088||n.frameRate>Math.max(i,30)||n.videoRange!=="SDR"&&n.videoRange!==e||n.bitrate>Math.max(s,8e6))||!!c&&$(h)&&Object.keys(c).some(u=>parseInt(u)>h)}function Gy(n,t,e){const i=n.videoCodec,s=n.audioCodec;if(!i||!s||!e)return Promise.resolve(bh);const r={width:n.width,height:n.height,bitrate:Math.ceil(Math.max(n.bitrate*.9,n.averageBitrate)),framerate:n.frameRate||30},a=n.videoRange;a!=="SDR"&&(r.transferFunction=a.toLowerCase());const o=i.split(",").map(l=>({type:"media-source",video:yt(yt({},r),{},{contentType:Mi(l,"video")})}));return s&&n.audioGroups&&n.audioGroups.forEach(l=>{var h;l&&((h=t.groups[l])==null||h.tracks.forEach(c=>{if(c.groupId===l){const u=c.channels||"",d=parseFloat(u);$(d)&&d>2&&o.push.apply(o,s.split(",").map(g=>({type:"media-source",audio:{contentType:Mi(g,"audio"),channels:""+d}})))}}))}),Promise.all(o.map(l=>{const h=Vy(l);return Sh[h]||(Sh[h]=e.decodingInfo(l))})).then(l=>({supported:!l.some(h=>!h.supported),configurations:o,decodingInfoResults:l})).catch(l=>({supported:!1,configurations:o,decodingInfoResults:[],error:l}))}function Vy(n){const{audio:t,video:e}=n,i=e||t;if(i){const s=i.contentType.split('"')[1];if(e)return`r${e.height}x${e.width}f${Math.ceil(e.framerate)}${e.transferFunction||"sd"}_${s}_${Math.ceil(e.bitrate/1e5)}`;if(t)return`c${t.channels}${t.spatialRendering?"s":"n"}_${s}`}return""}function Hy(){if(typeof matchMedia=="function"){const n=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(n.media!==t.media)return n.matches===!0}return!1}function Ky(n,t){let e=!1,i=[];return n&&(e=n!=="SDR",i=[n]),t&&(i=t.allowedVideoRanges||$s.slice(0),e=t.preferHDR!==void 0?t.preferHDR:Hy(),e?i=i.filter(s=>s!=="SDR"):i=["SDR"]),{preferHDR:e,allowedVideoRanges:i}}function Wy(n,t,e,i,s){const r=Object.keys(n),a=i==null?void 0:i.channels,o=i==null?void 0:i.audioCodec,l=a&&parseInt(a)===2;let h=!0,c=!1,u=1/0,d=1/0,g=1/0,f=0,p=[];const{preferHDR:y,allowedVideoRanges:v}=Ky(t,s);for(let T=r.length;T--;){const L=n[r[T]];h=L.channels[2]>0,u=Math.min(u,L.minHeight),d=Math.min(d,L.minFramerate),g=Math.min(g,L.minBitrate);const w=v.filter(I=>L.videoRanges[I]>0);w.length>0&&(c=!0,p=w)}u=$(u)?u:0,d=$(d)?d:0;const E=Math.max(1080,u),_=Math.max(30,d);return g=$(g)?g:e,e=Math.max(g,e),c||(t=void 0,p=[]),{codecSet:r.reduce((T,L)=>{const w=n[L];if(L===T)return T;if(w.minBitrate>e)return ae(L,`min bitrate of ${w.minBitrate} > current estimate of ${e}`),T;if(!w.hasDefaultAudio)return ae(L,"no renditions with default or auto-select sound found"),T;if(o&&L.indexOf(o.substring(0,4))%5!==0)return ae(L,`audio codec preference "${o}" not found`),T;if(a&&!l){if(!w.channels[a])return ae(L,`no renditions with ${a} channel sound found (channels options: ${Object.keys(w.channels)})`),T}else if((!o||l)&&h&&w.channels[2]===0)return ae(L,"no renditions with stereo sound found"),T;return w.minHeight>E?(ae(L,`min resolution of ${w.minHeight} > maximum of ${E}`),T):w.minFramerate>_?(ae(L,`min framerate of ${w.minFramerate} > maximum of ${_}`),T):p.some(I=>w.videoRanges[I]>0)?w.maxScore<f?(ae(L,`max score of ${w.maxScore} < selected max of ${f}`),T):T&&(Ps(L)>=Ps(T)||w.fragmentError>n[T].fragmentError)?T:(f=w.maxScore,L):(ae(L,`no variants with VIDEO-RANGE of ${JSON.stringify(p)} found`),T)},void 0),videoRanges:p,preferHDR:y,minFramerate:d,minBitrate:g}}function ae(n,t){C.log(`[abr] start candidates with "${n}" ignored because ${t}`)}function zy(n){return n.reduce((t,e)=>{let i=t.groups[e.groupId];i||(i=t.groups[e.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(e);const s=e.channels||"2";return i.channels[s]=(i.channels[s]||0)+1,i.hasDefault=i.hasDefault||e.default,i.hasAutoSelect=i.hasAutoSelect||e.autoselect,i.hasDefault&&(t.hasDefaultAudio=!0),i.hasAutoSelect&&(t.hasAutoSelectAudio=!0),t},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Yy(n,t,e,i){return n.slice(e,i+1).reduce((s,r)=>{if(!r.codecSet)return s;const a=r.audioGroups;let o=s[r.codecSet];o||(s[r.codecSet]=o={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),o.minBitrate=Math.min(o.minBitrate,r.bitrate);const l=Math.min(r.height,r.width);return o.minHeight=Math.min(o.minHeight,l),o.minFramerate=Math.min(o.minFramerate,r.frameRate),o.maxScore=Math.max(o.maxScore,r.score),o.fragmentError+=r.fragmentError,o.videoRanges[r.videoRange]=(o.videoRanges[r.videoRange]||0)+1,a&&a.forEach(h=>{if(!h)return;const c=t.groups[h];c&&(o.hasDefaultAudio=o.hasDefaultAudio||t.hasDefaultAudio?c.hasDefault:c.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(c.channels).forEach(u=>{o.channels[u]=(o.channels[u]||0)+c.channels[u]}))}),s},{})}function te(n,t,e){if("attrs"in n){const i=t.indexOf(n);if(i!==-1)return i}for(let i=0;i<t.length;i++){const s=t[i];if($e(n,s,e))return i}return-1}function $e(n,t,e){const{groupId:i,name:s,lang:r,assocLang:a,default:o}=n,l=n.forced;return(i===void 0||t.groupId===i)&&(s===void 0||t.name===s)&&(r===void 0||t.lang===r)&&(r===void 0||t.assocLang===a)&&(o===void 0||t.default===o)&&(l===void 0||t.forced===l)&&(!("characteristics"in n)||jy(n.characteristics||"",t.characteristics))&&(e===void 0||e(n,t))}function jy(n,t=""){const e=n.split(","),i=t.split(",");return e.length===i.length&&!e.some(s=>i.indexOf(s)===-1)}function Ne(n,t){const{audioCodec:e,channels:i}=n;return(e===void 0||(t.audioCodec||"").substring(0,4)===e.substring(0,4))&&(i===void 0||i===(t.channels||"2"))}function qy(n,t,e,i,s){const r=t[i],a=t.reduce((u,d,g)=>{const f=d.uri;return(u[f]||(u[f]=[])).push(g),u},{})[r.uri];a.length>1&&(i=Math.max.apply(Math,a));const o=r.videoRange,l=r.frameRate,h=r.codecSet.substring(0,4),c=wh(t,i,u=>{if(u.videoRange!==o||u.frameRate!==l||u.codecSet.substring(0,4)!==h)return!1;const d=u.audioGroups,g=e.filter(f=>!d||d.indexOf(f.groupId)!==-1);return te(n,g,s)>-1});return c>-1?c:wh(t,i,u=>{const d=u.audioGroups,g=e.filter(f=>!d||d.indexOf(f.groupId)!==-1);return te(n,g,s)>-1})}function wh(n,t,e){for(let i=t;i>-1;i--)if(e(n[i]))return i;for(let i=t+1;i<n.length;i++)if(e(n[i]))return i;return-1}class Ih{constructor(t){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:e,partCurrent:i,hls:s}=this,{autoLevelEnabled:r,media:a}=s;if(!e||!a)return;const o=performance.now(),l=i?i.stats:e.stats,h=i?i.duration:e.duration,c=o-l.loading.start,u=s.minAutoLevel;if(l.aborted||l.loaded&&l.loaded===l.total||e.level<=u){this.clearTimer(),this._nextAutoLevel=-1;return}if(!r||a.paused||!a.playbackRate||!a.readyState)return;const d=s.mainForwardBufferInfo;if(d===null)return;const g=this.bwEstimator.getEstimateTTFB(),f=Math.abs(a.playbackRate);if(c<=Math.max(g,1e3*(h/(f*2))))return;const p=d.len/f,y=l.loading.first?l.loading.first-l.loading.start:-1,v=l.loaded&&y>-1,E=this.getBwEstimate(),_=s.levels,T=_[e.level],L=l.total||Math.max(l.loaded,Math.round(h*T.averageBitrate/8));let w=v?c-y:c;w<1&&v&&(w=Math.min(c,l.loaded*8/E));const I=v?l.loaded*1e3/w:0,D=I?(L-l.loaded)/I:L*8/E+g/1e3;if(D<=p)return;const P=I?I*8:E;let R=Number.POSITIVE_INFINITY,k;for(k=e.level-1;k>u;k--){const M=_[k].maxBitrate;if(R=this.getTimeToLoadFrag(g/1e3,P,h*M,!_[k].details),R<p)break}if(R>=D||R>h*10)return;s.nextLoadLevel=s.nextAutoLevel=k,v?this.bwEstimator.sample(c-Math.min(g,y),l.loaded):this.bwEstimator.sampleTTFB(c);const Y=_[k].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>Y&&this.resetEstimator(Y),this.clearTimer(),C.warn(`[abr] Fragment ${e.sn}${i?" part "+i.index:""} of level ${e.level} is loading too slowly;
      Time to underbuffer: ${p.toFixed(3)} s
      Estimated load time for current fragment: ${D.toFixed(3)} s
      Estimated load time for down switch fragment: ${R.toFixed(3)} s
      TTFB estimate: ${y|0} ms
      Current BW estimate: ${$(E)?E|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${k} @ ${Y|0} bps`),s.trigger(m.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:i,stats:l})},this.hls=t,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(t){t&&(C.log(`setting initial bwe to ${t}`),this.hls.config.abrEwmaDefaultEstimate=t),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const t=this.hls.config;return new Uy(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate)}registerListeners(){const{hls:t}=this;t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.FRAG_LOADING,this.onFragLoading,this),t.on(m.FRAG_LOADED,this.onFragLoaded,this),t.on(m.FRAG_BUFFERED,this.onFragBuffered,this),t.on(m.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(m.LEVEL_LOADED,this.onLevelLoaded,this),t.on(m.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(m.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.on(m.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t&&(t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.FRAG_LOADING,this.onFragLoading,this),t.off(m.FRAG_LOADED,this.onFragLoaded,this),t.off(m.FRAG_BUFFERED,this.onFragBuffered,this),t.off(m.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(m.LEVEL_LOADED,this.onLevelLoaded,this),t.off(m.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(m.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.off(m.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(t,e){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(t,e){const i=e.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=(s=e.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(t,e){this.clearTimer()}onError(t,e){if(!e.fatal)switch(e.details){case S.BUFFER_ADD_CODEC_ERROR:case S.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case S.FRAG_LOAD_TIMEOUT:{const i=e.frag,{fragCurrent:s,partCurrent:r}=this;if(i&&s&&i.sn===s.sn&&i.level===s.level){const a=performance.now(),o=r?r.stats:i.stats,l=a-o.loading.start,h=o.loading.first?o.loading.first-o.loading.start:-1;if(o.loaded&&h>-1){const c=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(c,h),o.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(t,e,i,s){const r=t+i/e,a=s?this.lastLevelLoadSec:0;return r+a}onLevelLoaded(t,e){const i=this.hls.config,{loading:s}=e.stats,r=s.end-s.start;$(r)&&(this.lastLevelLoadSec=r/1e3),e.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(t,{frag:e,part:i}){const s=i?i.stats:e.stats;if(e.type===U.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(e)){if(this.clearTimer(),e.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:e.duration,a=this.hls.levels[e.level],o=(a.loaded?a.loaded.bytes:0)+s.loaded,l=(a.loaded?a.loaded.duration:0)+r;a.loaded={bytes:o,duration:l},a.realBitrate=Math.round(8*o/l)}if(e.bitrateTest){const r={stats:s,frag:e,part:i,id:e.type};this.onFragBuffered(m.FRAG_BUFFERED,r),e.bitrateTest=!1}else this.lastLoadedFragLevel=e.level}}onFragBuffered(t,e){const{frag:i,part:s}=e,r=s!=null&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const a=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(t){return t.type!==U.MAIN||t.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:t,minAutoLevel:e}=this.hls,i=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,e,t,0,s,1,1);if(r>-1)return r;const a=this.hls.firstLevel,o=Math.min(Math.max(a,e),t);return C.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const t=this.forcedAutoLevel,e=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(t!==-1&&(!e||!i||this.nextAutoLevelKey===this.getAutoLevelKey()))return t;const s=e&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(t!==-1){const r=this.hls.levels;if(r.length>Math.max(t,s)&&r[t].loadError<=r[s].loadError)return t}return this._nextAutoLevel=s,this.nextAutoLevelKey=this.getAutoLevelKey(),s}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:t,partCurrent:e,hls:i}=this,{maxAutoLevel:s,config:r,minAutoLevel:a}=i,o=e?e.duration:t?t.duration:0,l=this.getBwEstimate(),h=this.getStarvationDelay();let c=r.abrBandWidthFactor,u=r.abrBandWidthUpFactor;if(h){const y=this.findBestLevel(l,a,s,h,0,c,u);if(y>=0)return y}let d=o?Math.min(o,r.maxStarvationDelay):r.maxStarvationDelay;if(!h){const y=this.bitrateTestDelay;y&&(d=(o?Math.min(o,r.maxLoadingDelay):r.maxLoadingDelay)-y,C.info(`[abr] bitrate test took ${Math.round(1e3*y)}ms, set first fragment max fetchDuration to ${Math.round(1e3*d)} ms`),c=u=1)}const g=this.findBestLevel(l,a,s,h,d,c,u);if(C.info(`[abr] ${h?"rebuffering expected":"buffer is empty"}, optimal quality level ${g}`),g>-1)return g;const f=i.levels[a],p=i.levels[i.loadLevel];return(f==null?void 0:f.bitrate)<(p==null?void 0:p.bitrate)?a:i.loadLevel}getStarvationDelay(){const t=this.hls,e=t.media;if(!e)return 1/0;const i=e&&e.playbackRate!==0?Math.abs(e.playbackRate):1,s=t.mainForwardBufferInfo;return(s?s.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(t,e,i,s,r,a,o){var l;const h=s+r,c=this.lastLoadedFragLevel,u=c===-1?this.hls.firstLevel:c,{fragCurrent:d,partCurrent:g}=this,{levels:f,allAudioTracks:p,loadLevel:y,config:v}=this.hls;if(f.length===1)return 0;const E=f[u],_=!!(E!=null&&(l=E.details)!=null&&l.live),T=y===-1||c===-1;let L,w="SDR",I=(E==null?void 0:E.frameRate)||0;const{audioPreference:D,videoPreference:P}=v,R=this.audioTracksByGroup||(this.audioTracksByGroup=zy(p));if(T){if(this.firstSelection!==-1)return this.firstSelection;const F=this.codecTiers||(this.codecTiers=Yy(f,R,e,i)),H=Wy(F,w,t,D,P),{codecSet:x,videoRanges:N,minFramerate:J,minBitrate:K,preferHDR:q}=H;L=x,w=q?N[N.length-1]:N[0],I=J,t=Math.max(t,K),C.log(`[abr] picked start tier ${JSON.stringify(H)}`)}else L=E==null?void 0:E.codecSet,w=E==null?void 0:E.videoRange;const k=g?g.duration:d?d.duration:0,Y=this.bwEstimator.getEstimateTTFB()/1e3,M=[];for(let F=i;F>=e;F--){var j;const H=f[F],x=F>u;if(!H)continue;if(v.useMediaCapabilities&&!H.supportedResult&&!H.supportedPromise){const ft=navigator.mediaCapabilities;typeof(ft==null?void 0:ft.decodingInfo)=="function"&&By(H,R,w,I,t,D)?(H.supportedPromise=Gy(H,R,ft),H.supportedPromise.then(gt=>{if(!this.hls)return;H.supportedResult=gt;const It=this.hls.levels,Gt=It.indexOf(H);gt.error?C.warn(`[abr] MediaCapabilities decodingInfo error: "${gt.error}" for level ${Gt} ${JSON.stringify(gt)}`):gt.supported||(C.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${Gt} ${JSON.stringify(gt)}`),Gt>-1&&It.length>1&&(C.log(`[abr] Removing unsupported level ${Gt}`),this.hls.removeLevel(Gt)))})):H.supportedResult=bh}if(L&&H.codecSet!==L||w&&H.videoRange!==w||x&&I>H.frameRate||!x&&I>0&&I<H.frameRate||H.supportedResult&&!((j=H.supportedResult.decodingInfoResults)!=null&&j[0].smooth)){M.push(F);continue}const N=H.details,J=(g?N==null?void 0:N.partTarget:N==null?void 0:N.averagetargetduration)||k;let K;x?K=o*t:K=a*t;const q=k&&s>=k*2&&r===0?f[F].averageBitrate:f[F].maxBitrate,lt=this.getTimeToLoadFrag(Y,K,q*J,N===void 0);if(K>=q&&(F===c||H.loadError===0&&H.fragmentError===0)&&(lt<=Y||!$(lt)||_&&!this.bitrateTestDelay||lt<h)){const ft=this.forcedAutoLevel;return F!==y&&(ft===-1||ft!==y)&&(M.length&&C.trace(`[abr] Skipped level(s) ${M.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${f[M[0]].codecs}" ${f[M[0]].videoRange}; not compatible with "${E.codecs}" ${w}`),C.info(`[abr] switch candidate:${u}->${F} adjustedbw(${Math.round(K)})-bitrate=${Math.round(K-q)} ttfb:${Y.toFixed(1)} avgDuration:${J.toFixed(1)} maxFetchDuration:${h.toFixed(1)} fetchDuration:${lt.toFixed(1)} firstSelection:${T} codecSet:${L} videoRange:${w} hls.loadLevel:${y}`)),T&&(this.firstSelection=F),F}}return-1}set nextAutoLevel(t){const{maxAutoLevel:e,minAutoLevel:i}=this.hls,s=Math.min(Math.max(t,i),e);this._nextAutoLevel!==s&&(this.nextAutoLevelKey="",this._nextAutoLevel=s)}}class Zy{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(t){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var Et={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class Qy{constructor(t){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(m.BUFFER_APPENDED,this.onBufferAppended,this),t.on(m.FRAG_BUFFERED,this.onFragBuffered,this),t.on(m.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:t}=this;t.off(m.BUFFER_APPENDED,this.onBufferAppended,this),t.off(m.FRAG_BUFFERED,this.onFragBuffered,this),t.off(m.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(t,e){const i=this.activePartLists[e];if(i)for(let s=i.length;s--;){const r=i[s];if(!r)break;const a=r.end;if(r.start<=t&&a!==null&&t<=a)return r}return this.getBufferedFrag(t,e)}getBufferedFrag(t,e){const{fragments:i}=this,s=Object.keys(i);for(let r=s.length;r--;){const a=i[s[r]];if((a==null?void 0:a.body.type)===e&&a.buffered){const o=a.body;if(o.start<=t&&t<=o.end)return o}}return null}detectEvictedFragments(t,e,i,s){this.timeRanges&&(this.timeRanges[t]=e);const r=(s==null?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(a=>{const o=this.fragments[a];if(!o||r>=o.body.sn)return;if(!o.buffered&&!o.loaded){o.body.type===i&&this.removeFragment(o.body);return}const l=o.range[t];l&&l.time.some(h=>{const c=!this.isTimeBuffered(h.startPTS,h.endPTS,e);return c&&this.removeFragment(o.body),c})})}detectPartialFragments(t){const e=this.timeRanges,{frag:i,part:s}=t;if(!e||i.sn==="initSegment")return;const r=oi(i),a=this.fragments[r];if(!a||a.buffered&&i.gap)return;const o=!i.relurl;Object.keys(e).forEach(l=>{const h=i.elementaryStreams[l];if(!h)return;const c=e[l],u=o||h.partial===!0;a.range[l]=this.getBufferedTimes(i,s,u,c)}),a.loaded=null,Object.keys(a.range).length?(a.buffered=!0,(a.body.endList=i.endList||a.body.endList)&&(this.endListFragments[a.body.type]=a),Gs(a)||this.removeParts(i.sn-1,i.type)):this.removeFragment(a.body)}removeParts(t,e){const i=this.activePartLists[e];i&&(this.activePartLists[e]=i.filter(s=>s.fragment.sn>=t))}fragBuffered(t,e){const i=oi(t);let s=this.fragments[i];!s&&e&&(s=this.fragments[i]={body:t,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},t.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(t,e,i,s){const r={time:[],partial:i},a=t.start,o=t.end,l=t.minEndPTS||o,h=t.maxStartPTS||a;for(let c=0;c<s.length;c++){const u=s.start(c)-this.bufferPadding,d=s.end(c)+this.bufferPadding;if(h>=u&&l<=d){r.time.push({startPTS:Math.max(a,s.start(c)),endPTS:Math.min(o,s.end(c))});break}else if(a<d&&o>u){const g=Math.max(a,s.start(c)),f=Math.min(o,s.end(c));f>g&&(r.partial=!0,r.time.push({startPTS:g,endPTS:f}))}else if(o<=u)break}return r}getPartialFragment(t){let e=null,i,s,r,a=0;const{bufferPadding:o,fragments:l}=this;return Object.keys(l).forEach(h=>{const c=l[h];c&&Gs(c)&&(s=c.body.start-o,r=c.body.end+o,t>=s&&t<=r&&(i=Math.min(t-s,r-t),a<=i&&(e=c.body,a=i)))}),e}isEndListAppended(t){const e=this.endListFragments[t];return e!==void 0&&(e.buffered||Gs(e))}getState(t){const e=oi(t),i=this.fragments[e];return i?i.buffered?Gs(i)?Et.PARTIAL:Et.OK:Et.APPENDING:Et.NOT_LOADED}isTimeBuffered(t,e,i){let s,r;for(let a=0;a<i.length;a++){if(s=i.start(a)-this.bufferPadding,r=i.end(a)+this.bufferPadding,t>=s&&e<=r)return!0;if(e<=s)return!1}return!1}onFragLoaded(t,e){const{frag:i,part:s}=e;if(i.sn==="initSegment"||i.bitrateTest)return;const r=s?null:e,a=oi(i);this.fragments[a]={body:i,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(t,e){const{frag:i,part:s,timeRanges:r}=e;if(i.sn==="initSegment")return;const a=i.type;if(s){let o=this.activePartLists[a];o||(this.activePartLists[a]=o=[]),o.push(s)}this.timeRanges=r,Object.keys(r).forEach(o=>{const l=r[o];this.detectEvictedFragments(o,l,a,s)})}onFragBuffered(t,e){this.detectPartialFragments(e)}hasFragment(t){const e=oi(t);return!!this.fragments[e]}hasParts(t){var e;return!!((e=this.activePartLists[t])!=null&&e.length)}removeFragmentsInRange(t,e,i,s,r){s&&!this.hasGaps||Object.keys(this.fragments).forEach(a=>{const o=this.fragments[a];if(!o)return;const l=o.body;l.type!==i||s&&!l.gap||l.start<e&&l.end>t&&(o.buffered||r)&&this.removeFragment(l)})}removeFragment(t){const e=oi(t);t.stats.loaded=0,t.clearElementaryStreamInfo();const i=this.activePartLists[t.type];if(i){const s=t.sn;this.activePartLists[t.type]=i.filter(r=>r.fragment.sn!==s)}delete this.fragments[e],t.endList&&delete this.endListFragments[t.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function Gs(n){var t,e,i;return n.buffered&&(n.body.gap||((t=n.range.video)==null?void 0:t.partial)||((e=n.range.audio)==null?void 0:e.partial)||((i=n.range.audiovideo)==null?void 0:i.partial))}function oi(n){return`${n.type}_${n.level}_${n.sn}`}const Xy={length:0,start:()=>0,end:()=>0};class st{static isBuffered(t,e){try{if(t){const i=st.getBuffered(t);for(let s=0;s<i.length;s++)if(e>=i.start(s)&&e<=i.end(s))return!0}}catch{}return!1}static bufferInfo(t,e,i){try{if(t){const s=st.getBuffered(t),r=[];let a;for(a=0;a<s.length;a++)r.push({start:s.start(a),end:s.end(a)});return this.bufferedInfo(r,e,i)}}catch{}return{len:0,start:e,end:e,nextStart:void 0}}static bufferedInfo(t,e,i){e=Math.max(0,e),t.sort(function(h,c){return h.start-c.start||c.end-h.end});let s=[];if(i)for(let h=0;h<t.length;h++){const c=s.length;if(c){const u=s[c-1].end;t[h].start-u<i?t[h].end>u&&(s[c-1].end=t[h].end):s.push(t[h])}else s.push(t[h])}else s=t;let r=0,a,o=e,l=e;for(let h=0;h<s.length;h++){const c=s[h].start,u=s[h].end;if(e+i>=c&&e<u)o=c,l=u,r=l-e;else if(e+i<c){a=c;break}}return{len:r,start:o||0,end:l||0,nextStart:a}}static getBuffered(t){try{return t.buffered}catch(e){return C.log("failed to get media.buffered",e),Xy}}}class Vs{constructor(t,e,i,s=0,r=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Hs(),this.buffering={audio:Hs(),video:Hs(),audiovideo:Hs()},this.level=t,this.sn=e,this.id=i,this.size=s,this.part=r,this.partial=a}}function Hs(){return{start:0,executeStart:0,executeEnd:0,end:0}}function Ks(n,t){for(let i=0,s=n.length;i<s;i++){var e;if(((e=n[i])==null?void 0:e.cc)===t)return n[i]}return null}function Jy(n,t,e){return!!(t&&(e.endCC>e.startCC||n&&n.cc<e.startCC))}function t0(n,t){const e=n.fragments,i=t.fragments;if(!i.length||!e.length){C.log("No fragments to align");return}const s=Ks(e,i[0].cc);if(!s||s&&!s.startPTS){C.log("No frag in previous level to align on");return}return s}function Ah(n,t){if(n){const e=n.start+t;n.start=n.startPTS=e,n.endPTS=e+n.duration}}function Rh(n,t){const e=t.fragments;for(let i=0,s=e.length;i<s;i++)Ah(e[i],n);t.fragmentHint&&Ah(t.fragmentHint,n),t.alignedSliding=!0}function e0(n,t,e){t&&(i0(n,e,t),!e.alignedSliding&&t&&Ws(e,t),!e.alignedSliding&&t&&!e.skippedSegments&&mh(t,e))}function i0(n,t,e){if(Jy(n,e,t)){const i=t0(e,t);i&&$(i.start)&&(C.log(`Adjusting PTS using last level due to CC increase within current level ${t.url}`),Rh(i.start,t))}}function Ws(n,t){if(!n.hasProgramDateTime||!t.hasProgramDateTime)return;const e=n.fragments,i=t.fragments;if(!e.length||!i.length)return;let s,r;const a=Math.min(t.endCC,n.endCC);t.startCC<a&&n.startCC<a&&(s=Ks(i,a),r=Ks(e,a)),(!s||!r)&&(s=i[Math.floor(i.length/2)],r=Ks(e,s.cc)||e[Math.floor(e.length/2)]);const o=s.programDateTime,l=r.programDateTime;if(!o||!l)return;const h=(l-o)/1e3-(r.start-s.start);Rh(h,n)}const kh=Math.pow(2,17);class s0{constructor(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(t,e){const i=t.url;if(!i)return Promise.reject(new oe({type:G.NETWORK_ERROR,details:S.FRAG_LOAD_ERROR,fatal:!1,frag:t,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const s=this.config,r=s.fLoader,a=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),t.gap)if(t.tagList.some(g=>g[0]==="GAP")){l(Ph(t));return}else t.gap=!1;const h=this.loader=t.loader=r?new r(s):new a(s),c=Dh(t),u=_h(s.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:t.sn==="initSegment"?1/0:kh};t.stats=h.stats,h.load(c,d,{onSuccess:(g,f,p,y)=>{this.resetLoader(t,h);let v=g.data;p.resetIV&&t.decryptdata&&(t.decryptdata.iv=new Uint8Array(v.slice(0,16)),v=v.slice(16)),o({frag:t,part:null,payload:v,networkDetails:y})},onError:(g,f,p,y)=>{this.resetLoader(t,h),l(new oe({type:G.NETWORK_ERROR,details:S.FRAG_LOAD_ERROR,fatal:!1,frag:t,response:yt({url:i,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:p,stats:y}))},onAbort:(g,f,p)=>{this.resetLoader(t,h),l(new oe({type:G.NETWORK_ERROR,details:S.INTERNAL_ABORTED,fatal:!1,frag:t,error:new Error("Aborted"),networkDetails:p,stats:g}))},onTimeout:(g,f,p)=>{this.resetLoader(t,h),l(new oe({type:G.NETWORK_ERROR,details:S.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:p,stats:g}))},onProgress:(g,f,p,y)=>{e&&e({frag:t,part:null,payload:p,networkDetails:y})}})})}loadPart(t,e,i){this.abort();const s=this.config,r=s.fLoader,a=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),t.gap||e.gap){l(Ph(t,e));return}const h=this.loader=t.loader=r?new r(s):new a(s),c=Dh(t,e),u=_h(s.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:kh};e.stats=h.stats,h.load(c,d,{onSuccess:(g,f,p,y)=>{this.resetLoader(t,h),this.updateStatsFromPart(t,e);const v={frag:t,part:e,payload:g.data,networkDetails:y};i(v),o(v)},onError:(g,f,p,y)=>{this.resetLoader(t,h),l(new oe({type:G.NETWORK_ERROR,details:S.FRAG_LOAD_ERROR,fatal:!1,frag:t,part:e,response:yt({url:c.url,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:p,stats:y}))},onAbort:(g,f,p)=>{t.stats.aborted=e.stats.aborted,this.resetLoader(t,h),l(new oe({type:G.NETWORK_ERROR,details:S.INTERNAL_ABORTED,fatal:!1,frag:t,part:e,error:new Error("Aborted"),networkDetails:p,stats:g}))},onTimeout:(g,f,p)=>{this.resetLoader(t,h),l(new oe({type:G.NETWORK_ERROR,details:S.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,part:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:p,stats:g}))}})})}updateStatsFromPart(t,e){const i=t.stats,s=e.stats,r=s.total;if(i.loaded+=s.loaded,r){const l=Math.round(t.duration/e.duration),h=Math.min(Math.round(i.loaded/r),l),c=(l-h)*Math.round(i.loaded/h);i.total=i.loaded+c}else i.total=Math.max(i.loaded,i.total);const a=i.loading,o=s.loading;a.start?a.first+=o.first-o.start:(a.start=o.start,a.first=o.first),a.end=o.end}resetLoader(t,e){t.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()}}function Dh(n,t=null){const e=t||n,i={frag:n,part:t,responseType:"arraybuffer",url:e.url,headers:{},rangeStart:0,rangeEnd:0},s=e.byteRangeStartOffset,r=e.byteRangeEndOffset;if($(s)&&$(r)){var a;let o=s,l=r;if(n.sn==="initSegment"&&((a=n.decryptdata)==null?void 0:a.method)==="AES-128"){const h=r-s;h%16&&(l=r+(16-h%16)),s!==0&&(i.resetIV=!0,o=s-16)}i.rangeStart=o,i.rangeEnd=l}return i}function Ph(n,t){const e=new Error(`GAP ${n.gap?"tag":"attribute"} found`),i={type:G.MEDIA_ERROR,details:S.FRAG_GAP,fatal:!1,frag:n,error:e,networkDetails:null};return t&&(i.part=t),(t||n).stats.aborted=!0,new oe(i)}class oe extends Error{constructor(t){super(t.error.message),this.data=void 0,this.data=t}}class n0{constructor(t,e){this.subtle=void 0,this.aesIV=void 0,this.subtle=t,this.aesIV=e}decrypt(t,e){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t)}}class r0{constructor(t,e){this.subtle=void 0,this.key=void 0,this.subtle=t,this.key=e}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function a0(n){const t=n.byteLength,e=t&&new DataView(n.buffer).getUint8(t-1);return e?Me(n,0,t-e):n}class o0{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(t){const e=new DataView(t),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=e.getUint32(s*4);return i}initTable(){const t=this.sBox,e=this.invSBox,i=this.subMix,s=i[0],r=i[1],a=i[2],o=i[3],l=this.invSubMix,h=l[0],c=l[1],u=l[2],d=l[3],g=new Uint32Array(256);let f=0,p=0,y=0;for(y=0;y<256;y++)y<128?g[y]=y<<1:g[y]=y<<1^283;for(y=0;y<256;y++){let v=p^p<<1^p<<2^p<<3^p<<4;v=v>>>8^v&255^99,t[f]=v,e[v]=f;const E=g[f],_=g[E],T=g[_];let L=g[v]*257^v*16843008;s[f]=L<<24|L>>>8,r[f]=L<<16|L>>>16,a[f]=L<<8|L>>>24,o[f]=L,L=T*16843009^_*65537^E*257^f*16843008,h[v]=L<<24|L>>>8,c[v]=L<<16|L>>>16,u[v]=L<<8|L>>>24,d[v]=L,f?(f=E^g[g[g[T^E]]],p^=g[g[p]]):f=p=1}}expandKey(t){const e=this.uint8ArrayToUint32Array_(t);let i=!0,s=0;for(;s<e.length&&i;)i=e[s]===this.key[s],s++;if(i)return;this.key=e;const r=this.keySize=e.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const a=this.ksRows=(r+6+1)*4;let o,l;const h=this.keySchedule=new Uint32Array(a),c=this.invKeySchedule=new Uint32Array(a),u=this.sBox,d=this.rcon,g=this.invSubMix,f=g[0],p=g[1],y=g[2],v=g[3];let E,_;for(o=0;o<a;o++){if(o<r){E=h[o]=e[o];continue}_=E,o%r===0?(_=_<<8|_>>>24,_=u[_>>>24]<<24|u[_>>>16&255]<<16|u[_>>>8&255]<<8|u[_&255],_^=d[o/r|0]<<24):r>6&&o%r===4&&(_=u[_>>>24]<<24|u[_>>>16&255]<<16|u[_>>>8&255]<<8|u[_&255]),h[o]=E=(h[o-r]^_)>>>0}for(l=0;l<a;l++)o=a-l,l&3?_=h[o]:_=h[o-4],l<4||o<=4?c[l]=_:c[l]=f[u[_>>>24]]^p[u[_>>>16&255]]^y[u[_>>>8&255]]^v[u[_&255]],c[l]=c[l]>>>0}networkToHostOrderSwap(t){return t<<24|(t&65280)<<8|(t&16711680)>>8|t>>>24}decrypt(t,e,i){const s=this.keySize+6,r=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,l=o[0],h=o[1],c=o[2],u=o[3],d=this.uint8ArrayToUint32Array_(i);let g=d[0],f=d[1],p=d[2],y=d[3];const v=new Int32Array(t),E=new Int32Array(v.length);let _,T,L,w,I,D,P,R,k,Y,M,j,F,H;const x=this.networkToHostOrderSwap;for(;e<v.length;){for(k=x(v[e]),Y=x(v[e+1]),M=x(v[e+2]),j=x(v[e+3]),I=k^r[0],D=j^r[1],P=M^r[2],R=Y^r[3],F=4,H=1;H<s;H++)_=l[I>>>24]^h[D>>16&255]^c[P>>8&255]^u[R&255]^r[F],T=l[D>>>24]^h[P>>16&255]^c[R>>8&255]^u[I&255]^r[F+1],L=l[P>>>24]^h[R>>16&255]^c[I>>8&255]^u[D&255]^r[F+2],w=l[R>>>24]^h[I>>16&255]^c[D>>8&255]^u[P&255]^r[F+3],I=_,D=T,P=L,R=w,F=F+4;_=a[I>>>24]<<24^a[D>>16&255]<<16^a[P>>8&255]<<8^a[R&255]^r[F],T=a[D>>>24]<<24^a[P>>16&255]<<16^a[R>>8&255]<<8^a[I&255]^r[F+1],L=a[P>>>24]<<24^a[R>>16&255]<<16^a[I>>8&255]<<8^a[D&255]^r[F+2],w=a[R>>>24]<<24^a[I>>16&255]<<16^a[D>>8&255]<<8^a[P&255]^r[F+3],E[e]=x(_^g),E[e+1]=x(w^f),E[e+2]=x(L^p),E[e+3]=x(T^y),g=k,f=Y,p=M,y=j,e=e+4}return E.buffer}}const l0=16;class Br{constructor(t,{removePKCS7Padding:e=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=t.enableSoftwareAES,this.removePKCS7Padding=e,e)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:t,remainderData:e}=this;if(!t||e)return this.reset(),null;const i=new Uint8Array(t);return this.reset(),this.removePKCS7Padding?a0(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(t,e,i){return this.useSoftware?new Promise((s,r)=>{this.softwareDecrypt(new Uint8Array(t),e,i);const a=this.flush();a?s(a.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(t),e,i)}softwareDecrypt(t,e,i){const{currentIV:s,currentResult:r,remainderData:a}=this;this.logOnce("JS AES decrypt"),a&&(t=Rt(a,t),this.remainderData=null);const o=this.getValidChunk(t);if(!o.length)return null;s&&(i=s);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new o0),l.expandKey(e);const h=r;return this.currentResult=l.decrypt(o.buffer,0,i),this.currentIV=Me(o,-16).buffer,h||null}webCryptoDecrypt(t,e,i){if(this.key!==e||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(t,e,i));this.key=e,this.fastAesKey=new r0(this.subtle,e)}return this.fastAesKey.expandKey().then(s=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new n0(this.subtle,new Uint8Array(i)).decrypt(t.buffer,s)):Promise.reject(new Error("web crypto not initialized"))).catch(s=>(C.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${s.name}: ${s.message}`),this.onWebCryptoError(t,e,i)))}onWebCryptoError(t,e,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(t,e,i);const s=this.flush();if(s)return s.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(t){let e=t;const i=t.length-t.length%l0;return i!==t.length&&(e=Me(t,0,i),this.remainderData=Me(t,i)),e}logOnce(t){this.logEnabled&&(C.log(`[decrypter]: ${t}`),this.logEnabled=!1)}}const h0={toString:function(n){let t="";const e=n.length;for(let i=0;i<e;i++)t+=`[${n.start(i).toFixed(3)}-${n.end(i).toFixed(3)}]`;return t}},A={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class zs extends Zy{constructor(t,e,i,s,r){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=A.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=r,this.logPrefix=s,this.log=C.log.bind(C,`${s}:`),this.warn=C.warn.bind(C,`${s}:`),this.hls=t,this.fragmentLoader=new s0(t.config),this.keyLoader=i,this.fragmentTracker=e,this.config=t.config,this.decrypter=new Br(t.config),t.on(m.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(t){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const t=this.fragCurrent;t!=null&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=A.STOPPED}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}_streamEnded(t,e){if(e.live||t.nextStart||!t.end||!this.media)return!1;const i=e.partList;if(i!=null&&i.length){const r=i[i.length-1];return st.isBuffered(this.media,r.start+r.duration/2)}const s=e.fragments[e.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(s)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var t;return(t=this.levelLastLoaded)==null?void 0:t.details}}onMediaAttached(t,e){const i=this.media=this.mediaBuffer=e.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const s=this.config;this.levels&&s.autoStartLoad&&this.state===A.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(){const t=this.media;t!=null&&t.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),t&&this.onvseeking&&this.onvended&&(t.removeEventListener("seeking",this.onvseeking),t.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:t,fragCurrent:e,media:i,mediaBuffer:s,state:r}=this,a=i?i.currentTime:0,o=st.bufferInfo(s||i,a,t.maxBufferHole);if(this.log(`media seeking to ${$(a)?a.toFixed(3):a}, state: ${r}`),this.state===A.ENDED)this.resetLoadingState();else if(e){const l=t.maxFragLookUpTolerance,h=e.start-l,c=e.start+e.duration+l;if(!o.len||c<o.start||h>o.end){const u=a>c;(a<h||u)&&(u&&e.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),e.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(a,1/0,this.playlistType,!0),this.lastCurrentTime=a),!this.loadedmetadata&&!o.len&&(this.nextLoadPosition=this.startPosition=a),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(t,e){this.startTimeOffset=e.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(m.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=A.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(t,e,i){this._loadFragForPlayback(t,e,i)}_loadFragForPlayback(t,e,i){const s=r=>{if(this.fragContextChanged(t)){this.warn(`Fragment ${t.sn}${r.part?" p: "+r.part.index:""} of level ${t.level} was dropped during download.`),this.fragmentTracker.removeFragment(t);return}t.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(t,e,i,s).then(r=>{if(!r)return;const a=this.state;if(this.fragContextChanged(t)){(a===A.FRAG_LOADING||!this.fragCurrent&&a===A.PARSING)&&(this.fragmentTracker.removeFragment(t),this.state=A.IDLE);return}"payload"in r&&(this.log(`Loaded fragment ${t.sn} of level ${t.level}`),this.hls.trigger(m.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===A.STOPPED||this.state===A.ERROR||(this.warn(`Frag error: ${(r==null?void 0:r.message)||r}`),this.resetFragmentLoading(t))})}clearTrackerIfNeeded(t){var e;const{fragmentTracker:i}=this;if(i.getState(t)===Et.APPENDING){const s=t.type,r=this.getFwdBufferInfo(this.mediaBuffer,s),a=Math.max(t.duration,r?r.len:this.config.maxBufferLength),o=this.backtrackFragment;((o?t.sn-o.sn:0)===1||this.reduceMaxBufferLength(a,t.duration))&&i.removeFragment(t)}else((e=this.mediaBuffer)==null?void 0:e.buffered.length)===0?i.removeAllFragments():i.hasParts(t.type)&&(i.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type}),i.getState(t)===Et.PARTIAL&&i.removeFragment(t))}checkLiveUpdate(t){if(t.updated&&!t.live){const e=t.fragments[t.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type})}t.fragments[0]||(t.deltaUpdateFailed=!0)}flushMainBuffer(t,e,i=null){if(!(t-e))return;const s={startOffset:t,endOffset:e,type:i};this.hls.trigger(m.BUFFER_FLUSHING,s)}_loadInitSegment(t,e){this._doFragLoad(t,e).then(i=>{if(!i||this.fragContextChanged(t)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:s}=this,{payload:r}=i,a=t.decryptdata;if(r&&r.byteLength>0&&a!=null&&a.key&&a.iv&&a.method==="AES-128"){const o=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),a.key.buffer,a.iv.buffer).catch(l=>{throw s.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:t}),l}).then(l=>{const h=self.performance.now();return s.trigger(m.FRAG_DECRYPTED,{frag:t,payload:l,stats:{tstart:o,tdecrypt:h}}),i.payload=l,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===A.STOPPED||this.state===A.ERROR||(this.warn(i),this.resetFragmentLoading(t))})}completeInitSegmentLoad(t){const{levels:e}=this;if(!e)throw new Error("init load aborted, missing levels");const i=t.frag.stats;this.state=A.IDLE,t.frag.data=new Uint8Array(t.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(t){const{fragCurrent:e}=this;return!t||!e||t.sn!==e.sn||t.level!==e.level}fragBufferedComplete(t,e){var i,s,r,a;const o=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${this.playlistType===U.MAIN?"level":"track"} ${t.level} (frag:[${((i=t.startPTS)!=null?i:NaN).toFixed(3)}-${((s=t.endPTS)!=null?s:NaN).toFixed(3)}] > buffer:${o?h0.toString(st.getBuffered(o)):"(detached)"})`),t.sn!=="initSegment"){var l;if(t.type!==U.SUBTITLE){const c=t.elementaryStreams;if(!Object.keys(c).some(u=>!!c[u])){this.state=A.IDLE;return}}const h=(l=this.levels)==null?void 0:l[t.level];h!=null&&h.fragmentError&&(this.log(`Resetting level fragment error count of ${h.fragmentError} on frag buffered`),h.fragmentError=0)}this.state=A.IDLE,o&&(!this.loadedmetadata&&t.type==U.MAIN&&o.buffered.length&&((r=this.fragCurrent)==null?void 0:r.sn)===((a=this.fragPrevious)==null?void 0:a.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(t){const{transmuxer:e}=this;if(!e)return;const{frag:i,part:s,partsLoaded:r}=t,a=!r||r.length===0||r.some(l=>!l),o=new Vs(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!a);e.flush(o)}_handleFragmentLoadProgress(t){}_doFragLoad(t,e,i=null,s){var r;const a=e==null?void 0:e.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let o=null;if(t.encrypted&&!((r=t.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${t.sn} of [${a.startSN}-${a.endSN}], ${this.logPrefix==="[stream-controller]"?"level":"track"} ${t.level}`),this.state=A.KEY_LOADING,this.fragCurrent=t,o=this.keyLoader.load(t).then(c=>{if(!this.fragContextChanged(c.frag))return this.hls.trigger(m.KEY_LOADED,c),this.state===A.KEY_LOADING&&(this.state=A.IDLE),c}),this.hls.trigger(m.KEY_LOADING,{frag:t}),this.fragCurrent===null&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!t.encrypted&&a.encryptedFragments.length&&this.keyLoader.loadClear(t,a.encryptedFragments),i=Math.max(t.start,i||0),this.config.lowLatencyMode&&t.sn!=="initSegment"){const c=a.partList;if(c&&s){i>t.end&&a.fragmentHint&&(t=a.fragmentHint);const u=this.getNextPart(c,t,i);if(u>-1){const d=c[u];this.log(`Loading part sn: ${t.sn} p: ${d.index} cc: ${t.cc} of playlist [${a.startSN}-${a.endSN}] parts [0-${u}-${c.length-1}] ${this.logPrefix==="[stream-controller]"?"level":"track"}: ${t.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=d.start+d.duration,this.state=A.FRAG_LOADING;let g;return o?g=o.then(f=>!f||this.fragContextChanged(f.frag)?null:this.doFragPartsLoad(t,d,e,s)).catch(f=>this.handleFragLoadError(f)):g=this.doFragPartsLoad(t,d,e,s).catch(f=>this.handleFragLoadError(f)),this.hls.trigger(m.FRAG_LOADING,{frag:t,part:d,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!t.url||this.loadedEndOfParts(c,i))return Promise.resolve(null)}}this.log(`Loading fragment ${t.sn} cc: ${t.cc} ${a?"of ["+a.startSN+"-"+a.endSN+"] ":""}${this.logPrefix==="[stream-controller]"?"level":"track"}: ${t.level}, target: ${parseFloat(i.toFixed(3))}`),$(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=A.FRAG_LOADING;const l=this.config.progressive;let h;return l&&o?h=o.then(c=>!c||this.fragContextChanged(c==null?void 0:c.frag)?null:this.fragmentLoader.load(t,s)).catch(c=>this.handleFragLoadError(c)):h=Promise.all([this.fragmentLoader.load(t,l?s:void 0),o]).then(([c])=>(!l&&c&&s&&s(c),c)).catch(c=>this.handleFragLoadError(c)),this.hls.trigger(m.FRAG_LOADING,{frag:t,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):h}doFragPartsLoad(t,e,i,s){return new Promise((r,a)=>{var o;const l=[],h=(o=i.details)==null?void 0:o.partList,c=u=>{this.fragmentLoader.loadPart(t,u,s).then(d=>{l[u.index]=d;const g=d.part;this.hls.trigger(m.FRAG_LOADED,d);const f=yh(i,t.sn,u.index+1)||vh(h,t.sn,u.index+1);if(f)c(f);else return r({frag:t,part:g,partsLoaded:l})}).catch(a)};c(e)})}handleFragLoadError(t){if("data"in t){const e=t.data;t.data&&e.details===S.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):this.hls.trigger(m.ERROR,e)}else this.hls.trigger(m.ERROR,{type:G.OTHER_ERROR,details:S.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null}_handleTransmuxerFlush(t){const e=this.getCurrentContext(t);if(!e||this.state!==A.PARSING){!this.fragCurrent&&this.state!==A.STOPPED&&this.state!==A.ERROR&&(this.state=A.IDLE);return}const{frag:i,part:s,level:r}=e,a=self.performance.now();i.stats.parsing.end=a,s&&(s.stats.parsing.end=a),this.updateLevelTiming(i,s,r,t.partial)}getCurrentContext(t){const{levels:e,fragCurrent:i}=this,{level:s,sn:r,part:a}=t;if(!(e!=null&&e[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of level ${s}. The current chunk will not be buffered.`),null;const o=e[s],l=a>-1?yh(o,r,a):null,h=l?l.fragment:xy(o,r,i);return h?(i&&i!==h&&(h.stats=i.stats),{frag:h,part:l,level:o}):null}bufferFragmentData(t,e,i,s,r){var a;if(!t||this.state!==A.PARSING)return;const{data1:o,data2:l}=t;let h=o;if(o&&l&&(h=Rt(o,l)),!((a=h)!=null&&a.length))return;const c={type:t.type,frag:e,part:i,chunkMeta:s,parent:e.type,data:h};if(this.hls.trigger(m.BUFFER_APPENDING,c),t.dropped&&t.independent&&!i){if(r)return;this.flushBufferGap(e)}}flushBufferGap(t){const e=this.media;if(!e)return;if(!st.isBuffered(e,e.currentTime)){this.flushMainBuffer(0,t.start);return}const i=e.currentTime,s=st.bufferInfo(e,i,0),r=t.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),o=Math.max(Math.min(t.start-a,s.end-a),i+a);t.start-o>a&&this.flushMainBuffer(o,t.start)}getFwdBufferInfo(t,e){const i=this.getLoadPosition();return $(i)?this.getFwdBufferInfoAtPos(t,i,e):null}getFwdBufferInfoAtPos(t,e,i){const{config:{maxBufferHole:s}}=this,r=st.bufferInfo(t,e,s);if(r.len===0&&r.nextStart!==void 0){const a=this.fragmentTracker.getBufferedFrag(e,i);if(a&&r.nextStart<a.end)return st.bufferInfo(t,e,Math.max(r.nextStart,s))}return r}getMaxBufferLength(t){const{config:e}=this;let i;return t?i=Math.max(8*e.maxBufferSize/t,e.maxBufferLength):i=e.maxBufferLength,Math.min(i,e.maxMaxBufferLength)}reduceMaxBufferLength(t,e){const i=this.config,s=Math.max(Math.min(t-e,i.maxBufferLength),e),r=Math.max(t-e*3,i.maxMaxBufferLength/2,s);return r>=s?(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0):!1}getAppendedFrag(t,e=U.MAIN){const i=this.fragmentTracker.getAppendedFrag(t,U.MAIN);return i&&"fragment"in i?i.fragment:i}getNextFragment(t,e){const i=e.fragments,s=i.length;if(!s)return null;const{config:r}=this,a=i[0].start;let o;if(e.live){const l=r.initialLiveManifestSize;if(s<l)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${l})`),null;(!e.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||t<a)&&(o=this.getInitialLiveFragment(e,i),this.startPosition=this.nextLoadPosition=o?this.hls.liveSyncPosition||o.start:t)}else t<=a&&(o=i[0]);if(!o){const l=r.lowLatencyMode?e.partEnd:e.fragmentEnd;o=this.getFragmentAtPosition(t,l,e)}return this.mapToInitFragWhenRequired(o)}isLoopLoading(t,e){const i=this.fragmentTracker.getState(t);return(i===Et.OK||i===Et.PARTIAL&&!!t.gap)&&this.nextLoadPosition>e}getNextFragmentLoopLoading(t,e,i,s,r){const a=t.gap,o=this.getNextFragment(this.nextLoadPosition,e);if(o===null)return o;if(t=o,a&&t&&!t.gap&&i.nextStart){const l=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s);if(l!==null&&i.len+l.len>=r)return this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${t.sn}`),null}return t}mapToInitFragWhenRequired(t){return t!=null&&t.initSegment&&!(t!=null&&t.initSegment.data)&&!this.bitrateTest?t.initSegment:t}getNextPart(t,e,i){let s=-1,r=!1,a=!0;for(let o=0,l=t.length;o<l;o++){const h=t[o];if(a=a&&!h.independent,s>-1&&i<h.start)break;const c=h.loaded;c?s=-1:(r||h.independent||a)&&h.fragment===e&&(s=o),r=c}return s}loadedEndOfParts(t,e){const i=t[t.length-1];return i&&e>i.start&&i.loaded}getInitialLiveFragment(t,e){const i=this.fragPrevious;let s=null;if(i){if(t.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=Oy(e,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const r=i.sn+1;if(r>=t.startSN&&r<=t.endSN){const a=e[r-t.startSN];i.cc===a.cc&&(s=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=Fy(e,i.cc),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(s=this.getFragmentAtPosition(r,this.bitrateTest?t.fragmentEnd:t.edge,t))}return s}getFragmentAtPosition(t,e,i){const{config:s}=this;let{fragPrevious:r}=this,{fragments:a,endSN:o}=i;const{fragmentHint:l}=i,{maxFragLookUpTolerance:h}=s,c=i.partList,u=!!(s.lowLatencyMode&&c!=null&&c.length&&l);u&&l&&!this.bitrateTest&&(a=a.concat(l),o=l.sn);let d;if(t<e){const g=t>e-h?0:h;d=Us(r,a,t,g)}else d=a[a.length-1];if(d){const g=d.sn-i.startSN,f=this.fragmentTracker.getState(d);if((f===Et.OK||f===Et.PARTIAL&&d.gap)&&(r=d),r&&d.sn===r.sn&&(!u||c[0].fragment.sn>d.sn)&&r&&d.level===r.level){const p=a[g+1];d.sn<o&&this.fragmentTracker.getState(p)!==Et.OK?d=p:d=null}}return d}synchronizeToLiveEdge(t){const{config:e,media:i}=this;if(!i)return;const s=this.hls.liveSyncPosition,r=i.currentTime,a=t.fragments[0].start,o=t.edge,l=r>=a-e.maxFragLookUpTolerance&&r<=o;if(s!==null&&i.duration>s&&(r<s||!l)){const h=e.liveMaxLatencyDuration!==void 0?e.liveMaxLatencyDuration:e.liveMaxLatencyDurationCount*t.targetduration;(!l&&i.readyState<4||r<o-h)&&(this.loadedmetadata||(this.nextLoadPosition=s),i.readyState&&(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${o}, reset currentTime to : ${s.toFixed(3)}`),i.currentTime=s))}}alignPlaylists(t,e,i){const s=t.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;const r=t.fragments[0].start,a=!e,o=t.alignedSliding&&$(r);if(a||!o&&!r){const{fragPrevious:l}=this;e0(l,i,t);const h=t.fragments[0].start;return this.log(`Live playlist sliding: ${h.toFixed(2)} start-sn: ${e?e.startSN:"na"}->${t.startSN} prev-sn: ${l?l.sn:"na"} fragments: ${s}`),h}return r}waitForCdnTuneIn(t){return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,t.partTarget*3)}setStartPosition(t,e){let i=this.startPosition;if(i<e&&(i=-1),i===-1||this.lastCurrentTime===-1){const s=this.startTimeOffset!==null,r=s?this.startTimeOffset:t.startTimeOffset;r!==null&&$(r)?(i=e+r,r<0&&(i+=t.totalduration),i=Math.min(Math.max(e,i),e+t.totalduration),this.log(`Start time offset ${r} found in ${s?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):t.live?i=this.hls.liveSyncPosition||e:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:t}=this;let e=0;return this.loadedmetadata&&t?e=t.currentTime:this.nextLoadPosition&&(e=this.nextLoadPosition),e}handleFragLoadAborted(t,e){this.transmuxer&&t.sn!=="initSegment"&&t.stats.aborted&&(this.warn(`Fragment ${t.sn}${e?" part "+e.index:""} of level ${t.level} was aborted`),this.resetFragmentLoading(t))}resetFragmentLoading(t){(!this.fragCurrent||!this.fragContextChanged(t)&&this.state!==A.FRAG_LOADING_WAITING_RETRY)&&(this.state=A.IDLE)}onFragmentOrKeyLoadError(t,e){if(e.chunkMeta&&!e.frag){const c=this.getCurrentContext(e.chunkMeta);c&&(e.frag=c.frag)}const i=e.frag;if(!i||i.type!==t||!this.levels)return;if(this.fragContextChanged(i)){var s;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const r=e.details===S.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const a=e.errorAction,{action:o,retryCount:l=0,retryConfig:h}=a||{};if(a&&o===vt.RetryRequest&&h){this.resetStartWhenNotLoaded(this.levelLastLoaded);const c=Fr(h,l);this.warn(`Fragment ${i.sn} of ${t} ${i.level} errored with ${e.details}, retrying loading ${l+1}/${h.maxNumRetry} in ${c}ms`),a.resolved=!0,this.retryDate=self.performance.now()+c,this.state=A.FRAG_LOADING_WAITING_RETRY}else if(h&&a)if(this.resetFragmentErrors(t),l<h.maxNumRetry)!r&&o!==vt.RemoveAlternatePermanently&&(a.resolved=!0);else{C.warn(`${e.details} reached or exceeded max retry (${l})`);return}else(a==null?void 0:a.action)===vt.SendAlternateToPenaltyBox?this.state=A.WAITING_LEVEL:this.state=A.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(t){if(this.state===A.PARSING||this.state===A.PARSED){const e=t.frag,i=t.parent,s=this.getFwdBufferInfo(this.mediaBuffer,i),r=s&&s.len>.5;r&&this.reduceMaxBufferLength(s.len,(e==null?void 0:e.duration)||10);const a=!r;return a&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),e&&(this.fragmentTracker.removeFragment(e),this.nextLoadPosition=e.start),this.resetLoadingState(),a}return!1}resetFragmentErrors(t){t===U.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==A.STOPPED&&(this.state=A.IDLE)}afterBufferFlushed(t,e,i){if(!t)return;const s=st.getBuffered(t);this.fragmentTracker.detectEvictedFragments(e,s,i),this.state===A.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=A.IDLE}resetStartWhenNotLoaded(t){if(!this.loadedmetadata){this.startFragRequested=!1;const e=t?t.details:null;e!=null&&e.live?(this.startPosition=-1,this.setStartPosition(e,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(t){this.warn(`The loading context changed while buffering fragment ${t.sn} of level ${t.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(t=0){this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)}updateLevelTiming(t,e,i,s){var r;const a=i.details;if(!a){this.warn("level.details undefined");return}if(!Object.keys(t.elementaryStreams).reduce((o,l)=>{const h=t.elementaryStreams[l];if(h){const c=h.endPTS-h.startPTS;if(c<=0)return this.warn(`Could not parse fragment ${t.sn} ${l} duration reliably (${c})`),o||!1;const u=s?0:ph(a,t,h.startPTS,h.endPTS,h.startDTS,h.endDTS);return this.hls.trigger(m.LEVEL_PTS_UPDATED,{details:a,level:i,drift:u,type:l,frag:t,start:h.startPTS,end:h.endPTS}),!0}return o},!1)&&((r=this.transmuxer)==null?void 0:r.error)===null){const o=new Error(`Found no media in fragment ${t.sn} of level ${t.level} resetting transmuxer to fallback to playlist timing`);if(i.fragmentError===0&&(i.fragmentError++,t.gap=!0,this.fragmentTracker.removeFragment(t),this.fragmentTracker.fragBuffered(t,!0)),this.warn(o.message),this.hls.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.FRAG_PARSING_ERROR,fatal:!1,error:o,frag:t,reason:`Found no media in msn ${t.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=A.PARSED,this.hls.trigger(m.FRAG_PARSED,{frag:t,part:e})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(t){t.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(t){const e=this._state;e!==t&&(this._state=t,this.log(`${e}->${t}`))}get state(){return this._state}}class xh{constructor(){this.chunks=[],this.dataLength=0}push(t){this.chunks.push(t),this.dataLength+=t.length}flush(){const{chunks:t,dataLength:e}=this;let i;if(t.length)t.length===1?i=t[0]:i=c0(t,e);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function c0(n,t){const e=new Uint8Array(t);let i=0;for(let s=0;s<n.length;s++){const r=n[s];e.set(r,i),i+=r.length}return e}function u0(){return typeof __HLS_WORKER_BUNDLE__=="function"}function d0(){const n=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(n);return{worker:new self.Worker(t),objectURL:t}}function f0(n){const t=new self.URL(n,self.location.href).href;return{worker:new self.Worker(t),scriptURL:t}}function ee(n="",t=9e4){return{type:n,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class Gr{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(t,e,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(t){this.initPTS=t,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(t,e){return!1}appendFrame(t,e,i){}demux(t,e){this.cachedData&&(t=Rt(this.cachedData,t),this.cachedData=null);let i=xi(t,0),s=i?i.length:0,r;const a=this._audioTrack,o=this._id3Track,l=i?Cr(i):void 0,h=t.length;for((this.basePTS===null||this.frameIndex===0&&$(l))&&(this.basePTS=g0(l,e,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:kt.audioId3,duration:Number.POSITIVE_INFINITY});s<h;){if(this.canParse(t,s)){const c=this.appendFrame(a,t,s);c?(this.frameIndex++,this.lastPTS=c.sample.pts,s+=c.length,r=s):s=h}else N1(t,s)?(i=xi(t,s),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:kt.audioId3,duration:Number.POSITIVE_INFINITY}),s+=i.length,r=s):s++;if(s===h&&r!==h){const c=Me(t,r);this.cachedData?this.cachedData=Rt(this.cachedData,c):this.cachedData=c}}return{audioTrack:a,videoTrack:ee(),id3Track:o,textTrack:ee()}}demuxSampleAes(t,e,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(t){const e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:ee(),id3Track:this._id3Track,textTrack:ee()}}destroy(){}}const g0=(n,t,e)=>{if($(n))return n*90;const i=e?e.baseTime*9e4/e.timescale:0;return t*9e4+i};function p0(n,t,e,i){let s,r,a,o;const l=navigator.userAgent.toLowerCase(),h=i,c=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=((t[e+2]&192)>>>6)+1;const u=(t[e+2]&60)>>>2;if(u>c.length-1){const d=new Error(`invalid ADTS sampling index:${u}`);n.emit(m.ERROR,m.ERROR,{type:G.MEDIA_ERROR,details:S.FRAG_PARSING_ERROR,fatal:!0,error:d,reason:d.message});return}return a=(t[e+2]&1)<<2,a|=(t[e+3]&192)>>>6,C.log(`manifest codec:${i}, ADTS type:${s}, samplingIndex:${u}`),/firefox/i.test(l)?u>=6?(s=5,o=new Array(4),r=u-3):(s=2,o=new Array(2),r=u):l.indexOf("android")!==-1?(s=2,o=new Array(2),r=u):(s=5,o=new Array(4),i&&(i.indexOf("mp4a.40.29")!==-1||i.indexOf("mp4a.40.5")!==-1)||!i&&u>=6?r=u-3:((i&&i.indexOf("mp4a.40.2")!==-1&&(u>=6&&a===1||/vivaldi/i.test(l))||!i&&a===1)&&(s=2,o=new Array(2)),r=u)),o[0]=s<<3,o[0]|=(u&14)>>1,o[1]|=(u&1)<<7,o[1]|=a<<3,s===5&&(o[1]|=(r&14)>>1,o[2]=(r&1)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:c[u],channelCount:a,codec:"mp4a.40."+s,manifestCodec:h}}function Mh(n,t){return n[t]===255&&(n[t+1]&246)===240}function Oh(n,t){return n[t+1]&1?7:9}function Vr(n,t){return(n[t+3]&3)<<11|n[t+4]<<3|(n[t+5]&224)>>>5}function m0(n,t){return t+5<n.length}function Ys(n,t){return t+1<n.length&&Mh(n,t)}function y0(n,t){return m0(n,t)&&Mh(n,t)&&Vr(n,t)<=n.length-t}function v0(n,t){if(Ys(n,t)){const e=Oh(n,t);if(t+e>=n.length)return!1;const i=Vr(n,t);if(i<=e)return!1;const s=t+i;return s===n.length||Ys(n,s)}return!1}function $h(n,t,e,i,s){if(!n.samplerate){const r=p0(t,e,i,s);if(!r)return;n.config=r.config,n.samplerate=r.samplerate,n.channelCount=r.channelCount,n.codec=r.codec,n.manifestCodec=r.manifestCodec,C.log(`parsed codec:${n.codec}, rate:${r.samplerate}, channels:${r.channelCount}`)}}function Nh(n){return 1024*9e4/n}function E0(n,t){const e=Oh(n,t);if(t+e<=n.length){const i=Vr(n,t)-e;if(i>0)return{headerLength:e,frameLength:i}}}function Fh(n,t,e,i,s){const r=Nh(n.samplerate),a=i+s*r,o=E0(t,e);let l;if(o){const{frameLength:c,headerLength:u}=o,d=u+c,g=Math.max(0,e+d-t.length);g?(l=new Uint8Array(d-u),l.set(t.subarray(e+u,t.length),0)):l=t.subarray(e+u,e+d);const f={unit:l,pts:a};return g||n.samples.push(f),{sample:f,length:d,missing:g}}const h=t.length-e;return l=new Uint8Array(h),l.set(t.subarray(e,t.length),0),{sample:{unit:l,pts:a},length:h,missing:-1}}let js=null;const T0=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],_0=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],L0=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],C0=[0,1,1,4];function Uh(n,t,e,i,s){if(e+24>t.length)return;const r=Bh(t,e);if(r&&e+r.frameLength<=t.length){const a=r.samplesPerFrame*9e4/r.sampleRate,o=i+s*a,l={unit:t.subarray(e,e+r.frameLength),pts:o,dts:o};return n.config=[],n.channelCount=r.channelCount,n.samplerate=r.sampleRate,n.samples.push(l),{sample:l,length:r.frameLength,missing:0}}}function Bh(n,t){const e=n[t+1]>>3&3,i=n[t+1]>>1&3,s=n[t+2]>>4&15,r=n[t+2]>>2&3;if(e!==1&&s!==0&&s!==15&&r!==3){const a=n[t+2]>>1&1,o=n[t+3]>>6,l=e===3?3-i:i===3?3:4,h=T0[l*14+s-1]*1e3,c=_0[(e===3?0:e===2?1:2)*3+r],u=o===3?1:2,d=L0[e][i],g=C0[i],f=d*8*g,p=Math.floor(d*h/c+a)*g;if(js===null){const y=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);js=y?parseInt(y[1]):0}return js&&js<=87&&i===2&&h>=224e3&&o===0&&(n[t+3]=n[t+3]|128),{sampleRate:c,channelCount:u,frameLength:p,samplesPerFrame:f}}}function Hr(n,t){return n[t]===255&&(n[t+1]&224)===224&&(n[t+1]&6)!==0}function Gh(n,t){return t+1<n.length&&Hr(n,t)}function b0(n,t){return Hr(n,t)&&4<=n.length-t}function Vh(n,t){if(t+1<n.length&&Hr(n,t)){const e=Bh(n,t);let i=4;e!=null&&e.frameLength&&(i=e.frameLength);const s=t+i;return s===n.length||Gh(n,s)}return!1}class S0 extends Gr{constructor(t,e){super(),this.observer=void 0,this.config=void 0,this.observer=t,this.config=e}resetInitSegment(t,e,i,s){super.resetInitSegment(t,e,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:e,duration:s,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=xi(t,0);let i=(e==null?void 0:e.length)||0;if(Vh(t,i))return!1;for(let s=t.length;i<s;i++)if(v0(t,i))return C.log("ADTS sync word found !"),!0;return!1}canParse(t,e){return y0(t,e)}appendFrame(t,e,i){$h(t,this.observer,e,i,t.manifestCodec);const s=Fh(t,e,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}}const w0=/\/emsg[-/]ID3/i;class I0{constructor(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}resetTimeStamp(){}resetInitSegment(t,e,i,s){const r=this.videoTrack=ee("video",1),a=this.audioTrack=ee("audio",1),o=this.txtTrack=ee("text",1);if(this.id3Track=ee("id3",1),this.timeOffset=0,!(t!=null&&t.byteLength))return;const l=Hl(t);if(l.video){const{id:h,timescale:c,codec:u}=l.video;r.id=h,r.timescale=o.timescale=c,r.codec=u}if(l.audio){const{id:h,timescale:c,codec:u}=l.audio;a.id=h,a.timescale=c,a.codec=u}o.id=Ul.text,r.sampleDuration=0,r.duration=a.duration=s}resetContiguity(){this.remainderData=null}static probe(t){return z1(t)}demux(t,e){this.timeOffset=e;let i=t;const s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Rt(this.remainderData,t));const o=ty(i);this.remainderData=o.remainder,s.samples=o.valid||new Uint8Array}else s.samples=i;const a=this.extractID3Track(s,e);return r.samples=Wl(e,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){const t=this.timeOffset,e=this.videoTrack,i=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;const s=this.extractID3Track(e,this.timeOffset);return i.samples=Wl(t,e),{videoTrack:e,audioTrack:ee(),id3Track:s,textTrack:ee()}}extractID3Track(t,e){const i=this.id3Track;if(t.samples.length){const s=W(t.samples,["emsg"]);s&&s.forEach(r=>{const a=sy(r);if(w0.test(a.schemeIdUri)){const o=$(a.presentationTime)?a.presentationTime/a.timeScale:e+a.presentationTimeDelta/a.timeScale;let l=a.eventDuration===4294967295?Number.POSITIVE_INFINITY:a.eventDuration/a.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const h=a.payload;i.samples.push({data:h,len:h.byteLength,dts:o,pts:o,type:kt.emsg,duration:l})}})}return i}demuxSampleAes(t,e,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}const Hh=(n,t)=>{let e=0,i=5;t+=i;const s=new Uint32Array(1),r=new Uint32Array(1),a=new Uint8Array(1);for(;i>0;){a[0]=n[t];const o=Math.min(i,8),l=8-o;r[0]=4278190080>>>24+l<<l,s[0]=(a[0]&r[0])>>l,e=e?e<<o|s[0]:s[0],t+=1,i-=o}return e};class A0 extends Gr{constructor(t){super(),this.observer=void 0,this.observer=t}resetInitSegment(t,e,i,s){super.resetInitSegment(t,e,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:e,duration:s,inputTimeScale:9e4,dropped:0}}canParse(t,e){return e+64<t.length}appendFrame(t,e,i){const s=Kh(t,e,i,this.basePTS,this.frameIndex);if(s!==-1)return{sample:t.samples[t.samples.length-1],length:s,missing:0}}static probe(t){if(!t)return!1;const e=xi(t,0);if(!e)return!1;const i=e.length;return t[i]===11&&t[i+1]===119&&Cr(e)!==void 0&&Hh(t,i)<16}}function Kh(n,t,e,i,s){if(e+8>t.length||t[e]!==11||t[e+1]!==119)return-1;const r=t[e+4]>>6;if(r>=3)return-1;const a=[48e3,44100,32e3][r],o=t[e+4]&63,l=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][o*3+r]*2;if(e+l>t.length)return-1;const h=t[e+6]>>5;let c=0;h===2?c+=2:(h&1&&h!==1&&(c+=2),h&4&&(c+=2));const u=(t[e+6]<<8|t[e+7])>>12-c&1,d=[2,1,2,3,3,4,4,5][h]+u,g=t[e+5]>>3,f=t[e+5]&7,p=new Uint8Array([r<<6|g<<1|f>>2,(f&3)<<6|h<<3|u<<2|o>>4,o<<4&224]),y=1536/a*9e4,v=i+s*y,E=t.subarray(e,e+l);return n.config=p,n.channelCount=d,n.samplerate=a,n.samples.push({unit:E,pts:v}),l}class R0{constructor(){this.VideoSample=null}createVideoSample(t,e,i,s){return{key:t,frame:!1,pts:e,dts:i,units:[],debug:s,length:0}}getLastNalUnit(t){var e;let i=this.VideoSample,s;if((!i||i.units.length===0)&&(i=t[t.length-1]),(e=i)!=null&&e.units){const r=i.units;s=r[r.length-1]}return s}pushAccessUnit(t,e){if(t.units.length&&t.frame){if(t.pts===void 0){const i=e.samples,s=i.length;if(s){const r=i[s-1];t.pts=r.pts,t.dts=r.dts}else{e.dropped++;return}}e.samples.push(t)}t.debug.length&&C.log(t.pts+"/"+t.dts+":"+t.debug)}}class Wh{constructor(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const t=this.data,e=this.bytesAvailable,i=t.byteLength-e,s=new Uint8Array(4),r=Math.min(4,e);if(r===0)throw new Error("no bytes available");s.set(t.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(t){let e;t=Math.min(t,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>t?(this.word<<=t,this.bitsAvailable-=t):(t-=this.bitsAvailable,e=t>>3,t-=e<<3,this.bytesAvailable-=e,this.loadWord(),this.word<<=t,this.bitsAvailable-=t)}readBits(t){let e=Math.min(this.bitsAvailable,t);const i=this.word>>>32-e;if(t>32&&C.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return e=t-e,e>0&&this.bitsAvailable?i<<e|this.readBits(e):i}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if((this.word&2147483648>>>t)!==0)return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const t=this.skipLZ();return this.readBits(t+1)-1}readEG(){const t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(t){let e=8,i=8,s;for(let r=0;r<t;r++)i!==0&&(s=this.readEG(),i=(e+s+256)%256),e=i===0?e:i}readSPS(){let t=0,e=0,i=0,s=0,r,a,o;const l=this.readUByte.bind(this),h=this.readBits.bind(this),c=this.readUEG.bind(this),u=this.readBoolean.bind(this),d=this.skipBits.bind(this),g=this.skipEG.bind(this),f=this.skipUEG.bind(this),p=this.skipScalingList.bind(this);l();const y=l();if(h(5),d(3),l(),f(),y===100||y===110||y===122||y===244||y===44||y===83||y===86||y===118||y===128){const w=c();if(w===3&&d(1),f(),f(),d(1),u())for(a=w!==3?8:12,o=0;o<a;o++)u()&&(o<6?p(16):p(64))}f();const v=c();if(v===0)c();else if(v===1)for(d(1),g(),g(),r=c(),o=0;o<r;o++)g();f(),d(1);const E=c(),_=c(),T=h(1);T===0&&d(1),d(1),u()&&(t=c(),e=c(),i=c(),s=c());let L=[1,1];if(u()&&u())switch(l()){case 1:L=[1,1];break;case 2:L=[12,11];break;case 3:L=[10,11];break;case 4:L=[16,11];break;case 5:L=[40,33];break;case 6:L=[24,11];break;case 7:L=[20,11];break;case 8:L=[32,11];break;case 9:L=[80,33];break;case 10:L=[18,11];break;case 11:L=[15,11];break;case 12:L=[64,33];break;case 13:L=[160,99];break;case 14:L=[4,3];break;case 15:L=[3,2];break;case 16:L=[2,1];break;case 255:{L=[l()<<8|l(),l()<<8|l()];break}}return{width:Math.ceil((E+1)*16-t*2-e*2),height:(2-T)*(_+1)*16-(T?2:4)*(i+s),pixelRatio:L}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class k0 extends R0{parseAVCPES(t,e,i,s,r){const a=this.parseAVCNALu(t,i.data);let o=this.VideoSample,l,h=!1;i.data=null,o&&a.length&&!t.audFound&&(this.pushAccessUnit(o,t),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),a.forEach(c=>{var u;switch(c.type){case 1:{let p=!1;l=!0;const y=c.data;if(h&&y.length>4){const v=new Wh(y).readSliceType();(v===2||v===4||v===7||v===9)&&(p=!0)}if(p){var d;(d=o)!=null&&d.frame&&!o.key&&(this.pushAccessUnit(o,t),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.frame=!0,o.key=p;break}case 5:l=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,t),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.key=!0,o.frame=!0;break;case 6:{l=!0,zl(c.data,1,i.pts,e.samples);break}case 7:{var g,f;l=!0,h=!0;const p=c.data,y=new Wh(p).readSPS();if(!t.sps||t.width!==y.width||t.height!==y.height||((g=t.pixelRatio)==null?void 0:g[0])!==y.pixelRatio[0]||((f=t.pixelRatio)==null?void 0:f[1])!==y.pixelRatio[1]){t.width=y.width,t.height=y.height,t.pixelRatio=y.pixelRatio,t.sps=[p],t.duration=r;const v=p.subarray(1,4);let E="avc1.";for(let _=0;_<3;_++){let T=v[_].toString(16);T.length<2&&(T="0"+T),E+=T}t.codec=E}break}case 8:l=!0,t.pps=[c.data];break;case 9:l=!0,t.audFound=!0,o&&this.pushAccessUnit(o,t),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:l=!0;break;default:l=!1,o&&(o.debug+="unknown NAL "+c.type+" ");break}o&&l&&o.units.push(c)}),s&&o&&(this.pushAccessUnit(o,t),this.VideoSample=null)}parseAVCNALu(t,e){const i=e.byteLength;let s=t.naluState||0;const r=s,a=[];let o=0,l,h,c,u=-1,d=0;for(s===-1&&(u=0,d=e[0]&31,s=0,o=1);o<i;){if(l=e[o++],!s){s=l?0:1;continue}if(s===1){s=l?0:2;continue}if(!l)s=3;else if(l===1){if(h=o-s-1,u>=0){const g={data:e.subarray(u,h),type:d};a.push(g)}else{const g=this.getLastNalUnit(t.samples);g&&(r&&o<=4-r&&g.state&&(g.data=g.data.subarray(0,g.data.byteLength-r)),h>0&&(g.data=Rt(g.data,e.subarray(0,h)),g.state=0))}o<i?(c=e[o]&31,u=o,d=c,s=0):s=-1}else s=0}if(u>=0&&s>=0){const g={data:e.subarray(u,i),type:d,state:s};a.push(g)}if(a.length===0){const g=this.getLastNalUnit(t.samples);g&&(g.data=Rt(g.data,e))}return t.naluState=s,a}}class D0{constructor(t,e,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Br(e,{removePKCS7Padding:!1})}decryptBuffer(t){return this.decrypter.decrypt(t,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(t,e,i){const s=t[e].unit;if(s.length<=16)return;const r=s.subarray(16,s.length-s.length%16),a=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(a).then(o=>{const l=new Uint8Array(o);s.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(t,e+1,i)})}decryptAacSamples(t,e,i){for(;;e++){if(e>=t.length){i();return}if(!(t[e].unit.length<32)&&(this.decryptAacSample(t,e,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(t){const e=Math.floor((t.length-48)/160)*16+16,i=new Int8Array(e);let s=0;for(let r=32;r<t.length-16;r+=160,s+=16)i.set(t.subarray(r,r+16),s);return i}getAvcDecryptedUnit(t,e){const i=new Uint8Array(e);let s=0;for(let r=32;r<t.length-16;r+=160,s+=16)t.set(i.subarray(s,s+16),r);return t}decryptAvcSample(t,e,i,s,r){const a=Yl(r.data),o=this.getAvcEncryptedData(a);this.decryptBuffer(o.buffer).then(l=>{r.data=this.getAvcDecryptedUnit(a,l),this.decrypter.isSync()||this.decryptAvcSamples(t,e,i+1,s)})}decryptAvcSamples(t,e,i,s){if(t instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;e++,i=0){if(e>=t.length){s();return}const r=t[e].units;for(;!(i>=r.length);i++){const a=r[i];if(!(a.data.length<=48||a.type!==1&&a.type!==5)&&(this.decryptAvcSample(t,e,i,s,a),!this.decrypter.isSync()))return}}}}const Tt=188;class ge{constructor(t,e,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.videoParser=new k0}static probe(t){const e=ge.syncOffset(t);return e>0&&C.warn(`MPEG2-TS detected but first sync word found @ offset ${e}`),e!==-1}static syncOffset(t){const e=t.length;let i=Math.min(Tt*5,e-Tt)+1,s=0;for(;s<i;){let r=!1,a=-1,o=0;for(let l=s;l<e;l+=Tt)if(t[l]===71&&(e-l===Tt||t[l+Tt]===71)){if(o++,a===-1&&(a=l,a!==0&&(i=Math.min(a+Tt*99,t.length-Tt)+1)),r||(r=Kr(t,l)===0),r&&o>1&&(a===0&&o>2||l+Tt>i))return a}else{if(o)return-1;break}s++}return-1}static createTrack(t,e){return{container:t==="video"||t==="audio"?"video/mp2t":void 0,type:t,id:Ul[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:t==="audio"?e:void 0}}resetInitSegment(t,e,i,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=ge.createTrack("video"),this._audioTrack=ge.createTrack("audio",s),this._id3Track=ge.createTrack("id3"),this._txtTrack=ge.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=i,this._duration=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:t,_videoTrack:e,_id3Track:i}=this;t&&(t.pesData=null),e&&(e.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(t,e,i=!1,s=!1){i||(this.sampleAes=null);let r;const a=this._videoTrack,o=this._audioTrack,l=this._id3Track,h=this._txtTrack;let c=a.pid,u=a.pesData,d=o.pid,g=l.pid,f=o.pesData,p=l.pesData,y=null,v=this.pmtParsed,E=this._pmtId,_=t.length;if(this.remainderData&&(t=Rt(this.remainderData,t),_=t.length,this.remainderData=null),_<Tt&&!s)return this.remainderData=t,{audioTrack:o,videoTrack:a,id3Track:l,textTrack:h};const T=Math.max(0,ge.syncOffset(t));_-=(_-T)%Tt,_<t.byteLength&&!s&&(this.remainderData=new Uint8Array(t.buffer,_,t.buffer.byteLength-_));let L=0;for(let I=T;I<_;I+=Tt)if(t[I]===71){const D=!!(t[I+1]&64),P=Kr(t,I),R=(t[I+3]&48)>>4;let k;if(R>1){if(k=I+5+t[I+4],k===I+Tt)continue}else k=I+4;switch(P){case c:D&&(u&&(r=li(u))&&this.videoParser.parseAVCPES(a,h,r,!1,this._duration),u={data:[],size:0}),u&&(u.data.push(t.subarray(k,I+Tt)),u.size+=I+Tt-k);break;case d:if(D){if(f&&(r=li(f)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,r);break;case"mp3":this.parseMPEGPES(o,r);break;case"ac3":this.parseAC3PES(o,r);break}f={data:[],size:0}}f&&(f.data.push(t.subarray(k,I+Tt)),f.size+=I+Tt-k);break;case g:D&&(p&&(r=li(p))&&this.parseID3PES(l,r),p={data:[],size:0}),p&&(p.data.push(t.subarray(k,I+Tt)),p.size+=I+Tt-k);break;case 0:D&&(k+=t[k]+1),E=this._pmtId=P0(t,k);break;case E:{D&&(k+=t[k]+1);const Y=x0(t,k,this.typeSupported,i,this.observer);c=Y.videoPid,c>0&&(a.pid=c,a.segmentCodec=Y.segmentVideoCodec),d=Y.audioPid,d>0&&(o.pid=d,o.segmentCodec=Y.segmentAudioCodec),g=Y.id3Pid,g>0&&(l.pid=g),y!==null&&!v&&(C.warn(`MPEG-TS PMT found at ${I} after unknown PID '${y}'. Backtracking to sync byte @${T} to parse all TS packets.`),y=null,I=T-188),v=this.pmtParsed=!0;break}case 17:case 8191:break;default:y=P;break}}else L++;L>0&&qs(this.observer,new Error(`Found ${L} TS packet/s that do not start with 0x47`)),a.pesData=u,o.pesData=f,l.pesData=p;const w={audioTrack:o,videoTrack:a,id3Track:l,textTrack:h};return s&&this.extractRemainingSamples(w),w}flush(){const{remainderData:t}=this;this.remainderData=null;let e;return t?e=this.demux(t,-1,!1,!0):e={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e}extractRemainingSamples(t){const{audioTrack:e,videoTrack:i,id3Track:s,textTrack:r}=t,a=i.pesData,o=e.pesData,l=s.pesData;let h;if(a&&(h=li(a))?(this.videoParser.parseAVCPES(i,r,h,!0,this._duration),i.pesData=null):i.pesData=a,o&&(h=li(o))){switch(e.segmentCodec){case"aac":this.parseAACPES(e,h);break;case"mp3":this.parseMPEGPES(e,h);break;case"ac3":this.parseAC3PES(e,h);break}e.pesData=null}else o!=null&&o.size&&C.log("last AAC PES packet truncated,might overlap between fragments"),e.pesData=o;l&&(h=li(l))?(this.parseID3PES(s,h),s.pesData=null):s.pesData=l}demuxSampleAes(t,e,i){const s=this.demux(t,i,!0,!this.config.progressive),r=this.sampleAes=new D0(this.observer,this.config,e);return this.decrypt(s,r)}decrypt(t,e){return new Promise(i=>{const{audioTrack:s,videoTrack:r}=t;s.samples&&s.segmentCodec==="aac"?e.decryptAacSamples(s.samples,0,()=>{r.samples?e.decryptAvcSamples(r.samples,0,0,()=>{i(t)}):i(t)}):r.samples&&e.decryptAvcSamples(r.samples,0,0,()=>{i(t)})})}destroy(){this._duration=0}parseAACPES(t,e){let i=0;const s=this.aacOverFlow;let r=e.data;if(s){this.aacOverFlow=null;const u=s.missing,d=s.sample.unit.byteLength;if(u===-1)r=Rt(s.sample.unit,r);else{const g=d-u;s.sample.unit.set(r.subarray(0,u),g),t.samples.push(s.sample),i=s.missing}}let a,o;for(a=i,o=r.length;a<o-1&&!Ys(r,a);a++);if(a!==i){let u;const d=a<o-1;if(d?u=`AAC PES did not start with ADTS header,offset:${a}`:u="No ADTS header found in AAC PES",qs(this.observer,new Error(u),d),!d)return}$h(t,this.observer,r,a,this.audioCodec);let l;if(e.pts!==void 0)l=e.pts;else if(s){const u=Nh(t.samplerate);l=s.sample.pts+u}else{C.warn("[tsdemuxer]: AAC PES unknown PTS");return}let h=0,c;for(;a<o;)if(c=Fh(t,r,a,l,h),a+=c.length,c.missing){this.aacOverFlow=c;break}else for(h++;a<o-1&&!Ys(r,a);a++);}parseMPEGPES(t,e){const i=e.data,s=i.length;let r=0,a=0;const o=e.pts;if(o===void 0){C.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<s;)if(Gh(i,a)){const l=Uh(t,i,a,o,r);if(l)a+=l.length,r++;else break}else a++}parseAC3PES(t,e){{const i=e.data,s=e.pts;if(s===void 0){C.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let a=0,o=0,l;for(;o<r&&(l=Kh(t,i,o,s,a++))>0;)o+=l}}parseID3PES(t,e){if(e.pts===void 0){C.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=ot({},e,{type:this._videoTrack?kt.emsg:kt.audioId3,duration:Number.POSITIVE_INFINITY});t.samples.push(i)}}function Kr(n,t){return((n[t+1]&31)<<8)+n[t+2]}function P0(n,t){return(n[t+10]&31)<<8|n[t+11]}function x0(n,t,e,i,s){const r={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(n[t+1]&15)<<8|n[t+2],o=t+3+a-4,l=(n[t+10]&15)<<8|n[t+11];for(t+=12+l;t<o;){const h=Kr(n,t),c=(n[t+3]&15)<<8|n[t+4];switch(n[t]){case 207:if(!i){Wr("ADTS AAC");break}case 15:r.audioPid===-1&&(r.audioPid=h);break;case 21:r.id3Pid===-1&&(r.id3Pid=h);break;case 219:if(!i){Wr("H.264");break}case 27:r.videoPid===-1&&(r.videoPid=h,r.segmentVideoCodec="avc");break;case 3:case 4:!e.mpeg&&!e.mp3?C.log("MPEG audio found, not supported in this browser"):r.audioPid===-1&&(r.audioPid=h,r.segmentAudioCodec="mp3");break;case 193:if(!i){Wr("AC-3");break}case 129:e.ac3?r.audioPid===-1&&(r.audioPid=h,r.segmentAudioCodec="ac3"):C.log("AC-3 audio found, not supported in this browser");break;case 6:if(r.audioPid===-1&&c>0){let u=t+5,d=c;for(;d>2;){switch(n[u]){case 106:e.ac3!==!0?C.log("AC-3 audio found, not supported in this browser for now"):(r.audioPid=h,r.segmentAudioCodec="ac3");break}const g=n[u+1]+2;u+=g,d-=g}}break;case 194:case 135:return qs(s,new Error("Unsupported EC-3 in M2TS found")),r;case 36:return qs(s,new Error("Unsupported HEVC in M2TS found")),r}t+=c+5}return r}function qs(n,t,e){C.warn(`parsing error: ${t.message}`),n.emit(m.ERROR,m.ERROR,{type:G.MEDIA_ERROR,details:S.FRAG_PARSING_ERROR,fatal:!1,levelRetry:e,error:t,reason:t.message})}function Wr(n){C.log(`${n} with AES-128-CBC encryption found in unencrypted stream`)}function li(n){let t=0,e,i,s,r,a;const o=n.data;if(!n||n.size===0)return null;for(;o[0].length<19&&o.length>1;)o[0]=Rt(o[0],o[1]),o.splice(1,1);if(e=o[0],(e[0]<<16)+(e[1]<<8)+e[2]===1){if(i=(e[4]<<8)+e[5],i&&i>n.size-6)return null;const l=e[7];l&192&&(r=(e[9]&14)*536870912+(e[10]&255)*4194304+(e[11]&254)*16384+(e[12]&255)*128+(e[13]&254)/2,l&64?(a=(e[14]&14)*536870912+(e[15]&255)*4194304+(e[16]&254)*16384+(e[17]&255)*128+(e[18]&254)/2,r-a>60*9e4&&(C.warn(`${Math.round((r-a)/9e4)}s delta between PTS and DTS, align them`),r=a)):a=r),s=e[8];let h=s+9;if(n.size<=h)return null;n.size-=h;const c=new Uint8Array(n.size);for(let u=0,d=o.length;u<d;u++){e=o[u];let g=e.byteLength;if(h)if(h>g){h-=g;continue}else e=e.subarray(h),g-=h,h=0;c.set(e,t),t+=g}return i&&(i-=s+3),{data:c,pts:r,dts:a,len:i}}return null}class M0 extends Gr{resetInitSegment(t,e,i,s){super.resetInitSegment(t,e,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:e,duration:s,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=xi(t,0);let i=(e==null?void 0:e.length)||0;if(e&&t[i]===11&&t[i+1]===119&&Cr(e)!==void 0&&Hh(t,i)<=16)return!1;for(let s=t.length;i<s;i++)if(Vh(t,i))return C.log("MPEG Audio sync word found !"),!0;return!1}canParse(t,e){return b0(t,e)}appendFrame(t,e,i){if(this.basePTS!==null)return Uh(t,e,i,this.basePTS,this.frameIndex)}}class zh{static getSilentFrame(t,e){switch(t){case"mp4a.40.2":if(e===1)return new Uint8Array([0,200,0,128,35,128]);if(e===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(e===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(e===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(e===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(e===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(e===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(e===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(e===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const pe=Math.pow(2,32)-1;class b{static init(){b.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let t;for(t in b.types)b.types.hasOwnProperty(t)&&(b.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);const e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);b.HDLR_TYPES={video:e,audio:i};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);b.STTS=b.STSC=b.STCO=r,b.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),b.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),b.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),b.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const a=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);b.FTYP=b.box(b.types.ftyp,a,l,a,o),b.DINF=b.box(b.types.dinf,b.box(b.types.dref,s))}static box(t,...e){let i=8,s=e.length;const r=s;for(;s--;)i+=e[s].byteLength;const a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=i&255,a.set(t,4),s=0,i=8;s<r;s++)a.set(e[s],i),i+=e[s].byteLength;return a}static hdlr(t){return b.box(b.types.hdlr,b.HDLR_TYPES[t])}static mdat(t){return b.box(b.types.mdat,t)}static mdhd(t,e){e*=t;const i=Math.floor(e/(pe+1)),s=Math.floor(e%(pe+1));return b.box(b.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,85,196,0,0]))}static mdia(t){return b.box(b.types.mdia,b.mdhd(t.timescale,t.duration),b.hdlr(t.type),b.minf(t))}static mfhd(t){return b.box(b.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))}static minf(t){return t.type==="audio"?b.box(b.types.minf,b.box(b.types.smhd,b.SMHD),b.DINF,b.stbl(t)):b.box(b.types.minf,b.box(b.types.vmhd,b.VMHD),b.DINF,b.stbl(t))}static moof(t,e,i){return b.box(b.types.moof,b.mfhd(t),b.traf(i,e))}static moov(t){let e=t.length;const i=[];for(;e--;)i[e]=b.trak(t[e]);return b.box.apply(null,[b.types.moov,b.mvhd(t[0].timescale,t[0].duration)].concat(i).concat(b.mvex(t)))}static mvex(t){let e=t.length;const i=[];for(;e--;)i[e]=b.trex(t[e]);return b.box.apply(null,[b.types.mvex,...i])}static mvhd(t,e){e*=t;const i=Math.floor(e/(pe+1)),s=Math.floor(e%(pe+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return b.box(b.types.mvhd,r)}static sdtp(t){const e=t.samples||[],i=new Uint8Array(4+e.length);let s,r;for(s=0;s<e.length;s++)r=e[s].flags,i[s+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return b.box(b.types.sdtp,i)}static stbl(t){return b.box(b.types.stbl,b.stsd(t),b.box(b.types.stts,b.STTS),b.box(b.types.stsc,b.STSC),b.box(b.types.stsz,b.STSZ),b.box(b.types.stco,b.STCO))}static avc1(t){let e=[],i=[],s,r,a;for(s=0;s<t.sps.length;s++)r=t.sps[s],a=r.byteLength,e.push(a>>>8&255),e.push(a&255),e=e.concat(Array.prototype.slice.call(r));for(s=0;s<t.pps.length;s++)r=t.pps[s],a=r.byteLength,i.push(a>>>8&255),i.push(a&255),i=i.concat(Array.prototype.slice.call(r));const o=b.box(b.types.avcC,new Uint8Array([1,e[3],e[4],e[5],255,224|t.sps.length].concat(e).concat([t.pps.length]).concat(i))),l=t.width,h=t.height,c=t.pixelRatio[0],u=t.pixelRatio[1];return b.box(b.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,h>>8&255,h&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,b.box(b.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),b.box(b.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,c&255,u>>24,u>>16&255,u>>8&255,u&255])))}static esds(t){const e=t.config.length;return new Uint8Array([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([e]).concat(t.config).concat([6,1,2]))}static audioStsd(t){const e=t.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,e&255,0,0])}static mp4a(t){return b.box(b.types.mp4a,b.audioStsd(t),b.box(b.types.esds,b.esds(t)))}static mp3(t){return b.box(b.types[".mp3"],b.audioStsd(t))}static ac3(t){return b.box(b.types["ac-3"],b.audioStsd(t),b.box(b.types.dac3,t.config))}static stsd(t){return t.type==="audio"?t.segmentCodec==="mp3"&&t.codec==="mp3"?b.box(b.types.stsd,b.STSD,b.mp3(t)):t.segmentCodec==="ac3"?b.box(b.types.stsd,b.STSD,b.ac3(t)):b.box(b.types.stsd,b.STSD,b.mp4a(t)):b.box(b.types.stsd,b.STSD,b.avc1(t))}static tkhd(t){const e=t.id,i=t.duration*t.timescale,s=t.width,r=t.height,a=Math.floor(i/(pe+1)),o=Math.floor(i%(pe+1));return b.box(b.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,s&255,0,0,r>>8&255,r&255,0,0]))}static traf(t,e){const i=b.sdtp(t),s=t.id,r=Math.floor(e/(pe+1)),a=Math.floor(e%(pe+1));return b.box(b.types.traf,b.box(b.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255])),b.box(b.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,a>>24,a>>16&255,a>>8&255,a&255])),b.trun(t,i.length+16+20+8+16+8+8),i)}static trak(t){return t.duration=t.duration||4294967295,b.box(b.types.trak,b.tkhd(t),b.mdia(t))}static trex(t){const e=t.id;return b.box(b.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){const i=t.samples||[],s=i.length,r=12+16*s,a=new Uint8Array(r);let o,l,h,c,u,d;for(e+=8+r,a.set([t.type==="video"?1:0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,s&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255],0),o=0;o<s;o++)l=i[o],h=l.duration,c=l.size,u=l.flags,d=l.cts,a.set([h>>>24&255,h>>>16&255,h>>>8&255,h&255,c>>>24&255,c>>>16&255,c>>>8&255,c&255,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,u.degradPrio&61440,u.degradPrio&15,d>>>24&255,d>>>16&255,d>>>8&255,d&255],12+16*o);return b.box(b.types.trun,a)}static initSegment(t){b.types||b.init();const e=b.moov(t);return Rt(b.FTYP,e)}}b.types=void 0,b.HDLR_TYPES=void 0,b.STTS=void 0,b.STSC=void 0,b.STCO=void 0,b.STSZ=void 0,b.VMHD=void 0,b.SMHD=void 0,b.STSD=void 0,b.FTYP=void 0,b.DINF=void 0;const Yh=9e4;function zr(n,t,e=1,i=!1){const s=n*t*e;return i?Math.round(s):s}function O0(n,t,e=1,i=!1){return zr(n,t,1/e,i)}function $i(n,t=!1){return zr(n,1e3,1/Yh,t)}function $0(n,t=1){return zr(n,Yh,1/t)}const N0=10*1e3,jh=1024,F0=1152,U0=1536;let hi=null,Yr=null;class Zs{constructor(t,e,i,s=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.ISGenerated=!1,hi===null){const r=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);hi=r?parseInt(r[1]):0}if(Yr===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);Yr=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(t){C.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=t}resetNextTimestamp(){C.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){C.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(t){let e=!1;const i=t[0].pts,s=t.reduce((r,a)=>{let o=a.pts,l=o-r;return l<-4294967296&&(e=!0,o=Pt(o,i),l=o-r),l>0?r:o},i);return e&&C.debug("PTS rollover detected"),s}remux(t,e,i,s,r,a,o,l){let h,c,u,d,g,f,p=r,y=r;const v=t.pid>-1,E=e.pid>-1,_=e.samples.length,T=t.samples.length>0,L=o&&_>0||_>1;if((!v||T)&&(!E||L)||this.ISGenerated||o){if(this.ISGenerated){var w,I,D,P;const M=this.videoTrackConfig;M&&(e.width!==M.width||e.height!==M.height||((w=e.pixelRatio)==null?void 0:w[0])!==((I=M.pixelRatio)==null?void 0:I[0])||((D=e.pixelRatio)==null?void 0:D[1])!==((P=M.pixelRatio)==null?void 0:P[1]))&&this.resetInitSegment()}else u=this.generateIS(t,e,r,a);const R=this.isVideoContiguous;let k=-1,Y;if(L&&(k=B0(e.samples),!R&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,k>0){C.warn(`[mp4-remuxer]: Dropped ${k} out of ${_} video samples due to a missing keyframe`);const M=this.getVideoStartPts(e.samples);e.samples=e.samples.slice(k),e.dropped+=k,y+=(e.samples[0].pts-M)/e.inputTimeScale,Y=y}else k===-1&&(C.warn(`[mp4-remuxer]: No keyframe found out of ${_} video samples`),f=!1);if(this.ISGenerated){if(T&&L){const M=this.getVideoStartPts(e.samples),j=(Pt(t.samples[0].pts,M)-M)/e.inputTimeScale;p+=Math.max(0,j),y+=Math.max(0,-j)}if(T){if(t.samplerate||(C.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),u=this.generateIS(t,e,r,a)),c=this.remuxAudio(t,p,this.isAudioContiguous,a,E||L||l===U.AUDIO?y:void 0),L){const M=c?c.endPTS-c.startPTS:0;e.inputTimeScale||(C.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),u=this.generateIS(t,e,r,a)),h=this.remuxVideo(e,y,R,M)}}else L&&(h=this.remuxVideo(e,y,R,0));h&&(h.firstKeyFrame=k,h.independent=k!==-1,h.firstKeyFramePTS=Y)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(g=qh(i,r,this._initPTS,this._initDTS)),s.samples.length&&(d=Zh(s,r,this._initPTS))),{audio:c,video:h,initSegment:u,independent:f,text:d,id3:g}}generateIS(t,e,i,s){const r=t.samples,a=e.samples,o=this.typeSupported,l={},h=this._initPTS;let c=!h||s,u="audio/mp4",d,g,f;if(c&&(d=g=1/0),t.config&&r.length){switch(t.timescale=t.samplerate,t.segmentCodec){case"mp3":o.mpeg?(u="audio/mpeg",t.codec=""):o.mp3&&(t.codec="mp3");break;case"ac3":t.codec="ac-3";break}l.audio={id:"audio",container:u,codec:t.codec,initSegment:t.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):b.initSegment([t]),metadata:{channelCount:t.channelCount}},c&&(f=t.inputTimeScale,!h||f!==h.timescale?d=g=r[0].pts-Math.round(f*i):c=!1)}if(e.sps&&e.pps&&a.length){if(e.timescale=e.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:b.initSegment([e]),metadata:{width:e.width,height:e.height}},c)if(f=e.inputTimeScale,!h||f!==h.timescale){const p=this.getVideoStartPts(a),y=Math.round(f*i);g=Math.min(g,Pt(a[0].dts,p)-y),d=Math.min(d,p-y)}else c=!1;this.videoTrackConfig={width:e.width,height:e.height,pixelRatio:e.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,c?(this._initPTS={baseTime:d,timescale:f},this._initDTS={baseTime:g,timescale:f}):d=f=void 0,{tracks:l,initPTS:d,timescale:f}}remuxVideo(t,e,i,s){const r=t.inputTimeScale,a=t.samples,o=[],l=a.length,h=this._initPTS;let c=this.nextAvcDts,u=8,d=this.videoSampleDuration,g,f,p=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY,v=!1;if(!i||c===null){const x=e*r,N=a[0].pts-Pt(a[0].dts,a[0].pts);hi&&c!==null&&Math.abs(x-N-c)<15e3?i=!0:c=x-N}const E=h.baseTime*r/h.timescale;for(let x=0;x<l;x++){const N=a[x];N.pts=Pt(N.pts-E,c),N.dts=Pt(N.dts-E,c),N.dts<a[x>0?x-1:x].dts&&(v=!0)}v&&a.sort(function(x,N){const J=x.dts-N.dts,K=x.pts-N.pts;return J||K}),g=a[0].dts,f=a[a.length-1].dts;const _=f-g,T=_?Math.round(_/(l-1)):d||t.inputTimeScale/30;if(i){const x=g-c,N=x>T,J=x<-1;if((N||J)&&(N?C.warn(`AVC: ${$i(x,!0)} ms (${x}dts) hole between fragments detected at ${e.toFixed(3)}`):C.warn(`AVC: ${$i(-x,!0)} ms (${x}dts) overlapping between fragments detected at ${e.toFixed(3)}`),!J||c>=a[0].pts||hi)){g=c;const K=a[0].pts-x;if(N)a[0].dts=g,a[0].pts=K;else for(let q=0;q<a.length&&!(a[q].dts>K);q++)a[q].dts-=x,a[q].pts-=x;C.log(`Video: Initial PTS/DTS adjusted: ${$i(K,!0)}/${$i(g,!0)}, delta: ${$i(x,!0)} ms`)}}g=Math.max(0,g);let L=0,w=0,I=g;for(let x=0;x<l;x++){const N=a[x],J=N.units,K=J.length;let q=0;for(let lt=0;lt<K;lt++)q+=J[lt].data.length;w+=q,L+=K,N.length=q,N.dts<I?(N.dts=I,I+=T/4|0||1):I=N.dts,p=Math.min(N.pts,p),y=Math.max(N.pts,y)}f=a[l-1].dts;const D=w+4*L+8;let P;try{P=new Uint8Array(D)}catch(x){this.observer.emit(m.ERROR,m.ERROR,{type:G.MUX_ERROR,details:S.REMUX_ALLOC_ERROR,fatal:!1,error:x,bytes:D,reason:`fail allocating video mdat ${D}`});return}const R=new DataView(P.buffer);R.setUint32(0,D),P.set(b.types.mdat,4);let k=!1,Y=Number.POSITIVE_INFINITY,M=Number.POSITIVE_INFINITY,j=Number.NEGATIVE_INFINITY,F=Number.NEGATIVE_INFINITY;for(let x=0;x<l;x++){const N=a[x],J=N.units;let K=0;for(let ft=0,gt=J.length;ft<gt;ft++){const It=J[ft],Gt=It.data,ga=It.data.byteLength;R.setUint32(u,ga),u+=4,P.set(Gt,u),u+=ga,K+=4+ga}let q;if(x<l-1)d=a[x+1].dts-N.dts,q=a[x+1].pts-N.pts;else{const ft=this.config,gt=x>0?N.dts-a[x-1].dts:T;if(q=x>0?N.pts-a[x-1].pts:T,ft.stretchShortVideoTrack&&this.nextAudioPts!==null){const It=Math.floor(ft.maxBufferHole*r),Gt=(s?p+s*r:this.nextAudioPts)-N.pts;Gt>It?(d=Gt-gt,d<0?d=gt:k=!0,C.log(`[mp4-remuxer]: It is approximately ${Gt/90} ms to the next segment; using duration ${d/90} ms for the last video frame.`)):d=gt}else d=gt}const lt=Math.round(N.pts-N.dts);Y=Math.min(Y,d),j=Math.max(j,d),M=Math.min(M,q),F=Math.max(F,q),o.push(new Qh(N.key,d,K,lt))}if(o.length){if(hi){if(hi<70){const x=o[0].flags;x.dependsOn=2,x.isNonSync=0}}else if(Yr&&F-M<j-Y&&T/j<.025&&o[0].cts===0){C.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let x=g;for(let N=0,J=o.length;N<J;N++){const K=x+o[N].duration,q=x+o[N].cts;if(N<J-1){const lt=K+o[N+1].cts;o[N].duration=lt-q}else o[N].duration=N?o[N-1].duration:T;o[N].cts=0,x=K}}}d=k||!d?T:d,this.nextAvcDts=c=f+d,this.videoSampleDuration=d,this.isVideoContiguous=!0;const H={data1:b.moof(t.sequenceNumber++,g,ot({},t,{samples:o})),data2:P,startPTS:p/r,endPTS:(y+d)/r,startDTS:g/r,endDTS:c/r,type:"video",hasAudio:!1,hasVideo:!0,nb:o.length,dropped:t.dropped};return t.samples=[],t.dropped=0,H}getSamplesPerFrame(t){switch(t.segmentCodec){case"mp3":return F0;case"ac3":return U0;default:return jh}}remuxAudio(t,e,i,s,r){const a=t.inputTimeScale,o=t.samplerate?t.samplerate:a,l=a/o,h=this.getSamplesPerFrame(t),c=h*l,u=this._initPTS,d=t.segmentCodec==="mp3"&&this.typeSupported.mpeg,g=[],f=r!==void 0;let p=t.samples,y=d?0:8,v=this.nextAudioPts||-1;const E=e*a,_=u.baseTime*a/u.timescale;if(this.isAudioContiguous=i=i||p.length&&v>0&&(s&&Math.abs(E-v)<9e3||Math.abs(Pt(p[0].pts-_,E)-v)<20*c),p.forEach(function(F){F.pts=Pt(F.pts-_,E)}),!i||v<0){if(p=p.filter(F=>F.pts>=0),!p.length)return;r===0?v=0:s&&!f?v=Math.max(0,E):v=p[0].pts}if(t.segmentCodec==="aac"){const F=this.config.maxAudioFramesDrift;for(let H=0,x=v;H<p.length;H++){const N=p[H],J=N.pts,K=J-x,q=Math.abs(1e3*K/a);if(K<=-F*c&&f)H===0&&(C.warn(`Audio frame @ ${(J/a).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*K/a)} ms.`),this.nextAudioPts=v=x=J);else if(K>=F*c&&q<N0&&f){let lt=Math.round(K/c);x=J-lt*c,x<0&&(lt--,x+=c),H===0&&(this.nextAudioPts=v=x),C.warn(`[mp4-remuxer]: Injecting ${lt} audio frame @ ${(x/a).toFixed(3)}s due to ${Math.round(1e3*K/a)} ms gap.`);for(let ft=0;ft<lt;ft++){const gt=Math.max(x,0);let It=zh.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);It||(C.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),It=N.unit.subarray()),p.splice(H,0,{unit:It,pts:gt}),x+=c,H++}}N.pts=x,x+=c}}let T=null,L=null,w,I=0,D=p.length;for(;D--;)I+=p[D].unit.byteLength;for(let F=0,H=p.length;F<H;F++){const x=p[F],N=x.unit;let J=x.pts;if(L!==null){const q=g[F-1];q.duration=Math.round((J-L)/l)}else if(i&&t.segmentCodec==="aac"&&(J=v),T=J,I>0){I+=y;try{w=new Uint8Array(I)}catch(q){this.observer.emit(m.ERROR,m.ERROR,{type:G.MUX_ERROR,details:S.REMUX_ALLOC_ERROR,fatal:!1,error:q,bytes:I,reason:`fail allocating audio mdat ${I}`});return}d||(new DataView(w.buffer).setUint32(0,I),w.set(b.types.mdat,4))}else return;w.set(N,y);const K=N.byteLength;y+=K,g.push(new Qh(!0,h,K,0)),L=J}const P=g.length;if(!P)return;const R=g[g.length-1];this.nextAudioPts=v=L+l*R.duration;const k=d?new Uint8Array(0):b.moof(t.sequenceNumber++,T/l,ot({},t,{samples:g}));t.samples=[];const Y=T/a,M=v/a,j={data1:k,data2:w,startPTS:Y,endPTS:M,startDTS:Y,endDTS:M,type:"audio",hasAudio:!0,hasVideo:!1,nb:P};return this.isAudioContiguous=!0,j}remuxEmptyAudio(t,e,i,s){const r=t.inputTimeScale,a=t.samplerate?t.samplerate:r,o=r/a,l=this.nextAudioPts,h=this._initDTS,c=h.baseTime*9e4/h.timescale,u=(l!==null?l:s.startDTS*r)+c,d=s.endDTS*r+c,g=o*jh,f=Math.ceil((d-u)/g),p=zh.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);if(C.warn("[mp4-remuxer]: remux empty Audio"),!p){C.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}const y=[];for(let v=0;v<f;v++){const E=u+v*g;y.push({unit:p,pts:E,dts:E})}return t.samples=y,this.remuxAudio(t,e,i,!1)}}function Pt(n,t){let e;if(t===null)return n;for(t<n?e=-8589934592:e=8589934592;Math.abs(n-t)>4294967296;)n+=e;return n}function B0(n){for(let t=0;t<n.length;t++)if(n[t].key)return t;return-1}function qh(n,t,e,i){const s=n.samples.length;if(!s)return;const r=n.inputTimeScale;for(let o=0;o<s;o++){const l=n.samples[o];l.pts=Pt(l.pts-e.baseTime*r/e.timescale,t*r)/r,l.dts=Pt(l.dts-i.baseTime*r/i.timescale,t*r)/r}const a=n.samples;return n.samples=[],{samples:a}}function Zh(n,t,e){const i=n.samples.length;if(!i)return;const s=n.inputTimeScale;for(let a=0;a<i;a++){const o=n.samples[a];o.pts=Pt(o.pts-e.baseTime*s/e.timescale,t*s)/s}n.samples.sort((a,o)=>a.pts-o.pts);const r=n.samples;return n.samples=[],{samples:r}}class Qh{constructor(t,e,i,s){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=e,this.size=i,this.cts=s,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:t?2:1,isNonSync:t?0:1}}}class G0{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(t){this.initPTS=t,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(t,e,i,s){this.audioCodec=e,this.videoCodec=i,this.generateInitSegment(q1(t,s)),this.emitInitSegment=!0}generateInitSegment(t){let{audioCodec:e,videoCodec:i}=this;if(!(t!=null&&t.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const s=this.initData=Hl(t);s.audio&&(e=Xh(s.audio,tt.AUDIO)),s.video&&(i=Xh(s.video,tt.VIDEO));const r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:e+","+i,initSegment:t,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:e,initSegment:t,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,initSegment:t,id:"main"}:C.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(t,e,i,s,r,a){var o,l;let{initPTS:h,lastEndTime:c}=this;const u={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};$(c)||(c=this.lastEndTime=r||0);const d=e.samples;if(!(d!=null&&d.length))return u;const g={initPTS:void 0,timescale:1};let f=this.initData;if((o=f)!=null&&o.length||(this.generateInitSegment(d),f=this.initData),!((l=f)!=null&&l.length))return C.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),u;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);const p=Q1(d,f),y=Z1(f,d),v=y===null?r:y;(V0(h,v,r,p)||g.timescale!==h.timescale&&a)&&(g.initPTS=v-r,h&&h.timescale===1&&C.warn(`Adjusting initPTS by ${g.initPTS-h.baseTime}`),this.initPTS=h={baseTime:g.initPTS,timescale:1});const E=t?v-h.baseTime/h.timescale:c,_=E+p;J1(f,d,h.baseTime/h.timescale),p>0?this.lastEndTime=_:(C.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const T=!!f.audio,L=!!f.video;let w="";T&&(w+="audio"),L&&(w+="video");const I={data1:d,startPTS:E,startDTS:E,endPTS:_,endDTS:_,type:w,hasAudio:T,hasVideo:L,nb:1,dropped:0};return u.audio=I.type==="audio"?I:void 0,u.video=I.type!=="audio"?I:void 0,u.initSegment=g,u.id3=qh(i,r,h,h),s.samples.length&&(u.text=Zh(s,r,h)),u}}function V0(n,t,e,i){if(n===null)return!0;const s=Math.max(i,1),r=t-n.baseTime/n.timescale;return Math.abs(r-e)>s}function Xh(n,t){const e=n==null?void 0:n.codec;if(e&&e.length>4)return e;if(t===tt.AUDIO){if(e==="ec-3"||e==="ac-3"||e==="alac")return e;if(e==="fLaC"||e==="Opus")return xs(e,!1);const i="mp4a.40.5";return C.info(`Parsed audio codec "${e}" or audio object type not handled. Using "${i}"`),i}return C.warn(`Unhandled video codec "${e}"`),e==="hvc1"||e==="hev1"?"hvc1.1.6.L120.90":e==="av01"?"av01.0.04M.08":"avc1.42e01e"}let le;try{le=self.performance.now.bind(self.performance)}catch{C.debug("Unable to use Performance API on this environment"),le=si==null?void 0:si.Date.now}const Qs=[{demux:I0,remux:G0},{demux:ge,remux:Zs},{demux:S0,remux:Zs},{demux:M0,remux:Zs}];Qs.splice(2,0,{demux:A0,remux:Zs});class Jh{constructor(t,e,i,s,r){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=i,this.vendor=s,this.id=r}configure(t){this.transmuxConfig=t,this.decrypter&&this.decrypter.reset()}push(t,e,i,s){const r=i.transmuxing;r.executeStart=le();let a=new Uint8Array(t);const{currentTransmuxState:o,transmuxConfig:l}=this;s&&(this.currentTransmuxState=s);const{contiguous:h,discontinuity:c,trackSwitch:u,accurateTimeOffset:d,timeOffset:g,initSegmentChange:f}=s||o,{audioCodec:p,videoCodec:y,defaultInitPts:v,duration:E,initSegmentData:_}=l,T=H0(a,e);if(T&&T.method==="AES-128"){const D=this.getDecrypter();if(D.isSync()){let P=D.softwareDecrypt(a,T.key.buffer,T.iv.buffer);if(i.part>-1&&(P=D.flush()),!P)return r.executeEnd=le(),jr(i);a=new Uint8Array(P)}else return this.decryptionPromise=D.webCryptoDecrypt(a,T.key.buffer,T.iv.buffer).then(P=>{const R=this.push(P,null,i);return this.decryptionPromise=null,R}),this.decryptionPromise}const L=this.needsProbing(c,u);if(L){const D=this.configureTransmuxer(a);if(D)return C.warn(`[transmuxer] ${D.message}`),this.observer.emit(m.ERROR,m.ERROR,{type:G.MEDIA_ERROR,details:S.FRAG_PARSING_ERROR,fatal:!1,error:D,reason:D.message}),r.executeEnd=le(),jr(i)}(c||u||f||L)&&this.resetInitSegment(_,p,y,E,e),(c||f||L)&&this.resetInitialTimestamp(v),h||this.resetContiguity();const w=this.transmux(a,T,g,d,i),I=this.currentTransmuxState;return I.contiguous=!0,I.discontinuity=!1,I.trackSwitch=!1,r.executeEnd=le(),w}flush(t){const e=t.transmuxing;e.executeStart=le();const{decrypter:i,currentTransmuxState:s,decryptionPromise:r}=this;if(r)return r.then(()=>this.flush(t));const a=[],{timeOffset:o}=s;if(i){const u=i.flush();u&&a.push(this.push(u,null,t))}const{demuxer:l,remuxer:h}=this;if(!l||!h)return e.executeEnd=le(),[jr(t)];const c=l.flush(o);return Xs(c)?c.then(u=>(this.flushRemux(a,u,t),a)):(this.flushRemux(a,c,t),a)}flushRemux(t,e,i){const{audioTrack:s,videoTrack:r,id3Track:a,textTrack:o}=e,{accurateTimeOffset:l,timeOffset:h}=this.currentTransmuxState;C.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const c=this.remuxer.remux(s,r,a,o,h,l,!0,this.id);t.push({remuxResult:c,chunkMeta:i}),i.transmuxing.executeEnd=le()}resetInitialTimestamp(t){const{demuxer:e,remuxer:i}=this;!e||!i||(e.resetTimeStamp(t),i.resetTimeStamp(t))}resetContiguity(){const{demuxer:t,remuxer:e}=this;!t||!e||(t.resetContiguity(),e.resetNextTimestamp())}resetInitSegment(t,e,i,s,r){const{demuxer:a,remuxer:o}=this;!a||!o||(a.resetInitSegment(t,e,i,s),o.resetInitSegment(t,e,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(t,e,i,s,r){let a;return e&&e.method==="SAMPLE-AES"?a=this.transmuxSampleAes(t,e,i,s,r):a=this.transmuxUnencrypted(t,i,s,r),a}transmuxUnencrypted(t,e,i,s){const{audioTrack:r,videoTrack:a,id3Track:o,textTrack:l}=this.demuxer.demux(t,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,a,o,l,e,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(t,e,i,s,r){return this.demuxer.demuxSampleAes(t,e,i).then(a=>({remuxResult:this.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(t){const{config:e,observer:i,typeSupported:s,vendor:r}=this;let a;for(let d=0,g=Qs.length;d<g;d++){var o;if((o=Qs[d].demux)!=null&&o.probe(t)){a=Qs[d];break}}if(!a)return new Error("Failed to find demuxer by probing fragment data");const l=this.demuxer,h=this.remuxer,c=a.remux,u=a.demux;(!h||!(h instanceof c))&&(this.remuxer=new c(i,e,s,r)),(!l||!(l instanceof u))&&(this.demuxer=new u(i,e,s),this.probe=u.probe)}needsProbing(t,e){return!this.demuxer||!this.remuxer||t||e}getDecrypter(){let t=this.decrypter;return t||(t=this.decrypter=new Br(this.config)),t}}function H0(n,t){let e=null;return n.byteLength>0&&(t==null?void 0:t.key)!=null&&t.iv!==null&&t.method!=null&&(e=t),e}const jr=n=>({remuxResult:{},chunkMeta:n});function Xs(n){return"then"in n&&n.then instanceof Function}class K0{constructor(t,e,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=e,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}}class W0{constructor(t,e,i,s,r,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=e,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=a}}var tc={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,e="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(e=!1));function s(l,h,c){this.fn=l,this.context=h,this.once=c||!1}function r(l,h,c,u,d){if(typeof c!="function")throw new TypeError("The listener must be a function");var g=new s(c,u||l,d),f=e?e+h:h;return l._events[f]?l._events[f].fn?l._events[f]=[l._events[f],g]:l._events[f].push(g):(l._events[f]=g,l._eventsCount++),l}function a(l,h){--l._eventsCount===0?l._events=new i:delete l._events[h]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],h,c;if(this._eventsCount===0)return l;for(c in h=this._events)t.call(h,c)&&l.push(e?c.slice(1):c);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},o.prototype.listeners=function(l){var h=e?e+l:l,c=this._events[h];if(!c)return[];if(c.fn)return[c.fn];for(var u=0,d=c.length,g=new Array(d);u<d;u++)g[u]=c[u].fn;return g},o.prototype.listenerCount=function(l){var h=e?e+l:l,c=this._events[h];return c?c.fn?1:c.length:0},o.prototype.emit=function(l,h,c,u,d,g){var f=e?e+l:l;if(!this._events[f])return!1;var p=this._events[f],y=arguments.length,v,E;if(p.fn){switch(p.once&&this.removeListener(l,p.fn,void 0,!0),y){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,h),!0;case 3:return p.fn.call(p.context,h,c),!0;case 4:return p.fn.call(p.context,h,c,u),!0;case 5:return p.fn.call(p.context,h,c,u,d),!0;case 6:return p.fn.call(p.context,h,c,u,d,g),!0}for(E=1,v=new Array(y-1);E<y;E++)v[E-1]=arguments[E];p.fn.apply(p.context,v)}else{var _=p.length,T;for(E=0;E<_;E++)switch(p[E].once&&this.removeListener(l,p[E].fn,void 0,!0),y){case 1:p[E].fn.call(p[E].context);break;case 2:p[E].fn.call(p[E].context,h);break;case 3:p[E].fn.call(p[E].context,h,c);break;case 4:p[E].fn.call(p[E].context,h,c,u);break;default:if(!v)for(T=1,v=new Array(y-1);T<y;T++)v[T-1]=arguments[T];p[E].fn.apply(p[E].context,v)}}return!0},o.prototype.on=function(l,h,c){return r(this,l,h,c,!1)},o.prototype.once=function(l,h,c){return r(this,l,h,c,!0)},o.prototype.removeListener=function(l,h,c,u){var d=e?e+l:l;if(!this._events[d])return this;if(!h)return a(this,d),this;var g=this._events[d];if(g.fn)g.fn===h&&(!u||g.once)&&(!c||g.context===c)&&a(this,d);else{for(var f=0,p=[],y=g.length;f<y;f++)(g[f].fn!==h||u&&!g[f].once||c&&g[f].context!==c)&&p.push(g[f]);p.length?this._events[d]=p.length===1?p[0]:p:a(this,d)}return this},o.prototype.removeAllListeners=function(l){var h;return l?(h=e?e+l:l,this._events[h]&&a(this,h)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=e,o.EventEmitter=o,n.exports=o})(tc);var z0=tc.exports,qr=E1(z0);class ec{constructor(t,e,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const r=t.config;this.hls=t,this.id=e,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;const a=(h,c)=>{c=c||{},c.frag=this.frag,c.id=this.id,h===m.ERROR&&(this.error=c.error),this.hls.trigger(h,c)};this.observer=new qr,this.observer.on(m.FRAG_DECRYPTED,a),this.observer.on(m.ERROR,a);const o=fe(r.preferManagedMediaSource)||{isTypeSupported:()=>!1},l={mpeg:o.isTypeSupported("audio/mpeg"),mp3:o.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:o.isTypeSupported('audio/mp4; codecs="ac-3"')};if(this.useWorker&&typeof Worker<"u"&&(r.workerPath||u0())){try{r.workerPath?(C.log(`loading Web Worker ${r.workerPath} for "${e}"`),this.workerContext=f0(r.workerPath)):(C.log(`injecting Web Worker for "${e}"`),this.workerContext=d0()),this.onwmsg=c=>this.onWorkerMessage(c);const{worker:h}=this.workerContext;h.addEventListener("message",this.onwmsg),h.onerror=c=>{const u=new Error(`${c.message}  (${c.filename}:${c.lineno})`);r.enableWorker=!1,C.warn(`Error in "${e}" Web Worker, fallback to inline`),this.hls.trigger(m.ERROR,{type:G.OTHER_ERROR,details:S.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:u})},h.postMessage({cmd:"init",typeSupported:l,vendor:"",id:e,config:JSON.stringify(r)})}catch(h){C.warn(`Error setting up "${e}" Web Worker, fallback to inline`,h),this.resetWorker(),this.error=null,this.transmuxer=new Jh(this.observer,l,r,"",e)}return}this.transmuxer=new Jh(this.observer,l,r,"",e)}resetWorker(){if(this.workerContext){const{worker:t,objectURL:e}=this.workerContext;e&&self.URL.revokeObjectURL(e),t.removeEventListener("message",this.onwmsg),t.onerror=null,t.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(t,e,i,s,r,a,o,l,h,c){var u,d;h.transmuxing.start=self.performance.now();const{transmuxer:g}=this,f=a?a.start:r.start,p=r.decryptdata,y=this.frag,v=!(y&&r.cc===y.cc),E=!(y&&h.level===y.level),_=y?h.sn-y.sn:-1,T=this.part?h.part-this.part.index:-1,L=_===0&&h.id>1&&h.id===(y==null?void 0:y.stats.chunkCount),w=!E&&(_===1||_===0&&(T===1||L&&T<=0)),I=self.performance.now();(E||_||r.stats.parsing.start===0)&&(r.stats.parsing.start=I),a&&(T||!w)&&(a.stats.parsing.start=I);const D=!(y&&((u=r.initSegment)==null?void 0:u.url)===((d=y.initSegment)==null?void 0:d.url)),P=new W0(v,w,l,E,f,D);if(!w||v||D){C.log(`[transmuxer-interface, ${r.type}]: Starting new transmux session for sn: ${h.sn} p: ${h.part} level: ${h.level} id: ${h.id}
        discontinuity: ${v}
        trackSwitch: ${E}
        contiguous: ${w}
        accurateTimeOffset: ${l}
        timeOffset: ${f}
        initSegmentChange: ${D}`);const R=new K0(i,s,e,o,c);this.configureTransmuxer(R)}if(this.frag=r,this.part=a,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:t,decryptdata:p,chunkMeta:h,state:P},t instanceof ArrayBuffer?[t]:[]);else if(g){const R=g.push(t,p,h,P);Xs(R)?(g.async=!0,R.then(k=>{this.handleTransmuxComplete(k)}).catch(k=>{this.transmuxerError(k,h,"transmuxer-interface push error")})):(g.async=!1,this.handleTransmuxComplete(R))}}flush(t){t.transmuxing.start=self.performance.now();const{transmuxer:e}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:t});else if(e){let i=e.flush(t);Xs(i)||e.async?(Xs(i)||(i=Promise.resolve(i)),i.then(s=>{this.handleFlushResult(s,t)}).catch(s=>{this.transmuxerError(s,t,"transmuxer-interface flush error")})):this.handleFlushResult(i,t)}}transmuxerError(t,e,i){this.hls&&(this.error=t,this.hls.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.FRAG_PARSING_ERROR,chunkMeta:e,frag:this.frag||void 0,fatal:!1,error:t,err:t,reason:i}))}handleFlushResult(t,e){t.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(e)}onWorkerMessage(t){const e=t.data;if(!(e!=null&&e.event)){C.warn(`worker message received with no ${e?"event name":"data"}`);return}const i=this.hls;if(this.hls)switch(e.event){case"init":{var s;const r=(s=this.workerContext)==null?void 0:s.objectURL;r&&self.URL.revokeObjectURL(r);break}case"transmuxComplete":{this.handleTransmuxComplete(e.data);break}case"flush":{this.onFlush(e.data);break}case"workerLog":C[e.data.logType]&&C[e.data.logType](e.data.message);break;default:{e.data=e.data||{},e.data.frag=this.frag,e.data.id=this.id,i.trigger(e.event,e.data);break}}}configureTransmuxer(t){const{transmuxer:e}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:t}):e&&e.configure(t)}handleTransmuxComplete(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)}}const ic=100;class sc extends zs{constructor(t,e,i){super(t,e,i,"[audio-stream-controller]",U.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:t}=this;t.on(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.LEVEL_LOADED,this.onLevelLoaded,this),t.on(m.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(m.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(m.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(m.ERROR,this.onError,this),t.on(m.BUFFER_RESET,this.onBufferReset,this),t.on(m.BUFFER_CREATED,this.onBufferCreated,this),t.on(m.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(m.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(m.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(m.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.LEVEL_LOADED,this.onLevelLoaded,this),t.off(m.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(m.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(m.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(m.ERROR,this.onError,this),t.off(m.BUFFER_RESET,this.onBufferReset,this),t.off(m.BUFFER_CREATED,this.onBufferCreated,this),t.off(m.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(m.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(m.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(m.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(t,{frag:e,id:i,initPTS:s,timescale:r}){if(i==="main"){const a=e.cc;this.initPTS[e.cc]={baseTime:s,timescale:r},this.log(`InitPTS for cc: ${a} found from main: ${s}`),this.videoTrackCC=a,this.state===A.WAITING_INIT_PTS&&this.tick()}}startLoad(t){if(!this.levels){this.startPosition=t,this.state=A.STOPPED;return}const e=this.lastCurrentTime;this.stopLoad(),this.setInterval(ic),e>0&&t===-1?(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e,this.state=A.IDLE):(this.loadedmetadata=!1,this.state=A.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}doTick(){switch(this.state){case A.IDLE:this.doTickIdle();break;case A.WAITING_TRACK:{var t;const{levels:i,trackId:s}=this,r=i==null||(t=i[s])==null?void 0:t.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=A.WAITING_INIT_PTS}break}case A.FRAG_LOADING_WAITING_RETRY:{var e;const i=performance.now(),s=this.retryDate;if(!s||i>=s||(e=this.media)!=null&&e.seeking){const{levels:r,trackId:a}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((r==null?void 0:r[a])||null),this.state=A.IDLE}break}case A.WAITING_INIT_PTS:{const i=this.waitingData;if(i){const{frag:s,part:r,cache:a,complete:o}=i;if(this.initPTS[s.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=A.FRAG_LOADING;const l=a.flush(),h={frag:s,part:r,payload:l,networkDetails:null};this._handleFragmentLoadProgress(h),o&&super._handleFragmentLoadComplete(h)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${s.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const l=this.getLoadPosition(),h=st.bufferInfo(this.mediaBuffer,l,this.config.maxBufferHole);Ur(h.end,this.config.maxFragLookUpTolerance,s)<0&&(this.log(`Waiting fragment cc (${s.cc}) @ ${s.start} cancelled because another fragment at ${h.end} is needed`),this.clearWaitingFragment())}}else this.state=A.IDLE}}this.onTickEnd()}clearWaitingFragment(){const t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=A.IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:t}=this;t!=null&&t.readyState&&(this.lastCurrentTime=t.currentTime)}doTickIdle(){const{hls:t,levels:e,media:i,trackId:s}=this,r=t.config;if(!this.buffering||!i&&(this.startFragRequested||!r.startFragPrefetch)||!(e!=null&&e[s]))return;const a=e[s],o=a.details;if(!o||o.live&&this.levelLastLoaded!==a||this.waitForCdnTuneIn(o)){this.state=A.WAITING_TRACK;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,tt.AUDIO,U.AUDIO));const h=this.getFwdBufferInfo(l,U.AUDIO);if(h===null)return;if(!this.switchingTrack&&this._streamEnded(h,o)){t.trigger(m.BUFFER_EOS,{type:"audio"}),this.state=A.ENDED;return}const c=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,U.MAIN),u=h.len,d=this.getMaxBufferLength(c==null?void 0:c.len),g=o.fragments,f=g[0].start,p=this.getLoadPosition(),y=this.flushing?p:h.end;if(this.switchingTrack&&i){const T=p;o.PTSKnown&&T<f&&(h.end>f||h.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=f+.05)}if(u>=d&&!this.switchingTrack&&y<g[g.length-1].start)return;let v=this.getNextFragment(y,o),E=!1;if(v&&this.isLoopLoading(v,y)&&(E=!!v.gap,v=this.getNextFragmentLoopLoading(v,o,h,U.MAIN,d)),!v){this.bufferFlushed=!0;return}const _=c&&v.start>c.end+o.targetduration;if(_||!(c!=null&&c.len)&&h.len){const T=this.getAppendedFrag(v.start,U.MAIN);if(T===null||(E||(E=!!T.gap||!!_&&c.len===0),_&&!E||E&&h.nextStart&&h.nextStart<T.end))return}this.loadFragment(v,a,y)}getMaxBufferLength(t){const e=super.getMaxBufferLength();return t?Math.min(Math.max(e,t),this.config.maxMaxBufferLength):e}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(t,{audioTracks:e}){this.resetTransmuxer(),this.levels=e.map(i=>new Oe(i))}onAudioTrackSwitching(t,e){const i=!!e.url;this.trackId=e.id;const{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?this.setInterval(ic):this.resetTransmuxer(),i?(this.switchingTrack=e,this.state=A.IDLE,this.flushAudioIfNeeded(e)):(this.switchingTrack=null,this.bufferedTrack=e,this.state=A.STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(t,e){this.mainDetails=e.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(m.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(t,e){var i;if(this.mainDetails==null){this.cachedTrackLoadedData=e;return}const{levels:s}=this,{details:r,id:a}=e;if(!s){this.warn(`Audio tracks were reset while loading level ${a}`);return}this.log(`Audio track ${a} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const o=s[a];let l=0;if(r.live||(i=o.details)!=null&&i.live){this.checkLiveUpdate(r);const c=this.mainDetails;if(r.deltaUpdateFailed||!c)return;if(!o.details&&r.hasProgramDateTime&&c.hasProgramDateTime)Ws(r,c),l=r.fragments[0].start;else{var h;l=this.alignPlaylists(r,o.details,(h=this.levelLastLoaded)==null?void 0:h.details)}}o.details=r,this.levelLastLoaded=o,!this.startFragRequested&&(this.mainDetails||!r.live)&&this.setStartPosition(this.mainDetails||r,l),this.state===A.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=A.IDLE),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:i,part:s,payload:r}=t,{config:a,trackId:o,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const h=l[o];if(!h){this.warn("Audio track is undefined on fragment load progress");return}const c=h.details;if(!c){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const u=a.defaultAudioCodec||h.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new ec(this.hls,U.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const g=this.initPTS[i.cc],f=(e=i.initSegment)==null?void 0:e.data;if(g!==void 0){const p=s?s.index:-1,y=p!==-1,v=new Vs(i.level,i.sn,i.stats.chunkCount,r.byteLength,p,y);d.push(r,f,u,"",i,s,c.totalduration,!1,v,g)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${c.startSN} ,${c.endSN}],track ${o}`);const{cache:p}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new xh,complete:!1};p.push(new Uint8Array(r)),this.waitingVideoCC=this.videoTrackCC,this.state=A.WAITING_INIT_PTS}}_handleFragmentLoadComplete(t){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(t)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(t,e){const i=e.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),e.tracks.video&&(this.videoBuffer=e.tracks.video.buffer||null)}onFragBuffered(t,e){const{frag:i,part:s}=e;if(i.type!==U.AUDIO){if(!this.loadedmetadata&&i.type===U.MAIN){const r=this.videoBuffer||this.media;r&&st.getBuffered(r).length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(i.sn!=="initSegment"){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(m.AUDIO_TRACK_SWITCHED,yt({},r)))}this.fragBufferedComplete(i,s)}onError(t,e){var i;if(e.fatal){this.state=A.ERROR;return}switch(e.details){case S.FRAG_GAP:case S.FRAG_PARSING_ERROR:case S.FRAG_DECRYPT_ERROR:case S.FRAG_LOAD_ERROR:case S.FRAG_LOAD_TIMEOUT:case S.KEY_LOAD_ERROR:case S.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(U.AUDIO,e);break;case S.AUDIO_TRACK_LOAD_ERROR:case S.AUDIO_TRACK_LOAD_TIMEOUT:case S.LEVEL_PARSING_ERROR:!e.levelRetry&&this.state===A.WAITING_TRACK&&((i=e.context)==null?void 0:i.type)===Q.AUDIO_TRACK&&(this.state=A.IDLE);break;case S.BUFFER_APPEND_ERROR:case S.BUFFER_FULL_ERROR:if(!e.parent||e.parent!=="audio")return;if(e.details===S.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(e)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case S.INTERNAL_EXCEPTION:this.recoverWorkerError(e);break}}onBufferFlushing(t,{type:e}){e!==tt.VIDEO&&(this.flushing=!0)}onBufferFlushed(t,{type:e}){if(e!==tt.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===A.ENDED&&(this.state=A.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,e,U.AUDIO),this.tick())}}_handleTransmuxComplete(t){var e;const i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:a}=t,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:h,level:c}=o,{details:u}=c,{audio:d,text:g,id3:f,initSegment:p}=r;if(this.fragContextChanged(l)||!u){this.fragmentTracker.removeFragment(l);return}if(this.state=A.PARSING,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),p!=null&&p.tracks){const y=l.initSegment||l;this._bufferInitSegment(c,p.tracks,y,a),s.trigger(m.FRAG_PARSING_INIT_SEGMENT,{frag:y,id:i,tracks:p.tracks})}if(d){const{startPTS:y,endPTS:v,startDTS:E,endDTS:_}=d;h&&(h.elementaryStreams[tt.AUDIO]={startPTS:y,endPTS:v,startDTS:E,endDTS:_}),l.setElementaryStreamInfo(tt.AUDIO,y,v,E,_),this.bufferFragmentData(d,l,h,a)}if(f!=null&&(e=f.samples)!=null&&e.length){const y=ot({id:i,frag:l,details:u},f);s.trigger(m.FRAG_PARSING_METADATA,y)}if(g){const y=ot({id:i,frag:l,details:u},g);s.trigger(m.FRAG_PARSING_USERDATA,y)}}_bufferInitSegment(t,e,i,s){if(this.state!==A.PARSING)return;e.video&&delete e.video;const r=e.audio;if(!r)return;r.id="audio";const a=t.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${a}/${r.codec}]`),a&&a.split(",").length===1&&(r.levelCodec=a),this.hls.trigger(m.BUFFER_CODECS,e);const o=r.initSegment;if(o!=null&&o.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:o};this.hls.trigger(m.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(t,e,i){const s=this.fragmentTracker.getState(t);if(this.fragCurrent=t,this.switchingTrack||s===Et.NOT_LOADED||s===Et.PARTIAL){var r;if(t.sn==="initSegment")this._loadInitSegment(t,e);else if((r=e.details)!=null&&r.live&&!this.initPTS[t.cc]){this.log(`Waiting for video PTS in continuity counter ${t.cc} of live stream before loading audio fragment ${t.sn} of level ${this.trackId}`),this.state=A.WAITING_INIT_PTS;const a=this.mainDetails;a&&a.fragments[0].start!==e.details.fragments[0].start&&Ws(e.details,a)}else this.startFragRequested=!0,super.loadFragment(t,e,i)}else this.clearTrackerIfNeeded(t)}flushAudioIfNeeded(t){if(this.media&&this.bufferedTrack){const{name:e,lang:i,assocLang:s,characteristics:r,audioCodec:a,channels:o}=this.bufferedTrack;$e({name:e,lang:i,assocLang:s,characteristics:r,audioCodec:a,channels:o},t,Ne)||(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}}completeAudioSwitch(t){const{hls:e}=this;this.flushAudioIfNeeded(t),this.bufferedTrack=t,this.switchingTrack=null,e.trigger(m.AUDIO_TRACK_SWITCHED,yt({},t))}}function nc(n,t){if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++)if(!Ni(n[e].attrs,t[e].attrs))return!1;return!0}function Ni(n,t,e){const i=n["STABLE-RENDITION-ID"];return i&&!e?i===t["STABLE-RENDITION-ID"]:!(e||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(s=>n[s]!==t[s])}function Zr(n,t){return t.label.toLowerCase()===n.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(n.lang||"").toLowerCase())}class rc extends Bs{constructor(t){super(t,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:t}=this;t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.MANIFEST_PARSED,this.onManifestParsed,this),t.on(m.LEVEL_LOADING,this.onLevelLoading,this),t.on(m.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(m.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(m.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.MANIFEST_PARSED,this.onManifestParsed,this),t.off(m.LEVEL_LOADING,this.onLevelLoading,this),t.off(m.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(m.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(m.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.audioTracks||[]}onAudioTrackLoaded(t,e){const{id:i,groupId:s,details:r}=e,a=this.tracksInGroup[i];if(!a||a.groupId!==s){this.warn(`Audio track with id:${i} and group:${s} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=e.details,this.log(`Audio track ${i} "${a.name}" lang:${a.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,o)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(!e)return;const i=e.audioGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(s==null?void 0:s.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(d=>!i||i.indexOf(d.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(d=>d.default)&&(this.selectDefaultTrack=!1),o.forEach((d,g)=>{d.id=g});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const l=this.hls.config.audioPreference;if(!r&&l){const d=te(l,o,Ne);if(d>-1)r=o[d];else{const g=te(l,this.tracks);r=this.tracks[g]}}let h=this.findTrackId(r);h===-1&&r&&(h=this.findTrackId(null));const c={audioTracks:o};this.log(`Updating audio tracks, ${o.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(m.AUDIO_TRACKS_UPDATED,c);const u=this.trackId;if(h!==-1&&u===-1)this.setAudioTrack(h);else if(o.length&&u===-1){var a;const d=new Error(`No audio track selected for current audio group-ID(s): ${(a=this.groupIds)==null?void 0:a.join(",")} track count: ${o.length}`);this.warn(d.message),this.hls.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:d})}}else this.shouldReloadPlaylist(r)&&this.setAudioTrack(this.trackId)}onError(t,e){e.fatal||!e.context||e.context.type===Q.AUDIO_TRACK&&e.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(e.context.groupId)!==-1)&&(this.requestScheduled=-1,this.checkRetry(e))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(t){this.selectDefaultTrack=!1,this.setAudioTrack(t)}setAudioOption(t){const e=this.hls;if(e.config.audioPreference=t,t){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const s=this.currentTrack;if(s&&$e(t,s,Ne))return s;const r=te(t,this.tracksInGroup,Ne);if(r>-1){const a=this.tracksInGroup[r];return this.setAudioTrack(r),a}else if(s){let a=e.loadLevel;a===-1&&(a=e.firstAutoLevel);const o=qy(t,e.levels,i,a,Ne);if(o===-1)return null;e.nextLoadLevel=o}if(t.channels||t.audioCodec){const a=te(t,i);if(a>-1)return i[a]}}}return null}setAudioTrack(t){const e=this.tracksInGroup;if(t<0||t>=e.length){this.warn(`Invalid audio track id: ${t}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,s=e[t],r=s.details&&!s.details.live;if(t===this.trackId&&s===i&&r||(this.log(`Switching to audio-track ${t} "${s.name}" lang:${s.lang} group:${s.groupId} channels:${s.channels}`),this.trackId=t,this.currentTrack=s,this.hls.trigger(m.AUDIO_TRACK_SWITCHING,yt({},s)),r))return;const a=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(a)}findTrackId(t){const e=this.tracksInGroup;for(let i=0;i<e.length;i++){const s=e[i];if(!(this.selectDefaultTrack&&!s.default)&&(!t||$e(t,s,Ne)))return i}if(t){const{name:i,lang:s,assocLang:r,characteristics:a,audioCodec:o,channels:l}=t;for(let h=0;h<e.length;h++){const c=e[h];if($e({name:i,lang:s,assocLang:r,characteristics:a,audioCodec:o,channels:l},c,Ne))return h}for(let h=0;h<e.length;h++){const c=e[h];if(Ni(t.attrs,c.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return h}for(let h=0;h<e.length;h++){const c=e[h];if(Ni(t.attrs,c.attrs,["LANGUAGE"]))return h}}return-1}loadPlaylist(t){const e=this.currentTrack;if(this.shouldLoadPlaylist(e)&&e){super.loadPlaylist();const i=e.id,s=e.groupId;let r=e.url;if(t)try{r=t.addDirectives(r)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`loading audio-track playlist ${i} "${e.name}" lang:${e.lang} group:${s}`),this.clearTimer(),this.hls.trigger(m.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:t||null})}}}const ac=500;class oc extends zs{constructor(t,e,i){super(t,e,i,"[subtitle-stream-controller]",U.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:t}=this;t.on(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.LEVEL_LOADED,this.onLevelLoaded,this),t.on(m.ERROR,this.onError,this),t.on(m.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(m.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(m.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(m.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(m.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(m.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.LEVEL_LOADED,this.onLevelLoaded,this),t.off(m.ERROR,this.onError,this),t.off(m.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(m.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(m.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(m.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(m.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(m.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(t){this.stopLoad(),this.state=A.IDLE,this.setInterval(ac),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(t,e){this.mainDetails=e.details}onSubtitleFragProcessed(t,e){const{frag:i,success:s}=e;if(this.fragPrevious=i,this.state=A.IDLE,!s)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let a;const o=i.start;for(let h=0;h<r.length;h++)if(o>=r[h].start&&o<=r[h].end){a=r[h];break}const l=i.start+i.duration;a?a.end=l:(a={start:o,end:l},r.push(a)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null)}onBufferFlushing(t,e){const{startOffset:i,endOffset:s}=e;if(i===0&&s!==Number.POSITIVE_INFINITY){const r=s-1;if(r<=0)return;e.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(a=>{for(let o=0;o<a.length;){if(a[o].end<=r){a.shift();continue}else if(a[o].start<r)a[o].start=r;else break;o++}}),this.fragmentTracker.removeFragmentsInRange(i,r,U.SUBTITLE)}}onFragBuffered(t,e){if(!this.loadedmetadata&&e.frag.type===U.MAIN){var i;(i=this.media)!=null&&i.buffered.length&&(this.loadedmetadata=!0)}}onError(t,e){const i=e.frag;(i==null?void 0:i.type)===U.SUBTITLE&&(e.details===S.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==A.STOPPED&&(this.state=A.IDLE))}onSubtitleTracksUpdated(t,{subtitleTracks:e}){if(this.levels&&nc(this.levels,e)){this.levels=e.map(i=>new Oe(i));return}this.tracksBuffered=[],this.levels=e.map(i=>{const s=new Oe(i);return this.tracksBuffered[s.id]=[],s}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,U.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(t,e){var i;if(this.currentTrackId=e.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const s=this.levels[this.currentTrackId];s!=null&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.setInterval(ac)}onSubtitleTrackLoaded(t,e){var i;const{currentTrackId:s,levels:r}=this,{details:a,id:o}=e;if(!r){this.warn(`Subtitle tracks were reset while loading level ${o}`);return}const l=r[o];if(o>=r.length||!l)return;this.log(`Subtitle track ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let h=0;if(a.live||(i=l.details)!=null&&i.live){const u=this.mainDetails;if(a.deltaUpdateFailed||!u)return;const d=u.fragments[0];if(!l.details)a.hasProgramDateTime&&u.hasProgramDateTime?(Ws(a,u),h=a.fragments[0].start):d&&(h=d.start,Nr(a,h));else{var c;h=this.alignPlaylists(a,l.details,(c=this.levelLastLoaded)==null?void 0:c.details),h===0&&d&&(h=d.start,Nr(a,h))}}l.details=a,this.levelLastLoaded=l,o===s&&(!this.startFragRequested&&(this.mainDetails||!a.live)&&this.setStartPosition(this.mainDetails||a,h),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===A.IDLE&&(Us(null,a.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)))}_handleFragmentLoadComplete(t){const{frag:e,payload:i}=t,s=e.decryptdata,r=this.hls;if(!this.fragContextChanged(e)&&i&&i.byteLength>0&&s!=null&&s.key&&s.iv&&s.method==="AES-128"){const a=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer).catch(o=>{throw r.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.FRAG_DECRYPT_ERROR,fatal:!1,error:o,reason:o.message,frag:e}),o}).then(o=>{const l=performance.now();r.trigger(m.FRAG_DECRYPTED,{frag:e,payload:o,stats:{tstart:a,tdecrypt:l}})}).catch(o=>{this.warn(`${o.name}: ${o.message}`),this.state=A.IDLE})}}doTick(){if(!this.media){this.state=A.IDLE;return}if(this.state===A.IDLE){const{currentTrackId:t,levels:e}=this,i=e==null?void 0:e[t];if(!i||!e.length||!i.details)return;const{config:s}=this,r=this.getLoadPosition(),a=st.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,s.maxBufferHole),{end:o,len:l}=a,h=this.getFwdBufferInfo(this.media,U.MAIN),c=i.details,u=this.getMaxBufferLength(h==null?void 0:h.len)+c.levelTargetDuration;if(l>u)return;const d=c.fragments,g=d.length,f=c.edge;let p=null;const y=this.fragPrevious;if(o<f){const v=s.maxFragLookUpTolerance,E=o>f-v?0:v;p=Us(y,d,Math.max(d[0].start,o),E),!p&&y&&y.start<d[0].start&&(p=d[0])}else p=d[g-1];if(!p)return;if(p=this.mapToInitFragWhenRequired(p),p.sn!=="initSegment"){const v=p.sn-c.startSN,E=d[v-1];E&&E.cc===p.cc&&this.fragmentTracker.getState(E)===Et.NOT_LOADED&&(p=E)}this.fragmentTracker.getState(p)===Et.NOT_LOADED&&this.loadFragment(p,i,o)}}getMaxBufferLength(t){const e=super.getMaxBufferLength();return t?Math.max(e,t):e}loadFragment(t,e,i){this.fragCurrent=t,t.sn==="initSegment"?this._loadInitSegment(t,e):(this.startFragRequested=!0,super.loadFragment(t,e,i))}get mediaBufferTimeRanges(){return new Y0(this.tracksBuffered[this.currentTrackId]||[])}}class Y0{constructor(t){this.buffered=void 0;const e=(i,s,r)=>{if(s=s>>>0,s>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${r})`);return t[s][i]};this.buffered={get length(){return t.length},end(i){return e("end",i,t.length)},start(i){return e("start",i,t.length)}}}}class lc extends Bs{constructor(t){super(t,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const i=Ms(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")e=i[r];else if(i[r].mode==="showing"){e=i[r];break}const s=this.findTrackForTextTrack(e);this.subtitleTrack!==s&&this.setSubtitleTrack(s)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:t}=this;t.on(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.MANIFEST_PARSED,this.onManifestParsed,this),t.on(m.LEVEL_LOADING,this.onLevelLoading,this),t.on(m.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(m.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(m.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.MANIFEST_PARSED,this.onManifestParsed,this),t.off(m.LEVEL_LOADING,this.onLevelLoading,this),t.off(m.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(m.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(m.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,t)}onMediaDetaching(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),Ms(this.media.textTracks).forEach(t=>{ri(t)}),this.subtitleTrack=-1,this.media=null)}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.subtitleTracks}onSubtitleTrackLoaded(t,e){const{id:i,groupId:s,details:r}=e,a=this.tracksInGroup[i];if(!a||a.groupId!==s){this.warn(`Subtitle track with id:${i} and group:${s} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=e.details,this.log(`Subtitle track ${i} "${a.name}" lang:${a.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,o)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(!e)return;const i=e.subtitleGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(s==null?void 0:s.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(c=>!i||i.indexOf(c.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(c=>c.default)&&(this.selectDefaultTrack=!1),a.forEach((c,u)=>{c.id=u});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const o=this.hls.config.subtitlePreference;if(!r&&o){this.selectDefaultTrack=!1;const c=te(o,a);if(c>-1)r=a[c];else{const u=te(o,this.tracks);r=this.tracks[u]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const h={subtitleTracks:a};this.log(`Updating subtitle tracks, ${a.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(m.SUBTITLE_TRACKS_UPDATED,h),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}else this.shouldReloadPlaylist(r)&&this.setSubtitleTrack(this.trackId)}findTrackId(t){const e=this.tracksInGroup,i=this.selectDefaultTrack;for(let s=0;s<e.length;s++){const r=e[s];if(!(i&&!r.default||!i&&!t)&&(!t||$e(r,t)))return s}if(t){for(let s=0;s<e.length;s++){const r=e[s];if(Ni(t.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<e.length;s++){const r=e[s];if(Ni(t.attrs,r.attrs,["LANGUAGE"]))return s}}return-1}findTrackForTextTrack(t){if(t){const e=this.tracksInGroup;for(let i=0;i<e.length;i++){const s=e[i];if(Zr(s,t))return i}}return-1}onError(t,e){e.fatal||!e.context||e.context.type===Q.SUBTITLE_TRACK&&e.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(e.context.groupId)!==-1)&&this.checkRetry(e)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(t){this.selectDefaultTrack=!1,this.setSubtitleTrack(t)}setSubtitleOption(t){if(this.hls.config.subtitlePreference=t,t){const e=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,e.length){const i=this.currentTrack;if(i&&$e(t,i))return i;const s=te(t,this.tracksInGroup);if(s>-1){const r=this.tracksInGroup[s];return this.setSubtitleTrack(s),r}else{if(i)return null;{const r=te(t,e);if(r>-1)return e[r]}}}}return null}loadPlaylist(t){super.loadPlaylist();const e=this.currentTrack;if(this.shouldLoadPlaylist(e)&&e){const i=e.id,s=e.groupId;let r=e.url;if(t)try{r=t.addDirectives(r)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(m.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:t||null})}}toggleTrackModes(){const{media:t}=this;if(!t)return;const e=Ms(t.textTracks),i=this.currentTrack;let s;if(i&&(s=e.filter(r=>Zr(i,r))[0],s||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(e).forEach(r=>{r.mode!=="disabled"&&r!==s&&(r.mode="disabled")}),s){const r=this.subtitleDisplay?"showing":"hidden";s.mode!==r&&(s.mode=r)}}setSubtitleTrack(t){const e=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=t;return}if(t<-1||t>=e.length||!$(t)){this.warn(`Invalid subtitle track id: ${t}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,s=e[t]||null;if(this.trackId=t,this.currentTrack=s,this.toggleTrackModes(),!s){this.hls.trigger(m.SUBTITLE_TRACK_SWITCH,{id:t});return}const r=!!s.details&&!s.details.live;if(t===this.trackId&&s===i&&r)return;this.log(`Switching to subtitle-track ${t}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:""));const{id:a,groupId:o="",name:l,type:h,url:c}=s;this.hls.trigger(m.SUBTITLE_TRACK_SWITCH,{id:a,groupId:o,name:l,type:h,url:c});const u=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(u)}}class j0{constructor(t){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=t}append(t,e,i){const s=this.queues[e];s.push(t),s.length===1&&!i&&this.executeNext(e)}insertAbort(t,e){this.queues[e].unshift(t),this.executeNext(e)}appendBlocker(t){let e;const i=new Promise(r=>{e=r}),s={execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(s,t),i}executeNext(t){const e=this.queues[t];if(e.length){const i=e[0];try{i.execute()}catch(s){C.warn(`[buffer-operation-queue]: Exception executing "${t}" SourceBuffer operation: ${s}`),i.onError(s);const r=this.buffers[t];r!=null&&r.updating||this.shiftAndExecuteNext(t)}}}shiftAndExecuteNext(t){this.queues[t].shift(),this.executeNext(t)}current(t){return this.queues[t][0]}}const hc=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class cc{constructor(t){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=i=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:i,mediaSource:s}=this;this.log("Media source opened"),i&&(i.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(m.MEDIA_ATTACHED,{media:i,mediaSource:s})),s&&s.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:s}=this;i!==s&&C.error(`Media element src was set while attaching MediaSource (${s} > ${i})`)},this.hls=t;const e="[buffer-controller]";this.appendSource=cy(fe(t.config.preferManagedMediaSource)),this.log=C.log.bind(C,e),this.warn=C.warn.bind(C,e),this.error=C.error.bind(C,e),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:t}=this;t.on(m.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.MANIFEST_PARSED,this.onManifestParsed,this),t.on(m.BUFFER_RESET,this.onBufferReset,this),t.on(m.BUFFER_APPENDING,this.onBufferAppending,this),t.on(m.BUFFER_CODECS,this.onBufferCodecs,this),t.on(m.BUFFER_EOS,this.onBufferEos,this),t.on(m.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(m.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(m.FRAG_PARSED,this.onFragParsed,this),t.on(m.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:t}=this;t.off(m.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.MANIFEST_PARSED,this.onManifestParsed,this),t.off(m.BUFFER_RESET,this.onBufferReset,this),t.off(m.BUFFER_APPENDING,this.onBufferAppending,this),t.off(m.BUFFER_CODECS,this.onBufferCodecs,this),t.off(m.BUFFER_EOS,this.onBufferEos,this),t.off(m.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(m.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(m.FRAG_PARSED,this.onFragParsed,this),t.off(m.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new j0(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(t,e){let i=2;(e.audio&&!e.video||!e.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(t,e){const i=this.media=e.media,s=fe(this.appendSource);if(i&&s){var r;const a=this.mediaSource=new s;this.log(`created media source: ${(r=a.constructor)==null?void 0:r.name}`),a.addEventListener("sourceopen",this._onMediaSourceOpen),a.addEventListener("sourceended",this._onMediaSourceEnded),a.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(a.addEventListener("startstreaming",this._onStartStreaming),a.addEventListener("endstreaming",this._onEndStreaming));const o=this._objectUrl=self.URL.createObjectURL(a);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&a instanceof l,uc(i),q0(i,o),i.load()}catch{i.src=o}else i.src=o;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:t,mediaSource:e,_objectUrl:i}=this;if(e){if(this.log("media source detaching"),e.readyState==="open")try{e.endOfStream()}catch(s){this.warn(`onMediaDetaching: ${s.message} while calling endOfStream`)}this.onBufferReset(),e.removeEventListener("sourceopen",this._onMediaSourceOpen),e.removeEventListener("sourceended",this._onMediaSourceEnded),e.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.removeEventListener("startstreaming",this._onStartStreaming),e.removeEventListener("endstreaming",this._onEndStreaming)),t&&(t.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(t.removeAttribute("src"),this.appendSource&&uc(t),t.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(m.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(t=>{this.resetBuffer(t)}),this._initSourceBuffer(),this.hls.resumeBuffering()}resetBuffer(t){const e=this.sourceBuffer[t];try{if(e){var i;this.removeBufferListeners(t),this.sourceBuffer[t]=void 0,(i=this.mediaSource)!=null&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(e)}}catch(s){this.warn(`onBufferReset ${t}`,s)}}onBufferCodecs(t,e){const i=this.getSourceBufferTypes().length,s=Object.keys(e);if(s.forEach(a=>{if(i){const l=this.tracks[a];if(l&&typeof l.buffer.changeType=="function"){var o;const{id:h,codec:c,levelCodec:u,container:d,metadata:g}=e[a],f=Jl(l.codec,l.levelCodec),p=f==null?void 0:f.replace(hc,"$1");let y=Jl(c,u);const v=(o=y)==null?void 0:o.replace(hc,"$1");if(y&&p!==v){a.slice(0,5)==="audio"&&(y=xs(y,this.appendSource));const E=`${d};codecs=${y}`;this.appendChangeType(a,E),this.log(`switching codec ${f} to ${y}`),this.tracks[a]={buffer:l.buffer,codec:c,container:d,levelCodec:u,metadata:g,id:h}}}}else this.pendingTracks[a]=e[a]}),i)return;const r=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==r&&(this.log(`${r} bufferCodec event(s) expected ${s.join(",")}`),this.bufferCodecEventsExpected=r),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks()}appendChangeType(t,e){const{operationQueue:i}=this,s={execute:()=>{const r=this.sourceBuffer[t];r&&(this.log(`changing ${t} sourceBuffer type to ${e}`),r.changeType(e)),i.shiftAndExecuteNext(t)},onStart:()=>{},onComplete:()=>{},onError:r=>{this.warn(`Failed to change ${t} SourceBuffer type`,r)}};i.append(s,t,!!this.pendingTracks[t])}onBufferAppending(t,e){const{hls:i,operationQueue:s,tracks:r}=this,{data:a,type:o,frag:l,part:h,chunkMeta:c}=e,u=c.buffering[o],d=self.performance.now();u.start=d;const g=l.stats.buffering,f=h?h.stats.buffering:null;g.start===0&&(g.start=d),f&&f.start===0&&(f.start=d);const p=r.audio;let y=!1;o==="audio"&&(p==null?void 0:p.container)==="audio/mpeg"&&(y=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const v=l.start,E={execute:()=>{if(u.executeStart=self.performance.now(),y){const _=this.sourceBuffer[o];if(_){const T=v-_.timestampOffset;Math.abs(T)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${v} (delta: ${T}) sn: ${l.sn})`),_.timestampOffset=v)}}this.appendExecutor(a,o)},onStart:()=>{},onComplete:()=>{const _=self.performance.now();u.executeEnd=u.end=_,g.first===0&&(g.first=_),f&&f.first===0&&(f.first=_);const{sourceBuffer:T}=this,L={};for(const w in T)L[w]=st.getBuffered(T[w]);this.appendErrors[o]=0,o==="audio"||o==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(m.BUFFER_APPENDED,{type:o,frag:l,part:h,chunkMeta:c,parent:l.type,timeRanges:L})},onError:_=>{const T={type:G.MEDIA_ERROR,parent:l.type,details:S.BUFFER_APPEND_ERROR,sourceBufferName:o,frag:l,part:h,chunkMeta:c,error:_,err:_,fatal:!1};if(_.code===DOMException.QUOTA_EXCEEDED_ERR)T.details=S.BUFFER_FULL_ERROR;else{const L=++this.appendErrors[o];T.details=S.BUFFER_APPEND_ERROR,this.warn(`Failed ${L}/${i.config.appendErrorMaxRetry} times to append segment in "${o}" sourceBuffer`),L>=i.config.appendErrorMaxRetry&&(T.fatal=!0)}i.trigger(m.ERROR,T)}};s.append(E,o,!!this.pendingTracks[o])}onBufferFlushing(t,e){const{operationQueue:i}=this,s=r=>({execute:this.removeExecutor.bind(this,r,e.startOffset,e.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(m.BUFFER_FLUSHED,{type:r})},onError:a=>{this.warn(`Failed to remove from ${r} SourceBuffer`,a)}});e.type?i.append(s(e.type),e.type):this.getSourceBufferTypes().forEach(r=>{i.append(s(r),r)})}onFragParsed(t,e){const{frag:i,part:s}=e,r=[],a=s?s.elementaryStreams:i.elementaryStreams;a[tt.AUDIOVIDEO]?r.push("audiovideo"):(a[tt.AUDIO]&&r.push("audio"),a[tt.VIDEO]&&r.push("video"));const o=()=>{const l=self.performance.now();i.stats.buffering.end=l,s&&(s.stats.buffering.end=l);const h=s?s.stats:i.stats;this.hls.trigger(m.FRAG_BUFFERED,{frag:i,part:s,stats:h,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(o,r)}onFragChanged(t,e){this.trimBuffers()}onBufferEos(t,e){this.getSourceBufferTypes().reduce((i,s)=>{const r=this.sourceBuffer[s];return r&&(!e.type||e.type===s)&&(r.ending=!0,r.ended||(r.ended=!0,this.log(`${s} sourceBuffer now EOS`))),i&&!!(!r||r.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(s=>{const r=this.sourceBuffer[s];r&&(r.ending=!1)});const{mediaSource:i}=this;if(!i||i.readyState!=="open"){i&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${i.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),i.endOfStream()}))}onLevelUpdated(t,{details:e}){e.fragments.length&&(this.details=e,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:t,details:e,media:i}=this;if(!i||e===null||!this.getSourceBufferTypes().length)return;const s=t.config,r=i.currentTime,a=e.levelTargetDuration,o=e.live&&s.liveBackBufferLength!==null?s.liveBackBufferLength:s.backBufferLength;if($(o)&&o>0){const l=Math.max(o,a),h=Math.floor(r/a)*a-l;this.flushBackBuffer(r,a,h)}if($(s.frontBufferFlushThreshold)&&s.frontBufferFlushThreshold>0){const l=Math.max(s.maxBufferLength,s.frontBufferFlushThreshold),h=Math.max(l,a),c=Math.floor(r/a)*a+h;this.flushFrontBuffer(r,a,c)}}flushBackBuffer(t,e,i){const{details:s,sourceBuffer:r}=this;this.getSourceBufferTypes().forEach(a=>{const o=r[a];if(o){const l=st.getBuffered(o);if(l.length>0&&i>l.start(0)){if(this.hls.trigger(m.BACK_BUFFER_REACHED,{bufferEnd:i}),s!=null&&s.live)this.hls.trigger(m.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(o.ended&&l.end(l.length-1)-t<e*2){this.log(`Cannot flush ${a} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(m.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:a})}}})}flushFrontBuffer(t,e,i){const{sourceBuffer:s}=this;this.getSourceBufferTypes().forEach(r=>{const a=s[r];if(a){const o=st.getBuffered(a),l=o.length;if(l<2)return;const h=o.start(l-1),c=o.end(l-1);if(i>h||t>=h&&t<=c)return;if(a.ended&&t-c<2*e){this.log(`Cannot flush ${r} front buffer while SourceBuffer is in ended state`);return}this.hls.trigger(m.BUFFER_FLUSHING,{startOffset:h,endOffset:1/0,type:r})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")return;const{details:t,hls:e,media:i,mediaSource:s}=this,r=t.fragments[0].start+t.totalduration,a=i.duration,o=$(s.duration)?s.duration:0;t.live&&e.config.liveDurationInfinity?(s.duration=1/0,this.updateSeekableRange(t)):(r>o&&r>a||!$(a))&&(this.log(`Updating Media Source duration to ${r.toFixed(3)}`),s.duration=r)}updateSeekableRange(t){const e=this.mediaSource,i=t.fragments;if(i.length&&t.live&&e!=null&&e.setLiveSeekableRange){const s=Math.max(0,i[0].start),r=Math.max(s,s+t.totalduration);this.log(`Media Source duration is set to ${e.duration}. Setting seekable range to ${s}-${r}.`),e.setLiveSeekableRange(s,r)}}checkPendingTracks(){const{bufferCodecEventsExpected:t,operationQueue:e,pendingTracks:i}=this,s=Object.keys(i).length;if(s&&(!t||s===2||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};const r=this.getSourceBufferTypes();if(r.length)this.hls.trigger(m.BUFFER_CREATED,{tracks:this.tracks}),r.forEach(a=>{e.executeNext(a)});else{const a=new Error("could not create source buffer for media codec(s)");this.hls.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:a,reason:a.message})}}}createSourceBuffers(t){const{sourceBuffer:e,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const r in t)if(!e[r]){var s;const a=t[r];if(!a)throw Error(`source buffer exists for track ${r}, however track does not`);let o=((s=a.levelCodec)==null?void 0:s.indexOf(","))===-1?a.levelCodec:a.codec;o&&r.slice(0,5)==="audio"&&(o=xs(o,this.appendSource));const l=`${a.container};codecs=${o}`;this.log(`creating sourceBuffer(${l})`);try{const h=e[r]=i.addSourceBuffer(l),c=r;this.addBufferListener(c,"updatestart",this._onSBUpdateStart),this.addBufferListener(c,"updateend",this._onSBUpdateEnd),this.addBufferListener(c,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(c,"bufferedchange",(u,d)=>{const g=d.removedRanges;g!=null&&g.length&&this.hls.trigger(m.BUFFER_FLUSHED,{type:r})}),this.tracks[r]={buffer:h,codec:o,container:a.container,levelCodec:a.levelCodec,metadata:a.metadata,id:a.id}}catch(h){this.error(`error while trying to add sourceBuffer: ${h.message}`),this.hls.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:h,sourceBufferName:r,mimeType:l})}}}get mediaSrc(){var t,e;const i=((t=this.media)==null||(e=t.querySelector)==null?void 0:e.call(t,"source"))||this.media;return i==null?void 0:i.src}_onSBUpdateStart(t){const{operationQueue:e}=this;e.current(t).onStart()}_onSBUpdateEnd(t){var e;if(((e=this.mediaSource)==null?void 0:e.readyState)==="closed"){this.resetBuffer(t);return}const{operationQueue:i}=this;i.current(t).onComplete(),i.shiftAndExecuteNext(t)}_onSBUpdateError(t,e){var i;const s=new Error(`${t} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${s}`,e),this.hls.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.BUFFER_APPENDING_ERROR,sourceBufferName:t,error:s,fatal:!1});const r=this.operationQueue.current(t);r&&r.onError(s)}removeExecutor(t,e,i){const{media:s,mediaSource:r,operationQueue:a,sourceBuffer:o}=this,l=o[t];if(!s||!r||!l){this.warn(`Attempting to remove from the ${t} SourceBuffer, but it does not exist`),a.shiftAndExecuteNext(t);return}const h=$(s.duration)?s.duration:1/0,c=$(r.duration)?r.duration:1/0,u=Math.max(0,e),d=Math.min(i,h,c);d>u&&(!l.ending||l.ended)?(l.ended=!1,this.log(`Removing [${u},${d}] from the ${t} SourceBuffer`),l.remove(u,d)):a.shiftAndExecuteNext(t)}appendExecutor(t,e){const i=this.sourceBuffer[e];if(!i){if(!this.pendingTracks[e])throw new Error(`Attempting to append to the ${e} SourceBuffer, but it does not exist`);return}i.ended=!1,i.appendBuffer(t)}blockBuffers(t,e=this.getSourceBufferTypes()){if(!e.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(t);return}const{operationQueue:i}=this,s=e.map(r=>i.appendBlocker(r));Promise.all(s).then(()=>{t(),e.forEach(r=>{const a=this.sourceBuffer[r];a!=null&&a.updating||i.shiftAndExecuteNext(r)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(t,e,i){const s=this.sourceBuffer[t];if(!s)return;const r=i.bind(this,t);this.listeners[t].push({event:e,listener:r}),s.addEventListener(e,r)}removeBufferListeners(t){const e=this.sourceBuffer[t];e&&this.listeners[t].forEach(i=>{e.removeEventListener(i.event,i.listener)})}}function uc(n){const t=n.querySelectorAll("source");[].slice.call(t).forEach(e=>{n.removeChild(e)})}function q0(n,t){const e=self.document.createElement("source");e.type="video/mp4",e.src=t,n.appendChild(e)}const Z0={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},dc=n=>String.fromCharCode(Z0[n]||n),Bt=15,he=100,Q0={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},X0={17:2,18:4,21:6,22:8,23:10,19:13,20:15},J0={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},tv={25:2,26:4,29:6,30:8,31:10,27:13,28:15},ev=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class iv{constructor(){this.time=null,this.verboseLevel=0}log(t,e){if(this.verboseLevel>=t){const i=typeof e=="function"?e():e;C.log(`${this.time} [${t}] ${i}`)}}}const Fe=function(n){const t=[];for(let e=0;e<n.length;e++)t.push(n[e].toString(16));return t};class fc{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(t){const e=["foreground","underline","italics","background","flash"];for(let i=0;i<e.length;i++){const s=e[i];t.hasOwnProperty(s)&&(this[s]=t[s])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(t){return this.foreground===t.foreground&&this.underline===t.underline&&this.italics===t.italics&&this.background===t.background&&this.flash===t.flash}copy(t){this.foreground=t.foreground,this.underline=t.underline,this.italics=t.italics,this.background=t.background,this.flash=t.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class sv{constructor(){this.uchar=" ",this.penState=new fc}reset(){this.uchar=" ",this.penState.reset()}setChar(t,e){this.uchar=t,this.penState.copy(e)}setPenState(t){this.penState.copy(t)}equals(t){return this.uchar===t.uchar&&this.penState.equals(t.penState)}copy(t){this.uchar=t.uchar,this.penState.copy(t.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class nv{constructor(t){this.chars=[],this.pos=0,this.currPenState=new fc,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<he;e++)this.chars.push(new sv);this.logger=t}equals(t){for(let e=0;e<he;e++)if(!this.chars[e].equals(t.chars[e]))return!1;return!0}copy(t){for(let e=0;e<he;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<he;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(t){this.pos!==t&&(this.pos=t),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>he&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=he)}moveCursor(t){const e=this.pos+t;if(t>1)for(let i=this.pos+1;i<e+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(e)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(t){t>=144&&this.backSpace();const e=dc(t);if(this.pos>=he){this.logger.log(0,()=>"Cannot insert "+t.toString(16)+" ("+e+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(e,this.currPenState),this.moveCursor(1)}clearFromPos(t){let e;for(e=t;e<he;e++)this.chars[e].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const t=[];let e=!0;for(let i=0;i<he;i++){const s=this.chars[i].uchar;s!==" "&&(e=!1),t.push(s)}return e?"":t.join("")}setPenStyles(t){this.currPenState.setStyles(t),this.chars[this.pos].setPenState(this.currPenState)}}class Qr{constructor(t){this.rows=[],this.currRow=Bt-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let e=0;e<Bt;e++)this.rows.push(new nv(t));this.logger=t}reset(){for(let t=0;t<Bt;t++)this.rows[t].clear();this.currRow=Bt-1}equals(t){let e=!0;for(let i=0;i<Bt;i++)if(!this.rows[i].equals(t.rows[i])){e=!1;break}return e}copy(t){for(let e=0;e<Bt;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<Bt;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(t){this.rows[this.currRow].insertChar(t)}setPen(t){this.rows[this.currRow].setPenStyles(t)}moveCursor(t){this.rows[this.currRow].moveCursor(t)}setCursor(t){this.logger.log(2,"setCursor: "+t),this.rows[this.currRow].setCursor(t)}setPAC(t){this.logger.log(2,()=>"pacData = "+JSON.stringify(t));let e=t.row-1;if(this.nrRollUpRows&&e<this.nrRollUpRows-1&&(e=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==e){for(let o=0;o<Bt;o++)this.rows[o].clear();const r=this.currRow+1-this.nrRollUpRows,a=this.lastOutputScreen;if(a){const o=a.rows[r].cueStartTime,l=this.logger.time;if(o!==null&&l!==null&&o<l)for(let h=0;h<this.nrRollUpRows;h++)this.rows[e-this.nrRollUpRows+h+1].copy(a.rows[r+h])}}this.currRow=e;const i=this.rows[this.currRow];if(t.indent!==null){const r=t.indent,a=Math.max(r-1,0);i.setCursor(t.indent),t.color=i.chars[a].penState.foreground}const s={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(t){this.logger.log(2,()=>"bkgData = "+JSON.stringify(t)),this.backSpace(),this.setPen(t),this.insertChar(32)}setRollUpRows(t){this.nrRollUpRows=t}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const t=this.currRow+1-this.nrRollUpRows,e=this.rows.splice(t,1)[0];e.clear(),this.rows.splice(this.currRow,0,e),this.logger.log(2,"Rolling up")}getDisplayText(t){t=t||!1;const e=[];let i="",s=-1;for(let r=0;r<Bt;r++){const a=this.rows[r].getTextString();a&&(s=r+1,t?e.push("Row "+s+": '"+a+"'"):e.push(a.trim()))}return e.length>0&&(t?i="["+e.join(" | ")+"]":i=e.join(`
`)),i}getTextAndFormat(){return this.rows}}class gc{constructor(t,e,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new Qr(i),this.nonDisplayedMemory=new Qr(i),this.lastOutputScreen=new Qr(i),this.currRollUpRow=this.displayedMemory.rows[Bt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Bt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(t){this.outputFilter=t}setPAC(t){this.writeScreen.setPAC(t)}setBkgData(t){this.writeScreen.setBkgData(t)}setMode(t){t!==this.mode&&(this.mode=t,this.logger.log(2,()=>"MODE="+t),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=t)}insertChars(t){for(let i=0;i<t.length;i++)this.writeScreen.insertChar(t[i]);const e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>e+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(t){this.logger.log(2,"RU("+t+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(t)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(t){this.logger.log(2,"TO("+t+") - Tab Offset"),this.writeScreen.moveCursor(t)}ccMIDROW(t){const e={flash:!1};if(e.underline=t%2===1,e.italics=t>=46,e.italics)e.foreground="white";else{const i=Math.floor(t/2)-16,s=["white","green","blue","cyan","red","yellow","magenta"];e.foreground=s[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(e)),this.writeScreen.setPen(e)}outputDataUpdate(t=!1){const e=this.logger.time;e!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=e:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,e,this.lastOutputScreen),t&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:e),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))}}class pc{constructor(t,e,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=av(),this.logger=void 0;const s=this.logger=new iv;this.channels=[null,new gc(t,e,s),new gc(t+1,i,s)]}getHandler(t){return this.channels[t].getHandler()}setHandler(t,e){this.channels[t].setHandler(e)}addData(t,e){this.logger.time=t;for(let i=0;i<e.length;i+=2){const s=e[i]&127,r=e[i+1]&127;let a=!1,o=null;if(s===0&&r===0)continue;this.logger.log(3,()=>"["+Fe([e[i],e[i+1]])+"] -> ("+Fe([s,r])+")");const l=this.cmdHistory;if(s>=16&&s<=31){if(rv(s,r,l)){Js(null,null,l),this.logger.log(3,()=>"Repeated command ("+Fe([s,r])+") is dropped");continue}Js(s,r,this.cmdHistory),a=this.parseCmd(s,r),a||(a=this.parseMidrow(s,r)),a||(a=this.parsePAC(s,r)),a||(a=this.parseBackgroundAttributes(s,r))}else Js(null,null,l);if(!a&&(o=this.parseChars(s,r),o)){const h=this.currentChannel;h&&h>0?this.channels[h].insertChars(o):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!a&&!o&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Fe([s,r])+" orig: "+Fe([e[i],e[i+1]]))}}parseCmd(t,e){const i=(t===20||t===28||t===21||t===29)&&e>=32&&e<=47,s=(t===23||t===31)&&e>=33&&e<=35;if(!(i||s))return!1;const r=t===20||t===21||t===23?1:2,a=this.channels[r];return t===20||t===21||t===28||t===29?e===32?a.ccRCL():e===33?a.ccBS():e===34?a.ccAOF():e===35?a.ccAON():e===36?a.ccDER():e===37?a.ccRU(2):e===38?a.ccRU(3):e===39?a.ccRU(4):e===40?a.ccFON():e===41?a.ccRDC():e===42?a.ccTR():e===43?a.ccRTD():e===44?a.ccEDM():e===45?a.ccCR():e===46?a.ccENM():e===47&&a.ccEOC():a.ccTO(e-32),this.currentChannel=r,!0}parseMidrow(t,e){let i=0;if((t===17||t===25)&&e>=32&&e<=47){if(t===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const s=this.channels[i];return s?(s.ccMIDROW(e),this.logger.log(3,()=>"MIDROW ("+Fe([t,e])+")"),!0):!1}return!1}parsePAC(t,e){let i;const s=(t>=17&&t<=23||t>=25&&t<=31)&&e>=64&&e<=127,r=(t===16||t===24)&&e>=64&&e<=95;if(!(s||r))return!1;const a=t<=23?1:2;e>=64&&e<=95?i=a===1?Q0[t]:J0[t]:i=a===1?X0[t]:tv[t];const o=this.channels[a];return o?(o.setPAC(this.interpretPAC(i,e)),this.currentChannel=a,!0):!1}interpretPAC(t,e){let i;const s={color:null,italics:!1,indent:null,underline:!1,row:t};return e>95?i=e-96:i=e-64,s.underline=(i&1)===1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=Math.floor((i-16)/2)*4,s}parseChars(t,e){let i,s=null,r=null;if(t>=25?(i=2,r=t-8):(i=1,r=t),r>=17&&r<=19){let a;r===17?a=e+80:r===18?a=e+112:a=e+144,this.logger.log(2,()=>"Special char '"+dc(a)+"' in channel "+i),s=[a]}else t>=32&&t<=127&&(s=e===0?[t]:[t,e]);return s&&this.logger.log(3,()=>"Char codes =  "+Fe(s).join(",")),s}parseBackgroundAttributes(t,e){const i=(t===16||t===24)&&e>=32&&e<=47,s=(t===23||t===31)&&e>=45&&e<=47;if(!(i||s))return!1;let r;const a={};t===16||t===24?(r=Math.floor((e-32)/2),a.background=ev[r],e%2===1&&(a.background=a.background+"_semi")):e===45?a.background="transparent":(a.foreground="black",e===47&&(a.underline=!0));const o=t<=23?1:2;return this.channels[o].setBkgData(a),!0}reset(){for(let t=0;t<Object.keys(this.channels).length;t++){const e=this.channels[t];e&&e.reset()}Js(null,null,this.cmdHistory)}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++){const i=this.channels[e];i&&i.cueSplitAtTime(t)}}}function Js(n,t,e){e.a=n,e.b=t}function rv(n,t,e){return e.a===n&&e.b===t}function av(){return{a:null,b:null}}class tn{constructor(t,e){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=e}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(t,e,i){(this.startTime===null||this.startTime>t)&&(this.startTime=t),this.endTime=e,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var Xr=function(){if(si!=null&&si.VTTCue)return self.VTTCue;const n=["","lr","rl"],t=["start","middle","end","left","right"];function e(o,l){if(typeof l!="string"||!Array.isArray(o))return!1;const h=l.toLowerCase();return~o.indexOf(h)?h:!1}function i(o){return e(n,o)}function s(o){return e(t,o)}function r(o,...l){let h=1;for(;h<arguments.length;h++){const c=arguments[h];for(const u in c)o[u]=c[u]}return o}function a(o,l,h){const c=this,u={enumerable:!0};c.hasBeenReset=!1;let d="",g=!1,f=o,p=l,y=h,v=null,E="",_=!0,T="auto",L="start",w=50,I="middle",D=50,P="middle";Object.defineProperty(c,"id",r({},u,{get:function(){return d},set:function(R){d=""+R}})),Object.defineProperty(c,"pauseOnExit",r({},u,{get:function(){return g},set:function(R){g=!!R}})),Object.defineProperty(c,"startTime",r({},u,{get:function(){return f},set:function(R){if(typeof R!="number")throw new TypeError("Start time must be set to a number.");f=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"endTime",r({},u,{get:function(){return p},set:function(R){if(typeof R!="number")throw new TypeError("End time must be set to a number.");p=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"text",r({},u,{get:function(){return y},set:function(R){y=""+R,this.hasBeenReset=!0}})),Object.defineProperty(c,"region",r({},u,{get:function(){return v},set:function(R){v=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"vertical",r({},u,{get:function(){return E},set:function(R){const k=i(R);if(k===!1)throw new SyntaxError("An invalid or illegal string was specified.");E=k,this.hasBeenReset=!0}})),Object.defineProperty(c,"snapToLines",r({},u,{get:function(){return _},set:function(R){_=!!R,this.hasBeenReset=!0}})),Object.defineProperty(c,"line",r({},u,{get:function(){return T},set:function(R){if(typeof R!="number"&&R!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");T=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"lineAlign",r({},u,{get:function(){return L},set:function(R){const k=s(R);if(!k)throw new SyntaxError("An invalid or illegal string was specified.");L=k,this.hasBeenReset=!0}})),Object.defineProperty(c,"position",r({},u,{get:function(){return w},set:function(R){if(R<0||R>100)throw new Error("Position must be between 0 and 100.");w=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"positionAlign",r({},u,{get:function(){return I},set:function(R){const k=s(R);if(!k)throw new SyntaxError("An invalid or illegal string was specified.");I=k,this.hasBeenReset=!0}})),Object.defineProperty(c,"size",r({},u,{get:function(){return D},set:function(R){if(R<0||R>100)throw new Error("Size must be between 0 and 100.");D=R,this.hasBeenReset=!0}})),Object.defineProperty(c,"align",r({},u,{get:function(){return P},set:function(R){const k=s(R);if(!k)throw new SyntaxError("An invalid or illegal string was specified.");P=k,this.hasBeenReset=!0}})),c.displayState=void 0}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a}();class ov{decode(t,e){if(!t)return"";if(typeof t!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(t))}}function mc(n){function t(i,s,r,a){return(i|0)*3600+(s|0)*60+(r|0)+parseFloat(a||0)}const e=n.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return e?parseFloat(e[2])>59?t(e[2],e[3],0,e[4]):t(e[1],e[2],e[3],e[4]):null}class lv{constructor(){this.values=Object.create(null)}set(t,e){!this.get(t)&&e!==""&&(this.values[t]=e)}get(t,e,i){return i?this.has(t)?this.values[t]:e[i]:this.has(t)?this.values[t]:e}has(t){return t in this.values}alt(t,e,i){for(let s=0;s<i.length;++s)if(e===i[s]){this.set(t,e);break}}integer(t,e){/^-?\d+$/.test(e)&&this.set(t,parseInt(e,10))}percent(t,e){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(e)){const i=parseFloat(e);if(i>=0&&i<=100)return this.set(t,i),!0}return!1}}function yc(n,t,e,i){const s=i?n.split(i):[n];for(const r in s){if(typeof s[r]!="string")continue;const a=s[r].split(e);if(a.length!==2)continue;const o=a[0],l=a[1];t(o,l)}}const Jr=new Xr(0,0,""),en=Jr.align==="middle"?"middle":"center";function hv(n,t,e){const i=n;function s(){const o=mc(n);if(o===null)throw new Error("Malformed timestamp: "+i);return n=n.replace(/^[^\sa-zA-Z-]+/,""),o}function r(o,l){const h=new lv;yc(o,function(d,g){let f;switch(d){case"region":for(let p=e.length-1;p>=0;p--)if(e[p].id===g){h.set(d,e[p].region);break}break;case"vertical":h.alt(d,g,["rl","lr"]);break;case"line":f=g.split(","),h.integer(d,f[0]),h.percent(d,f[0])&&h.set("snapToLines",!1),h.alt(d,f[0],["auto"]),f.length===2&&h.alt("lineAlign",f[1],["start",en,"end"]);break;case"position":f=g.split(","),h.percent(d,f[0]),f.length===2&&h.alt("positionAlign",f[1],["start",en,"end","line-left","line-right","auto"]);break;case"size":h.percent(d,g);break;case"align":h.alt(d,g,["start",en,"end","left","right"]);break}},/:/,/\s/),l.region=h.get("region",null),l.vertical=h.get("vertical","");let c=h.get("line","auto");c==="auto"&&Jr.line===-1&&(c=-1),l.line=c,l.lineAlign=h.get("lineAlign","start"),l.snapToLines=h.get("snapToLines",!0),l.size=h.get("size",100),l.align=h.get("align",en);let u=h.get("position","auto");u==="auto"&&Jr.position===50&&(u=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=u}function a(){n=n.replace(/^\s+/,"")}if(a(),t.startTime=s(),a(),n.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);n=n.slice(3),a(),t.endTime=s(),a(),r(n,t)}function vc(n){return n.replace(/<br(?: \/)?>/gi,`
`)}class cv{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new ov,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(t){const e=this;t&&(e.buffer+=e.decoder.decode(t,{stream:!0}));function i(){let r=e.buffer,a=0;for(r=vc(r);a<r.length&&r[a]!=="\r"&&r[a]!==`
`;)++a;const o=r.slice(0,a);return r[a]==="\r"&&++a,r[a]===`
`&&++a,e.buffer=r.slice(a),o}function s(r){yc(r,function(a,o){},/:/)}try{let r="";if(e.state==="INITIAL"){if(!/\r\n|\n/.test(e.buffer))return this;r=i();const o=r.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(o!=null&&o[0]))throw new Error("Malformed WebVTT signature.");e.state="HEADER"}let a=!1;for(;e.buffer;){if(!/\r\n|\n/.test(e.buffer))return this;switch(a?a=!1:r=i(),e.state){case"HEADER":/:/.test(r)?s(r):r||(e.state="ID");continue;case"NOTE":r||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){e.state="NOTE";break}if(!r)continue;if(e.cue=new Xr(0,0,""),e.state="CUE",r.indexOf("-->")===-1){e.cue.id=r;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{hv(r,e.cue,e.regionList)}catch{e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":{const o=r.indexOf("-->")!==-1;if(!r||o&&(a=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(e.cue===null)continue;e.cue.text&&(e.cue.text+=`
`),e.cue.text+=r}continue;case"BADCUE":r||(e.state="ID")}}}catch{e.state==="CUETEXT"&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state=e.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const t=this;try{if((t.cue||t.state==="HEADER")&&(t.buffer+=`

`,t.parse()),t.state==="INITIAL"||t.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(e){t.onparsingerror&&t.onparsingerror(e)}return t.onflush&&t.onflush(),this}}const uv=/\r\n|\n\r|\n|\r/g,ta=function(n,t,e=0){return n.slice(e,e+t.length)===t},dv=function(n){let t=parseInt(n.slice(-3));const e=parseInt(n.slice(-6,-4)),i=parseInt(n.slice(-9,-7)),s=n.length>9?parseInt(n.substring(0,n.indexOf(":"))):0;if(!$(t)||!$(e)||!$(i)||!$(s))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${n}`);return t+=1e3*e,t+=60*1e3*i,t+=60*60*1e3*s,t},ea=function(n){let t=5381,e=n.length;for(;e;)t=t*33^n.charCodeAt(--e);return(t>>>0).toString()};function ia(n,t,e){return ea(n.toString())+ea(t.toString())+ea(e)}const fv=function(n,t,e){let i=n[t],s=n[i.prevCC];if(!s||!s.new&&i.new){n.ccOffset=n.presentationOffset=i.start,i.new=!1;return}for(;(r=s)!=null&&r.new;){var r;n.ccOffset+=i.start-s.start,i.new=!1,i=s,s=n[i.prevCC]}n.presentationOffset=e};function gv(n,t,e,i,s,r,a){const o=new cv,l=Zt(new Uint8Array(n)).trim().replace(uv,`
`).split(`
`),h=[],c=t?$0(t.baseTime,t.timescale):0;let u="00:00.000",d=0,g=0,f,p=!0;o.oncue=function(y){const v=e[i];let E=e.ccOffset;const _=(d-c)/9e4;if(v!=null&&v.new&&(g!==void 0?E=e.ccOffset=v.start:fv(e,i,_)),_){if(!t){f=new Error("Missing initPTS for VTT MPEGTS");return}E=_-e.presentationOffset}const T=y.endTime-y.startTime,L=Pt((y.startTime+E-g)*9e4,s*9e4)/9e4;y.startTime=Math.max(L,0),y.endTime=Math.max(L+T,0);const w=y.text.trim();y.text=decodeURIComponent(encodeURIComponent(w)),y.id||(y.id=ia(y.startTime,y.endTime,w)),y.endTime>0&&h.push(y)},o.onparsingerror=function(y){f=y},o.onflush=function(){if(f){a(f);return}r(h)},l.forEach(y=>{if(p)if(ta(y,"X-TIMESTAMP-MAP=")){p=!1,y.slice(16).split(",").forEach(v=>{ta(v,"LOCAL:")?u=v.slice(6):ta(v,"MPEGTS:")&&(d=parseInt(v.slice(7)))});try{g=dv(u)/1e3}catch(v){f=v}return}else y===""&&(p=!1);o.parse(y+`
`)}),o.flush()}const sa="stpp.ttml.im1t",Ec=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Tc=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,pv={left:"start",center:"center",right:"end",start:"start",end:"end"};function _c(n,t,e,i){const s=W(new Uint8Array(n),["mdat"]);if(s.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=s.map(o=>Zt(o)),a=O0(t.baseTime,1,t.timescale);try{r.forEach(o=>e(mv(o,a)))}catch(o){i(o)}}function mv(n,t){const e=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("tt")[0];if(!e)throw new Error("Invalid ttml");const i={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},s=Object.keys(i).reduce((h,c)=>(h[c]=e.getAttribute(`ttp:${c}`)||i[c],h),{}),r=e.getAttribute("xml:space")!=="preserve",a=Lc(na(e,"styling","style")),o=Lc(na(e,"layout","region")),l=na(e,"body","[begin]");return[].map.call(l,h=>{const c=Cc(h,r);if(!c||!h.hasAttribute("begin"))return null;const u=aa(h.getAttribute("begin"),s),d=aa(h.getAttribute("dur"),s);let g=aa(h.getAttribute("end"),s);if(u===null)throw bc(h);if(g===null){if(d===null)throw bc(h);g=u+d}const f=new Xr(u-t,g-t,c);f.id=ia(f.startTime,f.endTime,f.text);const p=o[h.getAttribute("region")],y=a[h.getAttribute("style")],v=yv(p,y,a),{textAlign:E}=v;if(E){const _=pv[E];_&&(f.lineAlign=_),f.align=E}return ot(f,v),f}).filter(h=>h!==null)}function na(n,t,e){const i=n.getElementsByTagName(t)[0];return i?[].slice.call(i.querySelectorAll(e)):[]}function Lc(n){return n.reduce((t,e)=>{const i=e.getAttribute("xml:id");return i&&(t[i]=e),t},{})}function Cc(n,t){return[].slice.call(n.childNodes).reduce((e,i,s)=>{var r;return i.nodeName==="br"&&s?e+`
`:(r=i.childNodes)!=null&&r.length?Cc(i,t):t?e+i.textContent.trim().replace(/\s+/g," "):e+i.textContent},"")}function yv(n,t,e){const i="http://www.w3.org/ns/ttml#styling";let s=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=n!=null&&n.hasAttribute("style")?n.getAttribute("style"):null;return a&&e.hasOwnProperty(a)&&(s=e[a]),r.reduce((o,l)=>{const h=ra(t,i,l)||ra(n,i,l)||ra(s,i,l);return h&&(o[l]=h),o},{})}function ra(n,t,e){return n&&n.hasAttributeNS(t,e)?n.getAttributeNS(t,e):null}function bc(n){return new Error(`Could not parse ttml timestamp ${n}`)}function aa(n,t){if(!n)return null;let e=mc(n);return e===null&&(Ec.test(n)?e=vv(n,t):Tc.test(n)&&(e=Ev(n,t))),e}function vv(n,t){const e=Ec.exec(n),i=(e[4]|0)+(e[5]|0)/t.subFrameRate;return(e[1]|0)*3600+(e[2]|0)*60+(e[3]|0)+i/t.frameRate}function Ev(n,t){const e=Tc.exec(n),i=Number(e[1]);switch(e[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/t.frameRate;case"t":return i/t.tickRate}return i}class Sc{constructor(t){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Ac(),this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},t.on(m.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(m.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(m.FRAG_LOADING,this.onFragLoading,this),t.on(m.FRAG_LOADED,this.onFragLoaded,this),t.on(m.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(m.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(m.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(m.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(m.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:t}=this;t.off(m.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(m.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(m.FRAG_LOADING,this.onFragLoading,this),t.off(m.FRAG_LOADED,this.onFragLoaded,this),t.off(m.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.off(m.FRAG_DECRYPTED,this.onFragDecrypted,this),t.off(m.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(m.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.off(m.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const t=new tn(this,"textTrack1"),e=new tn(this,"textTrack2"),i=new tn(this,"textTrack3"),s=new tn(this,"textTrack4");this.cea608Parser1=new pc(1,t,e),this.cea608Parser2=new pc(3,i,s)}}addCues(t,e,i,s,r){let a=!1;for(let o=r.length;o--;){const l=r[o],h=Tv(l[0],l[1],e,i);if(h>=0&&(l[0]=Math.min(l[0],e),l[1]=Math.max(l[1],i),a=!0,h/(i-e)>.5))return}if(a||r.push([e,i]),this.config.renderTextTracksNatively){const o=this.captionsTracks[t];this.Cues.newCue(o,e,i,s)}else{const o=this.Cues.newCue(null,e,i,s);this.hls.trigger(m.CUES_PARSED,{type:"captions",cues:o,track:t})}}onInitPtsFound(t,{frag:e,id:i,initPTS:s,timescale:r}){const{unparsedVttFrags:a}=this;i==="main"&&(this.initPTS[e.cc]={baseTime:s,timescale:r}),a.length&&(this.unparsedVttFrags=[],a.forEach(o=>{this.onFragLoaded(m.FRAG_LOADED,o)}))}getExistingTrack(t,e){const{media:i}=this;if(i)for(let s=0;s<i.textTracks.length;s++){const r=i.textTracks[s];if(Ic(r,{name:t,lang:e}))return r}return null}createCaptionsTrack(t){this.config.renderTextTracksNatively?this.createNativeTrack(t):this.createNonNativeTrack(t)}createNativeTrack(t){if(this.captionsTracks[t])return;const{captionsProperties:e,captionsTracks:i,media:s}=this,{label:r,languageCode:a}=e[t],o=this.getExistingTrack(r,a);if(o)i[t]=o,ri(i[t]),ch(i[t],s);else{const l=this.createTextTrack("captions",r,a);l&&(l[t]=!0,i[t]=l)}}createNonNativeTrack(t){if(this.nonNativeCaptionsTracks[t])return;const e=this.captionsProperties[t];if(!e)return;const i=e.label,s={_id:t,label:i,kind:"captions",default:e.media?!!e.media.default:!1,closedCaptions:e.media};this.nonNativeCaptionsTracks[t]=s,this.hls.trigger(m.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(t,e,i){const s=this.media;if(s)return s.addTextTrack(t,e,i)}onMediaAttaching(t,e){this.media=e.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:t}=this;Object.keys(t).forEach(e=>{ri(t[e]),delete t[e]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Ac(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:t}=this;if(!t)return;const e=t.textTracks;if(e)for(let i=0;i<e.length;i++)ri(e[i])}onSubtitleTracksUpdated(t,e){const i=e.subtitleTracks||[],s=i.some(r=>r.textCodec===sa);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(nc(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const r=this.media,a=r?Ms(r.textTracks):null;if(this.tracks.forEach((o,l)=>{let h;if(a){let c=null;for(let u=0;u<a.length;u++)if(a[u]&&Ic(a[u],o)){c=a[u],a[u]=null;break}c&&(h=c)}if(h)ri(h);else{const c=wc(o);h=this.createTextTrack(c,o.name,o.lang),h&&(h.mode="disabled")}h&&this.textTracks.push(h)}),a!=null&&a.length){const o=a.filter(l=>l!==null).map(l=>l.label);o.length&&C.warn(`Media element contains unused subtitle tracks: ${o.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const r=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(m.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:r})}}}onManifestLoaded(t,e){this.config.enableCEA708Captions&&e.captions&&e.captions.forEach(i=>{const s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!s)return;const r=`textTrack${s[1]}`,a=this.captionsProperties[r];a&&(a.label=i.name,i.lang&&(a.languageCode=i.lang),a.media=i)})}closedCaptionsForLevel(t){const e=this.hls.levels[t.level];return e==null?void 0:e.attrs["CLOSED-CAPTIONS"]}onFragLoading(t,e){if(this.enabled&&e.frag.type===U.MAIN){var i,s;const{cea608Parser1:r,cea608Parser2:a,lastSn:o}=this,{cc:l,sn:h}=e.frag,c=(i=(s=e.part)==null?void 0:s.index)!=null?i:-1;r&&a&&(h!==o+1||h===o&&c!==this.lastPartIndex+1||l!==this.lastCc)&&(r.reset(),a.reset()),this.lastCc=l,this.lastSn=h,this.lastPartIndex=c}}onFragLoaded(t,e){const{frag:i,payload:s}=e;if(i.type===U.SUBTITLE)if(s.byteLength){const r=i.decryptdata,a="stats"in e;if(r==null||!r.encrypted||a){const o=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),o&&o.textCodec===sa?this._parseIMSC1(i,s):this._parseVTTs(e)}}else this.hls.trigger(m.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(t,e){const i=this.hls;_c(e,this.initPTS[t.cc],s=>{this._appendCues(s,t.level),i.trigger(m.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})},s=>{C.log(`Failed to parse IMSC1: ${s}`),i.trigger(m.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:s})})}_parseVTTs(t){var e;const{frag:i,payload:s}=t,{initPTS:r,unparsedVttFrags:a}=this,o=r.length-1;if(!r[i.cc]&&o===-1){a.push(t);return}const l=this.hls,h=(e=i.initSegment)!=null&&e.data?Rt(i.initSegment.data,new Uint8Array(s)):s;gv(h,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,c=>{this._appendCues(c,i.level),l.trigger(m.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},c=>{const u=c.message==="Missing initPTS for VTT MPEGTS";u?a.push(t):this._fallbackToIMSC1(i,s),C.log(`Failed to parse VTT cue: ${c}`),!(u&&o>i.cc)&&l.trigger(m.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:c})})}_fallbackToIMSC1(t,e){const i=this.tracks[t.level];i.textCodec||_c(e,this.initPTS[t.cc],()=>{i.textCodec=sa,this._parseIMSC1(t,e)},()=>{i.textCodec="wvtt"})}_appendCues(t,e){const i=this.hls;if(this.config.renderTextTracksNatively){const s=this.textTracks[e];if(!s||s.mode==="disabled")return;t.forEach(r=>uh(s,r))}else{const s=this.tracks[e];if(!s)return;const r=s.default?"default":"subtitles"+e;i.trigger(m.CUES_PARSED,{type:"subtitles",cues:t,track:r})}}onFragDecrypted(t,e){const{frag:i}=e;i.type===U.SUBTITLE&&this.onFragLoaded(m.FRAG_LOADED,e)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(t,e){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:s}=this;if(!this.enabled||!i||!s)return;const{frag:r,samples:a}=e;if(!(r.type===U.MAIN&&this.closedCaptionsForLevel(r)==="NONE"))for(let o=0;o<a.length;o++){const l=a[o].bytes;if(l){const h=this.extractCea608Data(l);i.addData(a[o].pts,h[0]),s.addData(a[o].pts,h[1])}}}onBufferFlushing(t,{startOffset:e,endOffset:i,endOffsetSubtitles:s,type:r}){const{media:a}=this;if(!(!a||a.currentTime<i)){if(!r||r==="video"){const{captionsTracks:o}=this;Object.keys(o).forEach(l=>Dr(o[l],e,i))}if(this.config.renderTextTracksNatively&&e===0&&s!==void 0){const{textTracks:o}=this;Object.keys(o).forEach(l=>Dr(o[l],e,s))}}}extractCea608Data(t){const e=[[],[]],i=t[0]&31;let s=2;for(let r=0;r<i;r++){const a=t[s++],o=127&t[s++],l=127&t[s++];if(!(o===0&&l===0)&&(4&a)!==0){const h=3&a;(h===0||h===1)&&(e[h].push(o),e[h].push(l))}}return e}}function wc(n){return n.characteristics&&/transcribes-spoken-dialog/gi.test(n.characteristics)&&/describes-music-and-sound/gi.test(n.characteristics)?"captions":"subtitles"}function Ic(n,t){return!!n&&n.kind===wc(t)&&Zr(t,n)}function Tv(n,t,e,i){return Math.min(t,i)-Math.max(n,e)}function Ac(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class sn{constructor(t){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(t){this.streamController=t}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:t}=this;t.on(m.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(m.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(m.MANIFEST_PARSED,this.onManifestParsed,this),t.on(m.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(m.BUFFER_CODECS,this.onBufferCodecs,this),t.on(m.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:t}=this;t.off(m.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(m.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(m.MANIFEST_PARSED,this.onManifestParsed,this),t.off(m.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(m.BUFFER_CODECS,this.onBufferCodecs,this),t.off(m.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){const i=this.hls.levels[e.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(t,e){const i=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,i.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onLevelsUpdated(t,e){this.timer&&$(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const t=this.hls.levels;if(t.length){const e=this.hls,i=this.getMaxLevel(t.length-1);i!==this.autoLevelCapping&&C.log(`Setting autoLevelCapping to ${i}: ${t[i].height}p@${t[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),e.autoLevelCapping=i,e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){const e=this.hls.levels;if(!e.length)return-1;const i=e.filter((s,r)=>this.isLevelAllowed(s)&&r<=t);return this.clientRect=null,sn.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const t=this.media,e={width:0,height:0};if(t){const i=t.getBoundingClientRect();e.width=i.width,e.height=i.height,!e.width&&!e.height&&(e.width=i.right-i.left||t.width||0,e.height=i.bottom-i.top||t.height||0)}return this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch{}return t}isLevelAllowed(t){return!this.restrictedLevels.some(e=>t.bitrate===e.bitrate&&t.width===e.width&&t.height===e.height)}static getMaxLevelByMediaSize(t,e,i){if(!(t!=null&&t.length))return-1;const s=(o,l)=>l?o.width!==l.width||o.height!==l.height:!0;let r=t.length-1;const a=Math.max(e,i);for(let o=0;o<t.length;o+=1){const l=t[o];if((l.width>=a||l.height>=a)&&s(l,t[o+1])){r=o;break}}return r}}class Rc{constructor(t){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}setStreamController(t){this.streamController=t}registerListeners(){this.hls.on(m.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(m.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(t,e){const i=this.hls.config;if(i.capLevelOnFPSDrop){const s=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(t,e,i){const s=performance.now();if(e){if(this.lastTime){const r=s-this.lastTime,a=i-this.lastDroppedFrames,o=e-this.lastDecodedFrames,l=1e3*a/r,h=this.hls;if(h.trigger(m.FPS_DROP,{currentDropped:a,currentDecoded:o,totalDroppedFrames:i}),l>0&&a>h.config.fpsDroppedMonitoringThreshold*o){let c=h.currentLevel;C.warn("drop FPS ratio greater than max allowed value for currentLevel: "+c),c>0&&(h.autoLevelCapping===-1||h.autoLevelCapping>=c)&&(c=c-1,h.trigger(m.FPS_DROP_LEVEL_CAPPING,{level:c,droppedLevel:h.currentLevel}),h.autoLevelCapping=c,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=e}}checkFPSInterval(){const t=this.media;if(t)if(this.isVideoPlaybackQualityAvailable){const e=t.getVideoPlaybackQuality();this.checkFPS(t,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)}}const nn="[eme]";class Ue{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=Ue.CDMCleanupPromise?[Ue.CDMCleanupPromise]:[],this.debug=C.debug.bind(C,nn),this.log=C.log.bind(C,nn),this.warn=C.warn.bind(C,nn),this.error=C.error.bind(C,nn),this.onMediaEncrypted=e=>{const{initDataType:i,initData:s}=e,r=`"${e.type}" event: init data type: "${i}"`;if(this.debug(r),s!==null){if(!this.keyFormatPromise){let a=Object.keys(this.keySystemAccessPromises);a.length||(a=ws(this.config));const o=a.map(_r).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(o)}this.keyFormatPromise.then(a=>{const o=Er(a);let l,h;if(i==="sinf"){if(o!==X.FAIRPLAY){this.warn(`Ignoring unexpected "${e.type}" event with init data type: "${i}" for selected key-system ${o}`);return}const f=dt(new Uint8Array(s));try{const p=yr(JSON.parse(f).sinf),y=Kl(p);if(!y)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=y.subarray(8,24),h=X.FAIRPLAY}catch(p){this.warn(`${r} Failed to parse sinf: ${p}`);return}}else{if(o!==X.WIDEVINE&&o!==X.PLAYREADY){this.warn(`Ignoring unexpected "${e.type}" event with init data type: "${i}" for selected key-system ${o}`);return}const f=ay(s),p=f.filter(v=>!!v.systemId&&Tr(v.systemId)===o);p.length>1&&this.warn(`${r} Using first of ${p.length} pssh found for selected key-system ${o}`);const y=p[0];if(!y){f.length===0||f.some(v=>!v.systemId)?this.warn(`${r} contains incomplete or invalid pssh data`):this.log(`ignoring ${r} for ${f.map(v=>Tr(v.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(h=Tr(y.systemId),y.version===0&&y.data)if(h===X.WIDEVINE){const v=y.data.length-22;l=y.data.subarray(v,v+16)}else h===X.PLAYREADY&&(l=Ol(y.data))}if(!h||!l){this.log(`Unable to handle ${r} with key-system ${o}`);return}const c=Qt.hexDump(l),{keyIdToKeySessionPromise:u,mediaKeySessions:d}=this;let g=u[c];for(let f=0;f<d.length;f++){const p=d[f],y=p.decryptdata;if(!y.keyId)continue;const v=Qt.hexDump(y.keyId);if(c===v||y.uri.replace(/-/g,"").indexOf(c)!==-1){if(g=u[v],y.pssh)break;delete u[v],y.pssh=new Uint8Array(s),y.keyId=l,g=u[c]=g.then(()=>this.generateRequestWithPreferredKeySession(p,i,s,"encrypted-event-key-match")),g.catch(E=>this.handleError(E));break}}if(!g){if(h!==o){this.log(`Ignoring "${r}" with ${h} init data for selected key-system ${o}`);return}g=u[c]=this.getKeySystemSelectionPromise([h]).then(({keySystem:f,mediaKeys:p})=>{var y;this.throwIfDestroyed();const v=new ni("ISO-23001-7",c,(y=_r(f))!=null?y:"");return v.pssh=new Uint8Array(s),v.keyId=l,this.attemptSetMediaKeys(f,p).then(()=>{this.throwIfDestroyed();const E=this.createMediaKeySessionContext({decryptdata:v,keySystem:f,mediaKeys:p});return this.generateRequestWithPreferredKeySession(E,i,s,"encrypted-event-no-match")})}),g.catch(f=>this.handleError(f))}})}},this.onWaitingForKey=e=>{this.log(`"${e.type}" event`)},this.hls=t,this.config=t.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(m.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(m.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(m.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(m.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(m.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(m.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(m.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(m.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(t){const{drmSystems:e,widevineLicenseUrl:i}=this.config,s=e[t];if(s)return s.licenseUrl;if(t===X.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(t){const e=this.getLicenseServerUrl(t);if(e===void 0)throw new Error(`no license server URL configured for key-system "${t}"`);return e}getServerCertificateUrl(t){const{drmSystems:e}=this.config,i=e[t];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${t}"]`)}attemptKeySystemAccess(t){const e=this.hls.levels,i=(a,o,l)=>!!a&&l.indexOf(a)===o,s=e.map(a=>a.audioCodec).filter(i),r=e.map(a=>a.videoCodec).filter(i);return s.length+r.length===0&&r.push("avc1.42e01e"),new Promise((a,o)=>{const l=h=>{const c=h.shift();this.getMediaKeysPromise(c,s,r).then(u=>a({keySystem:c,mediaKeys:u})).catch(u=>{h.length?l(h):u instanceof xt?o(u):o(new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_NO_ACCESS,error:u,fatal:!0},u.message))})};l(t)})}requestMediaKeySystemAccess(t,e){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let s=`Configured requestMediaKeySystemAccess is not a function ${i}`;return Ml===null&&self.location.protocol==="http:"&&(s=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(s))}return i(t,e)}getMediaKeysPromise(t,e,i){const s=O1(t,e,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[t];let a=r==null?void 0:r.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${t}" key-system access with config: ${JSON.stringify(s)}`),a=this.requestMediaKeySystemAccess(t,s);const o=this.keySystemAccessPromises[t]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${t}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const h=this.fetchServerCertificate(t);return this.log(`Create media-keys for "${t}"`),o.mediaKeys=l.createMediaKeys().then(c=>(this.log(`Media-keys created for "${t}"`),h.then(u=>u?this.setMediaKeysServerCertificate(c,t,u):c))),o.mediaKeys.catch(c=>{this.error(`Failed to create media-keys for "${t}"}: ${c}`)}),o.mediaKeys})}return a.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:t,keySystem:e,mediaKeys:i}){this.log(`Creating key-system session "${e}" keyId: ${Qt.hexDump(t.keyId||[])}`);const s=i.createSession(),r={decryptdata:t,keySystem:e,mediaKeys:i,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(t){const e=t.decryptdata;if(e.pssh){const i=this.createMediaKeySessionContext(t),s=this.getKeyIdString(e),r="cenc";this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,r,e.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)}getKeyIdString(t){if(!t)throw new Error("Could not read keyId of undefined decryptdata");if(t.keyId===null)throw new Error("keyId is null");return Qt.hexDump(t.keyId)}updateKeySession(t,e){var i;const s=t.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyID ${Qt.hexDump(((i=t.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${e&&e.byteLength})`),s.update(e)}selectKeySystemFormat(t){const e=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${t.sn} ${t.type}: ${t.level}) key formats ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)),this.keyFormatPromise}getKeyFormatPromise(t){return new Promise((e,i)=>{const s=ws(this.config),r=t.map(Er).filter(a=>!!a&&s.indexOf(a)!==-1);return this.getKeySystemSelectionPromise(r).then(({keySystem:a})=>{const o=_r(a);o?e(o):i(new Error(`Unable to find format for key-system "${a}"`))}).catch(i)})}loadKey(t){const e=t.keyInfo.decryptdata,i=this.getKeyIdString(e),s=`(keyId: ${i} format: "${e.keyFormat}" method: ${e.method} uri: ${e.uri})`;this.log(`Starting session for key ${s}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(e).then(({keySystem:a,mediaKeys:o})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${t.frag.sn} ${t.frag.type}: ${t.frag.level} using key ${s}`),this.attemptSetMediaKeys(a,o).then(()=>{this.throwIfDestroyed();const l=this.createMediaKeySessionContext({keySystem:a,mediaKeys:o,decryptdata:e});return this.generateRequestWithPreferredKeySession(l,"cenc",e.pssh,"playlist-key")}))),r.catch(a=>this.handleError(a))),r}throwIfDestroyed(t="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(t){this.hls&&(this.error(t.message),t instanceof xt?this.hls.trigger(m.ERROR,t.data):this.hls.trigger(m.ERROR,{type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))}getKeySystemForKeyPromise(t){const e=this.getKeyIdString(t),i=this.keyIdToKeySessionPromise[e];if(!i){const s=Er(t.keyFormat),r=s?[s]:ws(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(t){if(t.length||(t=ws(this.config)),t.length===0)throw new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(t)}attemptSetMediaKeys(t,e){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${t}"`);const s=Promise.all(i).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(e)});return this.setMediaKeysQueue.push(s),s.then(()=>{this.log(`Media-keys set for "${t}"`),i.push(s),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(t,e,i,s){var r,a;const o=(r=this.config.drmSystems)==null||(a=r[t.keySystem])==null?void 0:a.generateRequest;if(o)try{const f=o.call(this.hls,e,i,t);if(!f)throw new Error("Invalid response from configured generateRequest filter");e=f.initDataType,i=t.decryptdata.pssh=f.initData?new Uint8Array(f.initData):null}catch(f){var l;if(this.warn(f.message),(l=this.hls)!=null&&l.config.debug)throw f}if(i===null)return this.log(`Skipping key-session request for "${s}" (no initData)`),Promise.resolve(t);const h=this.getKeyIdString(t.decryptdata);this.log(`Generating key-session request for "${s}": ${h} (init data type: ${e} length: ${i?i.byteLength:null})`);const c=new qr,u=t._onmessage=f=>{const p=t.mediaKeysSession;if(!p){c.emit("error",new Error("invalid state"));return}const{messageType:y,message:v}=f;this.log(`"${y}" message event for session "${p.sessionId}" message size: ${v.byteLength}`),y==="license-request"||y==="license-renewal"?this.renewLicense(t,v).catch(E=>{this.handleError(E),c.emit("error",E)}):y==="license-release"?t.keySystem===X.FAIRPLAY&&(this.updateKeySession(t,vr("acknowledged")),this.removeSession(t)):this.warn(`unhandled media key message type "${y}"`)},d=t._onkeystatuseschange=f=>{if(!t.mediaKeysSession){c.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(t);const p=t.keyStatus;c.emit("keyStatus",p),p==="expired"&&(this.warn(`${t.keySystem} expired for key ${h}`),this.renewKeySession(t))};t.mediaKeysSession.addEventListener("message",u),t.mediaKeysSession.addEventListener("keystatuseschange",d);const g=new Promise((f,p)=>{c.on("error",p),c.on("keyStatus",y=>{y.startsWith("usable")?f():y==="output-restricted"?p(new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):y==="internal-error"?p(new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${y}"`)):y==="expired"?p(new Error("key expired while generating request")):this.warn(`unhandled key status change "${y}"`)})});return t.mediaKeysSession.generateRequest(e,i).then(()=>{var f;this.log(`Request generated for key-session "${(f=t.mediaKeysSession)==null?void 0:f.sessionId}" keyId: ${h}`)}).catch(f=>{throw new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_NO_SESSION,error:f,fatal:!1},`Error generating key-session request: ${f}`)}).then(()=>g).catch(f=>{throw c.removeAllListeners(),this.removeSession(t),f}).then(()=>(c.removeAllListeners(),t))}onKeyStatusChange(t){t.mediaKeysSession.keyStatuses.forEach((e,i)=>{this.log(`key status change "${e}" for keyStatuses keyId: ${Qt.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Qt.hexDump(new Uint8Array(t.decryptdata.keyId||[]))} uri: ${t.decryptdata.uri}`),t.keyStatus=e})}fetchServerCertificate(t){const e=this.config,i=e.loader,s=new i(e),r=this.getServerCertificateUrl(t);return r?(this.log(`Fetching server certificate for "${t}"`),new Promise((a,o)=>{const l={responseType:"arraybuffer",url:r},h=e.certLoadPolicy.default,c={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,g,f,p)=>{a(d.data)},onError:(d,g,f,p)=>{o(new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:yt({url:l.url,data:void 0},d)},`"${t}" certificate request failed (${r}). Status: ${d.code} (${d.text})`))},onTimeout:(d,g,f)=>{o(new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:{url:l.url,data:void 0}},`"${t}" certificate request timed out (${r})`))},onAbort:(d,g,f)=>{o(new Error("aborted"))}};s.load(l,c,u)})):Promise.resolve()}setMediaKeysServerCertificate(t,e,i){return new Promise((s,r)=>{t.setServerCertificate(i).then(a=>{this.log(`setServerCertificate ${a?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${e}"`),s(t)}).catch(a=>{r(new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:!0},a.message))})})}renewLicense(t,e){return this.requestLicense(t,new Uint8Array(e)).then(i=>this.updateKeySession(t,new Uint8Array(i)).catch(s=>{throw new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:s,fatal:!0},s.message)}))}unpackPlayReadyKeyMessage(t,e){const i=String.fromCharCode.apply(null,new Uint16Array(e.buffer));if(!i.includes("PlayReadyKeyMessage"))return t.setRequestHeader("Content-Type","text/xml; charset=utf-8"),e;const s=new DOMParser().parseFromString(i,"application/xml"),r=s.querySelectorAll("HttpHeader");if(r.length>0){let c;for(let u=0,d=r.length;u<d;u++){var a,o;c=r[u];const g=(a=c.querySelector("name"))==null?void 0:a.textContent,f=(o=c.querySelector("value"))==null?void 0:o.textContent;g&&f&&t.setRequestHeader(g,f)}}const l=s.querySelector("Challenge"),h=l==null?void 0:l.textContent;if(!h)throw new Error("Cannot find <Challenge> in key message");return vr(atob(h))}setupLicenseXHR(t,e,i,s){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,t,e,i,s)}).catch(a=>{if(!i.decryptdata)throw a;return t.open("POST",e,!0),r.call(this.hls,t,e,i,s)}).then(a=>(t.readyState||t.open("POST",e,!0),{xhr:t,licenseChallenge:a||s})):(t.open("POST",e,!0),Promise.resolve({xhr:t,licenseChallenge:s}))}requestLicense(t,e){const i=this.config.keyLoadPolicy.default;return new Promise((s,r)=>{const a=this.getLicenseServerUrlOrThrow(t.keySystem);this.log(`Sending license request to URL: ${a}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!t.mediaKeysSession)return r(new Error("invalid state"));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let l=o.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const h=this.config.licenseResponseCallback;if(h)try{l=h.call(this.hls,o,a,t)}catch(c){this.error(c)}s(l)}else{const l=i.errorRetry,h=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>h||o.status>=400&&o.status<500)r(new xt({type:G.KEY_SYSTEM_ERROR,details:S.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:a,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${a}). Status: ${o.status} (${o.statusText})`));else{const c=h-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${c} attempts left`),this.requestLicense(t,e).then(s,r)}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=o,this.setupLicenseXHR(o,a,t,e).then(({xhr:l,licenseChallenge:h})=>{t.keySystem==X.PLAYREADY&&(h=this.unpackPlayReadyKeyMessage(l,h)),l.send(h)})})}onMediaAttached(t,e){if(!this.config.emeEnabled)return;const i=e.media;this.media=i,i.removeEventListener("encrypted",this.onMediaEncrypted),i.removeEventListener("waitingforkey",this.onWaitingForKey),i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const t=this.media,e=this.mediaKeySessions;t&&(t.removeEventListener("encrypted",this.onMediaEncrypted),t.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},ni.clearKeyUriToKeyIdMap();const i=e.length;Ue.CDMCleanupPromise=Promise.all(e.map(s=>this.removeSession(s)).concat(t==null?void 0:t.setMediaKeys(null).catch(s=>{this.log(`Could not clear media keys: ${s}`)}))).then(()=>{i&&(this.log("finished closing key sessions and clearing media keys"),e.length=0)}).catch(s=>{this.log(`Could not close sessions and clear media keys: ${s}`)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(t,{sessionKeys:e}){if(!(!e||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=e.reduce((s,r)=>(s.indexOf(r.keyFormat)===-1&&s.push(r.keyFormat),s),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(t){const{mediaKeysSession:e,licenseXhr:i}=t;if(e){this.log(`Remove licenses and keys and close session ${e.sessionId}`),t._onmessage&&(e.removeEventListener("message",t._onmessage),t._onmessage=void 0),t._onkeystatuseschange&&(e.removeEventListener("keystatuseschange",t._onkeystatuseschange),t._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;const s=this.mediaKeySessions.indexOf(t);return s>-1&&this.mediaKeySessions.splice(s,1),e.remove().catch(r=>{this.log(`Could not remove session: ${r}`)}).then(()=>e.close()).catch(r=>{this.log(`Could not close session: ${r}`)})}}}Ue.CDMCleanupPromise=void 0;class xt extends Error{constructor(t,e){super(e),this.data=void 0,t.error||(t.error=new Error(e)),this.data=t,t.err=t.error}}var _t;(function(n){n.MANIFEST="m",n.AUDIO="a",n.VIDEO="v",n.MUXED="av",n.INIT="i",n.CAPTION="c",n.TIMED_TEXT="tt",n.KEY="k",n.OTHER="o"})(_t||(_t={}));var oa;(function(n){n.DASH="d",n.HLS="h",n.SMOOTH="s",n.OTHER="o"})(oa||(oa={}));var Be;(function(n){n.OBJECT="CMCD-Object",n.REQUEST="CMCD-Request",n.SESSION="CMCD-Session",n.STATUS="CMCD-Status"})(Be||(Be={}));const _v={[Be.OBJECT]:["br","d","ot","tb"],[Be.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[Be.SESSION]:["cid","pr","sf","sid","st","v"],[Be.STATUS]:["bs","rtp"]};class ci{constructor(t,e){this.value=void 0,this.params=void 0,Array.isArray(t)&&(t=t.map(i=>i instanceof ci?i:new ci(i))),this.value=t,this.params=e}}class kc{constructor(t){this.description=void 0,this.description=t}}const Lv="Dict";function Cv(n){return Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":typeof n=="object"?JSON.stringify(n):String(n)}function bv(n,t,e,i){return new Error(`failed to ${n} "${Cv(t)}" as ${e}`,{cause:i})}const Dc="Bare Item",Sv="Boolean",wv="Byte Sequence",Iv="Decimal",Av="Integer";function Rv(n){return n<-999999999999999||999999999999999<n}const kv=/[\x00-\x1f\x7f]+/,Dv="Token",Pv="Key";function ie(n,t,e){return bv("serialize",n,t,e)}function xv(n){if(typeof n!="boolean")throw ie(n,Sv);return n?"?1":"?0"}function Mv(n){return btoa(String.fromCharCode(...n))}function Ov(n){if(ArrayBuffer.isView(n)===!1)throw ie(n,wv);return`:${Mv(n)}:`}function Pc(n){if(Rv(n))throw ie(n,Av);return n.toString()}function $v(n){return`@${Pc(n.getTime()/1e3)}`}function xc(n,t){if(n<0)return-xc(-n,t);const e=Math.pow(10,t);if(Math.abs(n*e%1-.5)<Number.EPSILON){const i=Math.floor(n*e);return(i%2===0?i:i+1)/e}else return Math.round(n*e)/e}function Nv(n){const t=xc(n,3);if(Math.floor(Math.abs(t)).toString().length>12)throw ie(n,Iv);const e=t.toString();return e.includes(".")?e:`${e}.0`}const Fv="String";function Uv(n){if(kv.test(n))throw ie(n,Fv);return`"${n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function Bv(n){return n.description||n.toString().slice(7,-1)}function Mc(n){const t=Bv(n);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t)===!1)throw ie(t,Dv);return t}function la(n){switch(typeof n){case"number":if(!$(n))throw ie(n,Dc);return Number.isInteger(n)?Pc(n):Nv(n);case"string":return Uv(n);case"symbol":return Mc(n);case"boolean":return xv(n);case"object":if(n instanceof Date)return $v(n);if(n instanceof Uint8Array)return Ov(n);if(n instanceof kc)return Mc(n);default:throw ie(n,Dc)}}function ha(n){if(/^[a-z*][a-z0-9\-_.*]*$/.test(n)===!1)throw ie(n,Pv);return n}function ca(n){return n==null?"":Object.entries(n).map(([t,e])=>e===!0?`;${ha(t)}`:`;${ha(t)}=${la(e)}`).join("")}function Oc(n){return n instanceof ci?`${la(n.value)}${ca(n.params)}`:la(n)}function Gv(n){return`(${n.value.map(Oc).join(" ")})${ca(n.params)}`}function Vv(n,t={whitespace:!0}){if(typeof n!="object")throw ie(n,Lv);const e=n instanceof Map?n.entries():Object.entries(n),i=t!=null&&t.whitespace?" ":"";return Array.from(e).map(([s,r])=>{r instanceof ci||(r=new ci(r));let a=ha(s);return r.value===!0?a+=ca(r.params):(a+="=",Array.isArray(r.value)?a+=Gv(r):a+=Oc(r)),a}).join(`,${i}`)}function Hv(n,t){return Vv(n,t)}const Kv=n=>n==="ot"||n==="sf"||n==="st",Wv=n=>typeof n=="number"?$(n):n!=null&&n!==""&&n!==!1;function zv(n,t){const e=new URL(n),i=new URL(t);if(e.origin!==i.origin)return n;const s=e.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;s[0]===r[0];)s.shift(),r.shift();for(;r.length;)r.shift(),s.unshift("..");return s.join("/")}function Yv(){try{return crypto.randomUUID()}catch{try{const n=URL.createObjectURL(new Blob),t=n.toString();return URL.revokeObjectURL(n),t.slice(t.lastIndexOf("/")+1)}catch{let n=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=(n+Math.random()*16)%16|0;return n=Math.floor(n/16),(t=="x"?e:e&3|8).toString(16)})}}}const rn=n=>Math.round(n),jv=(n,t)=>(t!=null&&t.baseUrl&&(n=zv(n,t.baseUrl)),encodeURIComponent(n)),an=n=>rn(n/100)*100,qv={br:rn,d:rn,bl:an,dl:an,mtp:an,nor:jv,rtp:an,tb:rn};function Zv(n,t){const e={};if(n==null||typeof n!="object")return e;const i=Object.keys(n).sort(),s=ot({},qv,t==null?void 0:t.formatters),r=t==null?void 0:t.filter;return i.forEach(a=>{if(r!=null&&r(a))return;let o=n[a];const l=s[a];l&&(o=l(o,t)),!(a==="v"&&o===1)&&(a=="pr"&&o===1||Wv(o)&&(Kv(a)&&typeof o=="string"&&(o=new kc(o)),e[a]=o))}),e}function $c(n,t={}){return n?Hv(Zv(n,t),ot({whitespace:!1},t)):""}function Qv(n,t={}){if(!n)return{};const e=Object.entries(n),i=Object.entries(_v).concat(Object.entries((t==null?void 0:t.customHeaderMap)||{})),s=e.reduce((r,a)=>{var o;const[l,h]=a,c=((o=i.find(u=>u[1].includes(l)))==null?void 0:o[0])||Be.REQUEST;return r[c]!=null||(r[c]={}),r[c][l]=h,r},{});return Object.entries(s).reduce((r,[a,o])=>(r[a]=$c(o,t),r),{})}function Xv(n,t,e){return ot(n,Qv(t,e))}const Jv="CMCD";function t2(n,t={}){if(!n)return"";const e=$c(n,t);return`${Jv}=${encodeURIComponent(e)}`}const Nc=/CMCD=[^&#]+/;function e2(n,t,e){const i=t2(t,e);if(!i)return n;if(Nc.test(n))return n.replace(Nc,i);const s=n.includes("?")?"&":"?";return`${n}${s}${i}`}class Fc{constructor(t){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=s=>{try{this.apply(s,{ot:_t.MANIFEST,su:!this.initialized})}catch(r){C.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=s=>{try{const r=s.frag,a=this.hls.levels[r.level],o=this.getObjectType(r),l={d:r.duration*1e3,ot:o};(o===_t.VIDEO||o===_t.AUDIO||o==_t.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(o)/1e3,l.bl=this.getBufferLength(o)),this.apply(s,l)}catch(r){C.warn("Could not generate segment CMCD data.",r)}},this.hls=t;const e=this.config=t.config,{cmcd:i}=e;i!=null&&(e.pLoader=this.createPlaylistLoader(),e.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||Yv(),this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const t=this.hls;t.on(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(m.MEDIA_DETACHED,this.onMediaDetached,this),t.on(m.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const t=this.hls;t.off(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(m.MEDIA_DETACHED,this.onMediaDetached,this),t.off(m.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(t,e){var i,s;this.audioBuffer=(i=e.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(s=e.tracks.video)==null?void 0:s.buffer}createData(){var t;return{v:1,sf:oa.HLS,sid:this.sid,cid:this.cid,pr:(t=this.media)==null?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(t,e={}){ot(e,this.createData());const i=e.ot===_t.INIT||e.ot===_t.VIDEO||e.ot===_t.MUXED;this.starved&&i&&(e.bs=!0,e.su=!0,this.starved=!1),e.su==null&&(e.su=this.buffering);const{includeKeys:s}=this;s&&(e=Object.keys(e).reduce((r,a)=>(s.includes(a)&&(r[a]=e[a]),r),{})),this.useHeaders?(t.headers||(t.headers={}),Xv(t.headers,e)):t.url=e2(t.url,e)}getObjectType(t){const{type:e}=t;if(e==="subtitle")return _t.TIMED_TEXT;if(t.sn==="initSegment")return _t.INIT;if(e==="audio")return _t.AUDIO;if(e==="main")return this.hls.audioTracks.length?_t.VIDEO:_t.MUXED}getTopBandwidth(t){let e=0,i;const s=this.hls;if(t===_t.AUDIO)i=s.audioTracks;else{const r=s.maxAutoLevel,a=r>-1?r+1:s.levels.length;i=s.levels.slice(0,a)}for(const r of i)r.bitrate>e&&(e=r.bitrate);return e>0?e:NaN}getBufferLength(t){const e=this.hls.media,i=t===_t.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!e?NaN:st.bufferInfo(i,e.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:t}=this.config,e=this.applyPlaylistData,i=t||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,r,a){e(s),this.loader.load(s,r,a)}}}createFragmentLoader(){const{fLoader:t}=this.config,e=this.applyFragmentData,i=t||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,r,a){e(s),this.loader.load(s,r,a)}}}}const i2=3e5;class Uc{constructor(t){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.log=C.log.bind(C,"[content-steering]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(m.MANIFEST_PARSED,this.onManifestParsed,this),t.on(m.ERROR,this.onError,this)}unregisterListeners(){const t=this.hls;t&&(t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(m.MANIFEST_PARSED,this.onManifestParsed,this),t.off(m.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const t=this.timeToLoad*1e3-(performance.now()-this.updated);if(t>0){this.scheduleRefresh(this.uri,t);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(t){const e=this.levels;e&&(this.levels=e.filter(i=>i!==t))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(t,e){const{contentSteering:i}=e;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(t,e){this.audioTracks=e.audioTracks,this.subtitleTracks=e.subtitleTracks}onError(t,e){const{errorAction:i}=e;if((i==null?void 0:i.action)===vt.SendAlternateToPenaltyBox&&i.flags===Dt.MoveAllAlternatesMatchingHost){const s=this.levels;let r=this.pathwayPriority,a=this.pathwayId;if(e.context){const{groupId:o,pathwayId:l,type:h}=e.context;o&&s?a=this.getPathwayForGroupId(o,h,a):l&&(a=l)}a in this.penalizedPathways||(this.penalizedPathways[a]=performance.now()),!r&&s&&(r=s.reduce((o,l)=>(o.indexOf(l.pathwayId)===-1&&o.push(l.pathwayId),o),[])),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==a),i.resolved||C.warn(`Could not resolve ${e.details} ("${e.error.message}") with content-steering for Pathway: ${a} levels: ${s&&s.length} priorities: ${JSON.stringify(r)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(t){this.levels=t;let e=this.getLevelsForPathway(this.pathwayId);if(e.length===0){const i=t[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),e=this.getLevelsForPathway(i),this.pathwayId=i}return e.length!==t.length&&this.log(`Found ${e.length}/${t.length} levels in Pathway "${this.pathwayId}"`),e}getLevelsForPathway(t){return this.levels===null?[]:this.levels.filter(e=>t===e.pathwayId)}updatePathwayPriority(t){this.pathwayPriority=t;let e;const i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(r=>{s-i[r]>i2&&delete i[r]});for(let r=0;r<t.length;r++){const a=t[r];if(a in i)continue;if(a===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(e=this.getLevelsForPathway(a),e.length>0){this.log(`Setting Pathway to "${a}"`),this.pathwayId=a,Eh(e),this.hls.trigger(m.LEVELS_UPDATED,{levels:e});const h=this.hls.levels[o];l&&h&&this.levels&&(h.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&h.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${h.bitrate}`),this.hls.nextLoadLevel=o);break}}}getPathwayForGroupId(t,e,i){const s=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<s.length;r++)if(e===Q.AUDIO_TRACK&&s[r].hasAudioGroup(t)||e===Q.SUBTITLE_TRACK&&s[r].hasSubtitleGroup(t))return s[r].pathwayId;return i}clonePathways(t){const e=this.levels;if(!e)return;const i={},s={};t.forEach(r=>{const{ID:a,"BASE-ID":o,"URI-REPLACEMENT":l}=r;if(e.some(c=>c.pathwayId===a))return;const h=this.getLevelsForPathway(o).map(c=>{const u=new nt(c.attrs);u["PATHWAY-ID"]=a;const d=u.AUDIO&&`${u.AUDIO}_clone_${a}`,g=u.SUBTITLES&&`${u.SUBTITLES}_clone_${a}`;d&&(i[u.AUDIO]=d,u.AUDIO=d),g&&(s[u.SUBTITLES]=g,u.SUBTITLES=g);const f=Gc(c.uri,u["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),p=new Oe({attrs:u,audioCodec:c.audioCodec,bitrate:c.bitrate,height:c.height,name:c.name,url:f,videoCodec:c.videoCodec,width:c.width});if(c.audioGroups)for(let y=1;y<c.audioGroups.length;y++)p.addGroupId("audio",`${c.audioGroups[y]}_clone_${a}`);if(c.subtitleGroups)for(let y=1;y<c.subtitleGroups.length;y++)p.addGroupId("text",`${c.subtitleGroups[y]}_clone_${a}`);return p});e.push(...h),Bc(this.audioTracks,i,l,a),Bc(this.subtitleTracks,s,l,a)})}loadSteeringManifest(t){const e=this.hls.config,i=e.loader;this.loader&&this.loader.destroy(),this.loader=new i(e);let s;try{s=new self.URL(t)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${t}`);return}if(s.protocol!=="data:"){const c=(this.hls.bandwidthEstimate||e.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+c)}const r={responseType:"json",url:s.href},a=e.steeringManifestLoadPolicy.default,o=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},h={onSuccess:(c,u,d,g)=>{this.log(`Loaded steering manifest: "${s}"`);const f=c.data;if(f.VERSION!==1){this.log(`Steering VERSION ${f.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=f.TTL;const{"RELOAD-URI":p,"PATHWAY-CLONES":y,"PATHWAY-PRIORITY":v}=f;if(p)try{this.uri=new self.URL(p,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${p}`);return}this.scheduleRefresh(this.uri||d.url),y&&this.clonePathways(y);const E={steeringManifest:f,url:s.toString()};this.hls.trigger(m.STEERING_MANIFEST_LOADED,E),v&&this.updatePathwayPriority(v)},onError:(c,u,d,g)=>{if(this.log(`Error loading steering manifest: ${c.code} ${c.text} (${u.url})`),this.stopLoad(),c.code===410){this.enabled=!1,this.log(`Steering manifest ${u.url} no longer available`);return}let f=this.timeToLoad*1e3;if(c.code===429){const p=this.loader;if(typeof(p==null?void 0:p.getResponseHeader)=="function"){const y=p.getResponseHeader("Retry-After");y&&(f=parseFloat(y)*1e3)}this.log(`Steering manifest ${u.url} rate limited`);return}this.scheduleRefresh(this.uri||u.url,f)},onTimeout:(c,u,d)=>{this.log(`Timeout loading steering manifest (${u.url})`),this.scheduleRefresh(this.uri||u.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(r,l,h)}scheduleRefresh(t,e=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const s=(i=this.hls)==null?void 0:i.media;if(s&&!s.ended){this.loadSteeringManifest(t);return}this.scheduleRefresh(t,this.timeToLoad*1e3)},e)}}function Bc(n,t,e,i){n&&Object.keys(t).forEach(s=>{const r=n.filter(a=>a.groupId===s).map(a=>{const o=ot({},a);return o.details=void 0,o.attrs=new nt(o.attrs),o.url=o.attrs.URI=Gc(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",e),o.groupId=o.attrs["GROUP-ID"]=t[s],o.attrs["PATHWAY-ID"]=i,o});n.push(...r)})}function Gc(n,t,e,i){const{HOST:s,PARAMS:r,[e]:a}=i;let o;t&&(o=a==null?void 0:a[t],o&&(n=o));const l=new self.URL(n);return s&&!o&&(l.host=s),r&&Object.keys(r).sort().forEach(h=>{h&&l.searchParams.set(h,r[h])}),l.href}const s2=/^age:\s*[\d.]+\s*$/im;class Vc{constructor(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new Pi,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,t.readyState!==4&&(this.stats.aborted=!0,t.abort()))}abort(){var t;this.abortInternal(),(t=this.callbacks)!=null&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(t,e,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=t,this.config=e,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:t,context:e}=this;if(!t||!e)return;const i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return r(i,e.url)}).catch(a=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",e.url,!0),r(i,e.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,e,t)}).catch(a=>{this.callbacks.onError({code:i.status,text:a.message},e,i,s)}):this.openAndSendXhr(i,e,t)}openAndSendXhr(t,e,i){t.readyState||t.open("GET",e.url,!0);const s=e.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:a}=i.loadPolicy;if(s)for(const o in s)t.setRequestHeader(o,s[o]);e.rangeEnd&&t.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),t.onreadystatechange=this.readystatechange.bind(this),t.onprogress=this.loadprogress.bind(this),t.responseType=e.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&$(r)?r:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),t.send()}readystatechange(){const{context:t,loader:e,stats:i}=this;if(!t||!e)return;const s=e.readyState,r=this.config;if(!i.aborted&&s>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;const a=e.status,o=e.responseType==="text"?e.responseText:null;if(a>=200&&a<300){const u=o??e.response;if(u!=null){i.loading.end=Math.max(self.performance.now(),i.loading.first);const d=e.responseType==="arraybuffer"?u.byteLength:u.length;if(i.loaded=i.total=d,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first),!this.callbacks)return;const g=this.callbacks.onProgress;if(g&&g(i,t,u,e),!this.callbacks)return;const f={url:e.responseURL,data:u,code:a};this.callbacks.onSuccess(f,i,t,e);return}}const l=r.loadPolicy.errorRetry,h=i.retry,c={url:t.url,data:void 0,code:a};Fs(l,h,!1,c)?this.retry(l):(C.error(`${a} while loading ${t.url}`),this.callbacks.onError({code:a,text:e.statusText},t,e,i))}}loadtimeout(){if(!this.config)return;const t=this.config.loadPolicy.timeoutRetry,e=this.stats.retry;if(Fs(t,e,!0))this.retry(t);else{var i;C.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const s=this.callbacks;s&&(this.abortInternal(),s.onTimeout(this.stats,this.context,this.loader))}}retry(t){const{context:e,stats:i}=this;this.retryDelay=Fr(t,i.retry),i.retry++,C.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${e==null?void 0:e.url}, retrying ${i.retry}/${t.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(t){const e=this.stats;e.loaded=t.loaded,t.lengthComputable&&(e.total=t.total)}getCacheAge(){let t=null;if(this.loader&&s2.test(this.loader.getAllResponseHeaders())){const e=this.loader.getResponseHeader("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.loader&&new RegExp(`^${t}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(t):null}}function n2(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const r2=/(\d+)-(\d+)\/(\d+)/;class Hc{constructor(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||h2,this.controller=new self.AbortController,this.stats=new Pi}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var t;this.abortInternal(),(t=this.callbacks)!=null&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(t,e,i){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const r=a2(t,this.controller.signal),a=i.onProgress,o=t.responseType==="arraybuffer",l=o?"byteLength":"length",{maxTimeToFirstByteMs:h,maxLoadTimeMs:c}=e.loadPolicy;this.context=t,this.config=e,this.callbacks=i,this.request=this.fetchSetup(t,r),self.clearTimeout(this.requestTimeout),e.timeout=h&&$(h)?h:c,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,t,this.response)},e.timeout),self.fetch(this.request).then(u=>{this.response=this.loader=u;const d=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),e.timeout=c,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,t,this.response)},c-(d-s.loading.start)),!u.ok){const{status:g,statusText:f}=u;throw new c2(f||"fetch, bad network response",g,u)}return s.loading.first=d,s.total=l2(u.headers)||s.total,a&&$(e.highWaterMark)?this.loadProgressively(u,s,t,e.highWaterMark,a):o?u.arrayBuffer():t.responseType==="json"?u.json():u.text()}).then(u=>{const d=this.response;if(!d)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);const g=u[l];g&&(s.loaded=s.total=g);const f={url:d.url,data:u,code:d.status};a&&!$(e.highWaterMark)&&a(s,t,u,d),i.onSuccess(f,s,t,d)}).catch(u=>{if(self.clearTimeout(this.requestTimeout),s.aborted)return;const d=u&&u.code||0,g=u?u.message:null;i.onError({code:d,text:g},t,u?u.details:null,s)})}getCacheAge(){let t=null;if(this.response){const e=this.response.headers.get("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.response?this.response.headers.get(t):null}loadProgressively(t,e,i,s=0,r){const a=new xh,o=t.body.getReader(),l=()=>o.read().then(h=>{if(h.done)return a.dataLength&&r(e,i,a.flush(),t),Promise.resolve(new ArrayBuffer(0));const c=h.value,u=c.length;return e.loaded+=u,u<s||a.dataLength?(a.push(c),a.dataLength>=s&&r(e,i,a.flush(),t)):r(e,i,c,t),l()}).catch(()=>Promise.reject());return l()}}function a2(n,t){const e={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(ot({},n.headers))};return n.rangeEnd&&e.headers.set("Range","bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)),e}function o2(n){const t=r2.exec(n);if(t)return parseInt(t[2])-parseInt(t[1])+1}function l2(n){const t=n.get("Content-Range");if(t){const i=o2(t);if($(i))return i}const e=n.get("Content-Length");if(e)return parseInt(e)}function h2(n,t){return new self.Request(n.url,t)}class c2 extends Error{constructor(t,e,i){super(t),this.code=void 0,this.details=void 0,this.code=e,this.details=i}}const u2=/\s/,d2={newCue(n,t,e,i){const s=[];let r,a,o,l,h;const c=self.VTTCue||self.TextTrackCue;for(let d=0;d<i.rows.length;d++)if(r=i.rows[d],o=!0,l=0,h="",!r.isEmpty()){var u;for(let p=0;p<r.chars.length;p++)u2.test(r.chars[p].uchar)&&o?l++:(h+=r.chars[p].uchar,o=!1);r.cueStartTime=t,t===e&&(e+=1e-4),l>=16?l--:l++;const g=vc(h.trim()),f=ia(t,e,g);n!=null&&(u=n.cues)!=null&&u.getCueById(f)||(a=new c(t,e,g),a.id=f,a.line=d+1,a.align="left",a.position=10+Math.min(80,Math.floor(l*8/32)*10),s.push(a))}return n&&s.length&&(s.sort((d,g)=>d.line==="auto"||g.line==="auto"?0:d.line>8&&g.line>8?g.line-d.line:d.line-g.line),s.forEach(d=>uh(n,d))),s}},f2={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Kc=yt(yt({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Vc,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Ih,bufferController:cc,capLevelController:sn,errorController:Ch,fpsController:Rc,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Ml,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:f2},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},g2()),{},{subtitleStreamController:oc,subtitleTrackController:lc,timelineController:Sc,audioStreamController:sc,audioTrackController:rc,emeController:Ue,cmcdController:Fc,contentSteeringController:Uc});function g2(){return{cueHandler:d2,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function p2(n,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(t.liveMaxLatencyDurationCount!==void 0&&(t.liveSyncDurationCount===void 0||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(t.liveMaxLatencyDuration!==void 0&&(t.liveSyncDuration===void 0||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const e=ua(n),i=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return i.forEach(r=>{const a=`${r==="level"?"playlist":r}LoadPolicy`,o=t[a]===void 0,l=[];s.forEach(h=>{const c=`${r}Loading${h}`,u=t[c];if(u!==void 0&&o){l.push(c);const d=e[a].default;switch(t[a]={default:d},h){case"TimeOut":d.maxLoadTimeMs=u,d.maxTimeToFirstByteMs=u;break;case"MaxRetry":d.errorRetry.maxNumRetry=u,d.timeoutRetry.maxNumRetry=u;break;case"RetryDelay":d.errorRetry.retryDelayMs=u,d.timeoutRetry.retryDelayMs=u;break;case"MaxRetryTimeout":d.errorRetry.maxRetryDelayMs=u,d.timeoutRetry.maxRetryDelayMs=u;break}}}),l.length&&C.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${JSON.stringify(t[a])}`)}),yt(yt({},e),t)}function ua(n){return n&&typeof n=="object"?Array.isArray(n)?n.map(ua):Object.keys(n).reduce((t,e)=>(t[e]=ua(n[e]),t),{}):n}function m2(n){const t=n.loader;t!==Hc&&t!==Vc?(C.log("[config]: Custom loader detected, cannot enable progressive streaming"),n.progressive=!1):n2()&&(n.loader=Hc,n.progressive=!0,n.enableSoftwareAES=!0,C.log("[config]: Progressive streaming enabled, using FetchLoader"))}let da;class y2 extends Bs{constructor(t,e){super(t,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=e,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(m.LEVEL_LOADED,this.onLevelLoaded,this),t.on(m.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(m.FRAG_BUFFERED,this.onFragBuffered,this),t.on(m.ERROR,this.onError,this)}_unregisterListeners(){const{hls:t}=this;t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(m.LEVEL_LOADED,this.onLevelLoaded,this),t.off(m.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(m.FRAG_BUFFERED,this.onFragBuffered,this),t.off(m.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(t,e){this.resetLevels()}onManifestLoaded(t,e){const i=this.hls.config.preferManagedMediaSource,s=[],r={},a={};let o=!1,l=!1,h=!1;e.levels.forEach(c=>{var u,d;const g=c.attrs;let{audioCodec:f,videoCodec:p}=c;((u=f)==null?void 0:u.indexOf("mp4a.40.34"))!==-1&&(da||(da=/chrome|firefox/i.test(navigator.userAgent)),da&&(c.audioCodec=f=void 0)),f&&(c.audioCodec=f=xs(f,i)),((d=p)==null?void 0:d.indexOf("avc1"))===0&&(p=c.videoCodec=gy(p));const{width:y,height:v,unknownCodecs:E}=c;if(o||(o=!!(y&&v)),l||(l=!!p),h||(h=!!f),E!=null&&E.length||f&&!Ar(f,"audio",i)||p&&!Ar(p,"video",i))return;const{CODECS:_,"FRAME-RATE":T,"HDCP-LEVEL":L,"PATHWAY-ID":w,RESOLUTION:I,"VIDEO-RANGE":D}=g,P=`${`${w||"."}-`}${c.bitrate}-${I}-${T}-${_}-${D}-${L}`;if(r[P])if(r[P].uri!==c.url&&!c.attrs["PATHWAY-ID"]){const R=a[P]+=1;c.attrs["PATHWAY-ID"]=new Array(R+1).join(".");const k=new Oe(c);r[P]=k,s.push(k)}else r[P].addGroupId("audio",g.AUDIO),r[P].addGroupId("text",g.SUBTITLES);else{const R=new Oe(c);r[P]=R,a[P]=1,s.push(R)}}),this.filterAndSortMediaOptions(s,e,o,l,h)}filterAndSortMediaOptions(t,e,i,s,r){let a=[],o=[],l=t;if((i||s)&&r&&(l=l.filter(({videoCodec:f,videoRange:p,width:y,height:v})=>(!!f||!!(y&&v))&&Iy(p))),l.length===0){Promise.resolve().then(()=>{if(this.hls){e.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(e.levels[0].attrs)}`);const f=new Error("no level with compatible codecs found in manifest");this.hls.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,error:f,reason:f.message})}});return}if(e.audioTracks){const{preferManagedMediaSource:f}=this.hls.config;a=e.audioTracks.filter(p=>!p.audioCodec||Ar(p.audioCodec,"audio",f)),Wc(a)}e.subtitles&&(o=e.subtitles,Wc(o));const h=l.slice(0);l.sort((f,p)=>{if(f.attrs["HDCP-LEVEL"]!==p.attrs["HDCP-LEVEL"])return(f.attrs["HDCP-LEVEL"]||"")>(p.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&f.height!==p.height)return f.height-p.height;if(f.frameRate!==p.frameRate)return f.frameRate-p.frameRate;if(f.videoRange!==p.videoRange)return $s.indexOf(f.videoRange)-$s.indexOf(p.videoRange);if(f.videoCodec!==p.videoCodec){const y=Xl(f.videoCodec),v=Xl(p.videoCodec);if(y!==v)return v-y}if(f.uri===p.uri&&f.codecSet!==p.codecSet){const y=Ps(f.codecSet),v=Ps(p.codecSet);if(y!==v)return v-y}return f.averageBitrate!==p.averageBitrate?f.averageBitrate-p.averageBitrate:0});let c=h[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==h.length)){for(let f=0;f<h.length;f++)if(h[f].pathwayId===l[0].pathwayId){c=h[f];break}}this._levels=l;for(let f=0;f<l.length;f++)if(l[f]===c){var u;this._firstLevel=f;const p=c.bitrate,y=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${p}`),((u=this.hls.userConfig)==null?void 0:u.abrEwmaDefaultEstimate)===void 0){const v=Math.min(p,this.hls.config.abrEwmaDefaultEstimateMax);v>y&&y===Kc.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=v)}break}const d=r&&!s,g={levels:l,audioTracks:a,subtitleTracks:o,sessionData:e.sessionData,sessionKeys:e.sessionKeys,firstLevel:this._firstLevel,stats:e.stats,audio:r,video:s,altAudio:!d&&a.some(f=>!!f.url)};this.hls.trigger(m.MANIFEST_PARSED,g),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return this._levels.length===0?null:this._levels}get level(){return this.currentLevelIndex}set level(t){const e=this._levels;if(e.length===0)return;if(t<0||t>=e.length){const c=new Error("invalid level idx"),u=t<0;if(this.hls.trigger(m.ERROR,{type:G.OTHER_ERROR,details:S.LEVEL_SWITCH_ERROR,level:t,fatal:u,error:c,reason:c.message}),u)return;t=Math.min(t,e.length-1)}const i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,a=e[t],o=a.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=a,i===t&&a.details&&s&&r===o)return;this.log(`Switching to level ${t} (${a.height?a.height+"p ":""}${a.videoRange?a.videoRange+" ":""}${a.codecSet?a.codecSet+" ":""}@${a.bitrate})${o?" with Pathway "+o:""} from level ${i}${r?" with Pathway "+r:""}`);const l={level:t,attrs:a.attrs,details:a.details,bitrate:a.bitrate,averageBitrate:a.averageBitrate,maxBitrate:a.maxBitrate,realBitrate:a.realBitrate,width:a.width,height:a.height,codecSet:a.codecSet,audioCodec:a.audioCodec,videoCodec:a.videoCodec,audioGroups:a.audioGroups,subtitleGroups:a.subtitleGroups,loaded:a.loaded,loadError:a.loadError,fragmentError:a.fragmentError,name:a.name,id:a.id,uri:a.uri,url:a.url,urlId:0,audioGroupIds:a.audioGroupIds,textGroupIds:a.textGroupIds};this.hls.trigger(m.LEVEL_SWITCHING,l);const h=a.details;if(!h||h.live){const c=this.switchParams(a.uri,s==null?void 0:s.details,h);this.loadPlaylist(c)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(t){this.manualLevelIndex=t,this._startLevel===void 0&&(this._startLevel=t),t!==-1&&(this.level=t)}get firstLevel(){return this._firstLevel}set firstLevel(t){this._firstLevel=t}get startLevel(){if(this._startLevel===void 0){const t=this.hls.config.startLevel;return t!==void 0?t:this.hls.firstAutoLevel}return this._startLevel}set startLevel(t){this._startLevel=t}onError(t,e){e.fatal||!e.context||e.context.type===Q.LEVEL&&e.context.level===this.level&&this.checkRetry(e)}onFragBuffered(t,{frag:e}){if(e!==void 0&&e.type===U.MAIN){const i=e.elementaryStreams;if(!Object.keys(i).some(r=>!!i[r]))return;const s=this._levels[e.level];s!=null&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(t,e){var i;const{level:s,details:r}=e,a=this._levels[s];if(!a){var o;this.warn(`Invalid level index ${s}`),(o=e.deliveryDirectives)!=null&&o.skip&&(r.deltaUpdateFailed=!0);return}s===this.currentLevelIndex?(a.fragmentError===0&&(a.loadError=0),this.playlistLoaded(s,e,a.details)):(i=e.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(t){super.loadPlaylist();const e=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let s=i.uri;if(t)try{s=t.addDirectives(s)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}const r=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${e}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""} with${r?" Pathway "+r:""} ${s}`),this.clearTimer(),this.hls.trigger(m.LEVEL_LOADING,{url:s,level:e,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(t){this.level=t,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=t)}removeLevel(t){var e;const i=this._levels.filter((s,r)=>r!==t?!0:(this.steering&&this.steering.removeLevel(s),s===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,s.details&&s.details.fragments.forEach(a=>a.level=-1)),!1));Eh(i),this._levels=i,this.currentLevelIndex>-1&&(e=this.currentLevel)!=null&&e.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(m.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(t,{levels:e}){this._levels=e}checkMaxAutoUpdated(){const{autoLevelCapping:t,maxAutoLevel:e,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==e&&(this._maxAutoLevel=e,this.hls.trigger(m.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:e,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function Wc(n){const t={};n.forEach(e=>{const i=e.groupId||"";e.id=t[i]=t[i]||0,t[i]++})}class v2{constructor(t){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=t}abort(t){for(const i in this.keyUriToKeyInfo){const s=this.keyUriToKeyInfo[i].loader;if(s){var e;if(t&&t!==((e=s.context)==null?void 0:e.frag.type))return;s.abort()}}}detach(){for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[t]}}destroy(){this.detach();for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t].loader;e&&e.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(t,e=S.KEY_LOAD_ERROR,i,s,r){return new oe({type:G.NETWORK_ERROR,details:e,fatal:!1,frag:t,response:r,error:i,networkDetails:s})}loadClear(t,e){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:s}=t;for(let r=0;r<e.length;r++){const a=e[r];if(s<=a.cc&&(i==="initSegment"||a.sn==="initSegment"||i<a.sn)){this.emeController.selectKeySystemFormat(a).then(o=>{a.setKeyFormat(o)});break}}}}load(t){return!t.decryptdata&&t.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(t).then(e=>this.loadInternal(t,e)):this.loadInternal(t)}loadInternal(t,e){var i,s;e&&t.setKeyFormat(e);const r=t.decryptdata;if(!r){const h=new Error(e?`Expected frag.decryptdata to be defined after setting format ${e}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(t,S.KEY_LOAD_ERROR,h))}const a=r.uri;if(!a)return Promise.reject(this.createKeyLoadError(t,S.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${a}"`)));let o=this.keyUriToKeyInfo[a];if((i=o)!=null&&i.decryptdata.key)return r.key=o.decryptdata.key,Promise.resolve({frag:t,keyInfo:o});if((s=o)!=null&&s.keyLoadPromise){var l;switch((l=o.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return o.keyLoadPromise.then(h=>(r.key=h.keyInfo.decryptdata.key,{frag:t,keyInfo:o}))}}switch(o=this.keyUriToKeyInfo[a]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(o,t):this.loadKeyEME(o,t);case"AES-128":return this.loadKeyHTTP(o,t);default:return Promise.reject(this.createKeyLoadError(t,S.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(t,e){const i={frag:e,keyInfo:t};if(this.emeController&&this.config.emeEnabled){const s=this.emeController.loadKey(i);if(s)return(t.keyLoadPromise=s.then(r=>(t.mediaKeySessionContext=r,i))).catch(r=>{throw t.keyLoadPromise=null,r})}return Promise.resolve(i)}loadKeyHTTP(t,e){const i=this.config,s=i.loader,r=new s(i);return e.keyLoader=t.loader=r,t.keyLoadPromise=new Promise((a,o)=>{const l={keyInfo:t,frag:e,responseType:"arraybuffer",url:t.decryptdata.uri},h=i.keyLoadPolicy.default,c={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,g,f,p)=>{const{frag:y,keyInfo:v,url:E}=f;if(!y.decryptdata||v!==this.keyUriToKeyInfo[E])return o(this.createKeyLoadError(y,S.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),p));v.decryptdata.key=y.decryptdata.key=new Uint8Array(d.data),y.keyLoader=null,v.loader=null,a({frag:y,keyInfo:v})},onError:(d,g,f,p)=>{this.resetLoader(g),o(this.createKeyLoadError(e,S.KEY_LOAD_ERROR,new Error(`HTTP Error ${d.code} loading key ${d.text}`),f,yt({url:l.url,data:void 0},d)))},onTimeout:(d,g,f)=>{this.resetLoader(g),o(this.createKeyLoadError(e,S.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),f))},onAbort:(d,g,f)=>{this.resetLoader(g),o(this.createKeyLoadError(e,S.INTERNAL_ABORTED,new Error("key loading aborted"),f))}};r.load(l,c,u)})}resetLoader(t){const{frag:e,keyInfo:i,url:s}=t,r=i.loader;e.keyLoader===r&&(e.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[s],r&&r.destroy()}}function zc(){return self.SourceBuffer||self.WebKitSourceBuffer}function fa(){if(!fe())return!1;const n=zc();return!n||n.prototype&&typeof n.prototype.appendBuffer=="function"&&typeof n.prototype.remove=="function"}function Yc(){if(!fa())return!1;const n=fe();return typeof(n==null?void 0:n.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(t=>n.isTypeSupported(Mi(t,"video")))||["mp4a.40.2","fLaC"].some(t=>n.isTypeSupported(Mi(t,"audio"))))}function E2(){var n;const t=zc();return typeof(t==null||(n=t.prototype)==null?void 0:n.changeType)=="function"}const T2=250,on=2,_2=.1,L2=.05;class C2{constructor(t,e,i,s){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=t,this.media=e,this.fragmentTracker=i,this.hls=s}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(t,e){const{config:i,media:s,stalled:r}=this;if(s===null)return;const{currentTime:a,seeking:o}=s,l=this.seeking&&!o,h=!this.seeking&&o;if(this.seeking=o,a!==t){if(this.moved=!0,o||(this.nudgeRetry=0),r!==null){if(this.stallReported){const y=self.performance.now()-r;C.warn(`playback not stuck anymore @${a}, after ${Math.round(y)}ms`),this.stallReported=!1}this.stalled=null}return}if(h||l){this.stalled=null;return}if(s.paused&&!o||s.ended||s.playbackRate===0||!st.getBuffered(s).length){this.nudgeRetry=0;return}const c=st.bufferInfo(s,a,0),u=c.nextStart||0;if(o){const y=c.len>on,v=!u||e&&e.start<=a||u-a>on&&!this.fragmentTracker.getPartialFragment(a);if(y||v)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var d;if(!(c.len>0)&&!u)return;const y=Math.max(u,c.start||0)-a,v=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,E=!(v==null||(d=v.details)==null)&&d.live?v.details.targetduration*2:on,_=this.fragmentTracker.getPartialFragment(a);if(y>0&&(y<=E||_)){s.paused||this._trySkipBufferHole(_);return}}const g=self.performance.now();if(r===null){this.stalled=g;return}const f=g-r;if(!o&&f>=T2&&(this._reportStall(c),!this.media))return;const p=st.bufferInfo(s,a,i.maxBufferHole);this._tryFixBufferStall(p,f)}_tryFixBufferStall(t,e){const{config:i,fragmentTracker:s,media:r}=this;if(r===null)return;const a=r.currentTime,o=s.getPartialFragment(a);o&&(this._trySkipBufferHole(o)||!this.media)||(t.len>i.maxBufferHole||t.nextStart&&t.nextStart-a<i.maxBufferHole)&&e>i.highBufferWatchdogPeriod*1e3&&(C.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(t){const{hls:e,media:i,stallReported:s}=this;if(!s&&i){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(t)})`);C.warn(r.message),e.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:t.len})}}_trySkipBufferHole(t){const{config:e,hls:i,media:s}=this;if(s===null)return 0;const r=s.currentTime,a=st.bufferInfo(s,r,0),o=r<a.start?a.start:a.nextStart;if(o){const l=a.len<=e.maxBufferHole,h=a.len>0&&a.len<1&&s.readyState<3,c=o-r;if(c>0&&(l||h)){if(c>e.maxBufferHole){const{fragmentTracker:d}=this;let g=!1;if(r===0){const f=d.getAppendedFrag(0,U.MAIN);f&&o<f.end&&(g=!0)}if(!g){const f=t||d.getAppendedFrag(r,U.MAIN);if(f){let p=!1,y=f.end;for(;y<o;){const v=d.getPartialFragment(y);if(v)y+=v.duration;else{p=!0;break}}if(p)return 0}}}const u=Math.max(o+L2,r+_2);if(C.warn(`skipping hole, adjusting currentTime from ${r} to ${u}`),this.moved=!0,this.stalled=null,s.currentTime=u,t&&!t.gap){const d=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${u}`);i.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:d,reason:d.message,frag:t})}return u}}return 0}_tryNudgeBuffer(){const{config:t,hls:e,media:i,nudgeRetry:s}=this;if(i===null)return;const r=i.currentTime;if(this.nudgeRetry++,s<t.nudgeMaxRetry){const a=r+(s+1)*t.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${r} to ${a}`);C.warn(o.message),i.currentTime=a,e.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1})}else{const a=new Error(`Playhead still not moving while enough data buffered @${r} after ${t.nudgeMaxRetry} nudges`);C.error(a.message),e.trigger(m.ERROR,{type:G.MEDIA_ERROR,details:S.BUFFER_STALLED_ERROR,error:a,fatal:!0})}}}const b2=100;class S2 extends zs{constructor(t,e,i){super(t,e,i,"[stream-controller]",U.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(m.MANIFEST_LOADING,this.onManifestLoading,this),t.on(m.MANIFEST_PARSED,this.onManifestParsed,this),t.on(m.LEVEL_LOADING,this.onLevelLoading,this),t.on(m.LEVEL_LOADED,this.onLevelLoaded,this),t.on(m.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(m.ERROR,this.onError,this),t.on(m.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(m.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(m.BUFFER_CREATED,this.onBufferCreated,this),t.on(m.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(m.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(m.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(m.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(m.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(m.MANIFEST_LOADING,this.onManifestLoading,this),t.off(m.MANIFEST_PARSED,this.onManifestParsed,this),t.off(m.LEVEL_LOADED,this.onLevelLoaded,this),t.off(m.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(m.ERROR,this.onError,this),t.off(m.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(m.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(m.BUFFER_CREATED,this.onBufferCreated,this),t.off(m.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(m.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(m.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(t){if(this.levels){const{lastCurrentTime:e,hls:i}=this;if(this.stopLoad(),this.setInterval(b2),this.level=-1,!this.startFragRequested){let s=i.startLevel;s===-1&&(i.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=i.firstAutoLevel),i.nextLoadLevel=s,this.level=i.loadLevel,this.loadedmetadata=!1}e>0&&t===-1&&(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e),this.state=A.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}else this._forceStartLoad=!0,this.state=A.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case A.WAITING_LEVEL:{const{levels:e,level:i}=this,s=e==null?void 0:e[i],r=s==null?void 0:s.details;if(r&&(!r.live||this.levelLastLoaded===s)){if(this.waitForCdnTuneIn(r))break;this.state=A.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=A.IDLE;break}break}case A.FRAG_LOADING_WAITING_RETRY:{var t;const e=self.performance.now(),i=this.retryDate;if(!i||e>=i||(t=this.media)!=null&&t.seeking){const{levels:s,level:r}=this,a=s==null?void 0:s[r];this.resetStartWhenNotLoaded(a||null),this.state=A.IDLE}}break}this.state===A.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:t,levelLastLoaded:e,levels:i,media:s}=this;if(e===null||!s&&(this.startFragRequested||!t.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const r=this.buffering?t.nextLoadLevel:t.loadLevel;if(!(i!=null&&i[r]))return;const a=i[r],o=this.getMainFwdBufferInfo();if(o===null)return;const l=this.getLevelDetails();if(l&&this._streamEnded(o,l)){const p={};this.altAudio&&(p.type="video"),this.hls.trigger(m.BUFFER_EOS,p),this.state=A.ENDED;return}if(!this.buffering)return;t.loadLevel!==r&&t.manualLevel===-1&&this.log(`Adapting to level ${r} from level ${this.level}`),this.level=t.nextLoadLevel=r;const h=a.details;if(!h||this.state===A.WAITING_LEVEL||h.live&&this.levelLastLoaded!==a){this.level=r,this.state=A.WAITING_LEVEL;return}const c=o.len,u=this.getMaxBufferLength(a.maxBitrate);if(c>=u)return;this.backtrackFragment&&this.backtrackFragment.start>o.end&&(this.backtrackFragment=null);const d=this.backtrackFragment?this.backtrackFragment.start:o.end;let g=this.getNextFragment(d,h);if(this.couldBacktrack&&!this.fragPrevious&&g&&g.sn!=="initSegment"&&this.fragmentTracker.getState(g)!==Et.OK){var f;const p=((f=this.backtrackFragment)!=null?f:g).sn-h.startSN,y=h.fragments[p-1];y&&g.cc===y.cc&&(g=y,this.fragmentTracker.removeFragment(y))}else this.backtrackFragment&&o.len&&(this.backtrackFragment=null);if(g&&this.isLoopLoading(g,d)){if(!g.gap){const p=this.audioOnly&&!this.altAudio?tt.AUDIO:tt.VIDEO,y=(p===tt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;y&&this.afterBufferFlushed(y,p,U.MAIN)}g=this.getNextFragmentLoopLoading(g,h,o,U.MAIN,u)}g&&(g.initSegment&&!g.initSegment.data&&!this.bitrateTest&&(g=g.initSegment),this.loadFragment(g,a,d))}loadFragment(t,e,i){const s=this.fragmentTracker.getState(t);this.fragCurrent=t,s===Et.NOT_LOADED||s===Et.PARTIAL?t.sn==="initSegment"?this._loadInitSegment(t,e):this.bitrateTest?(this.log(`Fragment ${t.sn} of level ${t.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(t,e)):(this.startFragRequested=!0,super.loadFragment(t,e,i)):this.clearTrackerIfNeeded(t)}getBufferedFrag(t){return this.fragmentTracker.getBufferedFrag(t,U.MAIN)}followingBufferedFrag(t){return t?this.getBufferedFrag(t.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:t,media:e}=this;if(e!=null&&e.readyState){let i;const s=this.getAppendedFrag(e.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);const r=this.getLevelDetails();if(r!=null&&r.live){const o=this.getMainFwdBufferInfo();if(!o||o.len<r.targetduration*2)return}if(!e.paused&&t){const o=this.hls.nextLoadLevel,l=t[o],h=this.fragLastKbps;h&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*h)+1:i=0}else i=0;const a=this.getBufferedFrag(e.currentTime+i);if(a){const o=this.followingBufferedFrag(a);if(o){this.abortCurrentFrag();const l=o.maxStartPTS?o.maxStartPTS:o.start,h=o.duration,c=Math.max(a.end,l+Math.min(Math.max(h-this.config.maxFragLookUpTolerance,h*(this.couldBacktrack?.5:.125)),h*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(c,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case A.KEY_LOADING:case A.FRAG_LOADING:case A.FRAG_LOADING_WAITING_RETRY:case A.PARSING:case A.PARSED:this.state=A.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(t,e){super.flushMainBuffer(t,e,this.altAudio?"video":null)}onMediaAttached(t,e){super.onMediaAttached(t,e);const i=e.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new C2(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:t}=this;t&&this.onvplaying&&this.onvseeked&&(t.removeEventListener("playing",this.onvplaying),t.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const t=this.media,e=t?t.currentTime:null;$(e)&&this.log(`Media seeked to ${e.toFixed(3)}`);const i=this.getMainFwdBufferInfo();if(i===null||i.len===0){this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(m.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(t,e){let i=!1,s=!1;e.levels.forEach(r=>{const a=r.audioCodec;a&&(i=i||a.indexOf("mp4a.40.2")!==-1,s=s||a.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&s&&!E2(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=e.levels,this.startFragRequested=!1}onLevelLoading(t,e){const{levels:i}=this;if(!i||this.state!==A.IDLE)return;const s=i[e.level];(!s.details||s.details.live&&this.levelLastLoaded!==s||this.waitForCdnTuneIn(s.details))&&(this.state=A.WAITING_LEVEL)}onLevelLoaded(t,e){var i;const{levels:s}=this,r=e.level,a=e.details,o=a.totalduration;if(!s){this.warn(`Levels were reset while loading level ${r}`);return}this.log(`Level ${r} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${o}`);const l=s[r],h=this.fragCurrent;h&&(this.state===A.FRAG_LOADING||this.state===A.FRAG_LOADING_WAITING_RETRY)&&h.level!==e.level&&h.loader&&this.abortCurrentFrag();let c=0;if(a.live||(i=l.details)!=null&&i.live){var u;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;c=this.alignPlaylists(a,l.details,(u=this.levelLastLoaded)==null?void 0:u.details)}if(l.details=a,this.levelLastLoaded=l,this.hls.trigger(m.LEVEL_UPDATED,{details:a,level:r}),this.state===A.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=A.IDLE}this.startFragRequested?a.live&&this.synchronizeToLiveEdge(a):this.setStartPosition(a,c),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:i,part:s,payload:r}=t,{levels:a}=this;if(!a){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const o=a[i.level],l=o.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const h=o.videoCodec,c=l.PTSKnown||!l.live,u=(e=i.initSegment)==null?void 0:e.data,d=this._getAudioCodec(o),g=this.transmuxer=this.transmuxer||new ec(this.hls,U.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=s?s.index:-1,p=f!==-1,y=new Vs(i.level,i.sn,i.stats.chunkCount,r.byteLength,f,p),v=this.initPTS[i.cc];g.push(r,u,d,h,i,s,l.totalduration,c,y,v)}onAudioTrackSwitching(t,e){const i=this.altAudio;if(!e.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const r=this.fragCurrent;r&&(this.log("Switching to main audio track, cancel main fragment load"),r.abortRequests(),this.fragmentTracker.removeFragment(r)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const s=this.hls;i&&(s.trigger(m.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),s.trigger(m.AUDIO_TRACK_SWITCHED,e)}}onAudioTrackSwitched(t,e){const i=e.id,s=!!this.hls.audioTracks[i].url;if(s){const r=this.videoBuffer;r&&this.mediaBuffer!==r&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=r)}this.altAudio=s,this.tick()}onBufferCreated(t,e){const i=e.tracks;let s,r,a=!1;for(const o in i){const l=i[o];if(l.id==="main"){if(r=o,s=l,o==="video"){const h=i[o];h&&(this.videoBuffer=h.buffer)}}else a=!0}a&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(t,e){const{frag:i,part:s}=e;if(i&&i.type!==U.MAIN)return;if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===A.PARSED&&(this.state=A.IDLE);return}const r=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*r.total/(r.buffering.end-r.loading.first)),i.sn!=="initSegment"&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}onError(t,e){var i;if(e.fatal){this.state=A.ERROR;return}switch(e.details){case S.FRAG_GAP:case S.FRAG_PARSING_ERROR:case S.FRAG_DECRYPT_ERROR:case S.FRAG_LOAD_ERROR:case S.FRAG_LOAD_TIMEOUT:case S.KEY_LOAD_ERROR:case S.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(U.MAIN,e);break;case S.LEVEL_LOAD_ERROR:case S.LEVEL_LOAD_TIMEOUT:case S.LEVEL_PARSING_ERROR:!e.levelRetry&&this.state===A.WAITING_LEVEL&&((i=e.context)==null?void 0:i.type)===Q.LEVEL&&(this.state=A.IDLE);break;case S.BUFFER_APPEND_ERROR:case S.BUFFER_FULL_ERROR:if(!e.parent||e.parent!=="main")return;if(e.details===S.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(e)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case S.INTERNAL_EXCEPTION:this.recoverWorkerError(e);break}}checkBuffer(){const{media:t,gapController:e}=this;if(!(!t||!e||!t.readyState)){if(this.loadedmetadata||!st.getBuffered(t).length){const i=this.state!==A.IDLE?this.fragCurrent:null;e.poll(this.lastCurrentTime,i)}this.lastCurrentTime=t.currentTime}}onFragLoadEmergencyAborted(){this.state=A.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(t,{type:e}){if(e!==tt.AUDIO||this.audioOnly&&!this.altAudio){const i=(e===tt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(i,e,U.MAIN),this.tick()}}onLevelsUpdated(t,e){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=e.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:t}=this;if(!t)return;const e=t.currentTime;let i=this.startPosition;if(i>=0&&e<i){if(t.seeking){this.log(`could not seek to ${i}, already seeking at ${e}`);return}const s=st.getBuffered(t),r=(s.length?s.start(0):0)-i;r>0&&(r<this.config.maxBufferHole||r<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${r} to match buffer start`),i+=r,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${e}`),t.currentTime=i}}_getAudioCodec(t){let e=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&e&&(this.log("Swapping audio codec"),e.indexOf("mp4a.40.5")!==-1?e="mp4a.40.2":e="mp4a.40.5"),e}_loadBitrateTestFrag(t,e){t.bitrateTest=!0,this._doFragLoad(t,e).then(i=>{const{hls:s}=this;if(!i||this.fragContextChanged(t))return;e.fragmentError=0,this.state=A.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const r=t.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),s.trigger(m.FRAG_LOADED,i),t.bitrateTest=!1})}_handleTransmuxComplete(t){var e;const i="main",{hls:s}=this,{remuxResult:r,chunkMeta:a}=t,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:h,level:c}=o,{video:u,text:d,id3:g,initSegment:f}=r,{details:p}=c,y=this.altAudio?void 0:r.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=A.PARSING,f){if(f!=null&&f.tracks){const _=l.initSegment||l;this._bufferInitSegment(c,f.tracks,_,a),s.trigger(m.FRAG_PARSING_INIT_SEGMENT,{frag:_,id:i,tracks:f.tracks})}const v=f.initPTS,E=f.timescale;$(v)&&(this.initPTS[l.cc]={baseTime:v,timescale:E},s.trigger(m.INIT_PTS_FOUND,{frag:l,id:i,initPTS:v,timescale:E}))}if(u&&p&&l.sn!=="initSegment"){const v=p.fragments[l.sn-1-p.startSN],E=l.sn===p.startSN,_=!v||l.cc>v.cc;if(r.independent!==!1){const{startPTS:T,endPTS:L,startDTS:w,endDTS:I}=u;if(h)h.elementaryStreams[u.type]={startPTS:T,endPTS:L,startDTS:w,endDTS:I};else if(u.firstKeyFrame&&u.independent&&a.id===1&&!_&&(this.couldBacktrack=!0),u.dropped&&u.independent){const D=this.getMainFwdBufferInfo(),P=(D?D.end:this.getLoadPosition())+this.config.maxBufferHole,R=u.firstKeyFramePTS?u.firstKeyFramePTS:T;if(!E&&P<R-this.config.maxBufferHole&&!_){this.backtrack(l);return}else _&&(l.gap=!0);l.setElementaryStreamInfo(u.type,l.start,L,l.start,I,!0)}else E&&T>on&&(l.gap=!0);l.setElementaryStreamInfo(u.type,T,L,w,I),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(u,l,h,a,E||_)}else if(E||_)l.gap=!0;else{this.backtrack(l);return}}if(y){const{startPTS:v,endPTS:E,startDTS:_,endDTS:T}=y;h&&(h.elementaryStreams[tt.AUDIO]={startPTS:v,endPTS:E,startDTS:_,endDTS:T}),l.setElementaryStreamInfo(tt.AUDIO,v,E,_,T),this.bufferFragmentData(y,l,h,a)}if(p&&g!=null&&(e=g.samples)!=null&&e.length){const v={id:i,frag:l,details:p,samples:g.samples};s.trigger(m.FRAG_PARSING_METADATA,v)}if(p&&d){const v={id:i,frag:l,details:p,samples:d.samples};s.trigger(m.FRAG_PARSING_USERDATA,v)}}_bufferInitSegment(t,e,i,s){if(this.state!==A.PARSING)return;this.audioOnly=!!e.audio&&!e.video,this.altAudio&&!this.audioOnly&&delete e.audio;const{audio:r,video:a,audiovideo:o}=e;if(r){let l=t.audioCodec;const h=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){l&&(l.indexOf("mp4a.40.5")!==-1?l="mp4a.40.2":l="mp4a.40.5");const c=r.metadata;c&&"channelCount"in c&&(c.channelCount||1)!==1&&h.indexOf("firefox")===-1&&(l="mp4a.40.5")}l&&l.indexOf("mp4a.40.5")!==-1&&h.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(l="mp4a.40.2",this.log(`Android: force audio codec to ${l}`)),t.audioCodec&&t.audioCodec!==l&&this.log(`Swapping manifest audio codec "${t.audioCodec}" for "${l}"`),r.levelCodec=l,r.id="main",this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${l||""}/${t.audioCodec||""}/${r.codec}]`)}a&&(a.levelCodec=t.videoCodec,a.id="main",this.log(`Init video buffer, container:${a.container}, codecs[level/parsed]=[${t.videoCodec||""}/${a.codec}]`)),o&&this.log(`Init audiovideo buffer, container:${o.container}, codecs[level/parsed]=[${t.codecs}/${o.codec}]`),this.hls.trigger(m.BUFFER_CODECS,e),Object.keys(e).forEach(l=>{const h=e[l].initSegment;h!=null&&h.byteLength&&this.hls.trigger(m.BUFFER_APPENDING,{type:l,data:h,frag:i,part:null,chunkMeta:s,parent:i.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,U.MAIN)}backtrack(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=A.IDLE}checkFragmentChanged(){const t=this.media;let e=null;if(t&&t.readyState>1&&t.seeking===!1){const i=t.currentTime;if(st.isBuffered(t,i)?e=this.getAppendedFrag(i):st.isBuffered(t,i+.1)&&(e=this.getAppendedFrag(i+.1)),e){this.backtrackFragment=null;const s=this.fragPlaying,r=e.level;(!s||e.sn!==s.sn||s.level!==r)&&(this.fragPlaying=e,this.hls.trigger(m.FRAG_CHANGED,{frag:e}),(!s||s.level!==r)&&this.hls.trigger(m.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){const t=this.nextBufferedFrag;return t?t.level:-1}get currentFrag(){const t=this.media;return t?this.fragPlaying||this.getAppendedFrag(t.currentTime):null}get currentProgramDateTime(){const t=this.media;if(t){const e=t.currentTime,i=this.currentFrag;if(i&&$(e)&&$(i.programDateTime)){const s=i.programDateTime+(e-i.start)*1e3;return new Date(s)}}return null}get currentLevel(){const t=this.currentFrag;return t?t.level:-1}get nextBufferedFrag(){const t=this.currentFrag;return t?this.followingBufferedFrag(t):null}get forceStartLoad(){return this._forceStartLoad}}class me{static get version(){return"1.5.20"}static isMSESupported(){return fa()}static isSupported(){return Yc()}static getMediaSource(){return fe()}static get Events(){return m}static get ErrorTypes(){return G}static get ErrorDetails(){return S}static get DefaultConfig(){return me.defaultConfig?me.defaultConfig:Kc}static set DefaultConfig(t){me.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new qr,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,I1(t.debug||!1,"Hls instance");const e=this.config=p2(me.DefaultConfig,t);this.userConfig=t,e.progressive&&m2(e);const{abrController:i,bufferController:s,capLevelController:r,errorController:a,fpsController:o}=e,l=new a(this),h=this.abrController=new i(this),c=this.bufferController=new s(this),u=this.capLevelController=new r(this),d=new o(this),g=new Ey(this),f=new by(this),p=e.contentSteeringController,y=p?new p(this):null,v=this.levelController=new y2(this,y),E=new Qy(this),_=new v2(this.config),T=this.streamController=new S2(this,E,_);u.setStreamController(T),d.setStreamController(T);const L=[g,v,T];y&&L.splice(1,0,y),this.networkControllers=L;const w=[h,c,u,d,f,E];this.audioTrackController=this.createController(e.audioTrackController,L);const I=e.audioStreamController;I&&L.push(new I(this,E,_)),this.subtitleTrackController=this.createController(e.subtitleTrackController,L);const D=e.subtitleStreamController;D&&L.push(new D(this,E,_)),this.createController(e.timelineController,w),_.emeController=this.emeController=this.createController(e.emeController,w),this.cmcdController=this.createController(e.cmcdController,w),this.latencyController=this.createController(Sy,w),this.coreComponents=w,L.push(l);const P=l.onErrorOut;typeof P=="function"&&this.on(m.ERROR,P,l)}createController(t,e){if(t){const i=new t(this);return e&&e.push(i),i}return null}on(t,e,i=this){this._emitter.on(t,e,i)}once(t,e,i=this){this._emitter.once(t,e,i)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,e,i=this,s){this._emitter.off(t,e,i,s)}listeners(t){return this._emitter.listeners(t)}emit(t,e,i){return this._emitter.emit(t,e,i)}trigger(t,e){if(this.config.debug)return this.emit(t,t,e);try{return this.emit(t,t,e)}catch(i){if(C.error("An internal error happened while handling event "+t+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const s=t===m.ERROR;this.trigger(m.ERROR,{type:G.OTHER_ERROR,details:S.INTERNAL_EXCEPTION,fatal:s,event:t,error:i}),this.triggeringException=!1}}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){C.log("destroy"),this.trigger(m.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;const t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){C.log("attachMedia"),this._media=t,this.trigger(m.MEDIA_ATTACHING,{media:t})}detachMedia(){C.log("detachMedia"),this.trigger(m.MEDIA_DETACHING,void 0),this._media=null}loadSource(t){this.stopLoad();const e=this.media,i=this.url,s=this.url=fr.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,C.log(`loadSource:${s}`),e&&i&&(i!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(e)),this.trigger(m.MANIFEST_LOADING,{url:t})}startLoad(t=-1){C.log(`startLoad(${t})`),this.started=!0,this.resumeBuffering();for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].startLoad(t),!(!this.started||!this.networkControllers));e++);}stopLoad(){C.log("stopLoad"),this.started=!1;for(let t=0;t<this.networkControllers.length&&(this.networkControllers[t].stopLoad(),!(this.started||!this.networkControllers));t++);}resumeBuffering(){C.log("resume buffering"),this.networkControllers.forEach(t=>{t.resumeBuffering&&t.resumeBuffering()})}pauseBuffering(){C.log("pause buffering"),this.networkControllers.forEach(t=>{t.pauseBuffering&&t.pauseBuffering()})}swapAudioCodec(){C.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){C.log("recoverMediaError");const t=this._media;this.detachMedia(),t&&this.attachMedia(t)}removeLevel(t){this.levelController.removeLevel(t)}get levels(){return this.levelController.levels||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){C.log(`set currentLevel:${t}`),this.levelController.manualLevel=t,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){C.log(`set nextLevel:${t}`),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){C.log(`set loadLevel:${t}`),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){C.log(`set firstLevel:${t}`),this.levelController.firstLevel=t}get startLevel(){const t=this.levelController.startLevel;return t===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:t}set startLevel(t){C.log(`set startLevel:${t}`),t!==-1&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){const e=!!t;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}set bandwidthEstimate(t){this.abrController.resetEstimator(t)}get ttfbEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(C.log(`set autoLevelCapping:${t}`),this._autoLevelCapping=t,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){wy(t)&&this._maxHdcpLevel!==t&&(this._maxHdcpLevel=t,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:t,config:{minAutoBitrate:e}}=this;if(!t)return 0;const i=t.length;for(let s=0;s<i;s++)if(t[s].maxBitrate>=e)return s;return 0}get maxAutoLevel(){const{levels:t,autoLevelCapping:e,maxHdcpLevel:i}=this;let s;if(e===-1&&t!=null&&t.length?s=t.length-1:s=e,i)for(let r=s;r--;){const a=t[r].attrs["HDCP-LEVEL"];if(a&&a<=i)return r}return s}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(t){this.abrController.nextAutoLevel=t}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(t){var e;return(e=this.audioTrackController)==null?void 0:e.setAudioOption(t)}setSubtitleOption(t){var e;return(e=this.subtitleTrackController)==null||e.setSubtitleOption(t),null}get allAudioTracks(){const t=this.audioTrackController;return t?t.allAudioTracks:[]}get audioTracks(){const t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){const t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){const e=this.audioTrackController;e&&(e.audioTrack=t)}get allSubtitleTracks(){const t=this.subtitleTrackController;return t?t.allSubtitleTracks:[]}get subtitleTracks(){const t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){const t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){const e=this.subtitleTrackController;e&&(e.subtitleTrack=t)}get subtitleDisplay(){const t=this.subtitleTrackController;return t?t.subtitleDisplay:!1}set subtitleDisplay(t){const e=this.subtitleTrackController;e&&(e.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}me.defaultConfig=void 0;const w2=Object.freeze(Object.defineProperty({__proto__:null,AbrController:Ih,AttrList:nt,AudioStreamController:sc,AudioTrackController:rc,BasePlaylistController:Bs,BaseSegment:mr,BaseStreamController:zs,BufferController:cc,CMCDController:Fc,CapLevelController:sn,ChunkMetadata:Vs,ContentSteeringController:Uc,DateRange:pr,EMEController:Ue,ErrorActionFlags:Dt,ErrorController:Ch,ErrorDetails:S,ErrorTypes:G,Events:m,FPSController:Rc,Fragment:bs,Hls:me,HlsSkip:Oi,HlsUrlParameters:Or,KeySystemFormats:Ct,KeySystems:X,Level:Oe,LevelDetails:xl,LevelKey:ni,LoadStats:Pi,MetadataSchema:kt,NetworkErrorAction:vt,Part:Pl,PlaylistLevelType:U,SubtitleStreamController:oc,SubtitleTrackController:lc,TimelineController:Sc,default:me,getMediaSource:fe,isMSESupported:fa,isSupported:Yc},Symbol.toStringTag,{value:"Module"}));Ge.initPaella=v1,Object.defineProperty(Ge,Symbol.toStringTag,{value:"Module"})});
